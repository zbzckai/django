!function(){var e={list:null,listMap:null,querysMap:null},t=sensorsdata.monitorModel=$.extend({},sensorsdata.EventsModule,{queue:[],get:function(t,n,a){"function"==typeof t&&(a=n,n=t,t=void 0),e.listMap&&a!==!1?n(this.getCache(t)):(this.queue.push({id:t,onSuccess:n}),this.request())},getCache:function(t){return void 0!==t?$.extend(!0,{},e.listMap[t]):$.extend(!0,[],e.list)},request:function(){if(!this.isLoading){this.isLoading=!0;var e,t,n=this;sensorsdata.ajax({url:sensorsdata.api.get("monitorAll"),isCommonError:!1,success:function(a){t?n.loadedHandle(a,t):e=a},error:sensorsdata.bind(this.errorHandle,this)}),sensorsdata.ajax({url:sensorsdata.api.get("monitorReport"),isCommonError:!1,success:function(a){e?n.loadedHandle(e,a):t=a},error:sensorsdata.bind(this.errorHandle,this)})}},loadedHandle:function(e,t){var n=this;this.isLoading=!1,this.loadDataProcess(e,t),this.queue.length&&(this.queue.forEach(function(e){e.onSuccess(n.getCache(e.id))}),this.queue.length=0),this.trigger("update")},loadDataProcess:function(t,n){e.list=t;var a=e.listMap={},s=e.querysMap={};t.forEach(function(e){var t=s[e.type]||(s[e.type]=[]);t.push(e.data),a[e.id]=e}),n.forEach(function(e){a[e.id]&&(a[e.id].detail=e)})},updateList:function(){this.request()},save:function(e,t,n,a){function s(){sensorsdata.ajax({method:"POST",url:sensorsdata.api.get("monitor",{id:e}),data:JSON.stringify(t),isCommonError:!1,success:function(){"function"==typeof n&&n(),i.updateList()},error:a})}var i=this;"string"==typeof e&&"string"!=typeof t&&(a=n,n=t,t=e,e=void 0),t.smtp_config_id?s():sensorsdata.emailConfig.getConfig(function(e){e&&e.id?(t.smtp_config_id=e.id,s()):(sensorsdata.warning.show(sensorsdata.languages.get("请设置发件邮箱<!--{en}Please set mailbox for sending-->")),sensorsdata.emailConfig.show())})},del:function(e,t,n){var a=this;sensorsdata.ajax({method:"DELETE",url:sensorsdata.api.get("monitor",{id:e}),isCommonError:!1,success:function(){"function"==typeof t&&t(),a.updateList()},error:n})},onoff:function(t,n,a,s){if("number"==typeof t){"boolean"!=typeof n&&(s=a,a=n,n=void 0);var i=e.listMap[t];i.disabled=void 0===n?!i.disabled:n,this.save(t,i,a,s)}},has:function(t,n){if("string"==typeof t&&n&&n.measures){if(!e.querysMap[t])return!1;for(var a=e.querysMap[t],s=0,i=a.length;i>s;s++)if(sensorsdata.util.diff(n,a[s]))return!0;return!1}},errorHandle:function(e){e&&e.responseJSON&&e.responseJSON.error&&sensorsdata.error.show(e.responseJSON.error)}}),n="#tpl-sensorsdata-monitor",a="#tpl-sensorsdata-monitor-select",s="",i="",r={dateUnit:[{name:"hour",cname:sensorsdata.languages.get("小时<!--{en}hour-->")},{name:"day",cname:sensorsdata.languages.get("天<!--{en}day-->")}],days:[{name:"mon",selected:!0,cname:sensorsdata.languages.get("周一<!--{en}Monday-->")},{name:"tue",selected:!0,cname:sensorsdata.languages.get("周二<!--{en}Tuesday-->")},{name:"wed",selected:!0,cname:sensorsdata.languages.get("周三<!--{en}Wednesday-->")},{name:"thu",selected:!0,cname:sensorsdata.languages.get("周四<!--{en}Thursday-->")},{name:"fri",selected:!0,cname:sensorsdata.languages.get("周五<!--{en}Friday-->")},{name:"sat",selected:!0,cname:sensorsdata.languages.get("周六<!--{en}Saturday-->")},{name:"sun",selected:!0,cname:sensorsdata.languages.get("周日<!--{en}Sunday-->")}],hours:function(){function e(e){return 10>e?"0"+e:e}for(var t=[],n=0;24>n;n++){var a={name:n+"",cname:e(n)+":00-"+e(n+1)+":00",selected:!0};t.push(a)}return t}(),send:[{name:"email",cname:sensorsdata.languages.get("邮件<!--{en}E-mail-->"),selected:!0}],condition:{"function":[{name:"less",cname:sensorsdata.languages.get("低于<!--{en}Lower than-->")},{name:"greater",cname:sensorsdata.languages.get("高于<!--{en}Higher than-->")},{name:"between",cname:sensorsdata.languages.get("区间在<!--{en}bettwen-->")},{name:"notbetween",cname:sensorsdata.languages.get("区间不在<!--{en}notbetween-->")}],unit:[{name:"int",cname:sensorsdata.languages.get("数值<!--{en}Numerical value-->")},{name:"ratio",cname:sensorsdata.languages.get("百分比<!--{en}Percentage-->")}]}},o=sensorsdata.CONSTSET.monitorReference,d={hour:[{name:"lastHour",cname:o.lastHour.cname},{name:"yesterdaySameHour",cname:o.yesterdaySameHour.cname},{name:"none",cname:o.none.cname}],day:[{name:"yesterday",cname:o.yesterday.cname},{name:"dayWeekBefore",cname:o.dayWeekBefore.cname},{name:"none",cname:o.none.cname}]};sensorsdata.monitor=$.extend({},sensorsdata.EventsModule,{init:function(){if(!this.isinit){var e=this;this.isinit=!0,this.slidePgae=sensorsdata.createSlidePage(),this.slidePgae.on("click",sensorsdata.bind(this.clickHandle,this)),Mustache.parse(s=$(n).html()),Mustache.parse(i=$(a).html()),t.on("update",function(){e.trigger("update")})}},clickHandle:function(e){switch(e.$target.attr("data-method")){case"save":this.save();break;case"del":this.del(e);break;case"close":this.hide();break;case"onoff":this.onoff(e);break;case"setemail":sensorsdata.emailConfig.show()}},show:function(e){if("number"==typeof e||e&&e.type&&e.data){this.init(),this.data&&this.destroy();var t=this;sensorsdata.emailConfig.getConfig(function(n){t.emailConfig=n,t.showPage(e)})}},showPage:function(e){"number"==typeof e?this.requestConfig(e):(this.data=$.extend(!0,{},e),"string"==typeof this.data.data&&(this.data.data=JSON.parse(this.data.data)),this.render())},hide:function(){this.slidePgae.hide(),this.destroy()},requestConfig:function(e){this.slidePgae.showLoading(),t.get(e,sensorsdata.bind(this.configLoaded,this),sensorsdata.bind(this.errorHandle,this))},configLoaded:function(e){this.slidePgae.closeLoading(),this.data=e,"string"==typeof this.data.data&&(this.data.data=JSON.parse(this.data.data)),this.render()},render:function(){var e=this;this.slidePgae.setTitle(sensorsdata.languages.get(this.data.id?"修改指标预警<!--{en}Revise the metric early warning-->":"新建指标预警<!--{en}Create new metric early warning-->")),this.buildTplData(function(t){e.slidePgae.setContent(Mustache.render(s,t)),e.renderPostprocess()})},buildTplData:function(e){var t=this.data,n=this.buildTplDataMonitor(),a=this.buildTplDataQuery(),s={id:t.id,emailConfig:this.emailConfig,titleLength:sensorsdata.languages.get("20<!--{en}50-->"),queryParams:a,monitorConfig:n};t.id&&(s.title=t.title,n.email=t.email.join(","),n.disabled=t.disabled,t.filter[0].conditions[0].function.indexOf("between")>-1?(n.condition.min=t.filter[0].conditions[0].params[0],n.condition.max=t.filter[0].conditions[0].params[1]):n.condition.value=t.filter[0].conditions[0].value),this.queryParamsProcess(a,function(){e(s)})},buildTplDataQuery:function(){var e=sensorsdata.cache.eventsMap,t=sensorsdata.cache.eventPropertiesMap,n=sensorsdata.cache.userPropertiesMap,a=sensorsdata.CONSTSET.eventEmptyValue,s=sensorsdata.CONSTSET.eventEmptyText,i=sensorsdata.CONSTSET.measureFunctions,r=sensorsdata.CONSTSET.propertyFunctions,o=sensorsdata.CONSTSET.filterRelation,d=$.extend(!0,{},this.data.data),l={};return l.measures=d.measures.map(function(r){if(r.expression)return r;var o={event_name:{name:r.event_name,cname:r.event_name===a?s:e[r.event_name]&&e[r.event_name].cname}};if(r.field){var d=r.field.split(".").pop(),l=t[d]||n[d];o.aggregator={name:r.field,cname:(l&&l.cname+sensorsdata.languages.get("的<!--{en}.-->"))+i[r.aggregator].cname}}else o.aggregator={name:r.aggregator,cname:i[r.aggregator].cname};return o}),d.filter&&d.filter.conditions&&(l.filter={conditions:d.filter.conditions.map(function(e){var a=e.field.split(".").pop(),s=t[a]||n[a];return{field:{name:e.field,cname:s&&s.cname},"function":{name:e["function"],cname:r[e["function"]].cname},params:e.params}})},l.filter.conditions.length>1&&(l.filter.relation={name:d.filter.relation,cname:o[d.filter.relation].cname})),l},queryParamsProcess:function(e,t){var n=[],a=[];e.measures.forEach(function(e){e.expression&&!e.name&&(n.push(e),a.push(e.expression))}),n.length?sensorsdata.util.indicatorReverse(a,function(e){e.forEach(function(e,t){n[t].name=e.expression.replace(/"/g,"")}),t()}):t()},buildTplDataMonitor:function(){var e=this.data,t=e.data.unit,n=e.days,a=e.hours,s=e.filter&&e.filter[0],i=s&&s.conditions&&s.conditions[0],o=$.extend(!0,{isReferenceNone:i&&"none"===i.reference},r),l=function(e,t){if(!t)return void(e[0].selected=!0);if("string"==typeof t){for(var n=0,a=e.length;a>n;n++)if(e[n].name===t)return void(e[n].selected=!0)}else if(t instanceof Array)for(var s=0,i=e.length;i>s;s++){var r=e[s];r.selected=!1;for(var o=0,d=t.length;d>o;o++){var l=t[o];r.name===l&&(r.selected=!0)}}};return o.condition.reference=$.extend(!0,[],d[t]||d.hour),l(o.dateUnit,t),l(o.condition["function"],i&&i["function"]),l(o.condition.reference,i&&i.reference),l(o.condition.unit,i&&i.unit),l(o.days,n&&n),l(o.hours,a&&a),o},renderPostprocess:function(){var e=this,t=this.slidePgae.$container,n=this.multiselects={};t.find(".config select").each(function(t,a){var s=a.getAttribute("name");n[s]=e.createMultiselect(s,$(a))});var a=this.$sendInput=t.find('.config .param-send input[name="value"]');this.$titleInput=t.find('input[name="title"]'),this.$conditionValueInput=t.find('.config .param-condition input[name="value"]'),this.$conditionFields=t.find(".config .param-condition .fields"),this.$intervalValueInput=t.find(".config .param-condition .interval-num"),this.$disabled=t.find('input[name="disabled"]'),this.$setemail=t.find(".config .setemail a"),this.$conditionUnit=t.find(".config .param-condition .unit"),this.$conditionTooltip=t.find(".config .param-condition .icon-help").on("mouseover",function(){this.setAttribute("data-original-title",e.buildConditionTips())}).tooltip();var s=this.$sendInput.val().split(",");a.val("").tagsinput("items"),s.forEach(function(e){a.tagsinput("add",e)}),this.slidePgae.show(),sensorsdata.emailConfig.on("update",sensorsdata.bind(this.emailConfigUpdated,this)),n.function.val().indexOf("between")>-1&&this.$conditionFields.addClass("interval-box"),1===n.dateUnit.get(0).selectedIndex&&this.multiselects.timeHour.parent().hide(),this.slidePgae.$container.find(".param-time").on("click",".selector",function(){var e=$(this),t=e.offset().top,n=e.height(),a=$("body").height(),s=$(".mod-foot").height(),i=a-t-n-s,r=258,o=390,d=e.find("ul");$(this).next().hasClass("selector")?i>r?d.css("maxHeight",r):d.css("maxHeight",i):i>o?d.css("maxHeight",o):d.css("maxHeight",i)}),this.$intervalValueInput.eq(0).on("focusout",function(e){var t=parseInt(e.target.value,10);this.$intervalValueInput.eq(2).prop("min",t)}.bind(this))},createMultiselect:function(e,t){var n=this;return t.multiselect({toggleClose:!1,enableCaseInsensitiveFiltering:!1,includeSelectAllOption:"timeDay"===e||"timeHour"===e?!0:!1,selectAllText:"timeDay"===e?sensorsdata.languages.get("全选(7天)<!--{en}alldays-->"):"timeHour"===e?sensorsdata.languages.get("全选(24小时)<!--{en}allhours-->"):"",selectAllValue:"timeDay"===e?"alldays":"timeHour"===e?"allhours":"",allSelectedText:"timeDay"===e?"全周":"timeHour"===e?"全天":"",onChange:function(t){n.selectChangeHandle(e,t?t.val():e)}})},emailConfigUpdated:function(e){this.emailConfig=e,sensorsdata.monitor.$setemail.html(e.from)},selectChangeHandle:function(e,t){switch(e){case"dateUnit":this.dateUnitChangeHandle(t);break;case"reference":this.referenceChangeHandle(t);break;case"function":this.functionChangeHandle(t)}},dateUnitChangeHandle:function(e){var t=Mustache.render(i,{name:"reference",options:d[e]});this.multiselects.reference.multiselect("destroy"),this.multiselects.reference=this.createMultiselect("reference",$(t).replaceAll(this.multiselects.reference)),this.$conditionValueInput.val(""),"day"===e?this.multiselects.timeHour.parent().hide():this.multiselects.timeHour.parent().show()},referenceChangeHandle:function(e){this.$conditionUnit["none"===e?"hide":"show"]()},functionChangeHandle:function(e){"between"===e||"notbetween"===e?this.$conditionFields.addClass("interval-box"):this.$conditionFields.removeClass("interval-box")},buildConditionTips:function(){var e={none:"当指标{{#less}}低于{{/less}}{{#greater}}高于{{/greater}} {{value}}{{^value}}-{{/value}} 时",other:{"int":"比{{#lastHour}}上一小时{{/lastHour}}{{#yesterdaySameHour}}昨天同期{{/yesterdaySameHour}}{{#yesterday}}昨日{{/yesterday}}{{#dayWeekBefore}}上周同期{{/dayWeekBefore}}{{#less}}低于{{/less}}{{#greater}}高于{{/greater}} {{value}}{{^value}}-{{/value}} 时",ratio:"{{#less}}低于{{/less}}{{#greater}}高于{{/greater}}{{#lastHour}}上一小时{{/lastHour}}{{#yesterdaySameHour}}昨天同期{{/yesterdaySameHour}}{{#yesterday}}昨日{{/yesterday}}{{#dayWeekBefore}}上周同期{{/dayWeekBefore}}值的 {{value}}{{^value}}-{{/value}}% 时"}},t={between:"当 {{min}}{{^min}}-{{/min}} ≤ 指标 ≤ {{max}}{{^max}}-{{/max}} 时",notbetween:"当指标 ＞ {{max}}{{^max}}-{{/max}} 或 ＜ {{min}}{{^min}}-{{/min}} 时"},n=this.multiselects,a=n.dateUnit.val(),s=n["function"].val(),i=n.reference.val(),r=n.unit.val(),o=this.$intervalValueInput.eq(0).val(),d=this.$intervalValueInput.eq(2).val(),l={value:this.$conditionValueInput.val()},u={};return l[s]=!0,l[i]=!0,l.min=o,l.max=d,u[a]=!0,s.indexOf("between")>-1?Mustache.render(t[s],l)+Mustache.render("，则{{#hour}}按小时{{/hour}}{{#day}}按天{{/day}}发送预警",u):Mustache.render("none"===i?e.none:e.other[r],l)+Mustache.render("，则{{#hour}}按小时{{/hour}}{{#day}}按天{{/day}}发送预警",u)},save:function(){var e=$.extend(this.data,this.buildOptions()),n=this.validateOptions(e);return n.error?void sensorsdata.error.show(n.error):void t.save(this.data.id,e,sensorsdata.bind(this.saveHandle,this),sensorsdata.bind(this.errorHandle,this))},buildOptions:function(){function e(){var e=t["function"].val();return e.indexOf("between")>-1?{"function":e,unit:"none"===t.reference.val()?"int":t.unit.val(),reference:"none",params:[parseInt(this.$intervalValueInput.eq(0).val(),10),parseInt(this.$intervalValueInput.eq(2).val(),10)]}:{"function":e,unit:"none"===t.reference.val()?"int":t.unit.val(),reference:t.reference.val(),value:this.$conditionValueInput.val()}}var t=this.multiselects,n=t.dateUnit.val();return"hour"===n?(this.data.days=t.timeDay.val(),this.data.hours=t.timeHour.val()):this.data.days=t.timeDay.val(),this.data.data.unit=n,{title:this.$titleInput.val(),smtp_config_id:this.emailConfig&&this.emailConfig.id,email:this.$sendInput.val()?this.$sendInput.val().split(","):[],disabled:this.$disabled.val(),filter:[{type:"simple",conditions:[e.call(this,t["function"].val())]}]}},validateOptions:function(e){for(var t=[{check:function(){return"undefined"!=typeof e.smtp_config_id},msg:sensorsdata.languages.get("请设置发件邮箱<!--{en}Please set mailbox for sending-->")},{check:function(){return!!e.title},msg:sensorsdata.languages.get("预警名称不能为空<!--{en}The early warning name can not be empty-->")},{check:function(){var t=e.data.unit,n=e.hours,a=e.days;return"day"===t?!!a:!!a&&n},msg:sensorsdata.languages.get("监控时间段不能为空<!--{en}The monitoring period should not be empty.-->")},{check:function(){return e.filter[0].conditions[0].function.indexOf("between")>-1?!0:!!e.filter[0].conditions[0].value},msg:sensorsdata.languages.get("指标值不能为空<!--{en}The metric value can not be empty-->")},{check:function(){if(-1===e.filter[0].conditions[0].function.indexOf("between"))return!0;var t=parseInt(e.filter[0].conditions[0].params[0],10),n=parseInt(e.filter[0].conditions[0].params[1],10);return!!t&&!!n&&n>=t},msg:sensorsdata.languages.get("区间值不可为空，且右侧数值不能小于左侧<!--{todo}-->")},{check:function(){return!!e.email.length},msg:sensorsdata.languages.get("收件人不能为空<!--{en}The recipient can not be empty-->")},{check:function(){for(var t=!0,n=e.email,a=0,s=n.length;s>a;a++)if(!/^(\w-*\.*)+@(\w-?)+(\.\w+)+$/.test(n[a])){t=!1;break}return t},msg:sensorsdata.languages.get("请填写正确的邮箱地址<!--{en}Please fill in the correct E-mail address-->")}],n={},a=0,s=t.length;s>a;a++){var i=t[a];if(!i.check()){n.error=i.msg;break}}return n},del:function(e){var n=this,a=e.$target.attr("data-id");a?sensorsdata.popover({ele:e.$target,showNow:!0,footer:$("#tpl_popover_footer_state_3").html(),content:Mustache.render($("#tpl_delete_monitor_content").html(),this.data.title),success:function(){t.del(Number(a),sensorsdata.bind(n.deleteHandle,n),sensorsdata.bind(n.errorHandle,n))}}):this.hide()},saveHandle:function(){this.hide(),sensorsdata.success.show(sensorsdata.languages.get("保存成功<!--{en}Saved successfully-->"))},deleteHandle:function(){this.hide(),sensorsdata.success.show(sensorsdata.languages.get("删除成功<!--{en}Delete successfully-->"))},errorHandle:function(e){e&&e.responseJSON&&e.responseJSON.error&&sensorsdata.error.show(e.responseJSON.error)},onoff:function(e){var t=e.$target.find("input");"true"===t.val()?(e.$target.addClass("on").find(".sa-switch").addClass("on"),t.val(!1)):(e.$target.removeClass("on").find(".sa-switch").removeClass("on"),t.val(!0))},has:sensorsdata.bind(t.has,t),destroy:function(){if(this.$sendInput){var e=this.multiselects;for(var t in e)e.hasOwnProperty(t)&&e[t].multiselect("destroy");this.$sendInput.tagsinput("destroy"),this.data=this.multiselects=this.$titleInput=this.$conditionValueInput=this.$sendInput=this.$disabled=this.$setemail=null,this.slidePgae.setContent(""),sensorsdata.emailConfig.off("update",this.emailConfigUpdated)}}})}();