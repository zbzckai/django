sensorsdata.GroupControl=function(){this.eventMap_={valueChangedEvent:[]},this.tplByItem_=$("#tpl-filter-by-item").html(),this.byObj_=null,this.lastValue_={},this.defaultOptions_={label:{overAllText:sensorsdata.languages.get("总体<!--{en}Overall-->"),begin:sensorsdata.languages.get("按<!--{en}Group by-->"),end:sensorsdata.languages.get("查看<!--{en}-->"),eventGroup:sensorsdata.languages.get("事件属性<!--{en}Event properties-->"),userGroup:sensorsdata.languages.get("用户属性<!--{en}User properties-->"),multiple:{nonSelectedText:sensorsdata.languages.get("请选择属性值<!--{en}Please select a property value-->"),filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->")}},disabled:!1,container:null,data:{event:[],session:[],user:[]},btnRemoveDisplay:!1,btnAddDisplay:!1,enableOverAll:!0,bucketDisplay:!0,showPropertyHelp:!1,buildPropertyHelp:null},this.options_={},this.isAdd_=!0,this.itemGroups_=[]},sensorsdata.GroupControl.prototype.init=function(t){this.options_=$.extend(!0,{},this.defaultOptions_),$.extend(!0,this.options_,t),this.filterPropObj();var e=this.options_;this.itemGroups_=$.isArray(e.data)?e.data:sensorsdata.convertProperty(e.data,!0),this.byObj_=e.container,this.addBy_(!1),e.container.unbind("click.GroupControl").bind("click.GroupControl",sensorsdata.bind(this.containerClick_,this))},sensorsdata.GroupControl.prototype.filterPropObj=function(){$.isArray(this.options_.data)?this.options_.data=this.options_.data.map(function(t){return t.items=t.items.filter(function(t){var e=t.fullName;return-1!==e.indexOf("user.")?"$id"!==t.name:-1!==e.indexOf("event.")?"$user_id"!==t.name:!0}),t}):(this.options_.data.hasOwnProperty("user")&&this.options_.data.user&&(this.options_.data.user=this.options_.data.user.filter(function(t){return"$id"!==t.name})),this.options_.data.hasOwnProperty("event")&&this.options_.data.event&&(this.options_.data.event=this.options_.data.event.filter(function(t){return"$user_id"!==t.name})))},sensorsdata.GroupControl.prototype.val=function(t){if(t)return this.setValue_(t);var e=this.getValue_();return $.extend(!0,{},e)},sensorsdata.GroupControl.prototype.getPropObj=function(){return this.options_.data},sensorsdata.GroupControl.prototype.bindEvent=function(t,e){this.eventMap_[t]&&this.eventMap_.valueChangedEvent.push(e)},sensorsdata.GroupControl.prototype.containerClick_=function(t){var e=$(t.target||t.srcElement),s=e.parents("div.group-control-item:first"),i=e.attr("data-method");switch(i){case"by-add":this.addBy_(),this.setStatus_(),this.execEvent_("valueChangedEvent");break;case"by-remove":s.remove(),this.setStatus_(),this.execEvent_("valueChangedEvent");break;case"bucket":}},sensorsdata.GroupControl.prototype.getSelectProperty_=function(t){var e=t.find("div.property :radio:checked").val();return e?this.findProperty_(e):{}},sensorsdata.GroupControl.prototype.addBy_=function(t,e){var s={};t!==!1&&(s=t?this.findProperty_(t,!0):this.getNextByProp_());var i=this.options_;if(t&&t!==s.fullName){var a=s.funnel_step>=-1,n=t.split(".");if(s={},a&&!$.isNumeric(n[0])&&("user"===n[0]?s=i.data.user.filter(function(t){return t.name===n[1]})[0]:"event"===n[0]?s=i.data.event.filter(function(t){return t.event_name===n[1]&&t.name===n[2]})[0]:"session"===n[0]&&(s=i.data.session.filter(function(t){return t.event_name===n[1]&&t.name===n[2]})[0])),$.isEmptyObject(s))return this.isAdd_=!1,!1}var r={itemGroups:this.itemGroups_,label:i.label,bucket:(e||[]).join(","),enableOverAll:i.enableOverAll,showPropertyHelp:i.showPropertyHelp,btnAddDisplay:i.btnAddDisplay,btnRemoveDisplay:i.btnRemoveDisplay},o=$(Mustache.render(this.tplByItem_,r));this.byObj_.append(o);var l=o.find('span[data-method="bucket"]');l.toggle(i.bucketDisplay),i.bucketDisplay&&l.bucketPopover({value:e,property:s,saveCallback:sensorsdata.bind(function(){this.execEvent_("valueChangedEvent")},this)});var d=o.find("div.property"),p=d.find("select");p.multiselect({templates:{li:$("#tpl-filter-by-multi-li").html()},includeFilterClearBtn:!1,enableFiltering:!0,syncButtonAndGroup:!0,maxHeight:490,nonSelectedText:this.options_.label.multiple.nonSelectedText,filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->"),onChange:sensorsdata.bind(function(){var t=this.getSelectProperty_(o),e=[];this.lastValue_&&!$.isEmptyObject(this.lastValue_.bucket)&&(e=this.lastValue_.bucket[t.fullName]||[]);var s=o.find('span[data-method="bucket"]');s.toggle(i.bucketDisplay),i.bucketDisplay&&s.bucketPopover({value:e,property:t,saveCallback:sensorsdata.bind(function(){this.execEvent_("valueChangedEvent")},this)}),this.setStatus_(),this.execEvent_("valueChangedEvent"),this.renderPropertyHelp_(o,t)},this)}),$.isEmptyObject(s)||p.multiselect("select",s.fullName),t&&this.execEvent_("valueChangedEvent"),d.find("input:radio").each(function(t,e){e=$(e),"true"===e.attr("data-dict")&&e.parents("a:first").find("span:last").attr("class","icon-data-type-dict"),"list"===e.attr("data-type")&&e.parents("a:first").find("span:last").addClass("icon-data-type-list")}),this.renderPropertyHelp_(o,s),o.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.isAdd_=!0},sensorsdata.GroupControl.prototype.renderPropertyHelp_=function(t,e){if(this.options_.showPropertyHelp){var s="";$.isFunction(this.options_.buildPropertyHelp)?s=this.options_.buildPropertyHelp(e):e.funnel_step>=0?s=sensorsdata.util.format(sensorsdata.languages.get("按照每个用户首次最长转化状态中的第 #{step} 步骤的 #{cname} 进行分组，一个用户只会出现在一个分组中，如果用户没有转化到该步骤则分到未知组<!--{en}Clustering by the  #{cname} of the #{step} step of fist time longest conversion of each user.Each user will only be displayed in one group clustering.If the user is not conserved to this step, he will be clustered to the unknown group.-->"),{step:e.funnel_step+1,cname:e.cname,name:e.name}):-1===e.funnel_step&&e.event_name&&(s=sensorsdata.util.format(sensorsdata.languages.get("按照每个用户任意步骤的 #{cname} 首次有效值进行分组，一个用户只会出现在一个分组中<!--{en}Clustered by the first time valid value of #{cname} of arbitrary step of each user. Each user will only be displayed in one group clustering.-->"),e)),t.find("div.property span.icon-help").toggle(!!s).attr("data-original-title",s).tooltip({container:"body"})}},sensorsdata.GroupControl.prototype.getNextByProp_=function(){for(var t=this.byObj_.find("div.property :radio:not([disabled],:checked)"),e=0,s=t.size();s>e;e++){var i=t.eq(e);if(i.val())return this.findProperty_(i.val())}return{}},sensorsdata.GroupControl.prototype.setStatus_=function(){var t=this.getValue_(),e=this.byObj_.find("div.property select option").length;if(!$.isArray(t.byFields)||0===t.byFields.length)return void this.byObj_.find('button[data-method="by-add"]:first').toggle(e>1);this.byObj_.find('button[data-method="by-add"]:first').removeAttr("style"),this.byObj_.find("div.property li.disabled").removeClass("disabled").find(":radio").removeAttr("disabled");for(var s=function(t,e){var s=$(e).parents("li:first");s.hasClass("active")||($(e).prop("disabled",!0),$(e).parents("li:first").addClass("disabled"))},i="",a=t.byFields.length,n=0;a>n;n++)this.byObj_.find('div.property :radio[value="'+t.byFields[n]+'"]').each(function(t,e){"list"===$(e).attr("data-type")&&(i=$(e).val())}),i&&(this.byObj_.find('div.property :radio[data-type="list"]').each(function(t,e){$(e).prop("disabled",!0),$(e).parents("li:first").addClass("disabled")}),this.byObj_.find('div.property :radio[value="'+i+'"]').parents("li.active:first").parents("ul:first").find(':radio[data-type="list"]').each(function(t,e){$(e).prop("disabled",""),$(e).parents("li:first").removeClass("disabled")}));for(var r=0;a>r;r++)this.byObj_.find('div.property :radio[value="'+t.byFields[r]+'"]').each(s)},sensorsdata.GroupControl.prototype.findProperty_=function(t,e){for(var s=this.itemGroups_,i={},a=0,n=s.length;n>a&&(i=s[a].items.filter(function(e){return e.fullName===t})[0]||{},$.isEmptyObject(i));a++);return e&&$.isEmptyObject(i)&&(i=s[0].items[0]),$.extend(!0,{},i)},sensorsdata.GroupControl.prototype.setValue_=function(t){if(this.lastValue_=t,this.byObj_.html(""),$.isArray(t.byFields)&&t.byFields.length>0){for(var e=t.bucket||{},s=!1,i=0,a=t.byFields.length;a>i;i++)this.addBy_(t.byFields[i],e[t.byFields[i]]),s=s||this.isAdd_,this.isAdd_===!1&&(1===a||i===a-1&&!s)&&(this.addBy_(!1),this.isAdd_=!0);this.setStatus_()}else this.addBy_(!1);this.options_.disabled===!0&&this.byObj_.find("button,input,select").attr("disabled",!0)},sensorsdata.GroupControl.prototype.getValue_=function(){var t={},e=this.options_;return this.byObj_&&this.byObj_.children().size()>0&&(t.byFields=[],t.bucket={},this.byObj_.children().each(sensorsdata.bind(function(s,i){i=$(i);var a=this.getSelectProperty_(i);if(!$.isEmptyObject(a)&&(t.byFields.push(a.fullName),e.bucketDisplay)){var n=i.find('span[data-method="bucket"]:visible').data("bucket-value")||[];n.length>0&&(t.bucket[a.fullName]=n)}},this))),t},sensorsdata.GroupControl.prototype.getFullValue=function(){var t=[],e=this.options_;return this.byObj_&&this.byObj_.children().size()>0&&(t=[],this.byObj_.children().each(sensorsdata.bind(function(s,i){i=$(i);var a=this.getSelectProperty_(i);if(!$.isEmptyObject(a)&&(t.push(a),e.bucketDisplay)){var n=i.find('span[data-method="bucket"]:visible').data("bucket-value")||[];n.length>0&&(t[t.length-1].bucket=n)}},this))),t},sensorsdata.GroupControl.prototype.execEvent_=function(t){if("valueChangedEvent"===t){var e=this.getValue_();if(!0===this.compare_(e,this.lastValue_))return;this.lastValue_=e}for(var s=null,i=0,a=this.eventMap_[t].length;a>i;i++){var n=this.eventMap_[t][i];"function"==typeof n&&(s=n(this.lastValue_))}return s},sensorsdata.GroupControl.prototype.compare_=function(t,e){if(t=sensorsdata.GroupControl.clearValue(t),e=sensorsdata.GroupControl.clearValue(e),t===e)return!0;if($.isEmptyObject(t)||$.isEmptyObject(e))return!1;if($.isArray(t.byFields)&&$.isArray(e.byFields)){if(t.byFields.join()===e.byFields.join()){for(var s=t.bucket||{},i=e.bucket||{},a=0,n=t.byFields.length;n>a;a++){var r=t.byFields[a],o=s[r]||[],l=i[r]||[];if(o.length!==l.length||o.join()!==l.join())return!1}return!0}return!1}return!1},sensorsdata.GroupControl.clearValue=function(t){if(!t||$.isEmptyObject(t))return{};if(!$.isArray(t.byFields)||0===t.byFields.length)return{};if($.isEmptyObject(t.bucket))delete t.bucket;else{var e={};for(var s in t.bucket)t.bucket.hasOwnProperty(s)&&t.byFields.indexOf(s)>=0&&(e[s]=t.bucket[s]);t.bucket=e}return t};