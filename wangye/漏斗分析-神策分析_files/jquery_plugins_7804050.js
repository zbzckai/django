sensorsdata.EventDropdown=function(e,t){this.$container_=e,this.tplButton_=$("#tpl-segmentation-index-event-select").html(),this.tplTag_=$("#tpl-segmentation-index-event-select-tag").html(),this.option_={events:null,eventName:"",eventNames:[],nonSelectedText:sensorsdata.languages.get("请选择事件<!--{en}Please select events-->"),multiple:!1,virtualDisplay:!0,onChange:null,optConfirm:!1,onConfirmed:null,onDropdownShown:function(){},multiselectOption:{templates:{button:this.tplButton_},includeFilterClearBtn:!1,enableFiltering:!0,toggleClose:!1,maxHeight:500,nonSelectedText:sensorsdata.languages.get("请选择事件<!--{en}Please select events-->"),filterPlaceholder:sensorsdata.languages.get("筛选事件…<!--{en}Search-->"),filterBehavior:"both",enableCaseInsensitiveFiltering:!0}},$.isEmptyObject(t)||$.extend(!0,this.option_,t),this.methodQueue_=[],this.events_=this.option_.events||sensorsdata.cache.events,this.init_()},sensorsdata.EventDropdown.prototype.multiselect=function(e,t,n){var i=["setDisabled"];if(1===this.$container_.find("ul.multiselect-container").length){if(-1===i.indexOf(e)){var a=this.$container_.find("button");return this.$container_.find("select:first").multiselect(e,t,n),void("destroy"===e?this.$container_.html(a):this.updateButtonText_())}switch(e){case"setDisabled":var s=this.option_.multiple?"ul li a :checkbox":"ul li a :radio";this.$container_.find("ul li.disabled").removeClass("disabled"),this.$container_.find(s+"[disabled]").prop("disabled",!1);for(var r=0,o=t.length;o>r;r++){var d=this.$container_.find(s+'[value="'+t[r]+'"]');d.is(":checked")||d.attr("disabled",!!n).parents("li:first").toggleClass("disabled",!!n)}}}else switch(this.methodQueue_.push({method:e,vars:t,var1:n}),e){case"selectAll":var l=this.events_.map(function(e){return e.name});this.$container_.data("selected-event",l),this.updateButtonText_();break;case"updateButtonText":this.updateButtonText_();break;case"select":this.$container_.data("selected-event",t),this.updateButtonText_()}},sensorsdata.EventDropdown.prototype.updateButtonText_=function(){var e=this.$container_.data("selected-event"),t=this.option_.nonSelectedText,n=null;$.isArray(e)&&e.length>0?t=e.length===this.events_.length?sensorsdata.util.format(sensorsdata.languages.get("全选 (#{length})<!--{en}Select all(#{length})-->"),e):e.length+" "+sensorsdata.languages.get("个<!--{en}items-->"):e&&(n=this.events_.filter(function(t){return t.name===e})[0],$.isEmptyObject(n)||(t=n.cname)),t&&this.$container_.find("button:first").find("span:last").text(t)},sensorsdata.EventDropdown.prototype.init_=function(){var e=this,t=this.$container_.find("button:first");t.off("click").on("click",function(){var n=[];n.push(e.option_.multiple===!0?'<select class="btn-selector" multiple="multiple">':'<select class="btn-selector">');for(var i=0,a=e.events_.length;a>i;i++){var s=e.events_[i];n.push('<option value="'+s.name+'" title="'+s.cname+'" data-id="'+s.id+'">'+Mustache.escape(s.cname)+"</option>")}if(n.push("</select>"),t.remove(),e.$container_.append(n.join("")),e.initMultiSelect_(e.option_.eventName||e.option_.eventNames),e.methodQueue_.length>0)for(var r=0,o=e.methodQueue_.length;o>r;r++){var d=e.methodQueue_[r];e.multiselect(d.method,d.vars,d.var1)}}),this.$container_.data("selected-event",e.option_.eventName||e.option_.eventNames),this.updateButtonText_()},sensorsdata.EventDropdown.prototype.initMultiSelect_=function(e){var t=this,n=this.option_.multiselectOption.onChange||this.option_.onChange;this.option_.multiselectOption.onChange=function(e){if(t.option_.multiple===!0){var i=[];t.$container_.find("ul li a :checkbox:checked").each(function(e,t){"multiselect-all"!==$(t).val()&&i.push($(t).val())}),t.$container_.data("selected-event",i)}else t.$container_.data("selected-event",t.$container_.find("ul li a :radio:checked").val());$.isFunction(n)&&(e instanceof jQuery?n(e.val(),e):n())},this.option_.optConfirm&&(this.option_.multiselectOption.onDropdownShow=function(){this.$ul.after($("#tpl-event-dropdown-confirm").html()),this.$ul.next("div").css("width",this.$ul.outerWidth()),this.$ul.next("div").css("top",this.$ul.outerHeight()+t.$container_.find("button:first").outerHeight())},this.option_.multiselectOption.onDropdownHide=function(){this.$ul.next("div").remove()},this.option_.multiselectOption.onDropdownShown=function(){t.option_.onDropdownShown&&$.isFunction(t.option_.onDropdownShown)&&t.option_.onDropdownShown();var e=this.$select;this.$ul.next("div").off("click").on("click",function(n){var i=$(n.target||n.srcElement),a=i.attr("data-method"),s=t.$container_.data("selected-event");return"confirm"!==a?"cancel"===a?(e.multiselect("deselectAll"),e.multiselect("updateButtonText"),!0):!1:s.length?($.isFunction(t.option_.onConfirmed)&&t.option_.onConfirmed(s),e.multiselect("deselectAll"),e.multiselect("updateButtonText"),void 0):!0})});var i=this.$container_.find("select:first");this.option_.multiselectOption.numberDisplayed=this.option_.multiple?0:1,i.multiselect(this.option_.multiselectOption),e&&i.multiselect("select",e),sensorsdata.ajax({url:"tag",showLoader:!1,success:function(e){if(i.next("div").hasClass("open")||t.$container_.find("button:first").click(),$.isArray(e)&&0!==e.length){var n=t.option_.virtualDisplay?e:e.filter(function(e){return e.name!==sensorsdata.languages.get("虚拟事件<!--{en}Virtual event-->")}),a=$(Mustache.render(t.tplTag_,n));t.$container_.find("li.multiselect-item.filter").after(a),a.filter(".multiselect-item-event-tag, .multiselect-item-event-tag-split:last").hide(),a.filter(".multiselect-item-event-tag-title").off("click.sensorsdata-eventdropdown").on("click.sensorsdata-eventdropdown",sensorsdata.bind(t.clickTagTitle_,t)),a.filter(".multiselect-item-event-tag").off("click.sensorsdata-eventdropdown").on("click.sensorsdata-eventdropdown",sensorsdata.bind(t.clickTag_,t))}}})},sensorsdata.EventDropdown.prototype.clickTagTitle_=function(){var e=this,t=this.$container_.find(".multiselect-item-event-tag-title");return 1===t.find("span.icon-expand-down").size()?(t.find("span.icon-expand-down").removeClass("icon-expand-down").addClass("icon-collapse-up"),this.$container_.find(".multiselect-item-event-tag, .multiselect-item-event-tag-split:last").slideDown({complete:function(){var t=e.$container_.find("ul.multiselect-container");t.data("isSetWidth")||t.width(t.width()).data("isSetWidth",!0)}})):(t.find("span.icon-collapse-up").removeClass("icon-collapse-up").addClass("icon-expand-down"),this.$container_.find(".multiselect-item-event-tag, .multiselect-item-event-tag-split:last").slideUp()),!1},sensorsdata.EventDropdown.prototype.clickTag_=function(e){var t=this.$container_.find(".multiselect-item-event-tag-title span:nth-child(2)"),n=$(e.target||e.srcElement).closest("li");n.hasClass("selected")?n.removeClass("selected"):this.option_.multiple?n.addClass("selected"):n.addClass("selected").siblings().removeClass("selected");var i=[];if(this.$container_.find("li.multiselect-item-event-tag.selected").each(function(){i.push(parseInt($(this).find("span[data-value]").attr("data-value"),10))}),0===i.length)t.text(sensorsdata.languages.get("标签选择<!--{en}Select tag-->"));else if(1===i.length){var a=this.$container_.find("li.multiselect-item-event-tag.selected span[data-value]").text();t.text(a)}else i.length>1&&t.text(i.length+sensorsdata.languages.get("个<!--{en}items-->"));var s=this.$container_.find("li.multiselect-item:not(.multiselect-item-event-tag):not(.filter-hidden)");if(0===i.length)s.removeClass("event-tag-hidden");else{var r=[];(this.option_.events||sensorsdata.cache.events).map(function(e){var t=sensorsdata.util.intersection(i,e.tag);t.length>0&&r.push(e.name)}),s.find('input[type="radio"],input[type="checkbox"]').each(function(){var e=r.indexOf($(this).val())>=0;$(this).parents("li.multiselect-item").toggleClass("event-tag-hidden",!e)})}return!1},$.fn.eventDropdown=function(e,t,n){if("string"==typeof e){var i=$(this).data("eventDropdown");i&&i.multiselect(e,t,n)}else e=$.isEmptyObject(e)?{}:e,$(this).data("eventDropdown",new sensorsdata.EventDropdown($(this),e));return this},sensorsdata.Dropdown=function(e,t){this.$btn=e,this.$ul=e.next("ul:first");var n={value:void 0,onSelect:null,onSelected:null,changeText:!0};$.isFunction(t)?n.onSelected=t:$.isEmptyObject(t)||(this.options=$.extend(!0,n,t)),this.options=n,0===this.$ul.length&&n.tpl&&(this.$btn.parent().append(n.tpl),this.$ul=this.$btn.next("ul:first")),"string"==typeof n.value&&this.select(n.value);var i=this;this.$ul.unbind("click.sa-dropdown").bind("click.sa-dropdown",function(e){var t=$(e.target||e.srcElement),a=t.closest("a[data-value]");0!==a.size()&&(a.parent("li:first").hasClass("disabled")||a.parent("li:first").hasClass("active")||$.isFunction(n.onSelect)&&n.onSelect(t)===!1||(i.select(a.attr("data-value")),$.isFunction(n.onSelected)&&n.onSelected(a.attr("data-value"),t)))})},sensorsdata.Dropdown.prototype.select=function(e){var t=this.$ul.find('li a[data-value="'+e+'"]').parent();if(0===t.size())return!1;t.addClass("active").siblings().removeClass("active");var n=t.find("a:first"),i=n.data();this.options.changeText&&(1===this.$btn.find("span:first").length?this.$btn.find("span:first").text(n.text()):this.$btn.text(n.text()));for(var a in i)i.hasOwnProperty(a)&&this.$btn.data(a,i[a]).attr("data-"+a,i[a]);return!0},$.fn.saDropdown=function(e,t){return"select"===e&&$(this).data("saDropdown")?$(this).data("saDropdown").select(t):$(this).data("saDropdown",new sensorsdata.Dropdown($(this),e)),this},$.fn.measureExpression=function(e){var t={focusout:null};$.extend(!0,t,e);var n=/(\?)|(\:)|(\|\|)|(\|)|(\&\&)|(\&)|(==)|(\!=)|(<=)|(\>=)|(<)|(\>)|(\+)|(\-)|(\*)|(\/)|(\%)|(\!)|(\s)|(\{)|(\})|(\()|(\))|($[1-9])|(^[1-9]+\w+)|(？)|(：)|(！=)|(——)|(—)|(！)|(（)|(）)|(\[)|(\])/g,i=["+","-","*","/","(",")"," "],a=27,s=38,r=40,o=13,d=function(e){var t=[],n=sensorsdata.CONSTSET.measureFunctions;for(var i in n)n.hasOwnProperty(i)&&n[i].type===e&&"exit_rate"!==i&&t.push({name:i,cname:n[i].cname,pinyin:n[i].pinyin,pinyinNoBlank:n[i].pinyin.replace(/\W/g,""),type:e});return t},l=this,u=l.next(),c=d("event"),p=d("property"),h={},f=null,v=function(e){var t=l.val().substring(0,e),n=$('<span style="display:none;">'+t+"</span>").appendTo("body"),i=n.width()+parseInt(l.css("padding-left"),10);n.remove();var a=l.width();return a>i?i:a},m=function(e){var t={type:"",prefix:"",eventCName:"",propCName:"",startIndex:0,endIndex:0,expression:e.expression,expressionEndIndex:e.endIndex};if(!e.expression)return t.type="event",t.startIndex=e.startIndex,t.endIndex=e.endIndex,t;if(1===e.expression.split(".").length)return t.type="event",t.prefix=e.leftPart,t.startIndex=e.startIndex,t.endIndex=e.endIndex,t;var n=0;if(2===e.expression.split(".").length)return n=e.leftPart.indexOf("."),n>=0?(t.type="property",t.prefix=e.leftPart.substring(n+1),t.eventCName=e.leftPart.substring(0,n),t.startIndex=e.startIndex+n+1,t.endIndex=e.endIndex):(t.type="event",t.prefix=e.leftPart,t.startIndex=e.startIndex,t.endIndex=e.startIndex+e.leftPart.length+e.rightPart.indexOf(".")),t;if(3===e.expression.split(".").length){var i=e.leftPart.indexOf("."),a=e.leftPart.lastIndexOf("."),s=e.expression.substring(i+1,a);if(c.filter(function(e){return e.cname===s}).length>0)return t;var r=e.leftPart.split(".").length-1;0===r?(t.type="event",t.prefix=e.leftPart.substring(0,t.cursorStart),t.startIndex=e.startIndex,t.endIndex=e.startIndex+e.leftPart.length+e.rightPart.indexOf(".")):1===r?(n=e.leftPart.indexOf("."),t.type="property",t.prefix=e.leftPart.substring(n+1),t.eventCName=e.leftPart.substring(0,n),t.startIndex=e.startIndex+n+1,t.endIndex=e.startIndex+e.leftPart.length+e.rightPart.indexOf(".")):(t.type="aggregator",t.prefix=e.leftPart.substring(a+1),t.eventCName=e.leftPart.substring(0,i),t.propCName=e.leftPart.substring(i+1,a),t.startIndex=e.startIndex+e.leftPart.lastIndexOf(".")+1,t.endIndex=e.startIndex+e.expression.length)}return t},g=function(e,t){var n={expression:"",cursorStart:0,leftPart:"",rightPart:"",input:e,startIndex:0,endIndex:0};if(!e)return n;var a=0,s=e.length,r=0,o=0,d=[];for(r=0,o=e.length;o>r;r++)'"'===e[r]&&d.push(r);for(r=t-1;r>=0;r--)if(i.indexOf(e[r])>=0&&d.filter(function(e){return r>e}).length%2===0){a=r+1;break}for(r=t,o=e.length;o>r;r++)if(i.indexOf(e[r])>=0&&d.filter(function(e){return r>e}).length%2===0){s=r;break}return n.startIndex=a,n.endIndex=s,n.expression=e.substring(a,s),n.cursorStart=t-a,n.leftPart=n.expression.substring(0,n.cursorStart),n.rightPart=n.expression.substring(n.cursorStart),n},x=function(e){return new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("cname","pinyin","pinyinNoBlank","name"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:e})},b=function(e,t){var n=t.prefix.replace(/\"/g,""),i=function(e){if(u.data("suggestType",t).hide().html(""),0!==e.length&&(1!==e.length||e[0].cname!==n)){for(var i=[],a=0,s=e.length;s>a;a++){var r="<li"+(e[a].cname===n?' class="active"':"")+'><a data-value="'+e[a].cname+'">'+e[a].cname+"</a></li>";i.push(r),s>a+1&&e[a].type!==e[a+1].type&&i.push('<li class="divider"></li>')}var o=v(t.startIndex);u.html(i.join("")).css({left:o}).show().find("li").bind("mouseover",function(){$(this).addClass("hover")}).bind("mouseleave",function(){$(this).removeClass("hover")})}};n?e.search(n,i):i(e.local)},y=function(e){var t=l.val(),n=g(t,e);if(n.expression.split(".").length>4)return void u.hide();var i=m(n);if(!i.type)return u.hide(),void(h=i);if(i.type===h.type&&i.eventCName===h.eventCName&&i.propCName===h.propCName&&i.startIndex===h.startIndex&&i.endIndex===h.endIndex)return i.prefix===h.prefix?u.toggle(u.find("li").size()>0):b(f,i),void(h=i);var a=$.extend(!0,[],sensorsdata.cache.events);"ALL"===sensorsdata.authority.eventPermission.type&&a.unshift(sensorsdata.CONSTSET.everyEvent);var s=[];h=i;var r="";if("property"===i.type){if(r=sensorsdata.findEventName($.trim(i.eventCName.replace(/\"/g,"")),a),!r)return;return void sensorsdata.ajax({useCache:!0,url:"event/"+r+"/properties",success:function(e){s=c;var t=e.event.filter(function(e){return"number"===e.data_type&&e.is_measure===!0});s=s.concat(t.map(function(e){return{name:e.name,cname:e.cname,type:"property",pinyin:e.pinyin,pinyinNoBlank:e.pinyin.replace(/\W/g,"")}})),t=e.event.filter(function(e){return!("number"===e.data_type&&e.is_measure===!0)}),s=s.concat(t.map(function(e){return{name:e.name,cname:e.cname,type:"property",pinyin:e.pinyin,pinyinNoBlank:e.pinyin.replace(/\W/g,"")}})),f=x(s),b(f,i)}})}"event"===i.type?(s=a.map(function(e){return{name:e.name,cname:e.cname,type:"event",pinyin:e.pinyin,pinyinNoBlank:e.pinyin.replace(/\W/g,"")}}),f=x(s),b(f,i)):"aggregator"===i.type&&(r=sensorsdata.findEventName($.trim(i.eventCName.replace(/\"/g,"")),a),sensorsdata.ajax({useCache:!0,url:"event/"+r+"/properties",success:function(e){var t=e.event.filter(function(e){return e.cname===$.trim(i.propCName.replace(/\"/g,""))})[0];if(!$.isEmptyObject(t)){var n="number"===t.data_type&&t.is_measure===!0;s=n?p:p.filter(function(e){return"uniqCount"===e.name}),f=x(s),b(f,i)}}}))},_=function(){sensorsdata.ajax({url:"events/custom/indicator/transform",method:"POST",showLoader:!1,queueEnable:!0,showCommonError:!1,data:JSON.stringify([{expression:l.val(),format:""}]),error:function(e){var t=parseInt(e.status,10);400!==t||l.hasClass("error")||sensorsdata.form.addError(l,sensorsdata.languages.get("表达式不完整或不合法<!--{en}The expression is incomplete or illegal-->"),!0)},success:sensorsdata.bind(function(){sensorsdata.form.removeError(l)},this)})},k=function(e,t){e.match(n)&&(e='"'+e+'"');var i=l.val(),a=t.startIndex,s=t.endIndex,r=i.substring(0,a),o=i.substring(s),d=t.expression.split("."),u=a+e.length;if("event"===t.type)1===d.length?(e+=".",u=a+e.length):u=a+e.length+1;else if("property"===t.type){var p=c.filter(function(t){return t.cname===e});2===d.length?(0===p.length&&(e+="."),u=a+e.length):0===p.length?u=a+e.length+1:(o=i.substring(t.expressionEndIndex),u=a+e.length)}var h=r+e+o;if(l.val(h).focus(),l[0].setSelectionRange)l[0].setSelectionRange(u,u);else if(l[0].createTextRange){var f=l[0].createTextRange();f.collapse(!0),f.moveEnd("character",u),f.moveStart("character",u),f.select()}y(u),_()};return l.unbind("keyup.measure-expression").bind("keyup.measure-expression",function(e){var t=e.which||e.keyCode;if(t!==a&&t!==s&&t!==r&&t!==o){var n=l.val();n.indexOf("。")===n.length-1&&l.val(n.replace("。",".")),_(),y(this.selectionStart)}}),l.unbind("click.measure-expression").bind("click.measure-expression",function(){$(this).prop("readonly")||y(this.selectionStart)}),l.unbind("focusout.measure-expression").bind("focusout.measure-expression",function(e){u.data("isFocusout",!0),setTimeout(function(){u.data("isFocusout")&&(u.hide(),$.isFunction(t.focusout)&&t.focusout(e))},200)}),l.unbind("keydown.measure-expression").bind("keydown.measure-expression",function(e){var t=e.which||e.keyCode,n=u.find("li.active");switch(t){case a:u.hide();break;case o:if(u.is(":visible")){var i=n.find("a").text();i&&(u.hide(),k(i,u.data("suggestType")))}break;case s:if(u.is(":visible"))if(1===n.size()){n.removeClass("active");var d=n.prev();d.hasClass("divider")&&(d=d.prev()),1===d.size()&&d.addClass("active")}else u.find("li:last").addClass("active");return!1;case r:if(u.is(":visible"))if(1===n.size()){n.removeClass("active");var l=n.next();l.hasClass("divider")&&(l=l.next()),1===l.size()&&l.addClass("active")}else u.find("li:first").addClass("active");return!1}}),u.unbind("click.measure-expression").bind("click.measure-expression",function(e){var t=$(e.target||e.srcElement),n=t.attr("data-value");n&&(u.data("isFocusout",!1),t.parents("li:first").addClass("active").siblings().removeClass("active"),k(n,u.data("suggestType")))}),this},$.fn.bucketPopover=function(e){var t={dataType:"",hasDict:!1,property:{},discreteItemDisplay:!0,value:[]},n=this;$.extend(!0,t,e),t.value=$.isArray(t.value)?1!==t.value.length||$.isNumeric(t.value[0])?2===t.value.length?t.value.filter(function(e){return $.isNumeric(e)}).map(function(e){return e-0}):t.value.filter(function(e){return $.isNumeric(e)}).map(function(e){return e-0}).sort(function(e,t){return e-t}):[null]:[];var i=!0;if($.isEmptyObject(t.property)?i="number"===t.dataType&&!t.hasDict||"date"===t.dataType||"datetime"===t.dataType:(i="number"===t.property.data_type&&t.property.has_dict!==!0||"date"===t.property.data_type||"datetime"===t.property.data_type,t.dataType=t.property.data_type),this.toggle(i),i!==!0)return n.data("bucket-value",[]),n.data("bucket-popover-save-callback",""),n.attr("data-bucket-type",""),this;var a="";0===t.value.length?a="default":1!==t.value.length||$.isNumeric(t.value[0])?a="custom":(t.value=[null],a="discrete"),n.data("bucket-value",t.value),n.data("bucket-popover-save-callback",t.saveCallback),n.attr("data-bucket-type",a);var s=!!this.attr("data-bucket-popover"),r=[];if(t.value.length>0){var o=t.value.length,d=o>=2;r.push({index:1,min:!0,end:t.value[0]});for(var l=1;o>l;l++)r.push({index:r.length+1,begin:t.value[l-1],end:t.value[l]});r.push({index:r.length+1,max:!0,begin:t.value[o-1],showRemove:d})}else r=[{index:1,min:!0,end:""},{index:2,max:!0,begin:""}];for(var u="data-bucket-popover-"+moment().unix()+"-"+Math.round(1e6*Math.random()),c="number"===t.dataType,p=$(Mustache.render($("#tpl-bucket-dialog-content").html(),{popName:u,isNumber:c,isDatetime:"datetime"===t.dataType,discreteItemDisplay:t.discreteItemDisplay,isDefault:"default"===a,isDiscete:"discrete"===a,isCustom:"custom"===a,isHour:!c&&0===t.value[0],isDay:!c&&1===t.value[0],isWeek:!c&&2===t.value[0],isMonth:!c&&3===t.value[0],isMinute:!c&&4===t.value[0],isQuarter:!c&&6===t.value[0],isYear:!c&&5===t.value[0],isAggregate:!c&&1===t.value[1]})),h=$("#tpl-bucket-dialog-custom-item").html(),f=0,v=r.length;v>f;f++)p.find("div#bucket-range-container").append(Mustache.render(h,r[f]));p.find('button[data-toggle="dropdown"]').each(function(e,n){$(n).saDropdown({value:t.value[0]+""})}),p.find("label[data-method]").unbind("click.aggregate").bind("click.aggregate",function(){var e=$(this).next("div").find('button[data-toggle="dropdown"]');e.attr("disabled")?e.removeAttr("disabled"):$(this).parent("div:first").siblings("div").find('button[data-toggle="dropdown"]').prop("disabled","disabled")});var m=function(e){var t=$(e.target||e.srcElement),n=t.val();t.parents('div[data-method="bucket-line"]').next().find('input[type="text"][disabled]').val(n)};if(p.find('div#bucket-range-container input[type="text"]:not("[disabled]")').bind("keyup",m),s)return n.data("bs.popover").options.content=p,n.data("bs.popover").setContent(),this;var g=$($("#tpl-bucket-dialog").html());return this.popover("destroy").popover({trigger:"click",content:p,template:g,html:!0,placement:"auto top",container:"body"}),g.unbind("click").bind("click",sensorsdata.bind(function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]"));var i=t.attr("data-method"),a=n.data("bs.popover").getContent(),s=a.find("div#bucket-range-container"),r=s.find('div[data-method="bucket-line"]'),o=r.size(),d=r.eq(o-1),l=d.find('button[data-method="bucket-remove"]'),u=a.find("input:visible:radio:checked"),c=u.val(),p=a.find('button[data-toggle="dropdown"]:not(:disabled)');switch(i){case"save":var f=[];if("custom"===c){for(var v=r.find('input[type="text"]'),g=0,x=v.size();x>g;g++){var b=v.eq(g).val();if(!$.trim(b)||!$.isNumeric(b))return void sensorsdata.form.addError(v.eq(g),sensorsdata.languages.get("请输入正确的数字<!--{en}Please enter the correct number-->"),!0,{container:a.find("#bucket-range-container"),placement:"top"});sensorsdata.form.removeError(v.eq(g))}a.find("div.alert-danger").hide(),r.find('input[type="text"]').not("[disabled]").each(function(e,t){f.push(Number($(t).val()))}),f.sort(function(e,t){return e-t})}else"discrete"===c?f=[null]:$.isNumeric(p.attr("data-value"))?(f.push(parseInt(p.attr("data-value"),10)),"is-aggregate"===c&&f.push(1)):"discrete"===p.attr("data-value")&&(f=[null]);n.data("bucket-value",f);var y=this.data("bucket-popover-save-callback");$.isFunction(y)&&y(f),n.popover("hide");break;case"cancel":n.popover("hide");break;case"bucket-date-radio":n.attr("data-bucket-type",c);break;case"bucket-number-radio":n.attr("data-bucket-type",c),"custom"!==c?(s.hide(),a.find('button[data-method="bucket-add"]').hide()):(s.show(),s.find('input[type="text"]:not([disabled]):first').focus(),a.find('button[data-method="bucket-add"]').show());break;case"bucket-add":var _=$(Mustache.render(h,{index:o,begin:d.find('input[type="text"]:first').val()}));_.bind("keyup",m),d.before(_),d.find('[data-method="title"]').html(sensorsdata.languages.get("区间<!--{en}range-->")+(o+1)+"："),d.find('input[type="text"]:first').val(""),o>=2?l.show():l.hide(),s.find('input[type="text"]:not([disabled]):last').focus();break;case"bucket-remove":var k=r.eq(o-2).remove(),w=k.find('input[type="text"]:first').val();d.find('[data-method="title"]').html(sensorsdata.languages.get("区间<!--{en}range-->")+(o-1)+"："),d.find('input[type="text"]:first').val(w),o-1>=3?l.show():l.hide()}},this)),$("body").unbind("click."+u).bind("click."+u,function(e){var t=$(e.target||e.srcElement),i=n.data();if(i){var a=i["bs.popover"],s="";a&&a.$tip&&a.$tip.is(jQuery)&&(s=a.$tip.attr("id")),!t.is(n)&&s&&0===t.parents('div[id="'+s+'"]').size()&&n.popover("hide")}}),this.attr("data-bucket-popover",u),this},$.fn.fixedColumn=function(e){return e=e||{},$.fn.fixedColumn.$passing||($.fn.fixedColumn.$passing=!0,$(window).resize(function(){$(".__div_fixed_column").each(function(){var e=$(this).data("target");if(e){var t=$(this).data("width"),n=$(e).find("th:first-child").outerWidth();n>t?$(this).hide():$(this).show()}})})),$(this).each(function(){var t=e.parent||$(this).parent(),n="undefined"==typeof e.removes?4:e.removes,i=$('<div class="__div_fixed_column"></div>').appendTo(t),a=$(this).clone();n&&a.find("td:nth-of-type(n+"+n+"),th:nth-of-type(n+ "+n+")").remove();var s=$(this).find("th:first-child").outerWidth();i.data("target",this).append(a).css({position:"absolute",top:0,overflow:"hidden",width:s});var r=a.find("th:first-child").outerWidth();/Firefox/i.test(navigator.userAgent)&&($(t).css({position:"static"}),i.css({left:$(t)[0].getBoundingClientRect().left-$(t)[0].parentNode.getBoundingClientRect().left})),i.data("width",r).css({width:r+1}),s>r&&i.hide()})},$.fn.fixedHeader=function(e){var t;return t={topOffset:40},e&&$.extend(t,e),this.each(function(){var e,n,i,a,s,r,o;r=function(){var i,a,r,o,d;if(s.is(":visible"))return a=void 0,o=n.scrollTop(),d=e.length&&e.offset().top-t.topOffset,r||i===d||(i=d),o>=i&&!r?r=1:i>=o&&r&&(r=0),r?$("thead.header-copy",s).removeClass("hide"):$("thead.header-copy",s).addClass("hide")},s=$(this),n=$(window),e=$("thead.header",s),a=0,i=e.length&&e.offset().top-t.topOffset,n.on("scroll",r),e.clone().removeClass("header").addClass("header-copy header-fixed").appendTo(s);var d=function(){o=[],s.find("thead.header > tr:first > th").each(function(e,t){return o.push($(t).outerWidth())}),$.each(o,function(e,t){return s.find("thead.header-copy > tr > th:eq("+e+")").css({width:t})}),s.find("thead.header-copy").css({margin:"0 auto",width:s.outerWidth()-1})};return d(),n.off("resize.fixed-header").on("resize.fixed-header",function(){d()}),r()})};