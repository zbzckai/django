var urlNoDashboard={"/behavior-path/":!0,"/interval/":!0};sensorsdata.DashboardList=function(){this.tpl=$("#tpl_dashboard_sidebar").html(),this.ele=$("#sa_dashboard_list_out"),this.outEle=$("#sa_sidebar"),this.clickBtn=this.outEle.find(".sa-sidebar-dashboard-add"),this.dashboards=[],this.initDashboardTemplate(),this.init()},sensorsdata.DashboardList.prototype={constructor:sensorsdata.DashboardList,remove:function(a){this.outEle.find('[data-nav="/dashboard/#dashid='+a+'"]').remove();for(var t=0,e=this.dashboards.length;e>t;t++)if(this.dashboards[t].id===a){this.dashboards.splice(t,1);break}},checkId:function(a){var t=null;return a&&(a=parseInt(a,10),t=this.dashboards.filter(function(t){return t.id===a})[0]),t?a:(a=this.outEle.find('.sidebar-links li[data-nav*="/dashboard/"]:first').attr("data-dashid"),a?parseInt(a,10):0)},sortShare:function(){var a=[],t=[];$.each(this.dashboards,function(e,s){s.user_id===sensorsdata.authority.userId?a.push(s):t.push(s)}),this.dashboards=a.concat(t);var e=this,s=[];return sensorsdata.authority.getSetting(function(a){if($.isArray(a.dashboards)){var t=$.extend(!0,[],e.dashboards);$.each(a.dashboards,function(a,e){var o=t.filter(function(a){return String(a.id)===String(e)});1===o.length&&(s.push(o[0]),delete t[t.indexOf(o[0])])}),e.dashboards=s.concat(t.filter(function(a){return a}));var o=e.dashboards.map(function(a){return a.id});sensorsdata.authority.updateSetting({dashboards:o})}})},renderEmptyView:function(){sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst?($("#sa-main").html(Mustache.render($("#tpl_dashboard_empty_state").html(),{value:sensorsdata.languages.get("您暂时还没有创建数据概览，请在左侧数据概览处添加<!--{en}You have not created a data overview.Please add at the data overview on the left.-->")})),$("#sa-main .dashboard-blank-slate").show()):($("#sa-main").html(Mustache.render($("#tpl_dashboard_empty_state").html(),{value:sensorsdata.languages.get("您暂时还没有数据概览，请联系管理员共享<!--{en}You don't have a data overview. Please contact with the administrator.-->")})),$("#sa_sidebar").html(""),$("#sa-main .dashboard-blank-slate").show())},addDashboard:function(a){var t={success:!0,operation_type:sensorsdata.languages.get("新建<!--{en}New-->")},e=this;sensorsdata.ajax({url:"dashboards",type:"post",contentType:"application/json",data:JSON.stringify({name:a}),error:function(a){t.success=!1,t.fail_reason=a.status,sensorsdata.track("dashboard_operation",t)},success:function(a){sensorsdata.track("dashboard_operation",t),"object"===$.type(a)&&a.id&&e.loadView(a.id)}})},switchNavView:function(){var a=[];this.ele.find(">li[data-nav]").each(function(t,e){a.push($(e).attr("data-dashid"))}),sensorsdata.authority.updateSetting({dashboards:a})},initDashboardTemplate:function(){var a=this;sensorsdata.ajax({url:"dashboard/import/all",success:function(t){a.dashboardTemplateList_=t,$.isEmptyObject(a.dashboardTemplateList_)||a.initDashboardTemplatePropertyList()}})},initDashboardTemplatePropertyList:function(){var a=this,t=function(a,t){Object.keys(t).map(function(e){var s=t[e],o=s.data_type;a[o]||(a[o]={}),a[o][s.name]||(a[o][s.name]=s)}),$.map(a,function(t,e){a[e]=Object.keys(t).map(function(a){return t[a]})})};a.dashboardTemplateProperties={EVENT_PROPERY:{},PROFILE_PROPERTY:{}},sensorsdata.ajax({url:"property/all",success:function(e){var s=a.dashboardTemplateProperties.EVENT_PROPERY;t(s,e)}}),sensorsdata.ajax({url:"property/user/properties",success:function(e){var s=a.dashboardTemplateProperties.PROFILE_PROPERTY;t(s,e)}})},initDashboardTemplateConf:function(a){var t=this,e=$("#sa_dashboard_template_list_select").val();sensorsdata.ajax({url:"dashboard/import_conf/"+e,success:function(e){var s=1,o=function(){return s++},r=function(){return s===e.length+1},i={orders:e,idx:o,is_last_order:r};Object.keys(e).map(function(a){Object.keys(e[a]).map(function(s){var o=e[a][s];o.is_select=!0,"CONSTANT"===o.type?(o.is_select=!1,o.is_number="number"===o.data_type.toLowerCase(),o.is_text="string"===o.data_type.toLowerCase()):o.choices="EVENT"===o.type?sensorsdata.cache.events:t.dashboardTemplateProperties[o.type][o.data_type.toLowerCase()]})}),a.find(".template-conf").html(Mustache.render($("#tpl_dashboard_import_popover_table").html(),i)),a.find(".import_conf_select").multiselect({includeFilterClearBtn:!1,enableFiltering:!0})}})},initDashboardTemplateList:function(a){var t=this,e=a.find(".dashboard-template");if(!$.isEmptyObject(t.dashboardTemplateList_)){var s=function(){e.is(":visible")?(a.find(".icon-expand-down-single").hide(),a.find(".icon-collapse-up-single").show()):(a.find(".icon-collapse-up-single").hide(),a.find(".icon-expand-down-single").show())};a.find(".pop-is-template").show(),s(),a.find(".pop-is-template").unbind("click").bind("click",function(){e.is(":visible")||t.initDashboardTemplateConf(e),e.toggle(),s()}),a.find(".template-list").html(Mustache.render($("#tpl_dashboard_import_list").html(),t.dashboardTemplateList_)),$("#sa_dashboard_template_list_select").multiselect({includeFilterClearBtn:!1,enableFiltering:!0,onChange:sensorsdata.bind(function(){t.initDashboardTemplateConf(e)},$("#sa_dashboard_template_list_select"))})}},importDashboardTemplate:function(a,t){for(var e=this,s={},o=t.find(".import_conf_value"),r=0;r!==o.length;r++){if(""===$(o[r]).val())return void sensorsdata.form.addError($(o[r]),sensorsdata.languages.get("请输入模板参数<!--{en}Please enter template parameters-->"),!0,{container:t.find(".popover"),trigger:"hover",placement:"top"});s[$(o[r]).attr("data-name")]=$(o[r]).val()}var i={name:a,kv:s},n=$("#sa_dashboard_template_list_select").val();sensorsdata.ajax({method:"POST",data:JSON.stringify(i),showCommonError:!0,url:"dashboard/import/"+n,success:function(a){return 0===a.error.length?(e.loadView(a.id),void t.find(".popover").hide()):void a.error.map(function(e){var s;s=$("name"===e?"#sa_dashboard_edit_input":"#dashboard_import_"+e),sensorsdata.form.addError(s,a.err_msg,!0,{container:t.find(".popover"),trigger:"hover",placement:"top"})})}})},initEvents_:function(){var a=this;sensorsdata.popover({title:function(){return sensorsdata.languages.get("创建新的概览<!--{en}Create New Dashboard-->")},content:function(){return sensorsdata.languages.replace('<span>名称：<!--{en}Name--></span><input type="text" placeholder="请输入数据概览名称" data-lang-placeholder="<!--{en}Name of the Dashboard-->" value="" id="sa_dashboard_edit_input"/>')},ele:this.clickBtn,placement:"bottom",template:sensorsdata.languages.replace($("#tpl_dashboard_import_popover").html()),onShow:function(){var t=$(this.container);sensorsdata.form.removeChildrenError(t),$("#sa_dashboard_edit_input").focus(),a.initDashboardTemplateList(t),t.find(".pop-is-success").unbind("click").bind("click",function(){sensorsdata.form.removeChildrenError(t);var e=$("#sa_dashboard_edit_input"),s=$.trim(e.val());return""===s?void sensorsdata.form.addError(e,sensorsdata.languages.get("请输入数据概览的名称<!--{en}Input dashboard name-->"),!0,{container:t.find(".popover"),placement:"top"}):void(t.find(".dashboard-template").is(":visible")?a.importDashboardTemplate(s,t):(a.addDashboard(s),t.find("popover").hide()))})}}),this.outEle.find(".icon-collapse-right").parent().next("ul").hide();var t=this.ele.get(0);Sortable.create(t,{onSort:function(){a.switchNavView()},animation:200,draggable:".g-drag-sort"})},loadView:function(a){var t=this;return sensorsdata.ajax({url:"dashboards",success:function(a){t.dashboards=a||[]}}).then(function(){return t.dashboards.length>0?t.sortShare():(t.renderEmptyView(),$.Deferred().resolve())}).then(function(){t.ele.html(Mustache.render(t.tpl,{glist:t.dashboards,isShare:function(){return this.user_id!==sensorsdata.authority.userId}})),t.ele.width()<50&&t.ele.find("a[title]").tooltip({container:"body",placement:"right"}),a&&t.ele.find('li[data-nav="/dashboard/#dashid='+a+'"]').trigger("click")})},init:function(){this.initEvents_()}},sensorsdata.DemoDataImport=function(){this.btnModal=$("#btn_demo_data_import"),this.modalLayer=$("#modal_data_import_layer"),this.modalTel=this.modalLayer.find(".data-import-layer-no-tel"),this.modalHasTel=this.modalLayer.find(".data-import-layer-has-tel"),this.modalSubmit=this.modalLayer.find("data-import-submit"),this.modalInputTel=this.modalLayer.find('input[type="tel"]'),this.elePcNewBtn=$("#sa-head-data-import-tip"),this.elePhoneNewBtn=$("#sa-head-data-import-tip-phone"),this.modalBodys=this.modalLayer.find(".modal-body"),this.getDemoName()},sensorsdata.DemoDataImport.prototype.getDemoName=function(){var a=window.location.host.match(/[^\.]*demo[^\.]*/),t=this;a&&a[0]&&sensorsdata.ajax({url:"/apply?check=true",showCommonError:!1,data:{username:sensorsdata.authority.userName},success:function(a){a.apply!==!0&&t.showBtn()}})},sensorsdata.DemoDataImport.prototype.showTel=function(a){a?(this.modalTel.hide(),this.modalHasTel.show()):(this.modalTel.show(),this.modalHasTel.hide()),this.modalLayer.modal()},sensorsdata.DemoDataImport.prototype.confirmSubmit=function(){var a=this,t={username:sensorsdata.authority.userName},e=this.modalInputTel.val();if(this.modalTel.is(":visible")){if(!/^1\d{10}$/.test(e))return sensorsdata.error.show(sensorsdata.languages.get("请输入正确的手机号码<!--{en}Please enter the correct cell phone number-->")),!1;t.tel=e}sensorsdata.ajax({url:"/apply",type:"post",showCommonError:!1,data:JSON.stringify(t),success:function(){a.modalBodys.eq(0).hide(),a.modalBodys.eq(1).show(),$(document.body).removeClass("sa-need-show-import-btn")},error:function(){sensorsdata.error.show(sensorsdata.languages.get("网络出错，请联系管理员<!--{en}Network error.Please contact the administrator.-->")),a.modalLayer.modal("hide")}})},sensorsdata.DemoDataImport.prototype.showBtn=function(){$(document.body).addClass("sa-need-show-import-btn"),this.elePcNewBtn.show()},sensorsdata.BookMarkList=function(a){this.eleMain=$("#bookmarkshow_out"),this.clickEleBtn=$("#bookmark_list_btn"),this.splitSymbol="-_-",this.ajaxData={},this.initPage=a,this.init()},sensorsdata.BookMarkList.prototype={init:function(){this.events()},events:function(){var a=this;this.clickEleBtn.click(function(){a.eleMain.is(":visible")?a.hideView():a.showView()}),this.eleMain.on("click",".bookmarkshow-main li",function(){var t=$(this).attr("data-position").split(a.splitSymbol),e=a.ajaxData[t[0]][t[1]];a.presentChart(e),a.hideView(),$("#sidebar-toggle").is(":visible")&&$("#sa_sidebar, #sa_head_nav, #sa-main, #sa-head-data-import-tip-phone").removeClass("shown")}).on("click",".bookmarkshow-sec .bookmarkshow-sec-right-edit",function(t){a.eleMain.find(".bookmarkshow-sec-right-edit").not($(this)).popover("hide"),t.stopPropagation();var e=$(this).closest("li"),s=e.attr("data-position").split(a.splitSymbol),o=a.ajaxData[s[0]][s[1]];a.bookmarkedit=new sensorsdata.BookmarkSave({saveBarDisplay:!1,deleteButtonDisplay:!0,dialogAttachElement:$(this),dialogContainer:".bookmarkshow-main",dialogViewport:"#bookmarkshow_out",bookmarkId:o.id,dashboardDisplay:!urlNoDashboard[s[0]],onBookmarkDeleted:function(){e.remove(),a.hideView()},onBookmarkUpdated:function(t){"object"!=typeof t||$.isEmptyObject(t)?sensorsdata.log(sensorsdata.languages.get("编辑书签返回数据有错误<!--{en}Return data of editing the bookmark is error-->")):(a.ajaxData[s[0]][s[1]]=t,a.renderView(a.ajaxData))}}),a.bookmarkedit.show()})},renderView:function(a){function t(a){var t=[];return $.each(a,function(a,s){var o={};o.glistHeader=sensorsdata.CONSTSET.urlMap[a],o.glistType=sensorsdata.CONSTSET.urlMapOrder[a],o.glistRows=s,t.push(o),$.each(s,function(t,s){s.timeFix=sensorsdata.BookmarkSave.buildTimeText(s),s.gposition=a+e.splitSymbol+t})}),t=sensorsdata.seniorSort(t,"glistType").reverse(),{glist:t}}var e=this,s=Mustache.render($("#tpl_bookmarkshow_out").html(),t(a));this.eleMain.html(s)},renderEmptyView:function(){var a=Mustache.render($("#tpl_bookmarkshow_out").html(),{nobookmark:!0});this.eleMain.html(a)},showView:function(){var a=this;sensorsdata.showFloatLayer({floatEle:a.eleMain,clickEleBtn:a.clickEleBtn,unCloseClass:["daterangepicker"],onLoad:function(){var t=$("#sa_sidebar").width();a.eleMain.removeClass("bookmarkshow-out-shown").css({left:t-320}),a.eleMain.show().animate({left:t},300,function(){a.eleMain.addClass("bookmarkshow-out-shown").attr("style","display:block")})},onClose:function(){a.hideView()}}),sensorsdata.ajax({url:"bookmarks/all",success:function(t){"object"!=typeof t||$.isEmptyObject(t)?(sensorsdata.log(sensorsdata.languages.get("书签数据为空<!--{en}Bookmark data is null-->")),a.renderEmptyView()):a.renderView(t),a.ajaxData=t}})},hideView:function(){$("#bookmark_list_btn.active").removeClass("active"),this.bookmarkedit&&this.bookmarkedit.close(),this.eleMain.animate({left:-320},200,function(){$(this).hide()})},presentChart:function(a){if(a){var t=JSON.parse(a.data);t[sensorsdata.CONSTSET.bookmarkId]=a.id,this.initPage(a.type+"#"+$.param(t))}else sensorsdata.log(sensorsdata.languages.get("错误的bookmark数据<!--{en}Error bookmark data-->"),a)}};