sensorsdata.DashboardEmailConfig=function(e){$("div.sa-email-config").remove(),this.dashId_=parseInt(e,10),this.$modal_=$($("#tpl-email-config").html()),this.tplSaDropdownItem_=$("#tpl-sa-dropdown-item").html(),this.tplSelectOption_=$("#tpl-select-option").html(),this.$list_=this.$modal_.find(".sa-col-wrap .col-left ul"),this.$save_=this.$modal_.find('button[data-method="save"]'),this.$btnAdd_=this.$modal_.find("#btnAddScheduler"),this.$btnAddSmtp_=this.$modal_.find("#btnAddSmtp"),this.$btnEditSmtp_=this.$modal_.find("#btnEditSmtp"),this.$receiver_=this.$modal_.find("#receiver"),this.$sendUnit_=this.$modal_.find("#send-time-unit"),this.$sendWeek_=this.$modal_.find("#send-time-week"),this.$sendMonth_=this.$modal_.find("#send-time-month"),this.$sendHour_=this.$modal_.find("#send-time-hour"),this.$baseTime_=this.$modal_.find("#base-time"),this.$withPdf_=this.$modal_.find("#with-pdf"),this.defaultSubject_="${dashboard_name}-${date}",this.defaultHourSubject_="${dashboard_name}-${date} ${hour}点",this.schedulers_=[],this.activeScheduler_={},this.smtpList_=[],this.init_()},sensorsdata.DashboardEmailConfig.prototype.modal=function(){var e=this;sensorsdata.ajax({url:"email/smtp_config",success:function(t){e.smtpList_=t||[]}}).then(function(){sensorsdata.ajax({url:"email/report",success:function(t){$.isArray(t)&&t.length>0&&(e.schedulers_=[],t.map(function(t){t.dashboard_id===e.dashId_&&(t=$.extend(!0,{},t),t.to_list=JSON.parse(t.to_list)||[],t.scheduler_cron=JSON.parse(t.scheduler_cron)||[],e.schedulers_.push(t))})),e.render_(),e.$modal_.modal({backdrop:"static",keyboard:!1})}})})},sensorsdata.DashboardEmailConfig.prototype.destroy=function(){this.$modal_.remove()},sensorsdata.DashboardEmailConfig.prototype.init_=function(){this.initEvents_()},sensorsdata.DashboardEmailConfig.prototype.buildEmptyScheduler_=function(){var e=["0","0",moment().add(1,"hour").hours().toString(),"?","*","","*"];return{id:-1,name:"新建任务",dashboard_id:this.dashId_,dashboard_url:window.location.href,subject:"",to_list:[],with_pdf:!1,with_image:!0,deviation:0,scheduler_cron:[e.join(" ")]}},sensorsdata.DashboardEmailConfig.prototype.render_=function(){this.renderList_(),this.renderConfig_();for(var e=[],t=[],s=moment().startOf("day");e.length<=23;)e.push({value:s.hours(),name:s.format("HH:mm")}),s.add(1,"hour"),t.length<23&&t.push({value:s.hours(),name:sensorsdata.util.format(sensorsdata.languages.get("发送前 #{hours} 小时<!--{en}#{hours} hours before sending -->"),{hours:s.hours()})});this.$sendHour_.next().html(Mustache.render(this.tplSaDropdownItem_,e)),this.$sendHour_.saDropdown({onSelected:function(){a.checkInputs_(!1)}}),this.$baseTime_.next().append(Mustache.render(this.tplSaDropdownItem_,t)),this.$baseTime_.saDropdown({onSelected:function(){a.checkInputs_(!1)}});var a=this;for(this.$sendWeek_.multiselect("destroy").multiselect({nSelectedText:sensorsdata.languages.get("天<!--{en}Day-->"),includeFilterClearBtn:!1,enableCaseInsensitiveFiltering:!1,maxHeight:230,onChange:function(){a.$sendWeek_.next().find("ul :checkbox:checked").length>0&&sensorsdata.form.removeError(a.$sendWeek_.next().find("button")),a.checkInputs_(!1)}}),e=[];e.length<31;)e.push({name:e.length+1+sensorsdata.languages.get("日<!--{en}day-->"),value:e.length+1});this.$sendMonth_.html(Mustache.render(this.tplSelectOption_,e)),this.$sendMonth_.multiselect("destroy").multiselect({nSelectedText:sensorsdata.languages.get("天<!--{en}Day-->"),includeFilterClearBtn:!1,enableCaseInsensitiveFiltering:!1,maxHeight:230,onChange:function(){a.checkInputs_(!1)}}),this.renderDetail_(this.schedulers_[0]),this.$modal_.find('[data-toggle="tooltip"]').tooltip({container:this.$modal_})},sensorsdata.DashboardEmailConfig.prototype.renderConfig_=function(){var e=this.smtpList_[0];this.$btnAddSmtp_.toggle(!e),this.$btnEditSmtp_.toggle(!!e),e&&this.$btnEditSmtp_.data("config-id",e.id).find("span:first").text(e.from)},sensorsdata.DashboardEmailConfig.prototype.initEvents_=function(){var e=this;this.$btnAdd_.off("click").on("click",function(){e.renderDetail_()}),this.$btnAddSmtp_.off("click").on("click",sensorsdata.bind(this.editSmtpConfig_,this)),this.$btnEditSmtp_.off("click").on("click",sensorsdata.bind(this.editSmtpConfig_,this)),this.$modal_.find("#subject").off("input propertychange").on("input propertychange",function(){e.checkInputs_(!1)}),this.$modal_.find("textarea").off("input propertychange").on("input propertychange",function(){e.checkInputs_(!1)}),this.$modal_.find("#with-pdf").off("change").on("change",function(){e.checkInputs_(!1)}),this.$list_.off("click","li").on("click","li",function(){var t=$(this);if(!t.hasClass("active")){var s=parseInt(t.find("a").attr("data-value"),10);e.renderDetail_(e.schedulers_.filter(function(e){return e.id===s})[0])}}),this.$modal_.find('button[data-method="delete"]').off("click").on("click",function(){var t=e.activeScheduler_.id;return-1===t?(e.$list_.find('a[data-value="'+t+'"]').parent().remove(),void e.renderDetail_(e.schedulers_[0])):void sensorsdata.ajax({method:"DELETE",url:"email/report/"+t,success:function(){e.$list_.find('a[data-value="'+t+'"]').parent().remove();for(var s=0,a=e.schedulers_.length;a>s;s++)if(e.schedulers_[s].id===t){e.schedulers_.splice(s,1);break}e.renderDetail_(e.schedulers_[0])}})}),this.$save_.off("click").on("click",function(){var t=e.buildScheduler_();if(!$.isEmptyObject(t)){var s=$(this),a=e.activeScheduler_.id;sensorsdata.ajax({method:"POST",url:"email/report"+(a>-1?"/"+a:""),data:e.convertAjaxParam_(t),success:function(n){if(e.activeScheduler_=t,!$.isEmptyObject(n)&&n.id)-1===a&&(e.activeScheduler_.id=n.id,e.$list_.find('a[data-value="-1"]').attr("data-value",n.id).text(e.activeScheduler_.name),e.schedulers_.push(e.activeScheduler_));else{e.$list_.find('a[data-value="'+a+'"]').text(e.activeScheduler_.name);for(var i=0,o=e.schedulers_.length;o>i;i++)e.schedulers_[i].id===a&&(e.schedulers_[i]=t)}e.$btnAdd_.prop("disabled",!1),s.text(sensorsdata.languages.get("已保存<!--{en}Already saved-->")).prop("disabled",!0)}})}}),this.$modal_.find("#btnTest").off("click").on("click",function(){return e.testEmail_(),!1})},sensorsdata.DashboardEmailConfig.prototype.convertAjaxParam_=function(e){var t=$.extend(!0,{},e);return-1===t.id&&delete t.id,t.to_list=JSON.stringify(t.to_list),t.scheduler_cron=JSON.stringify(t.scheduler_cron),JSON.stringify(t)},sensorsdata.DashboardEmailConfig.prototype.buildScheduler_=function(e){var t=$.extend(!0,{},this.activeScheduler_),s=this.$modal_.find("#subject");t.name=this.$sendUnit_.text()+this.$sendWeek_.next().find("button:visible span").text()+this.$sendHour_.text(),t.dashboard_id=this.dashId_,t.dashboard_url=window.location.href,t.smtp_config_id=this.$btnEditSmtp_.data("config-id"),t.description=this.$modal_.find("#description").val().trim(),t.with_pdf=this.$modal_.find("#with-pdf").is(":checked"),t.deviation=3600*this.$baseTime_.data("value")*1e3,t.to_list=this.$modal_.find("#receiver").tagsinput("items"),t.to_list=t.to_list.map(function(e){return{email:e}}),t.smtp_config_id?sensorsdata.form.removeError(this.$btnAddSmtp_):sensorsdata.form.addError(this.$btnAddSmtp_,"请设置发件人",!0,{container:this.$modal_});var a=this.$modal_.find("#receiver").siblings(".bootstrap-tagsinput");if(0===t.to_list.length)return e!==!1&&sensorsdata.form.addError(a,sensorsdata.languages.get("请填写收件人<!--{en}Please fill in the recipient-->"),!0,{container:this.$modal_}),{};sensorsdata.form.removeError(a),e!==!1&&sensorsdata.form.check(s,!0,1,{container:this.$modal_});var n=t.scheduler_cron[0].split(" "),i=this.$sendUnit_.data("value"),o=this.$sendHour_.data("value");switch(i){case"once":var r=moment();o<=r.hours()&&r.add(1,"day"),n[2]=o,n[3]=r.date(),n[4]=r.month()+1,n[5]="?",n[6]=r.year();break;case"day":n[2]=o,n[3]="*",n[4]="*",n[5]="?",n[6]="*";break;case"week":var d=[];if(this.$sendWeek_.next().find(":checkbox:checked").map(function(){d.push($(this).val())}),0===d.length)return e!==!1&&sensorsdata.form.addError(this.$sendWeek_.next().find("button"),sensorsdata.languages.get("请选择星期<!--{en}Please select the week-->"),!0,{container:this.$modal_}),{};sensorsdata.form.removeError(this.$sendWeek_.next().find("button")),n[2]=o,n[3]="?",n[4]="*",n[5]=d.join(","),n[6]="*";break;case"month":var l=[];if(this.$sendMonth_.next().find(":checkbox:checked").map(function(){l.push($(this).val())}),0===l.length)return e!==!1&&sensorsdata.form.addError(this.$sendMonth_.next().find("button"),sensorsdata.languages.get("请选择日期<!--{en}Please select the date-->"),!0,{container:this.$modal_}),{};sensorsdata.form.removeError(this.$sendMonth_.next().find("button")),n[2]=o,n[3]=l.join(","),n[4]="*",n[5]="?",n[6]="*"}return t.scheduler_cron[0]=n.join(" "),t.subject=s.val().trim(),t.subject||(t.subject=0===n[2]?this.defaultSubject_:this.defaultHourSubject_),t},sensorsdata.DashboardEmailConfig.prototype.checkInputs_=function(){var e=this.buildScheduler_(!1),t=JSON.stringify(this.activeScheduler_)!==JSON.stringify(e);this.$btnAdd_.prop("disabled",t),this.$save_.prop("disabled",!t).text(sensorsdata.languages.get(t?"保存并应用<!--{en}Save and apply-->":"已保存<!--{en}Already saved-->")),this.$modal_.find("#btnTest").prop("disabled",0===this.smtpList_.length||$.isEmptyObject(e))},sensorsdata.DashboardEmailConfig.prototype.editSmtpConfig_=function(){var e=this.smtpList_[0]||{};$.isEmptyObject(e)||(e.password=(new Date).getTime());var t=$(Mustache.render($("#tpl-common-modal").html(),{defaultCloseHide:!0,okButtonText:sensorsdata.languages.get("保存<!--{en}Save-->"),title:sensorsdata.languages.get("设置发送邮箱<!--{en}Set send mailbox-->"),content:Mustache.render($("#tpl-email-config-smtp").html(),e)})),s=t.find("#smtp-from"),a=t.find("#smtp-pwd"),n=t.find("#smtp-hostname"),i=t.find("#smtp-port"),o=t.find("#smtp-ssl"),r=t.find('[data-method="guess"]'),d=function(e){var s=void 0===e;t.find(".iconc-running").toggle(s),r.prop("disabled",s),n.prop("readonly",s),i.prop("readonly",s),o.toggleClass("disabled",s),sensorsdata.form.removeError(n),sensorsdata.form.removeError(i),s||($.isEmptyObject(e)?(sensorsdata.form.addError(n.val(""),sensorsdata.languages.get("探测失败，请输入<!--{en}The probe failed. Please enter-->"),!0,{container:t}),sensorsdata.form.addError(i.val(""),sensorsdata.languages.get("探测失败，请输入<!--{en}The probe failed. Please enter-->"),!1,{container:t})):(n.val(e.hostname),i.val(e.port),o.toggleClass("on",e.ssl)))},l=this;s.on("input propertychange",function(){var e=sensorsdata.form.check($(this),!0,1,{container:t});r.prop("disabled",!e)}),t.off("click").on("click",function(r){var c=$(r.target||r.srcElement),h=c.attr("data-method");switch(h){case"switch-ssl":c.toggleClass("on");break;case"guess":d(),sensorsdata.ajax({url:"email/smtp_config_guess?email="+s.val().trim(),error:function(){d({})},success:function(e){d(e||{})}});break;case"modal-ok":if(!sensorsdata.form.checkChildren(t,!0,1,{container:t}))break;e.from=s.val().trim(),e.username=e.from,e.hostname=n.val().trim(),e.port=i.val().trim(),e.ssl=o.hasClass("on"),e.id&&a.val().trim()===a.attr("data-mock-value")?delete e.password:e.password=a.val().trim(),sensorsdata.ajax({method:"POST",url:"email/smtp_config"+(e.id?"/"+e.id:""),data:JSON.stringify(e),success:function(s){!$.isEmptyObject(s)&&s.id&&(e.id=s.id,l.smtpList_.push(e)),l.renderConfig_(),sensorsdata.form.removeError(l.$btnAddSmtp_),t.modal("hide")}})}}),t.addClass("sa-email-smtp-config").modal({backdrop:!1}),t.off("hidden.bs.modal").on("hidden.bs.modal",function(){t.remove()})},sensorsdata.DashboardEmailConfig.prototype.testEmail_=function(){var e=$(Mustache.render($("#tpl-common-modal").html(),{defaultCloseHide:!0,okButtonText:sensorsdata.languages.get("发送<!--{en}Send-->"),title:sensorsdata.languages.get("选择收件人<!--{en}Select recipient-->"),content:$("#tpl-email-config-send-select").html()})),t=$.extend(!0,[],this.$modal_.find("#receiver").tagsinput("items")),s=e.find("input");s.tagsinput({splitChar:",",typeahead:{minLength:0,showHintOnFocus:!0,template:"{{display}}",autoSelect:!1,afterSelect:function(){s.tagsinput("input").val("")},source:function(e,a){var n=t.slice(),i=s.val().split(",");return i.map(function(e){var t=n.indexOf(e);t>=0&&n.splice(t,1)}),$.isFunction(a)&&a(n),n}}}),s.on("beforeItemAdd",function(e){e.cancel=!/^(\w-*\.*)+@(\w-?)+(\.\w+)+$/.test(e.item),sensorsdata.form.removeError($(this).prev()),a.checkInputs_(!1)});var a=this;e.find('[data-method="modal-ok"]').off("click").on("click",function(){var t=s.tagsinput("items").map(function(e){return{email:e}});if(0===t.length)return void sensorsdata.form.addError(s.prev(),sensorsdata.languages.get("必填<!--{en}Required-->"),!0,{container:e});var n=a.buildScheduler_();if(!$.isEmptyObject(n)){var i=$(this);i.text(sensorsdata.languages.get("发送中<!--{en}Sending-->")).prop("disabled",!0),n.to_list=t,sensorsdata.ajax({method:"PUT",timeout:0,url:"email/report",data:a.convertAjaxParam_(n),error:function(){i.text(sensorsdata.languages.get("发送<!--{en}Send-->")).prop("disabled",!1)},success:function(t){if($.isEmptyObject(t)||t.result!==!0){var s=(t||{}).reason;if(s){var a="https://www.baidu.com/s?wd="+encodeURIComponent(s);s=sensorsdata.util.format(sensorsdata.languages.get('发送失败：<a target="_blank" href="#{link}">#{reason}</a><!--{en}Sending failed：<a target="_blank" href="#{link}">#{reason}</a>-->'),{link:a})}else s=sensorsdata.languages.get("发送失败，原因未知，请联系值班同学<!--{en}Sending failed,unknown reason, please contact the staff on duty-->");sensorsdata.error.show(s)}else sensorsdata.info.show(sensorsdata.languages.get("发送成功，请注意查收<!--{en}Send successfully. Please check.-->"));e.modal("hide")}})}}),e.off("hidden.bs.modal").on("hidden.bs.modal",function(){e.remove()}),e.off("shown.bs.modal").on("hidden.bs.modal",function(){e.find("input").focus()}),e.addClass("sa-email-config-send-select").modal({backdrop:!1})},sensorsdata.DashboardEmailConfig.prototype.renderList_=function(){var e=[];this.schedulers_.length>0?e=this.schedulers_:e.push(this.buildEmptyScheduler_()),this.$list_.html(Mustache.render($("#tpl-email-config-schedule").html(),e))},sensorsdata.DashboardEmailConfig.prototype.renderDetail_=function(e){this.$modal_.find("#btnTest").prop("disabled",!e),e=e||this.buildEmptyScheduler_(),this.activeScheduler_=e,-1===e.id&&0===this.$list_.find('a[data-value="-1"]').length&&this.$list_.append(Mustache.render($("#tpl-email-config-schedule").html(),[e])),this.$list_.find("li").removeClass("active").find('a[data-value="'+e.id+'"]').parent().addClass("active");var t=this;this.$receiver_.tagsinput({splitChar:","}),this.$receiver_.on("beforeItemAdd",function(e){e.cancel=!/^(\w-*\.*)+@(\w-?)+(\.\w+)+$/.test(e.item),sensorsdata.form.removeError($(this).prev())}),this.$receiver_.on("itemAdded",function(){t.checkInputs_(!1)}),this.$receiver_.on("itemRemoved",function(){t.checkInputs_(!1)}),this.$receiver_.data("tagsinput").removeAll(),e.to_list.map(function(e){t.$receiver_.tagsinput("add",e.email)});var s=e.scheduler_cron[0].split(" "),a=this.toTimeUnit_(s);this.$sendUnit_.saDropdown({value:a,onSelected:function(e){t.renderSendRepeat_(e,s),t.checkInputs_(!1)}}),this.$sendHour_.data("saDropdown").select(s[2]),this.$baseTime_.data("saDropdown").select(e.deviation/36e5),this.renderSendRepeat_(a,s),this.$modal_.find("#description").val(e.description),this.$withPdf_.prop("checked",e.with_pdf),this.$modal_.find("#subject").val(0===s[2]&&e.subject!==this.defaultSubject_||0!==s[2]&&e.subject!==this.defaultHourSubject_?e.subject:"");var n=this.$modal_.find("#finish-info"),i=sensorsdata.CONSTSET.timeFormat,o=e.last_success_time&&moment(e.last_success_time,i),r=e.next_fire_time&&moment(e.next_fire_time,i);if(n.parent().toggle(!(!e.last_success_time&&!e.next_fire_time)),e.last_success_time||e.next_fire_time){var d="";e.last_success_time?(d=sensorsdata.util.format(sensorsdata.languages.get("成功发送：#{time}<!--{en}Successfully send：#{time}-->"),{time:o.format("MM-DD HH:mm:ss")}),e.next_fire_time&&(d+=sensorsdata.util.format(sensorsdata.languages.get("，下次发送：#{time}<!--{en}，next sending time: #{time}-->"),{time:r.format("MM-DD HH:mm:ss")}))):d=sensorsdata.util.format(sensorsdata.languages.get("已应用，下次发送时间：#{time}<!--{en}Applied, next sending time: #{time}-->"),{time:r.format("MM-DD HH:mm:ss")}),n.text(d)}this.$save_.prop("disabled",-1!==e.id).text(sensorsdata.languages.get(-1!==e.id?"已保存<!--{en}Already Saved-->":"保存并应用<!--{en}Save and apply-->")),this.$btnAdd_.prop("disabled",-1===e.id)},sensorsdata.DashboardEmailConfig.prototype.toTimeUnit_=function(e){return $.isNumeric(e[3])&&$.isNumeric(e[4])&&$.isNumeric(e[6])?"once":"*"===e[3]&&"*"===e[4]&&"?"===e[5]?"day":"?"===e[3]&&"*"===e[4]?"week":"*"===e[4]&&"?"===e[5]?"month":void 0},sensorsdata.DashboardEmailConfig.prototype.renderSendRepeat_=function(e,t){this.$sendWeek_.next().find(".error").removeClass("error"),this.$sendWeek_.next().toggle("week"===e),"week"===e&&this.$sendWeek_.multiselect("clearSelection").multiselect("select",t[5].split(",").map(function(e){return parseInt(e,10)})),this.$sendMonth_.next().find(".error").removeClass("error"),this.$sendMonth_.next().toggle("month"===e),"month"===e&&this.$sendMonth_.multiselect("clearSelection").multiselect("select",t[3].split(",").map(function(e){return parseInt(e,10)}))};