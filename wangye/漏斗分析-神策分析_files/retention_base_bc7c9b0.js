sensorsdata.RetentionBase=function(){sensorsdata.BasePage.call(this),this.durations_=[{name:"1",value:1,cname:sensorsdata.languages.get("次天留存<!--{en}Retention the next day-->"),unit:"day",unitCname:sensorsdata.languages.get("天<!--{en}days-->"),isDay:!0},{name:"2",value:7,cname:sensorsdata.languages.get("7天留存<!--{en}Retention in 7 days -->"),unit:"day",unitCname:sensorsdata.languages.get("天<!--{en}days-->"),isDay:!0},{name:"3",value:14,cname:sensorsdata.languages.get("14天留存<!--{en}Retention in 14 days -->"),unit:"day",unitCname:sensorsdata.languages.get("天<!--{en}days-->"),isDay:!0},{name:"4",value:30,cname:sensorsdata.languages.get("30天留存<!--{en}Retention in 30 days -->"),unit:"day",unitCname:sensorsdata.languages.get("天<!--{en}days-->"),isDay:!0},{name:"5",value:1,cname:sensorsdata.languages.get("次周留存<!--{en}Retention the next week-->"),unit:"week",unitCname:sensorsdata.languages.get("周<!--{en}weeks-->"),isWeek:!0},{name:"6",value:8,cname:sensorsdata.languages.get("8周留存<!--{en}Retention in 8 weeks-->"),unit:"week",unitCname:sensorsdata.languages.get("周<!--{en}weeks-->"),isWeek:!0},{name:"7",value:12,cname:sensorsdata.languages.get("12周留存<!--{en}Retention in 12 weeks-->"),unit:"week",unitCname:sensorsdata.languages.get("周<!--{en}weeks-->"),isWeek:!0},{name:"8",value:24,cname:sensorsdata.languages.get("24周留存<!--{en}Retention in 24 weeks-->"),unit:"week",unitCname:sensorsdata.languages.get("周<!--{en}weeks-->"),isWeek:!0},{name:"9",value:1,cname:sensorsdata.languages.get("次月留存<!--{en}Retention the next month-->"),unit:"month",unitCname:sensorsdata.languages.get("月<!--{en}months-->"),isMonth:!0},{name:"10",value:6,cname:sensorsdata.languages.get("6个月留存<!--{en}Retention in 6 month-->"),unit:"month",unitCname:sensorsdata.languages.get("月<!--{en}months-->"),isMonth:!0},{name:"11",value:12,cname:sensorsdata.languages.get("12个月留存<!--{en}Retention in 12 month-->"),unit:"month",unitCname:sensorsdata.languages.get("月<!--{en}months-->"),isMonth:!0},{name:"12",value:24,cname:sensorsdata.languages.get("24个月留存<!--{en}Retention in 24 month-->"),unit:"month",unitCname:sensorsdata.languages.get("月<!--{en}months-->"),isMonth:!0}]},sensorsdata.inherits(sensorsdata.RetentionBase,sensorsdata.BasePage),sensorsdata.RetentionBase.prototype.getDuration=function(e,t){if(!e||!t)return this.durations_[0];var n=this.durations_.filter(function(n){return n.value.toString()===e.toString()&&n.unit===t});return 1===n.length?n[0]:null},sensorsdata.RetentionBase.prototype.padRetentions=function(e,t,n){n=n||{};var a=sensorsdata.CONSTSET.timeFormat,s=this.getDuration(t.duration,t.unit),o=sensorsdata.getBeginDate(s.unit),r=function(e){var t=moment(e,a);return t.isValid()?o.diff(t,s.unit)+1:0},i=0;if(t.by_field){var d=sensorsdata.getBeginDate(s.unit,t.from_date);i=o.diff(d,s.unit)+1}else i=r(e.rows[0].by_value);return i=i<=s.value?i:s.value+1,e.rows.map(sensorsdata.bind(function(e){e.by_value=sensorsdata.formatByValue(e.by_value,n.data_type,"",t.bucket_param),$.isArray(e.cells)||(e.cells=[]);var a=0;if(t.by_field)a=i,e.cells.splice(i);else{var o=r(e.by_value);a=s.value<o?s.value+1:o,e.cells.splice(a)}for(var d=e.cells.length;i>d;d++)e.cells.push(a>d?{people:0,percent:0}:{})},this)),e},sensorsdata.RetentionBase.prototype.dealParam=function(e){var t=$.extend(!0,[],sensorsdata.cache.events);"ALL"===sensorsdata.authority.eventPermission.type&&t.unshift(sensorsdata.CONSTSET.everyEvent),$.isEmptyObject(e)||$.isEmptyObject(e.first_event)||0===t.filter(function(t){return t.name===e.first_event.event_name}).length&&(sensorsdata.error.show(sensorsdata.languages.get("没有相关事件的权限或事件不存在<!--{en}There are no permissions for the relevant events or the events do not exist-->")),e={}),$.isEmptyObject(e)||$.isEmptyObject(e.second_event)||0===t.filter(function(t){return t.name===e.second_event.event_name}).length&&(sensorsdata.error.show(sensorsdata.languages.get("没有相关事件的权限或事件不存在<!--{en}There are no permissions for the relevant events or the events do not exist-->")),e={});var n=sensorsdata.buildDefaultTimeRange(),a={first_event:{event_name:t[0].name},second_event:{event_name:t[0].name},measures:[],duration:7,unit:"day",from_date:n[0].format(sensorsdata.CONSTSET.dateFormat),to_date:n[1].format(sensorsdata.CONSTSET.dateFormat),extend_over_end_date:!0};if($.isEmptyObject(e))return a;e.is_wastage&&(e.is_wastage="true"===e.is_wastage?!0:!1);var s=sensorsdata.CONSTSET.dateFormat;if(moment(e.from_date,s).isValid()===!1&&delete e.from_date,moment(e.to_date,s).isValid()===!1&&delete e.to_date,"boolean"!=typeof e.extend_over_end_date&&(e.extend_over_end_date="false"===e.extend_over_end_date?!1:!0),$.isEmptyObject(e.first)||(e.first_event={},e.first_event.event_name=e.first.event,$.isEmptyObject(e.first.filter)?delete e.first_event.filter:e.first_event.filter=sensorsdata.FilterGroupControl.dealCompatible(e.first.filter),delete e.first),$.isEmptyObject(e.second)||(e.second_event={},e.second_event.event_name=e.second.event,$.isEmptyObject(e.second.filter)?delete e.second_event.filter:e.second_event.filter=sensorsdata.FilterGroupControl.dealCompatible(e.second.filter),delete e.second),e.user_filter=sensorsdata.FilterGroupControl.dealCompatible(e.user_filter),e.by&&(e.by_field=e.by,delete e.by),e.by_field){var o=e.by_field.split(".");3!==o.length?delete e.by_event:e.by_event||o[1]!==e.first_event.event_name?e.by_event||o[1]!==e.second_event.event_name||(e.by_event="second"):e.by_event="first"}else delete e.by_event;e.sampling_factor&&(e.sampling_factor=sensorsdata.BookmarkSave.dealSamplingValue(e.sampling_factor));var r=sensorsdata.buildBucketPopoverValue(e.bucket_param);return r.length>0?e.bucket_param=r:delete e.bucket_param,$.extend(!0,a,e)};