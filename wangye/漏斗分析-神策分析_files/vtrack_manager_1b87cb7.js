sensorsdata.VisualTrackingManager=function(e){this.option_=e,this.container_=e.container,this.container_.html($("#tpl-visual-tracking-manager").html()),this.tab_=this.container_.find("#tracking-tab"),this.modalTrigger_=this.container_.find("#modal-trigger"),this.modalConfirm_=this.container_.find("#modal-confirm"),this.panelWebDefine_=this.container_.find("#panel-web-define"),this.panelAppDefine_=this.container_.find("#panel-app-define"),this.panelEvents_=this.container_.find("#panel-visual-events"),this.panelAppConnect_=this.container_.find("#panel-app-connect"),this.panelAppClient_=this.container_.find("#panel-app-client"),this.panelAppRefreshing_=this.container_.find("#panel-app-refreshing"),this.panelAppSnapshot_=this.container_.find("#panel-app-snapshot"),this.btnDeploy_=this.container_.find("#btn-deploy"),this.btnConnect_=this.container_.find("#btn-connect"),this.linkWebDefine_=this.container_.find("#link-web-define"),this.inputWebUrl_=this.container_.find("#input-web-url"),this.$debugTrackInfo_=this.container_.find("#debug-track-info"),this.$trackManager_=this.container_.find('[data-method="track-manager"]'),this.$dataStreamPage_=this.container_.find('[data-method="data-stream"]'),this.tplEvents_=$("#tpl-visual-tracking-events").html(),this.tplAppClient_=$("#tpl-visual-tracking-appclient").html(),this.tplTrigger_=$("#tpl-visual-tracking-trigger").html(),this.tplControls_=$("#tpl-visual-tracking-controls").html(),this.tplPopover_=$("#tpl-visual-tracking-events-popover").html(),this.tplDebugTrack_=$("#tpl-visual-tracking-debug").html(),this.tplTriggerPicture_=$("#tpl-visual-tracking-trigger-picture").html(),this.container_.find("#link-import-tool").attr("href","/accessories/data_checker?project="+(sensorsdata.cache.project.name||"default")),this.defaultActiveLib_="Web",this.activeLib_=this.defaultActiveLib_,this.vEvents_=[],this.deletedTriggerIds_=[],this.deletedTriggers_=[],this.offline_=!1,this.pauseRender_=!1,this.isManualRefresh_=!1,this.connectTimeoutId_=void 0,this.refreshTimeoutId_=void 0,this.refreshEventsTimeoutId_=void 0,this.appClient_=null,this.clientScreen_={width:0,height:0},this.snapshotImageHash_="",this.snapshot_={},this.controls_=[],this.controlsUniq_="",this.triggerImageCache_={},this.isUnload_=!1,this.eventNameHelp_=sensorsdata.languages.get("事件名只支持英文、数字和下划线，且不能为预置名称<!--{en}The event name must be letters, numbers and underscores, and cannot be preset name-->"),this.missClientTip_=sensorsdata.languages.get("无法连接到此设备，请确保应用处于运行状态<!--{en}Unable to connect to this device,please make sure that the application is running-->"),this.init_()},sensorsdata.VisualTrackingManager.prototype.unload=function(){this.isUnload_=!0,this.controlsUniq_="",window.clearTimeout(this.refreshEventsTimeoutId_),window.clearTimeout(this.btnConnect_.data("interval-id")),this.btnConnect_.button("reset"),this.disConnectApp_(),$("html").unbind("click.VisualTrackingManager"),this.tab_.unbind("click"),this.panelEvents_.unbind("click"),this.panelAppDefine_.unbind("click"),this.modalTrigger_.unbind("click"),this.btnConnect_.unbind("click"),this.btnDeploy_.unbind("click"),this.linkWebDefine_.unbind("click"),$(window).unbind("popstate.VisualTrackingManager")},sensorsdata.VisualTrackingManager.prototype.reload=function(){this.isUnload_=!1,this.initEvents_()},sensorsdata.VisualTrackingManager.prototype.init_=function(){var e=sensorsdata.unparam(window.location.hash);this.activeLib_=e.lib||this.defaultActiveLib_,this.initEvents_(),this.changeTab_(this.activeLib_)},sensorsdata.VisualTrackingManager.prototype.initWebSuggest=function(){var e=this;sensorsdata.ajax({url:"vtrack/edit_mode/suggestion",success:function(t){if("object"!=typeof t||!$.isArray(t.urls))return sensorsdata.log(sensorsdata.languages.get("suggest数据格式有误<!--{en}suggest data format error-->")),!1;var n=t.urls,i=n.slice(0,10),a=function(e,t){t(""===e?i:$.grep(n,function(t){return-1!==t.indexOf(e)}))};e.inputWebUrl_.twitterTypeahead("destroy").twitterTypeahead({minLength:0,highlight:!0},{limit:10,source:a}),n[0]&&e.inputWebUrl_.twitterTypeahead("val",n[0]),e.inputWebUrl_.prev("input").css({width:"100%"}),e.inputWebUrl_.css({width:"100%"}).parent("span").css({width:"75%"})}}),setTimeout(function(){e.inputWebUrl_.focus()},1e3)},sensorsdata.VisualTrackingManager.prototype.initEvents_=function(){$(window).unbind("popstate.VisualTrackingManager").bind("popstate.VisualTrackingManager",sensorsdata.bind(this.windowPopstate_,this)),$("html").unbind("click.VisualTrackingManager").bind("click.VisualTrackingManager",sensorsdata.bind(this.htmlClick_,this)),this.tab_.unbind("click").bind("click",sensorsdata.bind(this.tabClick_,this)),this.panelEvents_.unbind("click").bind("click",sensorsdata.bind(this.panelEventsClick_,this)),this.panelAppDefine_.unbind("click").bind("click",sensorsdata.bind(this.panelAppDefineClick_,this)),this.modalTrigger_.unbind("click").bind("click",sensorsdata.bind(this.modalTriggerClick_,this)),this.modalTrigger_.find("#trigger-event-name").unbind("keypress.VisualTrackingManager").bind("keypress.VisualTrackingManager",sensorsdata.bind(this.modalTriggerKeypress_,this)),this.btnConnect_.unbind("click").bind("click",sensorsdata.bind(this.btnConnectClick_,this)),this.btnDeploy_.unbind("click").bind("click",sensorsdata.bind(this.btnDeployClick_,this)),this.linkWebDefine_.unbind("click").bind("click",sensorsdata.bind(this.linkWebDefineClick_,this)),this.$trackManager_.unbind("click").bind("click",sensorsdata.bind(function(){this.option_.initPage("/track-manager/")},this)),this.$dataStreamPage_.unbind("click").bind("click",sensorsdata.bind(function(){this.option_.initPage("/data-stream/")},this)),this.initWebSuggest(),this.modalTrigger_.find("span.icon-help").tooltip({container:"body",title:this.eventNameHelp_}),this.btnDeploy_.tooltip({container:"body",title:sensorsdata.languages.get("部署成功后，当用户再次启动应用时变动生效<!--{en}After successful deployment,the change will take effect when the user starts the application again-->")})},sensorsdata.VisualTrackingManager.prototype.windowPopstate_=function(){var e=sensorsdata.unparam(window.location.hash),t=e.lib||this.defaultActiveLib_;t!==this.activeLib_&&(this.activeLib_=t,this.changeTab_(this.activeLib_))},sensorsdata.VisualTrackingManager.prototype.htmlClick_=function(e){for(var t=$(e.target||e.srcElement),n=this,i=t.parents('.popover[id^="popover"]'),a=$('.popover[id^="popover"]'),s=0,r=a.size();r>s;s++)if(1!==i.size()||!i.is(a.eq(s))){var o=a.eq(s).data("bs.popover");o&&o.$element&&$.isFunction(o.$element.popover)&&o.$element.popover("hide")}0===t.parents("#debug-track-info").size()&&n.$debugTrackInfo_.hide()},sensorsdata.VisualTrackingManager.prototype.btnConnectClick_=function(e){var t=$(e.target||e.srcElement);t.is("button")||(t=t.parents("button:first"));var n=120,i=t.data("original-loading-text");t.data("last-seconds",n),t.data("loading-text",i+"("+n+"s)");var a=this,s=function(){var e=t.data("last-seconds");t.text(i+"("+e+"s)"),0>=e&&(t.button("reset"),window.clearTimeout(t.data("interval-id")),window.clearTimeout(a.connectTimeoutId_)),t.data("last-seconds",--e)},r=window.setInterval(s,1e3);t.data("interval-id",r),t.button("loading"),s(),this.connectApp_()},sensorsdata.VisualTrackingManager.prototype.btnDeployClick_=function(){var e=this,t=this.buildNewEvents_(),n=function(){sensorsdata.ajax({url:"vtrack/deploy/"+e.activeLib_,method:"PUT",success:function(){e.bindEvents_(),e.renderEvents_(e.activeLib_),$("span.vtrack-undeployed").removeClass("vtrack-undeployed"),sensorsdata.info.show(sensorsdata.languages.get("部署<!--{en}Deployment-->")+e.activeLib_+sensorsdata.languages.get("成功<!--{en}Success-->"))}})},i=function(){return 0===t.length?void n():void sensorsdata.ajax({url:"vtrack/events",method:"POST",data:JSON.stringify(t),success:function(){n()}})},a=function(t){return 0===e.deletedTriggerIds_.length?void t():void sensorsdata.ajax({url:"vtrack/triggers",method:"DELETE",data:JSON.stringify(e.deletedTriggerIds_),success:function(){t()}})};a(i)},sensorsdata.VisualTrackingManager.prototype.buildNewEvents_=function(){for(var e=[],t=0,n=this.vEvents_.length;n>t;t++){var i=$.extend(!0,{},this.vEvents_[t]);if(-1!==i.id){var a=i.triggers;i.triggers=[];for(var s=0,r=a.length;r>s;s++)a[s].id<0&&i.triggers.push(a[s]);i.triggers.length>0&&e.push(i)}else e.push(i)}return e},sensorsdata.VisualTrackingManager.prototype.linkWebDefineClick_=function(){var e=!1,t=this,n=$.trim(this.inputWebUrl_.val());return n?(0!==n.indexOf("https://")&&0!==n.indexOf("http://")&&0!==n.indexOf("//")&&(n="//"+n),this.linkWebDefine_.attr("href",n+"?sensorsdata_visual_mode_in").hide(),sensorsdata.ajax({async:!1,url:"vtrack/edit_mode?url="+n,method:"POST",success:function(){e=!0,t.linkWebDefine_.show()}}),e):(sensorsdata.info.show(sensorsdata.languages.get("请输入要进行可视化埋点的网址<!--{en}Please enter the URL where you want to visualize track-->")),!1)},sensorsdata.VisualTrackingManager.prototype.tabClick_=function(e){var t=$(e.target||e.srcElement),n=t.attr("data-method")||t.parents("[data-method]:first").attr("data-method");n&&this.changeTab_(n)},sensorsdata.VisualTrackingManager.prototype.changeTab_=function(e){var t=this,n=t.tab_.find('a[data-method="'+e+'"]'),i=function(){t.deletedTriggerIds_=[],n.addClass("active").siblings().removeClass("active"),t.controlsUniq_="",t.activeLib_=e,t.renderEvents_(e),"Web"===e?(t.panelWebDefine_.show(),t.panelAppDefine_.hide(),t.disConnectApp_()):(window.clearTimeout(t.refreshEventsTimeoutId_),t.panelWebDefine_.hide(),t.panelAppDefine_.show(),t.panelAppConnect_.show(),t.disConnectApp_(),t.panelAppDefine_.find("[data-lib-desc]").hide().filter('[data-lib-desc="'+e+'"]').show(),t.btnConnect_.button("reset"),window.clearTimeout(t.btnConnect_.data("interval-id")));var i=sensorsdata.unparam(window.location.hash);if(i.lib!==e){i.lib=e;var a="#"+$.param(i);a!==window.location.hash&&window.history.pushState(a,"",a)}},a=this.buildNewEvents_();if(this.appClient_){var s=this.deletedTriggerIds_.length>0||a.length>0;s?t.popConfirm_(sensorsdata.languages.get("确定放弃变更吗？<!--{en}Are you sure you give up the change?-->"),function(){i()}):t.offline_?i():t.popConfirm_(sensorsdata.languages.get("确定断开连接吗？<!--{en}Are you sure you want to disconnect?-->"),function(){i()})}else i()},sensorsdata.VisualTrackingManager.prototype.panelEventsClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.parents("[data-event-name]:first"),i=t.parents("[data-trigger-id]:first"),a=n.attr("data-event-name"),s=parseInt(i.attr("data-trigger-id"),10),r=i.attr("data-deployed"),o=null,d=sensorsdata.findIndex(this.vEvents_,function(e){return e.name===a});if(-1!==d){var l=t.attr("data-method");switch(l){case"restore-trigger":this.deletedTriggerIds_.splice(this.deletedTriggerIds_.indexOf(s),1),o=this.deletedTriggers_.filter(function(e){return e.id===s})[0],this.vEvents_[d].triggers.push(o),t.attr("data-method","remove-trigger").text(sensorsdata.languages.get("删除<!--{en}Delete-->")),i.removeClass("restore"),0===n.find("li.restore").size()&&n.find(".panel-title a").removeClass("remove"),this.bindEvents_();break;case"remove-trigger":var c=sensorsdata.findIndex(this.vEvents_[d].triggers,function(e){return e.id===s});if(-1===c)return;o=this.vEvents_[d].triggers.splice(c,1)[0];var p=function(){i.popover("destroy"),0===i.siblings().size()?i.parents("div[data-event-name]:first").remove():i.remove(),0===i.siblings(".new-trigger").size()&&n.find(".panel-title a").removeClass("new-trigger")},h=this;"false"===r?sensorsdata.ajax({url:"vtrack/triggers",method:"DELETE",data:JSON.stringify([s]),success:function(){p(),h.bindEvents_()}}):o.id>0?(this.deletedTriggerIds_.push(s),this.deletedTriggers_.push(o),n.find(".panel-title a").addClass("remove"),t.attr("data-method","restore-trigger").text(sensorsdata.languages.get("恢复<!--{en}Recovery-->")),i.addClass("restore"),this.btnDeploy_.removeAttr("disabled"),this.bindEvents_()):(p(),h.bindEvents_())}}},sensorsdata.VisualTrackingManager.prototype.renderEvents_=function(e){var t=this,n=function(e){for(var t=0,n=e.length;n>t;t++)for(var i=0,a=e[t].triggers.length;a>i;i++)if(e[t].triggers[i].deployed!==!0)return!0;return!1},i=function(e){var i=t.panelEvents_.find('.panel-title a[aria-expanded="true"]').parents("div[data-event-name]:first").attr("data-event-name"),a=Mustache.render(t.tplEvents_,{events:e},{tplTrigger:t.tplTrigger_});t.panelEvents_.html(a).parent().toggle(e.length>0),"Web"!==t.activeLib_&&t.panelEvents_.find("li").bind("mouseenter.trigger",sensorsdata.bind(t.triggerLiMouseenter_,t)),t.panelEvents_.find(".collapse").unbind("show.bs.collapse").unbind("hide.bs.collapse").bind("show.bs.collapse",function(){$(this).parents("div[data-event-name]:first").find("a span").removeClass("icon-expand-down-single").addClass("icon-collapse-up-single")}).bind("hide.bs.collapse",function(){$(this).parents("div[data-event-name]:first").find("a span").removeClass("icon-collapse-up-single").addClass("icon-expand-down-single")}),t.expandCollapse_(t.panelEvents_.find('div[data-event-name="'+i+'"] .collapse')),n(e)?t.btnDeploy_.removeAttr("disabled"):t.btnDeploy_.attr("disabled","disabled")},a=function(e,n){for(var i=[],a=0,s=e.length;s>a;a++){var r=e[a].triggers.filter(function(e){return e.lib===n&&-1===t.deletedTriggerIds_.indexOf(e.id)});if(r.length>0){var o=$.extend(!0,{},e[a]);o.renderName=o.name.replace(/\$/g,"-"),o.triggers=r,i.push(o)}}return i},s=function(n){sensorsdata.ajax({url:"vtrack/events/all",showLoader:!n,success:function(r){if(t.option_.closeLoading(),!$.isArray(r))return void sensorsdata.error.show(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->"));r.map(function(e){e.isSameName=e.name===e.cname,$.isArray(e.triggers)&&e.triggers.map(function(e,t){e.no_=t+1})});var o=a(r,e);if(n){var d=a(t.vEvents_,e);JSON.stringify(d)!==JSON.stringify(o)&&(console.log("rerender vtrack events"),i(o))}else i(o);t.vEvents_=r,"Web"===e&&t.isUnload_===!1&&(t.refreshEventsTimeoutId_=window.setTimeout(function(){s(!0)},2e3))}})};s()},sensorsdata.VisualTrackingManager.prototype.panelAppDefineClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=this,i=t.attr("data-method");switch(i){case"auto-refresh":n.offline_||n.turnAutoRefresh_(!t.hasClass("on"));break;case"manual-refresh":n.offline_||this.setManualRefreshing_(!0);break;case"remove-client":n.offline_||(this.removeClient_(!0),this.disConnectApp_());break;case"connect-client":n.refreshTimeoutId_||n.refreshSnapshot_(n.appClient_.client_id);break;case"select-trigger-control":var a='span.selected[data-method="select-trigger-control"]';if(1===this.panelAppDefine_.find(a).size())return;this.pauseRender_=!0,t.addClass("selected");var s=this.modalTrigger_.find("#trigger-event-name"),r=this.modalTrigger_.find("#trigger-event-cname"),o=this.modalTrigger_.find('button[data-method="ok"]'),d=function(){var e=$.trim(s.val()),t=-1;e&&(t=sensorsdata.findIndex(n.vEvents_,function(t){return t.name===e}),t>=0&&r.val(n.vEvents_[t].cname)),o.focus()},l=10,c=n.vEvents_.slice(0,l),p=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name","cname"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:n.vEvents_}),h=function(e,t){""===e?t(c):p.search(e,t)},g=function(e){return'<div class="vtrack-autosuggest-dropdown-item">'+e.name+"("+e.cname+")</div>"};s.twitterTypeahead("destroy").twitterTypeahead({minLength:0,highlight:!0},{limit:l,display:"name",source:h,templates:{suggestion:g}}).bind("typeahead:close",d),this.modalTrigger_.unbind("shown.bs.modal").bind("shown.bs.modal",function(){s.focus()}).unbind("hidden.bs.modal").bind("hidden.bs.modal",function(){n.pauseRender_=!1}),this.modalTrigger_.modal();break;case"select-prop-control":if(1!==t.siblings(".trigger.selected").size())return;t.hasClass("selected")?t.removeClass("selected"):t.addClass("selected")}},sensorsdata.VisualTrackingManager.prototype.turnAutoRefresh_=function(e){var t=this.panelAppClient_.find('[data-method="auto-refresh"]'),n=this.panelAppClient_.find('[data-method="manual-refresh"]'),i=this.panelAppClient_.find("[data-lib-icon]");e?(t.addClass("on"),n.hide(),i.addClass("refreshing")):(t.removeClass("on"),n.show(),i.removeClass("refreshing"))},sensorsdata.VisualTrackingManager.prototype.modalTriggerClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.attr("data-method");switch(n){case"modal-ok":this.modalTriggerOk_();break;case"modal-close":this.modalTrigger_.find("#trigger-event-name").val("").nextAll("p:first").hide(),this.modalTrigger_.find("div.alert-danger").hide(),this.panelAppDefine_.find("span.selected").removeClass("selected")}},sensorsdata.VisualTrackingManager.prototype.modalTriggerKeypress_=function(e){13===e.which&&this.modalTriggerOk_()},sensorsdata.VisualTrackingManager.prototype.modalTriggerOk_=function(){var e=this,t=this.modalTrigger_.find("div.alert-danger"),n=this.modalTrigger_.find("#trigger-event-name"),i=this.modalTrigger_.find("#trigger-event-cname"),a=$.trim(n.val()),s=$.trim(i.val()),r=function(t,n){var i=sensorsdata.findIndex(sensorsdata.cache.events,t);return i>=0&&(!n||n&&sensorsdata.cache.events[i].name!==n)?i:(i=sensorsdata.findIndex(e.vEvents_,t),i>=0&&n&&e.vEvents_[i].name===n?-1:i)};if(a){var o=this.vEvents_.filter(function(e){return e.name===a})[0];if(o){if(r(function(e){return e.cname===s},a)>=0)return void t.show().find("#error").html(sensorsdata.languages.get("事件显示名『<!--{en}Event display name『-->")+s+sensorsdata.languages.get("』已被使用。<!--{en}』has been used.-->"));for(var d=this.panelAppDefine_.find("span.selected.trigger").attr("data-control-path"),l=0,c=o.triggers.length;c>l;l++){var p=JSON.parse(o.triggers[l].config).path;if("Android"===this.activeLib_&&(p=JSON.stringify(p)),p===d)return void t.show().find("#error").html(sensorsdata.languages.get("事件『<!--{en}Event『-->")+s+sensorsdata.languages.get("』中已经存在此埋点<!--{en}』has already been tracked-->"))}}else{var h=/^((?!^distinct_id$|^original_id$|^time$|^properties$|^id$|^first_id$|^second_id$|^users$|^events$|^event$|^user_id$|^date$|^datetime$)[a-zA-Z_$][a-zA-Z\d_$]{0,99})$/;if(!h.test(a))return void t.show().find("#error").html(this.eventNameHelp_);if(r(function(e){return e.cname===s},a)>=0)return void t.show().find("#error").html(sensorsdata.languages.get("事件显示名『<!--{en}Event display name『-->")+s+sensorsdata.languages.get("』已被使用。<!--{en}』has been used.-->"))}t.hide(),n.val(""),i.val(""),this.saveTrigger_(a,s),this.modalTrigger_.modal("hide")}},sensorsdata.VisualTrackingManager.prototype.connectApp_=function(){var e=this,t=500,n=function(){sensorsdata.ajax({url:"vtrack/client",showLoader:!1,success:function(t){if($.isArray(t)&&0!==t.length){for(var n=0,i=t.length;i>n;n++)if(e.activeLib_===t[n].$lib){e.appClient_=t[n];break}if(e.appClient_){e.btnConnect_.button("reset"),window.clearTimeout(e.btnConnect_.data("interval-id")),void 0!==e.connectTimeoutId_&&(window.clearTimeout(e.connectTimeoutId_),e.connectTimeoutId_=void 0);var a=Mustache.render(e.tplAppClient_,{deviceName:e.appClient_.$device_name,deviceModel:e.appClient_.$device_model,os:e.appClient_.$os,osVersion:e.appClient_.$os_version,lib:e.appClient_.$lib,time:moment().format("HH:mm:ss")});e.panelAppClient_.html(a).show(),e.panelAppClient_.find('[data-toggle="tooltip"]').tooltip(),e.panelAppConnect_.hide(),e.panelAppRefreshing_.show(),e.refreshSnapshot_(e.appClient_.client_id),e.bindEvents_()}}},complete:function(){var i=e.btnConnect_.data("last-seconds");e.isUnload_===!1&&i>0&&!e.appClient_&&(e.connectTimeoutId_=window.setTimeout(n,t))}})};n()},sensorsdata.VisualTrackingManager.prototype.bindEvents_=function(){if(!this.appClient_||!this.appClient_.client_id)return void console.log("can not bind events, client is not exist.");if(this.offline_===!0)return void console.log("can not bind events, client is offline.");for(var e=[],t=0,n=this.vEvents_.length;n>t;t++)for(var i=0,a=this.vEvents_[t].triggers.length;a>i;i++){var s=this.vEvents_[t].triggers[i];s.lib===this.activeLib_&&e.push({id:s.id,deployed:s.id>0,config:s.config})}var r=this;sensorsdata.ajax({url:"vtrack/binding/"+this.appClient_.client_id,method:"POST",showCommonError:!1,errorStatusCode:401,data:JSON.stringify(e),error:function(e){console.log("can not bind events, ajax error.");var t=parseInt(e.status,10);404===t&&sensorsdata.info.show(r.missClientTip_)}})},sensorsdata.VisualTrackingManager.prototype.disConnectApp_=function(){return void 0!==this.refreshTimeoutId_&&window.clearTimeout(this.refreshTimeoutId_),void 0!==this.connectTimeoutId_&&window.clearTimeout(this.connectTimeoutId_),this.removeClient_(!1),this.appClient_=null,this.connectTimeoutId_=void 0,this.refreshTimeoutId_=void 0,this.snapshotImageHash_="",this.controls_=[],this.modalTrigger_.modal("hide").find("input").val("").nextAll("p:first").hide(),this.panelAppConnect_.show(),this.panelAppClient_.hide(),this.panelAppRefreshing_.hide(),this.panelAppSnapshot_.hide().find("span[data-control-path]").remove(),!0},sensorsdata.VisualTrackingManager.prototype.removeClient_=function(e){var t=this;t.appClient_&&t.appClient_.client_id&&sensorsdata.ajax({url:"vtrack/client/"+t.appClient_.client_id,method:"DELETE",showCommonError:!1,errorStatusCode:401,error:function(n){if(e){var i=parseInt(n.status,10);404===i&&sensorsdata.info.show(t.missClientTip_)}}})},sensorsdata.VisualTrackingManager.prototype.refreshSnapshot_=function(e){var t=this,n=t.container_.find('[data-method="auto-refresh"]'),i=1e3,a=3,s=0,r=!1,o=function(){sensorsdata.ajax({url:"vtrack/snapshot/"+e+"?last_image_hash="+(t.snapshotImageHash_||""),showLoader:!1,showCommonError:!1,errorStatusCode:401,error:function(){if(t.offline_!==!0&&++s>a){r=!0;var e=sensorsdata.languages.get("无法连接到此设备，要进行离线编辑吗？<!--{en}Unable to connect to this device,do you want to edit offline?-->");t.popConfirm_(e,function(){t.refreshTimeoutId_=window.setTimeout(o,i),r=!1,i=3e3,t.setOffline_(!0)},function(){t.disConnectApp_()})}},success:function(a){if(i=1e3,s=0,t.tab_.find("a.active").attr("data-method")===t.activeLib_&&!$.isEmptyObject(a)){if(!t.appClient_||t.appClient_.client_id!==e)return void(void 0!==this.refreshTimeoutId_&&(window.clearTimeout(this.refreshTimeoutId_),this.refreshTimeoutId_=void 0));if(t.setOffline_(!1),$.isArray(a.debug_track)&&a.debug_track.length>0&&(console.info(a.debug_track),t.renderDebugTrack_(a.debug_track)),(t.isManualRefresh_||t.pauseRender_!==!0&&n.hasClass("on"))&&(t.setManualRefreshing_(!1),!$.isEmptyObject(a.payload))){var r=null,o="";if("iOS"===t.appClient_.$lib?(r=a.payload,o=r.image_hash):a.payload.activities.length>0&&(r=a.payload.activities[a.payload.activities.length-1],$.isEmptyObject(r)||(o=a.payload.activities.map(function(e){return e.image_hash}).join(","))),o&&o!==t.snapshotImageHash_){var d=[];if("iOS"===t.appClient_.$lib){var l=r.serialized_objects.objects.filter(function(e){return e.id===r.serialized_objects.rootObject})[0],c=r.serialized_objects.objects.filter(function(e){return e.id===l.properties.screen.values[0].value})[0];t.clientScreen_.width=c.properties.bounds.values[0].value.Width,t.clientScreen_.height=c.properties.bounds.values[0].value.Height,d=t.convertIOSToControls_(r)}else{var p=r.serialized_objects.objects.filter(function(e){return 0===e.classes.indexOf("com.android.internal.policy.impl.PhoneWindow.DecorView")||0===e.classes.indexOf("com.android.internal.policy.PhoneWindow.DecorView")||e.classes.indexOf("com.android.internal.policy.impl.MultiPhoneWindow.MultiPhoneDecorView")})[0];t.clientScreen_.width=p.width,t.clientScreen_.height=p.height,d=t.convertAndroidToControls_(r,t.clientScreen_.width,t.clientScreen_.height)}t.snapshotImageHash_=o,t.snapshot_=r,t.renderApp_(r.screenshot,d)}}}},complete:function(){t.isUnload_===!1&&t.appClient_&&r!==!0&&(t.refreshTimeoutId_=window.setTimeout(o,i))}})};o()},sensorsdata.VisualTrackingManager.prototype.convertAndroidToControls_=function(e,t,n){var i=[];if($.isEmptyObject(e.serialized_objects)||!$.isArray(e.serialized_objects.objects))return i;var a=$.extend(!0,[],e.serialized_objects.objects),s=function(e){for(var t=["com.android.internal.policy.impl.PhoneWindow.DecorView","com.android.internal.policy.PhoneWindow.DecorView","com.android.internal.policy.impl.MultiPhoneWindow.MultiPhoneDecorView"],n=-1,i=e.length-1;i>=0;i--)if(t.indexOf(e[i].view_class)>=0){n=i;break}if(-1===n)return JSON.stringify(e);var a=e.slice(n);return a[0].index=-1,JSON.stringify(a)},r=0,o=function(e,d,l,c,p){p=$.extend(!0,[],p),r++;var h=a[e];if(0===h.visibility){p.push({index:h.index,sa_id_name:h.sa_id_name,view_class:h.classes[0]}),l=l-h.scrollX+h.left,c=c-h.scrollY+h.top;var g=h.width,u=h.height,v="";if((l>=0&&t>l&&c>=0&&n>c||l+g>=0&&t>l+g&&c+u>=0&&n>c+u)&&h.importantForAccessibility===!0&&(h.classes.indexOf("android.widget.EditText")>=0?v="text_changed":h.classes.indexOf("android.view.View")>=0&&h.clickable===!0&&(v="click"),0>l&&(g+=l,l=0),l+g>t&&(g=t-l),0>c&&(u+=c,c=0),c+u>n&&(u=n-c)),v&&i.push({eventType:v,path:s(p),x:l,y:c,width:g,height:u,zIndex:r}),h.subviews&&h.subviews.length>0)for(var f=0,_=h.subviews.length;_>f;f++){var m=sensorsdata.findIndex(a,function(e){return e.hashCode===h.subviews[f]});o(m,e,l,c,p)}}},d=sensorsdata.findIndex(a,function(t){return t.hashCode===e.serialized_objects.rootObject});return o(d,-1,0,0,[]),i},sensorsdata.VisualTrackingManager.prototype.convertIOSToControls_=function(e){var t=[];if($.isEmptyObject(e.serialized_objects)||!$.isArray(e.serialized_objects.objects))return t;var n=$.extend(!0,[],e.serialized_objects.objects),i=function(e){var t={};return e.map(function(e){var n=e["class"][0];t[n]?t[n].push(e):t[n]=[e]}),t},a=function(e,t,s,r){if(!t.path_){t.path_=e+"/"+t["class"][0];var o=t.properties,d=[],l=RegExp("mp_var[ABCE]");if(Object.keys(o).map(function(e){l.test(e)===!0&&o[e].values[0].value&&d.push(e+"='"+o[e].values[0].value+"'")}),d.length>0){if(t.path_=t.path_||"",t.path_&&t.path_.lastIndexOf("]")===t.path_.length-1){var c=t.path_.lastIndexOf("[");t.path_=t.path_.substr(0,c)}t.path_+="[("+d.join(" AND ")+")]"}else r>1&&(t.path_+="["+s+"]");var p=[],h={},g="";if(t["class"].indexOf("UIView")>=0){var u=[];if(t.properties.subviews&&t.properties.subviews.values.length>0&&(u=t.properties.subviews.values[0].value),u.length>0){p=u.map(function(e){return n.filter(function(t){return t.id===e})[0]}),h=i(p);for(g in h)h.hasOwnProperty(g)&&(p=h[g],p.map(function(e,n){a(t.path_,e,n,p.length)}))}}else if(t["class"].indexOf("UIViewController")>=0){var v=t.properties.childViewControllers.values[0].value||[],f=t.properties.presentedViewController.values[0].value;null!==f&&v.push(f);var _=t.properties.isViewLoaded.values[0].value;if(_){var m=t.properties.view.values[0].value;null!==m&&v.push(m)}p=v.map(function(e){return n.filter(function(t){return t.id===e})[0]}),h=i(p);for(g in h)h.hasOwnProperty(g)&&(p=h[g],p.map(function(e,n){a(t.path_,e,n,p.length)}))}}},s=0,r=function(e,i,a,o,d){s++;var l=n[e],c=l["class"],p=l.properties,h="",g="",u=!1;c.indexOf("UIControl")>=0&&l.path_&&l.path_.length>1?(u=!0,h="UIControl"):c.indexOf("UITableView")>=0&&l.delegate&&l.delegate["class"]&&p.allowsSelection.values[0].value===!0&&(u=!0,g=l.delegate["class"],h="UITableView");var v=p.frame.values[0].value,f=p.bounds.values[0].value,_=i+v.X-o,m=a+v.Y-d;u&&t.push({eventType:h,controlEvent:0===l["class"].indexOf("UITextField")?262144:64,tableDelegate:g,path:l.path_,x:_,y:m,width:v.Width,height:v.Height,zIndex:s}),n.splice(e,1);var b=[];if(p.subviews&&p.subviews.values.length>0&&(b=p.subviews.values[0].value||[]),b.length>0)for(var w=0,k=b.length;k>w;w++)e=sensorsdata.findIndex(n,function(e){return e.id===b[w]}),r(e,_,m,f.X,f.Y)},o=sensorsdata.findIndex(n,function(t){return t.id===e.serialized_objects.rootObject}),d=n[o],l=n.filter(function(e){return e.id===d.properties.rootViewController.values[0].value})[0];return a("",l,0,1,[]),r(o,0,0,0,0),t},sensorsdata.VisualTrackingManager.prototype.renderApp_=function(e,t){var n=parseInt(this.clientScreen_.width,10),i=this;this.panelAppRefreshing_.hide(),this.panelAppConnect_.hide(),this.panelAppSnapshot_.css("display","block");var a=this.panelAppDefine_.width(),s=JSON.stringify(t);s!==i.controlsUniq_&&i.panelAppSnapshot_.find("span[data-control-path]").remove();var r=$("#canvas-snapshot"),o=new Image;o.onload=function(){var e=r.width()/o.width;if(r.attr("width",o.width*e),r.attr("height",o.height*e),r[0].getContext("2d").drawImage(o,0,0,o.width,o.height,0,0,o.width*e,o.height*e),s===i.controlsUniq_)return void console.info("same controls, not render again.");e=1,n>a&&(e=r.width()/n),i.controls_=t,i.controlsUniq_=s;var d=t.map(function(t){var n=$.extend(!0,{},t);return n.x*=e,n.y*=e,n.width*=e,n.height*=e,n}),l=Mustache.render(i.tplControls_,{controls:d});i.panelAppSnapshot_.append(l)},r.css("width",n>a?a:n),o.src="data:image/jpeg;base64,"+e},sensorsdata.VisualTrackingManager.prototype.recoverAppControl_=function(){this.panelAppDefine_.find("span.selected").removeClass("selected")},sensorsdata.VisualTrackingManager.prototype.saveTrigger_=function(e,t){var n=this,i=this.panelAppDefine_.find("span.selected.trigger"),a=i.attr("data-control-path"),s={};s="iOS"===n.appClient_.$lib?{$lib:n.appClient_.$lib,$lib_version:n.appClient_.lib_version,$os:n.appClient_.os,$os_version:n.appClient_.os_version,control_event:parseInt(i.data("control-event"),10),event_name:e,event_type:i.attr("data-event-type"),table_delegate:i.attr("data-table-delegate"),path:a,properties:[]}:{path:JSON.parse(a),$lib:n.appClient_.$lib,event_name:e,event_type:i.attr("data-event-type"),properties:[]};var r=$("#canvas-snapshot")[0],o=r.toDataURL("image/jpeg"),d=r.getContext("2d"),l=i.attr("data-pos").split(",").map(function(e){return parseInt(e,10)});l[0]=l[0]<0?0:l[0],l[1]=l[1]<0?0:l[1],l[2]=l[2]>r.width?r.width:l[2],l[3]=l[3]>r.height?r.height:l[3],d.lineWidth="2",d.strokeStyle="red",d.rect(l[0],l[1],l[2],l[3]),d.stroke();var c=r.toDataURL("image/jpeg"),p=new Image;p.src=o,d.drawImage(p,0,0);var h={id:-(moment().valueOf()%1e6),event_name:e,lib:n.appClient_.$lib,config:JSON.stringify(s),snapshot:c},g=sensorsdata.findIndex(this.vEvents_,function(t){return t.name===e});if(-1===g){var u={id:-1,name:e,cname:t||e,isSameName:!t||t===e,triggers:[h]};n.vEvents_.push(u),n.renderNewTrigger_(u)}else h.no_=n.vEvents_[g].triggers.length+2,n.vEvents_[g].cname=t,n.vEvents_[g].triggers.push(h),n.renderNewTrigger_(n.vEvents_[g]);n.recoverAppControl_(),n.bindEvents_()},sensorsdata.VisualTrackingManager.prototype.renderNewTrigger_=function(e){var t=this;e=$.extend(!0,{},e),e.triggers=e.triggers.filter(function(e){return e.lib===t.activeLib_}),e.renderName=e.name.replace(/\$/g,"-");var n=e.triggers[e.triggers.length-1];n.lib=this.appClient_.$lib,n.no_=e.triggers.length;var i=this.panelEvents_.find('div[data-event-name="'+e.name+'"]');if(1===i.size()){var a=Mustache.render(this.tplTrigger_,n);i.find(".panel-body ul").append(a)}else i=$(Mustache.render(this.tplEvents_,{events:[e]},{tplTrigger:this.tplTrigger_})),this.panelEvents_.append(i).parent().show(),i.find(".collapse").unbind("show.bs.collapse").unbind("hide.bs.collapse").bind("show.bs.collapse",function(){$(this).parents("div[data-event-name]:first").find("a span").removeClass("icon-expand-down-single").addClass("icon-collapse-up-single")}).bind("hide.bs.collapse",function(){$(this).parents("div[data-event-name]:first").find("a span").removeClass("icon-collapse-up-single").addClass("icon-expand-down-single")});this.expandCollapse_(i.find(".collapse")),this.bindPopover_(i.find('li[data-trigger-id="'+n.id+'"]'),n.snapshot,!1),i.find(".panel-title a").addClass("new-trigger"),i.find('li[data-trigger-id="'+n.id+'"]').addClass("new-trigger"),t.btnDeploy_.removeAttr("disabled")},sensorsdata.VisualTrackingManager.prototype.renderDebugTrack_=function(e){var t=this;if(e=e.filter(function(e){return e&&e.payload&&e.payload.trigger_id}),0!==e.length){for(var n=function(e){for(var n=0,i=t.vEvents_.length;i>n;n++){var a=t.vEvents_[n].triggers.filter(function(t){return t.id===e
})[0];if(a)return a}return null},i=this.panelAppDefine_.find("span[data-control-path]"),a=this.panelEvents_.find("li[data-trigger-id]"),s=function(e,t){e.data("interval-id")&&(window.clearInterval(e.data("interval-id")),e.data("interval-id",0)),e.toggleClass(t);var n=window.setInterval(function(){e.toggleClass(t);var n=e.data("interval-times");n>=4&&(window.clearInterval(e.data("interval-id")),e.removeClass(t),e.data("interval-id",0)),e.data("interval-times",++n)},400);e.data("interval-id",n),e.data("interval-times",0)},r=function(e){var n=JSON.parse(e.config).path;"Android"===t.activeLib_&&(n=JSON.stringify(n));for(var r=0,o=i.size();o>r;r++)if(i.eq(r).attr("data-control-path")===n){s(i.eq(r),"vtrack-debug-control");break}var d=a.filter('[data-trigger-id="'+e.id+'"]');1===d.size()&&(d.is(":visible")||(d=d.parents("div[data-event-name]:first").find("h4.panel-title")),s(d,"vtrack-debug-trigger"))},o=0,d=e.length;d>o;o++){var l=e[o],c=parseInt(l.payload.trigger_id,10),p=n(c);p&&r(p)}t.popTrackData_(e)}},sensorsdata.VisualTrackingManager.prototype.popTrackData_=function(e){for(var t=this,n=function(e,n,i){var a=Mustache.render(t.tplDebugTrack_,{time:moment(i).format("HH:mm:ss SSS"),eventNames:n,props:e});sensorsdata.trackInfo.show({content:a,clickFunc:function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.attr("data-method");"alert-fixed"===n&&(t.hasClass("on")?t.removeClass("on"):(t.addClass("on"),sensorsdata.trackInfo.hide(t)))},beforeHideFunc:function(e){return e.find('[data-method="alert-fixed"]').hasClass("on")}})},i=function(e,t,i){for(var a=sensorsdata.CONSTSET.eventEmptyValue,s=0,r=t.length;r>s;s++){var o=sensorsdata.findIndex(sensorsdata.cache.events,function(e){return e.name===t[s]});if(o>=0){a=t[s];break}}e=$.extend(!0,{},e),sensorsdata.ajax({useCache:!0,url:"event/"+a+"/properties?show_all=true",success:sensorsdata.bind(function(a){for(var s=[],r=0,o=a.event.length;o>r;r++){var d=a.event[r].name;e.hasOwnProperty(d)&&(s.push({key:d,value:e[d]}),delete e[d])}for(var l in e)e.hasOwnProperty(l)&&s.push({key:l,value:e[l]});n(s,t,i)},this)})},a={},s=0,r=e.length;r>s;s++){var o=e[s].payload,d=o.path;"Android"===t.activeLib_&&(d=JSON.stringify(d));var l=sensorsdata.findEventCname(o.event.event,t.vEvents_);a[d]?-1===a[d].eventNames.indexOf(l)&&a[d].eventNames.push(l):a[d]={time:o.event.time,properties:o.event.properties,eventNames:[l]}}for(var c in a)a.hasOwnProperty(c)&&i(a[c].properties,a[c].eventNames,a[c].time)},sensorsdata.VisualTrackingManager.prototype.triggerLiMouseenter_=function(e){var t=this,n=$(e.target||e.srcElement);if(n=1===n.filter("[data-trigger-id]").size()?n:n.parents("li:first"),!n.attr("data-popover-exist")||!n.data("bs.popover")){var i=n.attr("data-trigger-id");return t.triggerImageCache_[i]?void t.bindPopover_(n,t.triggerImageCache_[i]):void sensorsdata.ajax({url:"vtrack/trigger/"+i,queueEnable:!0,queueOverwrite:!1,success:function(e){t.triggerImageCache_[i]=e.snapshot,t.bindPopover_(n,e.snapshot)}})}},sensorsdata.VisualTrackingManager.prototype.bindPopover_=function(e,t,n){var i="";t?(-1===t.indexOf("data:image/jpeg;base64,")&&(t="data:image/jpeg;base64,"+t),i='<img style="width:200px;" src="'+t+'"/>'):i=this.tplTriggerPicture_,e.popover({trigger:"hover",container:"body",title:"",content:i,html:!0,placement:"left auto",viewport:{selector:"body"},template:this.tplPopover_}),e.attr("data-popover-exist","yes"),n!==!1&&e.popover("show")},sensorsdata.VisualTrackingManager.prototype.popConfirm_=function(e,t,n,i){this.modalConfirm_.find("div.modal-body > h3").html(e),this.modalConfirm_.find("div.modal-body > p:first").html(i),this.modalConfirm_.unbind("click").bind("click",sensorsdata.bind(function(e){var i=$(e.target||e.srcElement);i.attr("data-method")||(i=i.parents("[data-method]:first"));var a=i.attr("data-method");switch(a){case"modal-ok":$.isFunction(t)&&(t(),this.modalConfirm_.modal("hide"));break;case"modal-close":$.isFunction(n)&&(n(),this.modalConfirm_.modal("hide"))}},this)),this.modalConfirm_.modal()},sensorsdata.VisualTrackingManager.prototype.expandCollapse_=function(e){e.size()>0&&0===e.filter('[aria-expanded="true"]').size()&&(this.panelEvents_.find('.panel-collapse.collapse[aria-expanded="true"]').collapse("hide"),e.collapse("show"))},sensorsdata.VisualTrackingManager.prototype.setOffline_=function(e){this.panelAppClient_.find("#device-status").text(sensorsdata.languages.get(e?"离线<!--{en}Offline-->":"在线<!--{en}Online-->"));var t=this.panelAppClient_.find('[data-method="manual-refresh"]'),n=this.panelAppClient_.find('[data-method="remove-client"]');e?(t.addClass("disabled"),n.removeClass("icon-disconnect").addClass("icon-disconnect-disabled")):(t.removeClass("disabled"),n.removeClass("icon-disconnect-disabled").addClass("icon-disconnect")),e&&this.turnAutoRefresh_(!1),this.offline_=e},sensorsdata.VisualTrackingManager.prototype.setManualRefreshing_=function(e){this.isManualRefresh_=e;var t=this.panelAppClient_.find('[data-method="manual-refresh"]');e?t.addClass("manual-refreshing"):t.removeClass("manual-refreshing")};