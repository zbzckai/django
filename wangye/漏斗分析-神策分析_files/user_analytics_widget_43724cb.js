var UserAnalytics=require("pages/userAnalytics/userAnalytics");sensorsdata.UserAnalyticsWidget=function(e){if($.isEmptyObject(e))throw"Init UserAnalyticsWidget error, parameter is empty.";if(e.configContainer instanceof jQuery==!1||e.contentContainer instanceof jQuery==!1)throw"Init UserAnalyticsWidget error, container is not jQuery object.";if(!$.isFunction(e.saveConfig))throw"Init UserAnalyticsWidget error, saveConfig is not function.";if($.isEmptyObject(e.widgetObj)||$.isEmptyObject(e.widgetObj.bookmark))throw"Init UserAnalyticsWidget error, widgetObj is empty.";this.configContainer_=e.configContainer,this.contentContainer_=e.contentContainer,this.bookmark_=e.widgetObj.bookmark,this.config_=e.config,this.saveConfig_=e.saveConfig,this.tplLoader_=$("#tpl-widget-loader").html(),this.tplContent_=$("#tpl-user-analytics-widget-content").html(),this.tplConfig_=$("#tpl-user-analytics-widget-config").html(),this.tplConfigType_=$("#tpl-user-analytics-widget-config-type").html(),this.tplSingleKeyInfo_=$("#tpl-user-analytics-widget-single-key-info").html(),this.tplkeyInfo_=$("#tpl-user-analytics-widget-content-key-info").html(),this.userObj_={},this.paramObj_={},this.rawObj_={},this.userProperties_=[],this.chart_=null,this.userAnalytics_=UserAnalytics,this.userRollObj_={},this.widgetTypes_=[{value:"number",text:sensorsdata.languages.get("数字<!--{en}Number-->"),icon:"icon-num"},{value:"line",text:sensorsdata.languages.get("线图<!--{en}Line chart-->"),icon:"icon-line-chart"},{value:"column",text:sensorsdata.languages.get("柱图<!--{en}Bar chart-->"),icon:"icon-bar-chart"},{value:"pie",text:sensorsdata.languages.get("饼图<!--{en}Pie chart-->"),icon:"icon-pie-chart"}],this.measureMap_={MAX:sensorsdata.languages.get("最大值<!--{en}Max value-->"),MIN:sensorsdata.languages.get("最小值<!--{en}Min value-->"),AVG:sensorsdata.languages.get("平均值<!--{en}Average value-->"),SUM:sensorsdata.languages.get("总和<!--{en}Total-->"),uniqAvg:sensorsdata.languages.get("人均值<!--{en}Value per capita-->"),uniqCount:sensorsdata.languages.get("去重数<!--{en}Deduplication-->")},this.measureUnits_=[],this.isOverRowsLimit_=!1,this.rowsLimit_=50,this.renderAllow_=!1,this.dataAlready_=!1,this.init()},sensorsdata.UserAnalyticsWidget.prototype.refresh=function(e,t){this.init(t)},sensorsdata.UserAnalyticsWidget.prototype.resize=function(){this.chart_&&$.isFunction(this.chart_.resize)&&this.chart_.resize()},sensorsdata.UserAnalyticsWidget.prototype.init=function(e){this.setEmpty_(this.tplloader_),this.paramObj_=JSON.parse(this.bookmark_.data);var t=this.paramObj_,s=this.paramObj_.by_fields||[];"boolean"==typeof e?t.use_cache=e:delete t.use_cache,this.userCache_={},this.config_.widgetType=this.paramObj_.chartsType,0===s.length&&(this.config_.widgetType="number");var i=this.config_.widgetX;i?t.x_axis_field=i:this.config_.widgetX=t.x_axis_field,0===s.length?(delete this.config_.widgetX,delete t.x_axis_field):t.x_axis_field&&-1===s.indexOf(t.x_axis_field)&&(this.config_.widgetX=s[0],t.x_axis_field=s[0]),sensorsdata.ajax({url:"property/user/properties",success:sensorsdata.bind(function(e){this.userProperties_=e,this.measureUnits_=this.userAnalytics_.buildMeasureUnits(t,this.userProperties_),this.measureName_=this.userAnalytics_.buildMeasureName(t,this.userProperties_),this.renderConfig_(this.config_),this.changeRedirectUrl_(),this.getWidgetData_(this.config_)},this)})},sensorsdata.UserAnalyticsWidget.prototype.getDisplayTypes_=function(e,t){var s=[];return e||t?(s.push("line"),s.push("column"),s.push("pie")):s.push("number"),s},sensorsdata.UserAnalyticsWidget.prototype.getWidgetData_=function(e){var t=this.paramObj_,s=e.widgetX,i=(t.by_fields||[]).length>0,a=[],r=sensorsdata.bind(function(){if(!$.isEmptyObject(this.userObj_)&&i){a=this.userObj_.rows.map(function(e){return e.name});var t=[];$.isArray(e.widgetByValues)&&0!==e.widgetByValues.length?(e.widgetByValues.map(function(e){a.indexOf(e)>=0&&t.push(e)}),0===t.length&&(t=a.slice(0,3))):t=a.slice(0,3),this.config_.widgetByValues=t}},this),n=sensorsdata.bind(function(){if(!$.isEmptyObject(this.userRollObj_)){a=this.userRollObj_.rows.map(function(e){return e.name});var t=[];$.isArray(e.widgetByValues)&&0!==e.widgetByValues.length?(e.widgetByValues.map(function(e){a.indexOf(e)>=0&&t.push(e)}),0===t.length&&(t=a.slice(0,3))):t=a.slice(0,3),this.config_.widgetByValues=t}},this),o=sensorsdata.bind(function(){$.isEmptyObject(this.userObj_)||(this.config_.widgetIndex=this.userObj_.series.length-1)},this),l=sensorsdata.bind(function(){r(),o(),this.seriesLen_=this.userObj_.series.length,this.renderAllow_===!0&&this.renderContent_(this.config_)},this),d=sensorsdata.bind(function(){n(),this.renderAllow_===!0&&this.renderContent_(this.config_)},this);$.isEmptyObject(this.userCache_[s])||$.isEmptyObject(this.userCache_.rollup)?(this.setEmpty_(this.tplLoader_),"pie"===e.widgetType?this.getRollData_(d):this.getData_(t,s,l)):$.isEmptyObject(this.userCache_.rollup)||(this.setEmpty_(this.tplLoader_),"pie"===e.widgetType?(this.userRollObj_=this.userCache_.rollup,d()):(this.setEmpty_(this.tplLoader_),this.userObj_=this.userCache_[s],l()))},sensorsdata.UserAnalyticsWidget.prototype.renderConfig_=function(e){var t=this.paramObj_,s=(t.by_fields||[]).length>0,i=t.x_axis_field,a={},r=[];if(s){var n=sensorsdata.bind(function(e,t){var i=this.getDisplayTypes_(e,s),a=$.extend(!0,[],this.widgetTypes_),r=-1,n=-1;return a.map(function(e,s){e.display=-1!==i.indexOf(e.value),e.display&&e.value===t&&(r=s),e.display&&-1===n&&(n=s)}),-1!==r?a[r].active=!0:-1!==n&&(a[n].active=!0),1===i.length&&(a[n].display=!1),a},this);if(s){for(var o=t.by_fields,l={},d=0;d<o.length;d++)r.push(sensorsdata.findProperty(o[d],[{user:this.userProperties_}]));l=sensorsdata.findProperty(i,[{user:this.userProperties_}]),a=$(Mustache.render(this.tplConfig_,{unit:"user."+l.name,unitText:l.cname,group:r})),this.configContainer_.html(a),this.configContainer_.find("#widgetX").parent().prop("disabled",1===o.length||"pie"===t.chartsType)}this.configContainer_.find('a[data-value="'+e.widgetX+'"]').parent().addClass("active");var h=this.configContainer_.find("span#widgetX"),c=h.parents("div:first");c.on("click","ul a",sensorsdata.bind(function(e){var t=$(e.target||e.srcElement),s=t.attr("data-value"),i=t.parents("li:first");if(!i.hasClass("active")&&!i.hasClass("disabled")&&(i.addClass("active").siblings(".active").removeClass("active"),h.attr("data-value")!==s)){h.attr("data-value",s),h.html(c.find('ul a[data-value="'+s+'"]').html());var a=Mustache.render(this.tplConfigType_,{types:n(s,this.config_.widgetType)}),r=this.configContainer_.find("div#widgetType").html(a).find("span.active").attr("data-value");this.config_.widgetX=s,this.config_.widgetType=r,this.getWidgetData_(this.config_),this.saveConfig_(this.config_),this.changeRedirectUrl_()}},this));var u=Mustache.render(this.tplConfigType_,{types:n(e.widgetX,e.widgetType)});this.configContainer_.find("div#widgetType").html(u).bind("click",sensorsdata.bind(function(e){var s=$(e.target||e.srcElement);if("widgetType"===s.attr("data-method")){var i=s.attr("data-value");s.siblings().removeClass("active"),s.addClass("active");var a=s.parent().parent(),r=a.find("#widgetX").attr("data-value");this.config_.widgetType=i,a.find("button").prop("disabled",1===t.by_fields.length||"pie"===i),this.config_.widgetX=r,this.getWidgetData_(this.config_),this.saveConfig_(this.config_),this.changeRedirectUrl_()}},this))}},sensorsdata.UserAnalyticsWidget.prototype.changeRedirectUrl_=function(){var e="line";if(this.paramObj_.chartsType){("column"===this.config_.widgetType||"pie"===this.config_.widgetType)&&(e=this.config_.widgetType),"number"!==this.config_.widgetType||this.config_.widgetX||(e="pie");var t=$.extend(!0,{},this.paramObj_);t.chartsType=e,t[sensorsdata.CONSTSET.bookmarkId]=this.bookmark_.id;var s=this.bookmark_.type+"#"+$.param(t);this.contentContainer_.parents("article.dashboard-widget:first").find("header h4[data-href]").attr("data-href",s)}},sensorsdata.UserAnalyticsWidget.prototype.getData_=function(e,t,s){var i="user/report?bookmarkId="+this.bookmark_.id,a=this.userAnalytics_.validResponse;e.limit=this.rowsLimit_+1,e.ignore_cache_expire=!0,this.rawObj_={},void 0!==t&&(e.x_axis_field=t),sensorsdata.reportAjax({queueEnable:!0,url:i,method:"post",data:this.userAnalytics_.clearAjaxData(e),customErrorStatusCode:422,error:sensorsdata.bind(function(e){var s=sensorsdata.buildAjaxError(e.status,e.responseJSON);this.setEmpty_(s),this.userCache_[t]=this.userObj_={}},this),success:sensorsdata.bind(function(i){return a(i)?(this.dataAlready_=!0,this.rawObj_=$.extend(!0,{},i),this.isOverRowsLimit_=i.rows.length>this.rowsLimit_,i.rows.splice(this.rowsLimit_),this.userCache_[t]=this.userObj_=this.convertAjaxModel(this.paramObj_,i,[{user:this.userProperties_}],this.buildMeasureName(e),e.bucket_params),void($.isEmptyObject(this.userObj_)?this.setEmpty_(sensorsdata.languages.get("查询结果为空<!--{en}The query results are empty-->")):s())):void sensorsdata.error.show("数据格式错误，请联系技术人员")},this)})},sensorsdata.UserAnalyticsWidget.prototype.getRollData_=function(e){this.userRollObj_={};var t=this.paramObj_,s=t.x_axis_field;t.limit=this.rowsLimit_+1;var i="user/report?bookmarkId="+this.bookmark_.id;t.x_axis_field&&delete t.x_axis_field;var a=t;return t.ignore_cache_expire=!0,sensorsdata.reportAjax({queueEnable:!0,url:i,method:"POST",data:a,customErrorStatusCode:422,error:sensorsdata.bind(function(e){var t=sensorsdata.buildAjaxError(e.status,e.responseJSON);this.setEmpty_(t),this.userCache_.rollup=this.userRollObj_={}},this),success:sensorsdata.bind(function(i){this.dataAlready_=!0,this.isOverRollRowsLimit_=i.rows.length>this.rowsLimit_,i.rows.splice(this.rowsLimit_),this.rawRollUserObj_=$.extend(!0,{},i),this.userCache_.rollup=this.userRollObj_=this.converPieAjaxModel(i,[{user:this.userProperties_}],this.buildMeasureName(t),t.bucket_params),t.x_axis_field=s,$.isEmptyObject(this.userRollObj_)?this.setEmpty_(this.tplloader_):e()},this)})},sensorsdata.UserAnalyticsWidget.prototype.buildMeasureName=function(e){var t=e.measures[0],s=t.aggregator,i=t.field,a="";if("count"===s)a+=sensorsdata.languages.get("用户数<!--{en}User Number-->");else{var r=sensorsdata.findProperty(i,[{user:this.userProperties_}]),n=this.measureMap_[s];a=a.concat(r.cname,sensorsdata.languages.get("的<!--{en} . -->"),n)}return a},sensorsdata.UserAnalyticsWidget.prototype.convertAjaxModel=function(e,t,s,i,a){if(!$.isEmptyObject(t)&&$.isArray(t.series)&&0!==t.series.length&&$.isArray(t.rows)&&0!==t.rows.length){var r={series:[],rows:[],num:t.num_rows},n=(t.by_fields||[]).length,o=i;return t.rows.map(sensorsdata.bind(function(e){n>0&&(o=UserAnalytics.buildByValueText(t.by_fields,e.by_values,s,a)),r.rows.push({name:o,data:e.values})},this)),$.isArray(t.series)&&t.series.length>0&&t.series.map(sensorsdata.bind(function(t){var i=UserAnalytics.buildTableByValueText(t,e.x_axis_field,s,a);r.series.push(i)},this)),r}},sensorsdata.UserAnalyticsWidget.prototype.converPieAjaxModel=function(e,t,s,i){if(!$.isEmptyObject(e)&&$.isArray(e.series)&&0!==e.series.length&&$.isArray(e.rows)&&0!==e.rows.length){var a={series:[],rows:[],num:e.num_rows},r=(e.by_fields||[]).length,n=s;return e.rows.map(sensorsdata.bind(function(s){r>0&&(n=UserAnalytics.buildPieByValueText(e.by_fields,s.by_values,t,i)),a.rows.push({name:n,data:s.values})},this)),a}},sensorsdata.UserAnalyticsWidget.prototype.renderContent_=function(e){this.clearChart_(),this.contentContainer_.removeClass("no-display").html(this.tplContent_),this.renderToolbar_(e),this.renderKeyInfo_(e),this.renderChart_(e)},sensorsdata.UserAnalyticsWidget.prototype.renderToolbar_=function(e){var t="",s=e.widgetType,i=e.widgetIndex,a=e.widgetByValues,r=this.contentContainer_.find("div#toolbar-container"),n=this.paramObj_,o=[],l=(n.by_fields||[]).length>0;if(!($.isEmptyObject(e)||"pie"===s&&$.isEmptyObject(this.userRollObj_)||"pie"!==s&&$.isEmptyObject(this.userObj_)||void 0===n.by_fields)){"pie"===s?o=this.userRollObj_.rows.map(function(e){return e.name}):l&&n.by_fields.length>1&&"pie"!==s&&(o=this.userObj_.rows.map(function(e){return e.name}));var d="";"pie"!==s&&(d=sensorsdata.trimConstHtml(this.userObj_.series[i]));var h=function(e){e?r.find("li.filter").addClass("disabled").find('input[type="text"].multiselect-search').attr("disabled","disabled").attr("placeholder","最多显示3组数据"):r.find("li.filter").removeClass("disabled").find('input[type="text"].multiselect-search').removeAttr("disabled").attr("placeholder",sensorsdata.languages.get("搜索<!--{en}Search-->"))},c=function(e){r.find(":checkbox").each(function(t,s){s=$(s);var i=parseInt(s.val(),10);e.length<3?(s.removeAttr("disabled"),s.parents("li:first").removeClass("disabled")):-1===e.indexOf(i)&&(s.attr("disabled","disabled"),s.parents("li:first").addClass("disabled"))})},u="";(l&&1===n.by_fields.length&&"pie"===s||l&&n.by_fields.length>1)&&("pie"===s||$.isEmptyObject(this.userObj_)?"pie"!==s||$.isEmptyObject(this.userRollObj_)||(u=sensorsdata.languages.get(this.isOverRollRowsLimit_?"前<!--{en}before-->":"共<!--{en}in total-->")+this.userRollObj_.rows.length+sensorsdata.languages.get("组<!--{en}group-->")):u=sensorsdata.languages.get(this.isOverRowsLimit_?"前<!--{en}before-->":"共<!--{en}in total-->")+this.userObj_.rows.length+sensorsdata.languages.get("组<!--{en}group-->")),t=$("#tpl-user-analytics-widget-toolbar-by-select").html();var _=$("#tpl-user-analytics-widget-toolbar-by-select-ul").html(),g={timeText:d,byValues:o.map(function(e,t){return{index:t,value:e,disabled:-1===a.indexOf(e)}})},p=Mustache.render(t,g);r.html(p).show(),"pie"!==s&&l&&1===n.by_fields.length&&r.find("#by-select").html("");var y=r.find("select");y.multiselect("destroy"),y.multiselect({nonSelectedText:u,enableFiltering:!0,templates:{ul:_},buttonText:function(){return u},onChange:sensorsdata.bind(function(){var e=[],t=[];r.find(":checkbox:checked").each(function(s,i){var a=parseInt($(i).val(),10);t.push(o[a]),e.push(a)}),this.config_.widgetByValues=t,this.renderKeyInfo_(this.config_),this.renderChart_(this.config_),h(t.length>=3),c(e)},this)});var f=a.map(function(e){return o.indexOf(e)});y.multiselect("select",f),h(a.length>=3),c(f)}},sensorsdata.UserAnalyticsWidget.prototype.renderNumber_=function(){if(!$.isEmptyObject(this.userObj_)){var e=this.userObj_.rows[0].data[0][0],t=this.userObj_.rows[0].name,s=this.paramObj_.measures[0].aggregator,i="count"===s?sensorsdata.languages.get("人<!--{en}People-->"):"",a=this.contentContainer_.find("div#widget-chart-container");a.removeClass("display-none");var r={info:$.isNumeric(e)?sensorsdata.formatNumber(e):"--",unit:i},n=Mustache.render(this.tplSingleKeyInfo_,{values:r});a.html(n);var o=Mustache.render($("#tpl-user-analytics-widget-toolbar-text").html(),{texts:t});this.contentContainer_.find("div#toolbar-container").html(o).show()}},sensorsdata.UserAnalyticsWidget.prototype.renderKeyInfo_=function(e){var t=this.userObj_,s=e.widgetIndex,i=e.widgetByValues||[],a=e.widgetX,r=this.contentContainer_.find("div#keyinfo-container"),n=e.widgetType;if(!($.isEmptyObject(e)||"pie"===n&&$.isEmptyObject(this.userRollObj_)||"pie"!==n&&$.isEmptyObject(this.userObj_))){if("pie"===n||!a)return void r.addClass("display-none").html("");r.removeClass("display-none");for(var o=function(e){return e.data[s]&&null!==e.data[s][0]?e.data[s][0]:"--"},l=[],d=this.measureUnits_[0],h={isChart:"number"!==e.widgetType},c=0;c<i.length;c++){var u=i[c],_=t.rows.filter(function(e){return e.name===u})[0];if(_){var g=[{value:o(_),unit:d}];l.push({values:g,tip:_.name})}}var p=Mustache.render(this.tplkeyInfo_,{tips:l,style:h});r.html(p)}},sensorsdata.UserAnalyticsWidget.prototype.render=function(){this.renderAllow_=!0,this.dataAlready_&&this.renderContent_(this.config_)},sensorsdata.UserAnalyticsWidget.prototype.renderChart_=function(e){if(!($.isEmptyObject(e)||$.isEmptyObject(this.userObj_)&&"pie"!==e.widgetType||$.isEmptyObject(this.userRollObj_)&&"pie"===e.widgetType))switch(this.clearChart_(),e.widgetType){case"line":this.chart_=new sensorsdata.UserAnalyticsLineChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues);break;case"column":this.chart_=new sensorsdata.UserAnalyticsBarChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues);break;case"pie":this.chart_=new sensorsdata.UserAnalyticsPieChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues);break;case"number":this.renderNumber_()}},sensorsdata.UserAnalyticsWidget.prototype.buildChartOption_=function(){var e=this.paramObj_,t=this.userObj_,s=this.rawObj_,i=this.userRollObj_,a={container:this.contentContainer_.find("div#widget-chart-container"),limit:3,queryData:e,userObj_:t,rawObj_:s,userRollObj_:i,widgetModel:!0,measureUnit:this.measureUnits_,measureName:this.measureName_,onPointChanged:sensorsdata.bind(this.changeXAxis_,this)};return a},sensorsdata.UserAnalyticsWidget.prototype.changeXAxis_=function(e){e>=0&&e!==this.config_.widgetIndex&&(this.config_.widgetIndex=e,this.renderToolbar_(this.config_),this.renderKeyInfo_(this.config_))},sensorsdata.UserAnalyticsWidget.prototype.clearChart_=function(){this.chart_&&$.isFunction(this.chart_.destroy)&&this.chart_.destroy()},sensorsdata.UserAnalyticsWidget.prototype.setEmpty_=function(e){this.clearChart_(),this.contentContainer_.addClass("no-display").html(e||sensorsdata.languages.get("没有查询到数据<!--{en}No data-->"))};