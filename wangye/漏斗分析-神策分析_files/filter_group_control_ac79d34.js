sensorsdata.FilterGroupControl=function(){this.tplCond_=$("#tpl-filter-condition").html(),this.tplCondItem_=$("#tpl-filter-condition-item").html(),this.tplCondItemProp_=$("#tpl-filter-condition-item-property").html(),this.tplCondItemFunc_=$("#tpl-filter-condition-item-function").html(),this.filterObj_=null,this.eventMap_={valueChangedEvent:[],allRemovedEvent:[],inputKeyupEvent:[]},this.lastValue_={},this.defaultOptions_={label:{title:"",beforePro:[],multiple:{nonSelectedText:sensorsdata.languages.get("请选择属性值<!--{en}Please select a property value-->"),filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->")},property:{eventGroup:sensorsdata.languages.get("事件属性<!--{en}Event properties-->"),userGroup:sensorsdata.languages.get("用户属性<!--{en}User properties-->")},input:{numberSplit:sensorsdata.languages.get("与<!--{en}between-->"),numberTail:sensorsdata.languages.get("之间<!--{en}and-->"),dateOn:sensorsdata.languages.get("在<!--{en}During-->"),dateDay:sensorsdata.languages.get("天<!--{en}Day-->"),dateAfter:sensorsdata.languages.get("之内<!--{en}in-->"),dateBefore:sensorsdata.languages.get("之前<!--{en}Before-->"),dateBetween:sensorsdata.languages.get("之间<!--{en}and-->"),contain:sensorsdata.languages.get("包含<!--{en}includes-->"),notContain:sensorsdata.languages.get("不含<!--{en}Exclude-->"),thisWeek:sensorsdata.languages.get("当周<!--{en}This week-->"),thisDay:sensorsdata.languages.get("当天<!--{en}This day-->"),thisMonth:sensorsdata.languages.get("当月<!--{en}This month-->"),dateLater:sensorsdata.languages.get("之后<!--{en}After-->")},help:[]},timeUnit:{second:sensorsdata.languages.get("秒<!--{en}second-->"),minute:sensorsdata.languages.get("分<!--{en}minute-->"),hour:sensorsdata.languages.get("小时<!--{en}Hour-->"),day:sensorsdata.languages.get("天<!--{en}Day-->"),week:sensorsdata.languages.get("周<!--{en}Week-->"),month:sensorsdata.languages.get("月<!--{en}Month-->"),year:sensorsdata.languages.get("年<!--{en}year-->")},timeType:"",disabled:!1,container:null,showRelation:!0,disableRelation:!1,showRemoveButton:!0,showPropertyHelp:!1,propertyObj:{event:[],session:[],user:[]},relations:[{name:"and",cname:sensorsdata.languages.get("且<!--{en}and-->")},{name:"or",cname:sensorsdata.languages.get("或<!--{en}or-->")}],templates:{li:$("#tpl-filter-by-multi-li").html()},excludeFunctions:[],functions:{dict:[{name:"equal",cname:sensorsdata.languages.get("等于<!--{en}equals to-->")},{name:"notEqual",cname:sensorsdata.languages.get("不等于<!--{en}does not equal to-->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}],number:[{name:"equal",cname:sensorsdata.languages.get("等于<!--{en}equals to-->")},{name:"notEqual",cname:sensorsdata.languages.get("不等于<!--{en}does not equal to-->")},{name:"less",cname:sensorsdata.languages.get("小于<!--{en}less than-->")},{name:"greater",cname:sensorsdata.languages.get("大于<!--{en}greater than-->")},{name:"between",cname:sensorsdata.languages.get("区间<!--{en}range-->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}],string:[{name:"equal",cname:sensorsdata.languages.get("等于<!--{en}equals to-->")},{name:"notEqual",cname:sensorsdata.languages.get("不等于<!--{en}does not equal to-->")},{name:"contain",cname:sensorsdata.languages.get("包含<!--{en}includes-->")},{name:"notContain",cname:sensorsdata.languages.get("不包含<!--{en}excludes-->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")},{name:"isEmpty",cname:sensorsdata.languages.get("为空<!--{en}null -->")},{name:"isNotEmpty",cname:sensorsdata.languages.get("不为空<!--{en}not null-->")},{name:"rlike",cname:sensorsdata.languages.get("正则匹配<!--{en}Regular matches-->")},{name:"notrlike",cname:sensorsdata.languages.get("正则不匹配<!--{en}Regular mismatches-->")}],list:[{name:"in",cname:sensorsdata.languages.get("包含<!--{en}includes-->")},{name:"notInclude",cname:sensorsdata.languages.get("不包含<!--{en}excludes-->")},{name:"isEmpty",cname:sensorsdata.languages.get("为空<!--{en}null -->")},{name:"isNotEmpty",cname:sensorsdata.languages.get("不为空<!--{en}not null-->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}],date:[{name:"absolute_between",cname:sensorsdata.languages.get("绝对时间<!--{en}Absolute time-->")},{name:"relative",cname:sensorsdata.languages.get("相对当前时间点<!--{en}Be relative to current time -->")},{name:"relative_between",cname:sensorsdata.languages.get("相对当前时间区间<!--{en}Be relative to current time range-->")},{name:"relative_event_time",cname:sensorsdata.languages.get("相对事件发生时间<!--{en}Be relative to event occurrence time -->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}],datetime:[{name:"absolute_between",cname:sensorsdata.languages.get("绝对时间<!--{en}Absolute time-->")},{name:"relative",cname:sensorsdata.languages.get("相对当前时间点<!--{en}Be relative to current time -->")},{name:"relative_between",cname:sensorsdata.languages.get("相对当前时间区间<!--{en}Be relative to current time range-->")},{name:"relative_event_time",cname:sensorsdata.languages.get("相对事件发生时间<!--{en}Be relative to event occurrence time -->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}],bool:[{name:"isTrue",cname:sensorsdata.languages.get("为真<!--{en}True-->")},{name:"isFalse",cname:sensorsdata.languages.get("为假<!--{en}False-->")},{name:"isSet",cname:sensorsdata.languages.get("有值<!--{en}has value -->")},{name:"notSet",cname:sensorsdata.languages.get("没值<!--{en}has no value-->")}]}},this.options_={},this.autoSuggestLength_=10,this.autoRefresh_=!0,this.itemGroups_=[]},sensorsdata.FilterGroupControl.prototype.init=function(e){if(!(e.container instanceof jQuery)||0===e.container.length||$.isEmptyObject(e.propertyObj))return void console.log("sensorsdata.FilterGroupControl init failed, parameters is errors.");this.options_=$.extend(!0,{},this.defaultOptions_),$.extend(!0,this.options_,e);var t=this.options_;if($.isEmptyObject(e.functions)||(t.functions=e.functions),$.isArray(t.excludeFunctions)&&t.excludeFunctions.length>0)for(var a in t.functions)t.functions.hasOwnProperty(a)&&(t.functions[a]=t.functions[a].filter(function(e){return-1===t.excludeFunctions.indexOf(e.name)}));this.itemGroups_=sensorsdata.convertProperty(t.propertyObj,!1);var n=this;this.itemGroups_=this.itemGroups_.map(function(e){return e=n.setDictPropType(e)}),this.filterObj_=null,t.container.html("").off("click.FilterGroupControl").on("click.FilterGroupControl",sensorsdata.bind(this.holdPlaceClick_,this))},sensorsdata.FilterGroupControl.prototype.setDictPropType=function(e){return $.isEmptyObject(e)?e:($.isArray(e.items)&&e.items.length>0&&e.items.map(function(e){e.has_dict&&(e.data_type="string")}),e)},sensorsdata.FilterGroupControl.prototype.val=function(e){if(e)return this.setValue_($.extend(!0,{},e||{}));var t=this.getValue_();return $.extend(!0,{},t)},sensorsdata.FilterGroupControl.prototype.updateHelpLabel=function(e){if(!$.isArray(e)||0===e.length)return!1;var t=this.getLineLength_();if(0===t)return!1;for(var a=this.filterObj_.find(".filter-contain").children(),n=0;t>n&&n<e.length;n++)a.eq(n).find("span.icon-help").attr("data-original-title",e[n])},sensorsdata.FilterGroupControl.prototype.getPropObj=function(){return this.options_.propertyObj},sensorsdata.FilterGroupControl.prototype.changeTimeType=function(e){if(this.filterObj_&&this.filterObj_ instanceof jQuery&&e!==this.options_.timeType){this.options_.timeType=e;var t=this;this.filterObj_.find(".filter-contain div.filter-item").each(function(){t.renderFunc_($(this))})}},sensorsdata.FilterGroupControl.prototype.addFilter=function(e,t,a){if(!$.isEmptyObject(e)){var n=this.findProperty_(e.field,!0);if(n.fullName!==e.field){var s=n.funnel_step>=-1,i=e.field.split(".");n={},s&&!$.isNumeric(i[0])&&("user"===i[0]?n=this.options_.propertyObj.user.filter(function(e){return e.name===i[1]})[0]:"event"===i[0]?n=this.options_.propertyObj.event.filter(function(e){return e.event_name===i[1]&&e.name===i[2]})[0]:"session"===i[0]&&(n=this.options_.propertyObj.session.filter(function(e){return e.event_name===i[1]&&e.name===i[2]})[0]))}if($.isEmptyObject(n))return sensorsdata.info.show(sensorsdata.util.format(sensorsdata.languages.get("属性 #{field} 已经不存在，已从过滤中删除<!--{en}Property#{field} does not exist, and has been deleted from the filter-->"),e)),!1;e.field=n.fullName}var r=this.options_;this.filterObj_||(this.filterObj_=$(Mustache.render(this.tplCond_,{showRelation:r.showRelation,disableRelation:r.disableRelation,label:r.label})),this.options_.container.append(this.filterObj_),this.options_.disabled===!0&&this.filterObj_.find("button,input,select").attr("disabled",!0));var o=this.getLineLength_(),l=r.label,d={label:r.label,labelBeforePro:l.beforePro.length>o?l.beforePro[o]:"",labelHelp:l.help.length>o?l.help[o]:"",showRemoveButton:r.showRemoveButton,showPropertyHelp:r.showPropertyHelp},u=$(Mustache.render(this.tplCondItem_,d));this.filterObj_.find(".filter-contain").append(u);var p=function(){t!==!1&&setTimeout(sensorsdata.bind(function(){u.find("div.property button.multiselect").click()},this),100)};return this.renderFilter_(u,e||{}),p(),a!==!1&&this.execEvent_("valueChangedEvent"),!0},sensorsdata.FilterGroupControl.prototype.renderFilter_=function(e,t){this.renderProperty_(e,this.findProperty_(t.field,!0)),this.renderFunc_(e,t);var a=this.getLineLength_();this.options_.showRelation===!0&&a>=1&&(this.filterObj_.find("button[data-relation]").attr("data-relation")||this.setRelation_(),this.toggleRelation_()),this.initEnterEvent_(e),e.find('[data-toggle="tooltip"]').tooltip({container:"body"}),this.options_.disabled===!0&&e.find("button,input,select").attr("disabled",!0)},sensorsdata.FilterGroupControl.prototype.initEnterEvent_=function(e){e.find('input[type="text"]').bind("keydown.sensorsdata",sensorsdata.bind(function(e){var t=$(e.target||e.srcElement);t.is(":focus")&&13===e.keyCode&&this.execEvent_("valueChangedEvent")},this))},sensorsdata.FilterGroupControl.prototype.setRelation_=function(e){var t=this.options_;if(t.showRelation===!0&&this.filterObj_){var a=e?this.byName_(t.relations,e):t.relations[0];this.filterObj_.find("button[data-relation]").attr("data-relation",a.name).text(a.cname)}},sensorsdata.FilterGroupControl.prototype.renderProperty_=function(e,t){var a=e.find("div.property"),n=a.find("select");n.html(Mustache.render(this.tplCondItemProp_,this.itemGroups_)),n.multiselect("destroy");var s={templates:this.options_.templates,includeFilterClearBtn:!1,enableFiltering:!0,syncButtonAndGroup:!0,maxHeight:490,nonSelectedText:this.options_.label.multiple.nonSelectedText,filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->"),onChange:sensorsdata.bind(function(){var t=this.getSelectProperty_(e);this.renderFunc_(e),this.execEvent_("valueChangedEvent"),this.renderPropertyHelp_(e,t),"date"===t.data_type||"datetime"===t.data_type?e.find("span.selected.date-type").click():"list"===t.data_type?e.find("div.input").find('input[type="text"]:visible:first').focus():setTimeout(function(){e.find("div.function button:visible").click()},100)},this)};$.isFunction(this.options_.buttonText)&&(s.buttonText=this.options_.buttonText),n.multiselect(s),a.find("input:radio").each(function(e,t){t=$(t),"true"===t.attr("data-dict")&&t.parents("a:first").find("span:last").attr("class","icon-data-type-dict")}),n.multiselect("select",t.fullName),this.renderPropertyHelp_(e,t),e.find("div.function").show()},sensorsdata.FilterGroupControl.prototype.renderPropertyHelp_=function(e,t){if(this.options_.showPropertyHelp){var a="";t.funnel_step>=0?a=sensorsdata.util.format(sensorsdata.languages.get("以每个用户首次最长转化状态中的第 #{step} 步骤的 #{cname} 进行筛选<!--{en}Filter by the #{cname} of the #{step} step of each user's first longest conversion state-->"),{step:t.funnel_step+1,cname:t.cname,name:t.name}):-1===t.funnel_step&&t.event_name&&(a=sensorsdata.util.format(sensorsdata.languages.get("以每个用户任意步骤的 #{cname} 的首次有效值进行筛选<!--{en}Filter by the first valid value of #{cname} of each user's arbitrary step-->"),t)),e.find("div.property span.icon-help").toggle(!!a).attr("data-original-title",a).tooltip({container:"body"})}},sensorsdata.FilterGroupControl.prototype.getLineLength_=function(){return this.filterObj_?this.filterObj_.find(".filter-contain").children().size():0},sensorsdata.FilterGroupControl.prototype.bindEvent=function(e,t){$.isArray(this.eventMap_[e])&&this.eventMap_[e].push(t)},sensorsdata.FilterGroupControl.prototype.holdPlaceClick_=function(e){var t=this,a=$(e.target||e.srcElement),n=a.attr("data-method");n||(a=a.parents("[data-method]:first"),n=a.attr("data-method"));var s=a.parents("div.filter-item:first"),i=function(){var e=a.parents("div:first").find(".selected");return e.attr("data-value")!==a.attr("data-value")?(e.text(a.text()),e.attr("data-value",a.attr("data-value")),a.attr("data-type")?e.attr("data-type",a.attr("data-type")):e.removeAttr("data-type"),!0):!1};switch(n){case"relation":this.execEvent_("valueChangedEvent");var r=a.attr("data-relation"),o=this.indexOf_(this.options_.relations,r),l=this.options_.relations[0===o?1:0];a.attr("data-relation",l.name).text(l.cname),this.execEvent_("valueChangedEvent");break;case"condition-func":i()&&(this.renderInput_(s),this.execEvent_("valueChangedEvent"),s.find('div.input input[type="text"]:visible:first').focus());break;case"condition-remove":s.remove(),this.toggleRelation_(),this.execEvent_("valueChangedEvent"),0===this.filterObj_.find(".filter-contain div.filter-item").size()&&(this.filterObj_.remove(),this.filterObj_=null,this.execEvent_("allRemovedEvent"));break;case"date-input-inout":i()&&this.updateDateInputTooltip(s.find("div.input input[data-days]:visible:first"),s,!1),this.execEvent_("valueChangedEvent");break;case"tagsinput-edit":var d=s.find(".property button").text().trim(),u=s.find(".function button").text().trim(),p=$(Mustache.render($("#tpl-common-modal").html(),{title:d+u,content:$("#tpl-tagsinput-edit").html()})),c=a.prev(),m=p.find('input[name="tagsinput-split"]'),f=p.find("textarea");f.val(c.tagsinput("items").join("\n"));var h=function(e){return"comma"===e?sensorsdata.util.csvToArray(f.val()).filter(function(e){return!!$.trim(e)}):"crlf"===e?f.val().split("\n").filter(function(e){return!!$.trim(e)}):void 0};m.off("change").on("change",function(){var e=m.filter(":checked").val(),t=[];"comma"===e?(t=h("crlf"),f.val(sensorsdata.util.arrayToCsv(t))):"crlf"===e&&(t=h("comma"),f.val(t.join("\n")))}),p.find("#btn-ok").on("click",function(){var e=h("crlf");t.autoRefresh_=!1,c.tagsinput("removeAll"),e.map(function(e){c.tagsinput("add",e)}),p.modal("hide"),t.autoRefresh_=!0,t.execEvent_("valueChangedEvent")}),p.modal({backdrop:"static",keyboard:!1}),p.on("hidden.bs.modal",function(){p.remove()})}},sensorsdata.FilterGroupControl.prototype.renderFunc_=function(e,t){t=t||{};var a=this.getSelectProperty_(e);if(!$.isEmptyObject(a)){var n=a.data_type,s=t["function"];"date"!==n&&"datetime"!==n||"relative_before"!==s&&"relative_within"!==s||(s="relative");var i=this.getDefaultFunc_(n,s,a&&a.has_dict),r={functions:this.options_.functions[a.has_dict?"dict":n],selectFunc:i};"$user_id"===a.name&&(r.functions=r.functions.filter(function(e){return"isEmpty"!==e.name&&"isNotEmpty"!==e.name})),"absolute"===this.options_.timeType&&(r.functions=r.functions.filter(function(e){return"relative"!==e.name&&"relative_between"!==e.name&&"relative_event_time"!==e.name})),this.options_.relative_event&&(r.functions=r.functions.filter(function(e){return"relative_event_time"!==e.name})),e.find("div.function").html(Mustache.render(this.tplCondItemFunc_,r)).show(),e.find("div."+n+"-"+r.selectFunc.name).show().siblings().hide(),this.renderInput_(e,t)}},sensorsdata.FilterGroupControl.prototype.getSelectProperty_=function(e){var t=e.find("div.property :radio:checked").val();return t?this.findProperty_(t,!1):{}},sensorsdata.FilterGroupControl.prototype.renderInput_=function(e,t){t=t||{};var a=this.getSelectProperty_(e);if(!$.isEmptyObject(a)){var n=e.find("div.function span.selected").attr("data-value");if("isSet"===n||"notSet"===n||"isTrue"===n||"isFalse"===n||"isEmpty"===n||"isNotEmpty"===n)return void e.find("div.input").hide();var s=a.data_type;"datetime"===s&&a.is_truncated&&(s="date");var i=s+"-"+n,r=e.find("div.input").show().find("div."+i).show();r.siblings().hide(),r.find("input").unbind("keyup.filter-group-control").bind("keyup.filter-group-control",sensorsdata.bind(function(){this.execEvent_("inputKeyupEvent")},this)),r.find("input").tooltip("destroy"),r.find('span.icon-help,button[data-method="tagsinput-edit"]').tooltip("destroy").tooltip({animation:!1});var o=sensorsdata.bind(function(){this.execEvent_("valueChangedEvent")},this),l=$.isArray(t.params)?t.params:[],d=r.find("input").val(1===l.length?l[0]:""),u=r.find('input[data-role="tagsinput"]');switch(i){case"number-equal":case"number-notEqual":"yes"===u.attr("data-typeahead-flat")&&u.tagsinput("destroy"),u.tagsinput({typeahead:{items:0,minLength:0,showHintOnFocus:!0,template:"{{display}}",autoSelect:!1,afterSelect:function(){u.tagsinput("input").val("")}}}),l.map(function(e){u.tagsinput("add",e)}),u.on("beforeItemAdd",function(e){e.cancel=!$.isNumeric(e.item)}),u.on("itemAdded",o),u.on("itemRemoved",o),u.attr("data-typeahead-flat","yes"),this.options_.disabled===!0&&r.find("div.bootstrap-tagsinput").addClass("disabled");break;case"number-less":case"number-greater":break;case"number-between":2===l.length&&(r.find("input").eq(0).val(l[0]),r.find("input").eq(1).val(l[1]));break;case"string-equal":case"string-notEqual":"yes"===u.attr("data-typeahead-flat")&&u.tagsinput("destroy"),u.tagsinput({typeahead:{items:this.autoSuggestLength_,minLength:0,showHintOnFocus:!0,template:"{{display}}",async:!1,autoSelect:!1,afterSelect:function(){u.tagsinput("input").val("")},source:sensorsdata.bind(function(e,t){var n=r.find('input[data-role="tagsinput"]').val().split(","),s=function(e){n.map(function(t){var a=e.indexOf(t);a>=0&&e.splice(a,1)}),$.isFunction(t)&&t(e)};return this.searchPropertyValues_(a.id,e,s,this.autoSuggestLength_+n.length)},this)}}),l.map(function(e){u.tagsinput("add",e)}),u.on("itemAdded",o),u.on("itemRemoved",o),u.attr("data-typeahead-flat","yes"),this.options_.disabled===!0&&r.find("div.bootstrap-tagsinput").addClass("disabled");break;case"string-contain":case"string-notContain":"yes"===d.attr("data-typeahead-flat")&&d.typeahead("destroy");var p=sensorsdata.bind(this.execEvent_,this);d.typeahead({items:this.autoSuggestLength_,autoSelect:!1,minLength:0,maxItem:100,showHintOnFocus:!0,template:"{{display}}",async:!1,afterSelect:function(){p("valueChangedEvent"),this.hide()},source:sensorsdata.bind(function(e,t){return this.searchPropertyValues_(a.id,e,t)},this)}).show(),d.attr("data-typeahead-flat","yes");break;case"string-rlike":case"string-notrlike":break;case"bool-isTrue":case"bool-isFalse":break;case"date-absolute_between":case"date-relative":case"date-relative_between":case"date-relative_event_time":this.renderDateInput_(r,t,"date");break;case"datetime-absolute_between":case"datetime-relative":case"datetime-relative_between":case"datetime-relative_event_time":this.renderDateInput_(r,t,"datetime");break;case"list-in":case"list-notInclude":var c=r.find('input[data-role="tagsinput"]');"yes"===c.attr("data-typeahead-flat")&&c.tagsinput("destroy"),c.tagsinput({typeahead:{items:this.autoSuggestLength_,minLength:0,showHintOnFocus:!0,template:"{{display}}",async:!1,autoSelect:!1,afterSelect:function(){c.tagsinput("input").val("")},source:sensorsdata.bind(function(e,t){var n=r.find('input[data-role="tagsinput"]').val().split(","),s=function(e){n.map(function(t){var a=e.indexOf(t);a>=0&&e.splice(a,1)}),$.isFunction(t)&&t(e)};return this.searchPropertyValues_(a.id,e,s,this.autoSuggestLength_+n.length)},this)}}),l.map(function(e){c.tagsinput("add",e)}),c.on("itemAdded",o),c.on("itemRemoved",o),c.attr("data-typeahead-flat","yes"),this.options_.disabled===!0&&r.find("div.bootstrap-tagsinput").addClass("disabled")}e.find("div."+i).show(),this.initInputBlurEvent_(r);var m=this;e.find('input[type="text"]:visible').off("input.realtime propertychange.realtime").on("input.realtime propertychange.realtime",function(){m.checkFilterInputs_($(this))})}},sensorsdata.FilterGroupControl.prototype.renderDateInput_=function(e,t,a){t=t||{};var n=this,s=e.parents(".filter-item:first").find("div.function span.selected").attr("data-value"),i=this.options_.label.input;e.find("span.icon-help").hide();var r=null,o=null;if("absolute_between"===s){var l="date"===a?sensorsdata.CONSTSET.dateFormat:sensorsdata.CONSTSET.normalTimeFormat,d=moment().add(-8,"day").startOf("day");$.isArray(t.params)&&t.params[0]&&(d=moment(t.params[0],l));var u=moment().add(-1,"day").startOf("day");$.isArray(t.params)&&t.params[1]&&(u=moment(t.params[1],l));var p=e.find("div#datepicker input");p.removeClass("date").removeClass("datetime").addClass(a),p.eq(0).val(d.format(l)),p.eq(1).val(u.format(l));var c={autoclose:!0,minView:"month",todayBtn:!0,language:"zh-CN",format:"date"===a?"yyyy-mm-dd":"yyyy-mm-dd hh:ii",todayHighlight:!0,forceParse:!1};p.datetimepicker("remove").datetimepicker(c).unbind("changeDate").bind("changeDate",sensorsdata.bind(function(){this.execEvent_("valueChangedEvent")},this))}else if("relative_between"===s){if(e.find("span.icon-help").show(),e.find("span.icon-help").tooltip("destroy").tooltip({animation:!1}),$.isArray(t.params)&&3===t.params.length){r=parseInt(t.params[0],10),o=parseInt(t.params[1],10);var m=moment().subtract(r-1,"day").format(sensorsdata.CONSTSET.dateFormat),f=moment().subtract(o-1,"day").format(sensorsdata.CONSTSET.dateFormat);e.find('input[data-days="early"]').val(r).tooltip("destroy").tooltip({title:m+"("+i.contain+")"}),e.find('input[data-days="later"]').val(o).tooltip("destroy").tooltip({title:f+"("+i.notContain+")"})}}else if("relative_event_time"===s){e.find("span.icon-help").show().tooltip("destroy").tooltip({animation:!1});var h=e.find('div.input-relative_event_time [data-method="'+s+'"]');if($.isArray(t.params))1===t.params.length?(h.eq(0).show(),h.eq(0).find("button > span").attr("data-value","relative_this_"+t.params[0]),h.eq(0).find("button > span").html(sensorsdata.languages.get("当<!--{en}When-->")+this.options_.timeUnit[t.params[0]])):3===t.params.length&&(r=parseInt(t.params[0],10),o=parseInt(t.params[1],10),0>r?(h.eq(0).find("button > span").attr("data-value","relative_after"),h.eq(0).find("button > span").html(sensorsdata.languages.get("之后<!--{en}After-->")),h.eq(1).find("input").val(Math.abs(parseInt(t.params[0],10)))):(h.eq(0).find("button > span").attr("data-value","relative_before"),h.eq(0).find("button > span").html(sensorsdata.languages.get("之前<!--{en}Before-->")),h.eq(1).find("input").val(parseInt(t.params[1],10))),h.eq(2).find("button > span").attr("data-value",t.params[2]),h.eq(2).find("button > span").html(this.options_.timeUnit[t.params[2]]),h.show());else{h.hide();var g=h.eq(0).find("button > span").attr("data-value");-1===g.indexOf("relative_this")?h.show():h.eq(0).show()}h.eq(0).unbind("click.change").bind("click.change",function(e){var t=$(e.target||e.srcElement),a=t.attr("data-method");switch(a){case"date-input-inout":var n=t.attr("data-value");"this"===n.split("_")[1]?(h.find("input").val(""),h.eq(0).siblings().hide()):h.show()}})}else{var v=t["function"],y="";if($.isArray(t.params)&&2===t.params.length){y=t.params[0];var b=e.find('[data-method="date-input-inout"][data-value="'+v+'"]');e.find("span.selected.inout:visible").attr("data-value",v).text(b.text())}e.find("input[data-days]").val(y)}e.find("[data-absolute]").hide().filter('[data-absolute="'+s+'"]').show(),n.updateDateInputTooltip(e.find("input[data-days]:visible"),e,!1),e.find("input[data-days]:visible").unbind("input propertychange").bind("input propertychange",function(){n.updateDateInputTooltip($(this),e,!0)})},sensorsdata.FilterGroupControl.prototype.updateDateInputTooltip=function(e,t,a){var n=this;e.each(function(e,s){var i=$(s),r=i.val();if(!i.hasClass("error")&&$.isNumeric(r)){r=parseInt(r,10);var o=moment().subtract(r-1,"day").format(sensorsdata.CONSTSET.dateFormat),l=i.attr("data-days"),d=n.options_.label.input;switch(l){case"now":var u="relative_within"===t.find("div[data-absolute]:visible > button > span").attr("data-value")?d.contain:d.notContain;o+="("+u+")";break;case"early":o+="("+d.contain+")";break;case"later":o+="("+d.notContain+")"}i.attr("data-original-title",o).tooltip(),a&&i.tooltip("fixTitle").tooltip("show")}r||i.tooltip("destroy")})},sensorsdata.FilterGroupControl.prototype.initInputBlurEvent_=function(e){var t=this;e.find('input[type="text"]').off("blur.custom").on("blur.custom",function(){t.checkFilterInputs_(e)&&t.execEvent_("valueChangedEvent")})},sensorsdata.FilterGroupControl.prototype.checkFilterInputs_=function(e){var t=e.parents("div.filter-item:first"),a=this.getSelectProperty_(t),n=a.data_type,s=t.find(".function span.selected").attr("data-value"),i=n+"-"+s,r=sensorsdata.languages.get("必填，数字且大于0<!--{en}Required, must be number greater than 0-->");switch(i){case"number-less":case"number-greater":case"number-between":e.is("input")&&($.isNumeric(e.val().trim())?sensorsdata.form.removeError(e):sensorsdata.form.addError(e,sensorsdata.languages.get("请输入数字<!--{en}Please enter number-->"),!0));break;case"string-rlike":case"string-notrlike":try{new RegExp(e.val().trim()),sensorsdata.form.removeError(e)}catch(o){sensorsdata.form.addError(e,sensorsdata.languages.get("错误的正则表达式：<!--{en}Wrong regular expression:-->")+o.message,!0),console.info(o)}break;case"datetime-relative_between":case"date-relative_between":var l=parseInt(e.find('input[data-days="early"]').val(),10),d=parseInt(e.find('input[data-days="later"]').val(),10);if(l&&l>0&&d&&d>0&&l>d){sensorsdata.form.removeError(e.find('input[data-days="early"]')),sensorsdata.form.removeError(e.find('input[data-days="later"]'));var u=moment().subtract(l-1,"day").format(sensorsdata.CONSTSET.dateFormat),p=moment().subtract(d-1,"day").format(sensorsdata.CONSTSET.dateFormat);return e.find('input[data-days="early"]').attr("data-original-title",u+"("+this.options_.label.input.contain+")"),e.find('input[data-days="later"]').attr("data-original-title",p+"("+this.options_.label.input.notContain+")"),sensorsdata.form.addTooltip(e.find('input[data-days="early"]')),sensorsdata.form.addTooltip(e.find('input[data-days="later"]')),t.find("span.icon-help:visible").tooltip("hide"),!0}return $.isNumeric(l)&&0>l?sensorsdata.form.addError(e.find('input[data-days="early"]'),r):sensorsdata.form.removeError(e.find('input[data-days="early"]')),$.isNumeric(d)&&0>d?sensorsdata.form.addError(e.find('input[data-days="later"]'),r):sensorsdata.form.removeError(e.find('input[data-days="later"]')),l&&!d?(sensorsdata.form.addError(e.find('input[data-days="later"]'),r),!1):!l&&d?(sensorsdata.form.addError(e.find('input[data-days="early"]'),r),!1):(l||d||(sensorsdata.form.removeError(e.find('input[data-days="early"]')),sensorsdata.form.removeError(e.find('input[data-days="later"]')),t.find("span.icon-help:visible").tooltip("hide")),d>=l&&l>0&&d>0&&(sensorsdata.form.addError(e.find('input[data-days="early"]')),sensorsdata.form.addError(e.find('input[data-days="later"]')),t.find("span.icon-help:visible").tooltip("show")),!1);case"datetime-relative_event_time":case"date-relative_event_time":var c=e.find('[data-method="relative_event_time"]').eq(1).find("input"),m=parseInt(c.val(),10);if(isNaN(m)&&m)return sensorsdata.form.addError(c,r),!1;break;case"datetime-absolute_between":case"date-absolute_between":var f=e.find('input[name="start"]'),h=e.find('input[name="end"]'),g=sensorsdata.languages.get("错误的时间格式<!--{en}Incorrect time format -->");if(!moment(f.val()).isValid())return sensorsdata.form.addError(f,g),!1;if(!moment(h.val()).isValid())return sensorsdata.form.addError(h,g),!1;sensorsdata.form.removeError(e.find("input"))}return!0},sensorsdata.FilterGroupControl.prototype.getDefaultFunc_=function(e,t,a){if(!e)return null;var n=this.options_,s=n.functions[a?"dict":e],i=null;return t&&(i=s.filter(function(e){return e.name===t})[0]),i||(i="date"!==e&&"datetime"!==e||"absolute"!==n.timeType?s[0]:s.filter(function(e){return"relative"!==e.name})[0]),i},sensorsdata.FilterGroupControl.prototype.findProperty_=function(e,t){var a={},n=this.options_.propertyObj;if(e){var s=function(t){return t.fullName===e};a=n.session.filter(s)[0]||n.event.filter(s)[0]||n.user.filter(s)[0]||{}}return t&&$.isEmptyObject(a)&&(a=n.session[0]||n.event[0]||n.user[0]||{}),$.extend(!0,{},a)},sensorsdata.FilterGroupControl.prototype.toggleRelation_=function(){if(this.filterObj_){var e=this.filterObj_.find(".filter-contain").children().size()>1;this.filterObj_.find("#filter-group-relation").toggle(e)}},sensorsdata.FilterGroupControl.prototype.getValue_=function(){var e={};if(this.filterObj_&&this.filterObj_.find(".filter-contain").size()>0){var t=[];this.filterObj_.find(".filter-contain").children().each(sensorsdata.bind(function(e,a){var n=this.buildCondition_($(a));$.isEmptyObject(n)||t.push(n)},this)),t.length>0&&(e.conditions=t)}if($.isArray(e.conditions)&&e.conditions.length>1){var a=this.filterObj_.find("button[data-relation]");if(a.is(":visible")){var n=a.attr("data-relation");e.relation=n?n:"and"}}return e},sensorsdata.FilterGroupControl.prototype.buildCondition_=function(e){var t=this.getSelectProperty_(e);if(!t)return{};var a=t.data_type,n=e.find(".function span.selected").attr("data-value"),s=a+"-"+n,i=e.find("div."+s),r={field:t.fullName,"function":n,params:[]};if("isSet"===n||"notSet"===n||"isEmpty"===n||"isNotEmpty"===n)return r;var o=i.find("input:first"),l=o.val();switch(s){case"number-equal":case"number-notEqual":if(r.params=i.find("input[data-typeahead-flat]").tagsinput("items"),r.params=r.params.filter(function(e){return $.isNumeric(e)}).map(function(e){return e/1}),r.params.length>0)return r;break;case"number-less":case"number-greater":if(l&&$.isNumeric(l))return r.params.push(l),r;break;case"number-between":var d=i.find("input").eq(0).val(),u=i.find("input").eq(1).val();if(d&&u&&$.isNumeric(d)&&$.isNumeric(u))return 0>=d-u?(r.params[0]=d,r.params[1]=u):(r.params[0]=u,r.params[1]=d),r;break;case"string-equal":case"string-notEqual":if(r.params=i.find("input[data-typeahead-flat]").tagsinput("items"),r.params.length>0)return r;break;case"string-contain":case"string-notContain":if(l)return r.params.push(l),r;break;case"string-rlike":case"string-notrlike":if(l&&!o.hasClass("error"))return r.params.push(l),r;break;case"bool-isTrue":case"bool-isFalse":return r;case"date-absolute_between":case"date-relative":case"datetime-absolute_between":case"datetime-relative":case"datetime-relative_between":case"date-relative_between":case"date-relative_event_time":case"datetime-relative_event_time":if("absolute_between"===n){var p="date"===a?sensorsdata.CONSTSET.dateFormat:sensorsdata.CONSTSET.timeFormat,c=e.find("div#datepicker"),m=c.find("input:first").val(),f=c.find("input:eq(1)").val();return r["function"]="absolute_between",r.params.push(moment(m).format(p)),r.params.push(moment(f).format(p)),r}if("relative_between"===n){var h=parseInt(i.find('input[data-days="early"]').val(),10),g=parseInt(i.find('input[data-days="later"]').val(),10),v="day";if(r["function"]="relative_between",h&&h>0&&g&&g>0&&h>g)return r.params.push(h+""),r.params.push(g+""),r.params.push(v),r}else{if("relative_event_time"===n){var y=i.find('div[data-absolute="'+n+'"] div[data-method="'+n+'"]'),b=y.eq(0).find("button span").attr("data-value"),_=parseInt(y.eq(1).find("input").val(),10);switch(b){case"relative_this_day":case"relative_this_week":case"relative_this_month":r.params.push(b.split("_")[2]);
break;case"relative_after":isNaN(_)?r={}:(r.params.push(-_+""),r.params.push("0"),r.params.push(y.eq(2).find("button span").attr("data-value"))),sensorsdata.form.removeError(y.eq(1).find("input"));break;case"relative_before":isNaN(_)?r={}:(r.params.push("0"),r.params.push(_+""),r.params.push(y.eq(2).find("button span").attr("data-value"))),sensorsdata.form.removeError(y.eq(1).find("input"))}return r}var E=parseInt(i.find("input[data-days]").val(),10);if(E>0)return r["function"]=i.find("span.inout").attr("data-value"),r.params.push(E+"","day"),r}break;case"list-in":case"list-notInclude":if(r.params=i.find("input[data-typeahead-flat]").tagsinput("items"),r.params.length>0)return r;break;default:return{}}return{}},sensorsdata.FilterGroupControl.prototype.setValue_=function(e){if(this.lastValue_=e=sensorsdata.FilterGroupControl.dealCompatible(e),$.isArray(e.conditions)){for(var t=0,a=e.conditions.length;a>t;t++)this.addFilter(e.conditions[t],!1,!1);this.setRelation_(e.relation)}return!0},sensorsdata.FilterGroupControl.prototype.execEvent_=function(e){if("valueChangedEvent"===e){if(this.autoRefresh_===!1)return;var t=this.getValue_();if(!0===this.compare_(t,this.lastValue_))return;this.lastValue_=t}for(var a=null,n=0,s=this.eventMap_[e].length;s>n;n++){var i=this.eventMap_[e][n];"function"==typeof i&&(a=i(this.lastValue_))}return a},sensorsdata.FilterGroupControl.prototype.compare_=function(e,t){return e===t?!0:e&&t?JSON.stringify(e)===JSON.stringify(t):!1},sensorsdata.FilterGroupControl.prototype.searchPropertyValues_=function(e,t,a,n){t=$.trim(t);var s="property/"+e+"/values?limit="+(n||this.autoSuggestLength_);return t&&(s+="&fuzzyStr="+encodeURIComponent(t)),sensorsdata.ajax({queueEnable:!0,queueKey:"property/"+e+"/values",url:s,success:function(e){$.isArray(e)&&$.isFunction(a)&&a(e)}})},sensorsdata.FilterGroupControl.prototype.byName_=function(e,t){if(!$.isArray(e)||0===e.length)return null;for(var a=0,n=e.length;n>a;a++)if(e[a].name===t)return e[a];return null},sensorsdata.FilterGroupControl.prototype.indexOf_=function(e,t){if(!$.isArray(e)||0===e.length)return-1;for(var a=0,n=e.length;n>a;a++)if(e[a].name===t)return a;return-1},sensorsdata.FilterGroupControl.dealCompatible=function(e){if(!e||$.isEmptyObject(e))return{};if($.isArray(e.conditions)&&0!==e.conditions.length){"and"!==e.relation&&"or"!==e.relation&&delete e.relation;for(var t=0,a=e.conditions.length;a>t;t++){var n=e.conditions[t];$.isEmptyObject(n)?(e.conditions.splice(t,1),a--,t--):(n.property&&(n.field=n.property,delete n.property),n.event&&(n.event_name=n.event,delete n.event),$.isArray(n.params)&&0!==n.params.length||(n.params=[]))}0===e.conditions.length&&delete e.conditions}else delete e.conditions,delete e.relation;return e};