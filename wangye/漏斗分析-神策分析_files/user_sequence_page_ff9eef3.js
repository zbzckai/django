sensorsdata.UserEventsPage=function(e){sensorsdata.BasePage.call(this),this.options=e,this.options.container=e.container||$("body"),this.tplUserSequence_=$("#tpl_user_sequence").html(),this.options.container.html(this.tplUserSequence_),this.pageName=window.location.pathname,this.sequenceData={events:[],prev_page:!0,next_page:!0,timeLabel:[]},this.user_id=e.user_id,this.naviPath_=window.location.pathname.split("/").filter(function(e){return""!==e}),this.apiMap_={segmentation:"events",funnel:"funnels",retention:"retentions",addiction:"addictions",clustering:"users",user_analytics:"users","behavior-path":"users","web-click":"users","app-click":"events","search-users":"users"},this.eventProps_=null,this.eventList_=null,this.userProps_=null,this.userProfile_=null,this.userProfileData_={},this.timelineContainer_=this.options.container.find("#event-timeline"),this.tplTimeLine_=$("#tpl_event_timeline").html(),this.breadCrumbContainer_=this.options.container.find("#breadcrumb-wrap"),this.tplBreadCrumb_=$("#tpl_breadcrumb").html(),this.tplUserProfile_=$("#tpl_user_profile").html(),this.sequenceContainer_=this.options.container.find("#sequence-list"),this.eventJqXHR=null,this.propsJqXHR=null,this.barJqXHR=null,this.pieJqXHR=null,this.userProfileContainer_=this.options.container.find("#userProfileContainer"),this.pageNextContainer_=this.options.container.find("#page-next"),this.pagePrevContainer_=this.options.container.find("#page-previous"),this.tplPageNext=$("#tpl_page_next").html(),this.tplPagePrev=$("#tpl_page_previous").html(),this.inputDate_=this.options.container.find("#inputDate"),this.eventsEditList_=this.options.container.find("#events-edit-list"),this.propsEditList_=this.options.container.find("#props-edit-list"),this.selectedProps=[],this.selectedEvents=[],this.allEvents_=[],this.barChartContainer_=this.options.container.find("#bar-container"),this.pieChartContainer_=this.options.container.find("#pie-container"),this.pieOption={tooltip:$.extend(!0,{},sensorsdata.echarts.option.tooltip),color:sensorsdata.CONSTSET.chartsColors},this.barOption=$.extend(!0,{},sensorsdata.echarts.option),this.graphContainer_=this.options.container.find("#graph-container"),this.page={start:0,end:0,isFirstInit:!0},this.unitsMap={day:"day",week:"week",month:"month"},this.optionTab=this.options.container.find("#option-tab"),this.segObj_={},this.pieObj_={},this.barChart_=null,this.pieChart_=null,this.isFocus=null,this.previewDict={$pageview:"$title",$AppViewScreen:"$title"},this.osDict_={ios:"iOS",android:"Android",web:"web",windows:"web",mac:"web"},this.longText_=[],this.init()},sensorsdata.UserEventsPage.prototype.init=function(){sensorsdata.UsersListPage.superClass_.init.call(this),this.initBreadCrumb_(),this.paramObj_=sensorsdata.unparam(window.location.hash),this.paramObj_=this.dealParam_(this.paramObj_);var e=this,t=sensorsdata.cache.project.name||"default";this.selectedEvents=JSON.parse(sensorsdata.localStorage.getItem("seq-events-"+t)||"[]"),this.selectedProps=JSON.parse(sensorsdata.localStorage.getItem("seq-props-"+t)||"[]");var a={users:[],profiles:[]};a.users.push(e.paramObj_.user_id),e.getUserProps_().then(function(){var s=JSON.parse(sensorsdata.localStorage.getItem("selected-cols-"+t)||"[]");s instanceof Array&&0!==s.length?(e.selectedCols=s,s.forEach(function(t){var s=e.userProps_.filter(function(e){return e.name===t.name});s.length&&a.profiles.push("user."+t.name)})):(e.selectedCols=[],e.userProps_.forEach(function(e){e.is_segmenter||"$id"===e.name||a.profiles.push("user."+e.name)})),e.getUserPropsByIdList_(a).then(function(){e.renderUserProfile_()})}),sensorsdata.disableReportAjaxCache(),this.selectedEvents=this.selectedEvents.filter(function(e){return sensorsdata.cache.events.filter(function(t){return t.name===e}).length>0}),0===this.selectedEvents.length&&(this.selectedEvents=this.allEvents_.map(function(e){return e.name})),this.getProperties_(this.selectedEvents,function(t){e.eventProps_=[];for(var a={},s=t.event||[],n=0;n<s.length;n++)a[s[n].name]||"$user_id"===s[n].name||(e.eventProps_.push(s[n]),a[s[n].name]=!0);e.selectedProps=e.selectedProps.filter(function(t){return e.eventProps_.filter(function(e){return e.name===t}).length>0}),e.initInputDate_(),e.renderPropsEdit_(),e.renderEventsEdit_();var r=e.formatParam_(e.paramObj_);e.eventJqXHR=e.getEventList_(r),e.eventJqXHR.then(function(){sensorsdata.enableReportAjaxCache(),e.paramObj_.from_date=e.eventList_.from_date,e.paramObj_.to_date=e.eventList_.to_date,e.paramObj_.sequence_from_date=e.eventList_.from_date,e.paramObj_.sequence_to_date=e.eventList_.to_date;var t=e.inputDate_.data("daterangepicker");t.setStartDate(e.paramObj_.from_date),t.setEndDate(e.paramObj_.to_date),e.initBarChart_(e.paramObj_),e.longText_=[],e.sequenceData=e.formatData_(e.eventList_),e.renderTable_(e.sequenceData)})}),$(window).off("resize.seq").on("resize.seq",function(){e.barChart_&&$.isFunction(e.barChart_.resize)&&e.barChart_.resize(),e.pieChart_&&$.isFunction(e.pieChart_.resize)&&e.pieChart_.resize()}),this.options.closeLoading()},sensorsdata.UserEventsPage.prototype.formatParam_=function(e){var t=$.extend(!0,{},e);return t.events=this.selectedEvents,t.properties=this.selectedProps,t.page=0,t},sensorsdata.UserEventsPage.prototype.getUserProps_=function(){return sensorsdata.ajax({url:"property/user/properties",success:sensorsdata.bind(function(e){this.userProps_=e},this)})},sensorsdata.UserEventsPage.prototype.getUserPropsByIdList_=function(e){var t=this;return e.use_cache=!1,e.limit=1,sensorsdata.reportAjax({type:"post",url:"users/list",data:e,showLoader:!1,success:sensorsdata.bind(function(e){e.size>0&&(t.userProfile_=e.users[0])},this)})},sensorsdata.UserEventsPage.prototype.initBreadCrumb_=function(){for(var e=this.naviPath_,t="/",a=[],s=0;s<e.length;s++){t=t+e[s]+"/";var n={cname:sensorsdata.CONSTSET.urlMap["/"+e[s]+"/"],href:t,parent:s!==e.length-1};"/search-users/"===t&&(n.parent=!1),a.push(n)}var r={list:a,clusterTag:!1,eventsTag:!0};this.breadCrumbContainer_.html(Mustache.render(this.tplBreadCrumb_,r));var i=this;i.options.container.find("#breadcrumb-wrap li").unbind("click").bind("click",function(){var e=$(this).attr("data-href");if(e){var t=sensorsdata.unparam(window.location.hash),a=e.split("/")[2];i.apiMap_.hasOwnProperty(e)||(t.hasOwnProperty("page")&&"users"!==a&&delete t.page,delete t.sequence_from_date,delete t.sequence_to_date,i.options.initPage($(this).attr("data-href")+"#"+$.param(t)))}}),i.options.container.find('[data-toggle="tooltip"]').tooltip(),i.options.container.find('[data-method="download"]').unbind("click.sequence").bind("click.sequence",function(){var e=$.extend(!0,{},i.paramObj_);e=i.formatParam_(e),e.page&&delete e.page,e.num_per_page&&delete e.num_per_page,e.all_page=!0;var t=i.apiMap_[i.naviPath_[0]]+"/sequence/csv",a=i.naviPath_.map(function(e){var t="/"+e+"/";return sensorsdata.CONSTSET.urlMap[t]}).join("-");e.from_date&&e.to_date&&(a+="-"+e.from_date+sensorsdata.CONSTSET.dateRangeSplit+e.to_date),e.use_cache=!0,sensorsdata.download(t,e,a,i.userProfile_)}),i.options.container.find('[data-method="refresh"]').unbind("click.refresh").bind("click.refresh",function(){sensorsdata.disableReportAjaxCache(),i.clearPage();var e=i.formatParam_(i.paramObj_);i.eventJqXHR=i.getEventList_(e),i.eventJqXHR.then(function(){i.propsJqXHR=i.getEventProps_(),i.propsJqXHR.then(function(){i.paramObj_.from_date=i.inputDate_.data("startDate").format(sensorsdata.CONSTSET.dateFormat),i.paramObj_.to_date=i.inputDate_.data("endDate").format(sensorsdata.CONSTSET.dateFormat),i.paramObj_.sequence_from_date=i.paramObj_.from_date,i.paramObj_.sequence_to_date=i.paramObj_.to_date,i.options.container.find('button[data-method="clear-selected"]').css("display","none"),i.initBarChart_(i.paramObj_),i.initPieChart_(i.clearPieAjaxData_(i.paramObj_)),sensorsdata.enableReportAjaxCache(),i.longText_=[],i.sequenceData=i.formatData_(i.eventList_),i.renderTable_(i.sequenceData)})})})},sensorsdata.UserEventsPage.prototype.getProperties_=function(e,t){if(!$.isArray(e)||0===e.length)throw console.info(e),sensorsdata.languages.get("获取事件属性的参数错误<!--{en}The parameter of obtaining event property is error-->");var a=e.filter(function(e,t,a){return a.indexOf(e)===t}),s={events:a.join(","),method:"union"};sensorsdata.ajax({useCache:!0,contentType:"application/x-www-form-urlencoded",url:"event/properties",data:s,method:"POST",success:sensorsdata.bind(function(e){if($.isEmptyObject(e))throw sensorsdata.error.show(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->")),console.info(e),"ajax return error json.";this.propObj_=e,t.call(this,e)},this)})},sensorsdata.UserEventsPage.prototype.renderEventsEdit_=function(){var e=this;this.eventsEditList_.eventDropdown("destroy").eventDropdown({multiple:!0,events:this.allEvents_,virtualDisplay:!1,multiselectOption:{includeSelectAllOption:!0,onDropdownHidden:function(){var t=e.eventsEditList_.data("selected-event");if(0===t.length&&(sensorsdata.info.show(sensorsdata.languages.get("默认选择全部事件<!--{en}Default select all events-->")),e.eventsEditList_.eventDropdown("selectAll",!1)),t.length===e.allEvents_.length&&(t=[]),JSON.stringify(t)!==JSON.stringify(e.selectedEvents)){e.selectedEvents=t;var a=sensorsdata.cache.project.name||"default";sensorsdata.localStorage.setItem("seq-events-"+a,JSON.stringify(e.selectedEvents)),e.paramObj_.from_date=e.inputDate_.data("startDate").format(sensorsdata.CONSTSET.dateFormat),e.paramObj_.to_date=e.inputDate_.data("endDate").format(sensorsdata.CONSTSET.dateFormat),e.paramObj_.sequence_from_date=e.paramObj_.from_date,e.paramObj_.sequence_to_date=e.paramObj_.to_date,e.options.container.find('button[data-method="clear-selected"]').css("display","none"),e.initBarChart_(e.paramObj_),e.initPieChart_(e.clearPieAjaxData_(e.paramObj_)),e.clearPage();var s=[];s=0===e.selectedEvents.length?e.allEvents_.map(function(e){return e.name}):e.selectedEvents,e.getProperties_(s,function(t){for(var a=[],s={},n=t.event||[],r=0;r<n.length;r++)s[n[r].name]||"$user_id"===n[r].name||(a.push(n[r]),s[n[r].name]=!0);e.eventProps_=a,e.renderPropsEdit_();var i=e.formatParam_(e.paramObj_);e.eventJqXHR=e.getEventList_(i),e.eventJqXHR.then(function(){sensorsdata.enableReportAjaxCache(),e.longText_=[],e.sequenceData=e.formatData_(e.eventList_),e.renderTable_(e.sequenceData)})})}}}}),e.selectedEvents.length===this.allEvents_.length||0===e.selectedEvents.length?this.eventsEditList_.eventDropdown("selectAll",!1):this.eventsEditList_.eventDropdown("select",e.selectedEvents)},sensorsdata.UserEventsPage.prototype.renderPropsEdit_=function(){var e=this;this.propsEditList_.html(""),this.propsEditList_.html(Mustache.render($("#tpl-props-edit").html(),{props:this.eventProps_}));var t=this.eventProps_.map(function(e){return e.name}).slice(0,100),a=this.propsEditList_.find("select");a.multiselect({includeFilterClearBtn:!1,enableFiltering:!0,selectAllText:sensorsdata.languages.get("选择前100个<!--{en}Select the first 100-->"),allSelectedText:sensorsdata.languages.get("100个属性<!--{en}100 properties-->"),nonSelectedText:sensorsdata.languages.get("请选择事件属性<!--{en}Please select event properties-->"),filterPlaceholder:sensorsdata.languages.get("筛选属性…<!--{en}Filter the property-->"),toggleClose:!1,maxHeight:490,includeSelectAllOption:!0,buttonText:function(e){var t=e.length;return t+sensorsdata.languages.get("个属性<!--{en}properties-->")},onChange:function(s){var n=e.propsEditList_.find(":checkbox"),r=e.propsEditList_.find(':checkbox[value="multiselect-all"]');s||(e.propsEditList_.find("input").prop("disabled",!1),e.propsEditList_.find("li").removeClass("disabled"),r.is(":checked")&&(a.multiselect("deselectAll"),a.multiselect("select",t),r.prop("checked",!0)));var i=n.filter(":checked");if(i.length>=100){var o=a.find("option").filter(function(){return!$(this).is(":selected")});o.each(function(){var t=e.propsEditList_.find('input[value="'+$(this).val()+'"]');t.prop("disabled",!0),t.parent("li").addClass("disabled")})}else a.find("option").each(function(){var t=e.propsEditList_.find('input[value="'+$(this).val()+'"]');t.prop("disabled",!1),t.parent("li").removeClass("disabled")});a.multiselect("updateButtonText")},onDropdownHidden:function(){var s=[];if(e.propsEditList_.find(":checkbox:checked").each(function(e,t){"multiselect-all"!==$(t).val()&&s.push($(t).val())}),0===s.length&&(sensorsdata.info.show(sensorsdata.languages.get("默认选择前100个属性<!--{en}Default select the first 100 properties-->")),a.multiselect("select",t),e.propsEditList_.find(':checkbox[value="multiselect-all"]').prop("checked",!0)),JSON.stringify(s)!==JSON.stringify(e.selectedProps)){e.selectedProps=s;var n=sensorsdata.cache.project.name||"default";sensorsdata.localStorage.setItem("seq-props-"+n,JSON.stringify(e.selectedProps)),e.clearPage();var r=e.formatParam_(e.paramObj_);e.eventJqXHR=e.getEventList_(r),e.eventJqXHR.then(function(){sensorsdata.enableReportAjaxCache(),e.longText_=[],e.sequenceData=e.formatData_(e.eventList_),e.renderTable_(e.sequenceData)})}}}),0===e.selectedProps.length?a.multiselect("select",t):a.multiselect("select",e.selectedProps);var s=e.propsEditList_.find(":checkbox:checked");s.length>100&&a.find("option").each(function(){if(!$(this).is(":selected")){var t=e.propsEditList_.find('input[value="'+$(this).val()+'"]');t.prop("disabled",!0),t.parent("li").addClass("disabled")}});var n=a.find("option").slice(0,100),r=n.filter(function(e,t){return!$(t).is(":selected")}).length;r||e.propsEditList_.find(':checkbox[value="multiselect-all"]').prop("checked",!0),a.multiselect("updateButtonText"),this.propsEditList_.find("button").tooltip("destroy").tooltip({title:sensorsdata.languages.get("最多选择 100 个属性<!--{en}Select 100 properties at most-->"),container:"body"})},sensorsdata.UserEventsPage.prototype.initInputDate_=function(){var e=this;this.inputDate_.unbind("apply.daterangepicker").bind("apply.daterangepicker",function(){var t=$.extend(!0,{},e.paramObj_);t.from_date=e.inputDate_.data("startDate").format(sensorsdata.CONSTSET.dateFormat),t.to_date=e.inputDate_.data("endDate").format(sensorsdata.CONSTSET.dateFormat),t.sequence_from_date=t.from_date,t.sequence_to_date=t.to_date,JSON.stringify(t)!==JSON.stringify(e.paramObj_)&&(e.paramObj_=t,e.clearPage(),e.options.container.find('button[data-method="clear-selected"]').css("display","none"),e.eventJqXHR=e.getEventList_(e.formatParam_(e.paramObj_)),e.eventJqXHR.then(function(){e.initBarChart_(e.paramObj_),e.initPieChart_(e.clearPieAjaxData_(e.paramObj_)),sensorsdata.enableReportAjaxCache(),e.longText_=[],e.sequenceData=e.formatData_(e.eventList_),e.renderTable_(e.sequenceData)}))});var t=sensorsdata.CONSTSET,a=this.paramObj_,s={};s.unit=a.unit&&this.unitsMap.hasOwnProperty(a.unit)?this.paramObj_.unit:"day",this.graphContainer_.find("button[data-slice-unit]").removeClass("active"),this.graphContainer_.find('button[data-slice-unit="'+s.unit+'"]').addClass("active"),s.startDate=moment(a.from_date,t.dateFormat),s.endDate=moment(a.to_date,t.dateFormat),sensorsdata.initDateRangeInput(this.inputDate_,s)},sensorsdata.UserEventsPage.prototype.drawBarChart_=function(e){var t=this;if($.isEmptyObject(this.segObj_)||0===this.segObj_.rows.length)return void e.html($("#tpl_no_sankey").html());var a={tooltip:{},xAxis:{data:[],date_origin:[]},yAxis:{minInterval:1},series:[{type:"bar",name:sensorsdata.languages.get("事件次数<!--{en}Event times-->"),data:[],barMaxWidth:"40%",itemStyle:{emphasis:{shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)",color:"#4DB7EA"}}}]};this.barOption=$.extend(!0,{},this.barOption,a),this.barOption.xAxis.data=this.segObj_.series,this.barOption.xAxis.date_origin=this.segObj_.date_origin,this.barOption.series[0].data=this.segObj_.rows,this.barChart_&&this.barChart_.hasOwnProperty("isDisposed")&&!this.barChart_.isDisposed()&&this.barChart_.dispose(),this.barChart_=echarts.init(e[0]),this.barChart_.showLoading(),this.barChart_.setOption(this.barOption),this.barChart_.hideLoading(),this.barChart_.off("mouseover"),this.barChart_.on("click",function(e){t.options.container.find('button[data-method="clear-selected"]').css("display","block");var a=e.dataIndex;a!==t.isFocus&&(t.isFocus=a,t.barChart_.dispatchAction({type:"downplay"})),t.barChart_.dispatchAction({type:"highlight",seriesIndex:e.seriesIndex,seriesName:e.seriesName,dataIndex:a});var s=moment(t.barOption.xAxis.date_origin[a]).format(sensorsdata.CONSTSET.dateFormat);switch(t.paramObj_.sequence_from_date=s,t.paramObj_.unit){case"day":case void 0:t.paramObj_.sequence_to_date=s,t.paramObj_.unit="day";break;case"week":t.paramObj_.sequence_to_date=moment(s).add(6,"days").format(sensorsdata.CONSTSET.dateFormat);break;case"month":t.paramObj_.sequence_to_date=moment(s).add(1,"months").subtract(1,"days").format(sensorsdata.CONSTSET.dateFormat)}var n=t.formatParam_(t.paramObj_);t.clearPage(),t.eventJqXHR=t.getEventList_(n),t.eventJqXHR.then(function(){sensorsdata.enableReportAjaxCache(),t.longText_=[],t.sequenceData=t.formatData_(t.eventList_),t.renderTable_(t.sequenceData)}),t.initPieChart_(t.clearPieAjaxData_(t.paramObj_))})},sensorsdata.UserEventsPage.prototype.initBarChart_=function(e){var t=this;return e=t.clearBarAjaxData(e),t.barJqXHR=t.getBarChartData_(e),t.barJqXHR.then(function(){t.drawBarChart_(t.barChartContainer_)})},sensorsdata.UserEventsPage.prototype.drawPie_=function(e){if($.isEmptyObject(this.pieObj_)||0===this.pieObj_.series[0].data.length)return void e.html($("#tpl_no_sankey").html());var t={tooltip:{trigger:"item",formatter:function(e){return e.seriesName+"</br>"+sensorsdata.echarts.truncateLabel(e.data.name,50)+"："+e.value+sensorsdata.languages.get("次, 占<!--{en}time, -->")+e.percent+"%"}},label:{normal:sensorsdata.echarts.legendLabel.normal,emphasis:sensorsdata.echarts.legendLabel.normal},series:[{name:sensorsdata.languages.get("事件名<!--{en}Name of events-->"),type:"pie",selectedOffset:0,label:$.extend(!0,{},sensorsdata.echarts.option.legendLabel),radius:["31%","55%"],data:[]}]};this.pieOption=$.extend(!0,{},this.pieOption,t),this.pieOption.series[0].data=this.pieObj_.series[0].data;var a=null;a=this.paramObj_.sequence_from_date!==this.paramObj_.sequence_to_date?this.paramObj_.sequence_from_date+sensorsdata.languages.get("到<!--{en}To-->")+this.paramObj_.sequence_to_date:sensorsdata.formatTime(moment(this.paramObj_.sequence_from_date),this.paramObj_.unit,!1,!0),a+=sensorsdata.languages.get("该用户的行为概览<!--{en}An overview of the user's behavior-->"),this.options.container.find("#overview-title").html("<h4>"+a+"</h4>"),this.pieOption.label.normal.formatter=function(e){return sensorsdata.echarts.truncateLabel(e.name,10)+"\n"+e.percent+"%"},this.pieOption.label.emphasis.formatter=function(e){return sensorsdata.echarts.truncateLabel(e.name,10)+"\n"+e.percent+"%"},this.pieChart_&&this.pieChart_.hasOwnProperty("isDisposed")&&!this.pieChart_.isDisposed()&&this.pieChart_.dispose(),this.pieChart_=echarts.init(e[0]),this.pieChart_.showLoading(),this.pieChart_.setOption(this.pieOption),this.pieChart_.hideLoading()},sensorsdata.UserEventsPage.prototype.initPieChart_=function(e){var t=this;return t.pieChartContainer_.html(""),t.pieJqXHR=t.getPieChartData_(e),t.pieJqXHR.then(function(){t.drawPie_(t.pieChartContainer_)})},sensorsdata.UserEventsPage.prototype.getBarChartData_=function(e){var t="events/report/?bookmarkId="+(e[sensorsdata.CONSTSET.bookmarkId]||"");return delete e.sampling_factor,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST-bar-"+t,url:t,method:"POST",data:e,success:sensorsdata.bind(function(e){if(this.compareSegObj_={},$.isEmptyObject(e))this.segObj_={};else{if(!this.validResponse(e))return void sensorsdata.error.show(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->"));this.segObj_=this.convertAjaxModel(e)}},this)})},sensorsdata.UserEventsPage.prototype.validResponse=function(e){return $.isEmptyObject(e)?!0:$.isArray(e.series)&&$.isArray(e.rows)&&e.rows.length>0?e.series.length===e.rows[0].values.length:!0},sensorsdata.UserEventsPage.prototype.convertAjaxModel=function(e){if($.isEmptyObject(e)||!$.isArray(e.series)||0===e.series.length||!$.isArray(e.rows)||0===e.rows.length)return{};var t={series:[],rows:[],num:e.num_rows,date_origin:[]};return t.date_origin=e.series,t.unit=this.paramObj_.unit?this.paramObj_.unit:"day",t.series=e.series.map(function(e){return sensorsdata.formatTime(moment(e),t.unit,!1,!0)}),t.rows=e.rows[0].values.map(function(e){return e[0]||0}),t},sensorsdata.UserEventsPage.prototype.clearBarAjaxData=function(e){var t=$.extend(!0,{},e);$.isArray(t.measures)&&t.measures.length>0&&t.measures.map(function(e){e.event_name===sensorsdata.CONSTSET.sessionGeneral.name&&(e.event_name=sensorsdata.CONSTSET.eventEmptyValue)});var a={};a.sampling_factor=t.sampling_factor,a.from_date=moment(t.from_date).format(sensorsdata.CONSTSET.dateFormat),a.to_date=moment(t.to_date).format(sensorsdata.CONSTSET.dateFormat);var s=this.paramObj_.distinct_id?this.paramObj_.distinct_id:this.userProfile_.first_id||this.userProfile_.second_id;a.filter={conditions:[{field:"event.$Anything.$user_id","function":"equal",params:[s]}]},a.measures=[{event_name:"$Anything",aggregator:"general",events:[]}];var n={};if(0!==this.selectedEvents.length)n={field:"event.$Anything.$event_id","function":"equal",params:this.selectedEvents},a.measures[0].events=$.extend(!0,[],this.selectedEvents);else{var r=this.allEvents_.map(function(e){return e.name});n={field:"event.$Anything.$event_id","function":"equal",params:r},a.measures[0].events=r}return a.filter.conditions.push(n),a.unit=e.unit?e.unit:"day",a},sensorsdata.UserEventsPage.prototype.clearPieAjaxData_=function(e){$.isArray(e.measures)&&e.measures.length>0&&e.measures.map(function(e){e.event_name===sensorsdata.CONSTSET.sessionGeneral.name&&(e.event_name=sensorsdata.CONSTSET.eventEmptyValue)});var t={};t.sampling_factor=e.sampling_factor,t.from_date=moment(e.sequence_from_date).format(sensorsdata.CONSTSET.dateFormat),t.to_date=moment(e.sequence_to_date).format(sensorsdata.CONSTSET.dateFormat);var a=this.paramObj_.distinct_id?this.paramObj_.distinct_id:this.userProfile_.first_id||this.userProfile_.second_id;t.filter={conditions:[{field:"event.$Anything.$user_id","function":"equal",params:[a]}]},t.measures=[{event_name:"$Anything",aggregator:"count",events:[]}];var s=null;if(0!==this.selectedEvents.length)s={field:"event.$Anything.$event_id","function":"equal",params:null},s.params=$.extend(!0,[],this.selectedEvents),t.measures[0].events=$.extend(!0,[],this.selectedEvents);else{var n=this.allEvents_.map(function(e){return e.name});s={field:"event.$Anything.$event_id","function":"equal",params:n},t.measures[0].events=n}return t.filter.conditions.push(s),t.unit=e.unit?e.unit:"day",t.by_fields=["event.$Anything.$event_id"],t.bucket_params={"event.$Anything.$event_id":[null]},t.rollup_date=!0,t},sensorsdata.UserEventsPage.prototype.getPieChartData_=function(e){var t="events/report/?bookmarkId="+(e[sensorsdata.CONSTSET.bookmarkId]||"");return delete e.sampling_factor,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST-pie-"+t,url:t,method:"POST",data:e,success:sensorsdata.bind(function(e){if($.isEmptyObject(e))this.pieObj_={};else{if(!this.validResponse(e))return void sensorsdata.error.show(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->"));this.pieObj_=this.formatPieData(e)}},this)})},sensorsdata.UserEventsPage.prototype.formatPieData=function(e){var t={legend:{data:[]},series:[{data:[]}]};return!$.isEmptyObject(e)&&$.isArray(e.series)&&0!==e.series.length&&$.isArray(e.rows)&&0!==e.rows.length?(e.rows.forEach(function(e){var a=sensorsdata.findEventCname(e.by_values[0],sensorsdata.cache.events)||e.by_values[0];t.legend.data.push(a),t.series[0].data.push({name:a,value:e.values[0][0]})}),t):t},sensorsdata.UserEventsPage.prototype.renderTable_=function(e,t){var a=this;if(this.pageNextContainer_.html(Mustache.render(this.tplPageNext,e)),this.pagePrevContainer_.html(Mustache.render(this.tplPagePrev,e)),t)switch(t){case"page-next":this.timelineContainer_.prepend(Mustache.render(this.tplTimeLine_,$.extend(!0,{},e,{isNew:!0}))),this.timelineContainer_.find(".timeline.new").slideDown(500,function(){a.timelineContainer_.find(".timeline").removeClass("new"),a.initEvents_()});break;case"page-previous":this.timelineContainer_.append(Mustache.render(this.tplTimeLine_,$.extend(!0,{},e,{isNew:!0}))),this.timelineContainer_.find(".timeline.new").slideDown(500,function(){a.timelineContainer_.find(".timeline").removeClass("new"),a.initEvents_()})}else this.timelineContainer_.html(Mustache.render(this.tplTimeLine_,e)).slideDown(500,function(){a.initEvents_()})},sensorsdata.UserEventsPage.prototype.renderUserProfile_=function(){var e=this,t=function(e,t){var a=-1;return $.each(t,function(t,s){s.name===e&&(a=t)}),a};e.userProfileData_.list=[];var a={name:"first_id",cname:sensorsdata.languages.get("匿名ID<!--{en}Anonymous ID-->"),value:null},s={name:"second_id",cname:sensorsdata.languages.get("登录ID<!--{en}Login ID-->"),value:null};if(e.userProfile_?(a.value=e.userProfile_.first_id?e.userProfile_.first_id:sensorsdata.CONSTSET.unknownByValue,s.value=e.userProfile_.second_id?e.userProfile_.second_id:sensorsdata.CONSTSET.unknownByValue,a.value===s.value&&(a.value=sensorsdata.CONSTSET.unknownByValue)):(a.value=sensorsdata.CONSTSET.unknownByValue,s.value=sensorsdata.CONSTSET.unknownByValue),e.userProfileData_.list.push(a),e.userProfileData_.list.push(s),e.userProfile_&&e.userProfile_.profiles)for(var n in e.userProfile_.profiles)if(e.userProfile_.profiles.hasOwnProperty(n)){var r=t(n,e.userProps_),i={};if(-1!==r){if(i={name:n,cname:e.userProps_[r].cname,data_type:e.userProps_[r].data_type},"datetime"===i.data_type){var o=e.userProps_[r].is_truncated?sensorsdata.CONSTSET.dateFormat:sensorsdata.CONSTSET.timeFormat;i.value=moment(e.userProfile_.profiles[n]).format(o)}else i.value=sensorsdata.formatByValue(e.userProfile_.profiles[n],i.data_type);e.userProfileData_.list.push(i)}else i={name:n,cname:sensorsdata.CONSTSET.unknownByValue,value:sensorsdata.CONSTSET.unknownByValue,data_type:"string"},e.userProfileData_.list.push(i)}e.userProfileContainer_.find("#profile-list").html(Mustache.render(e.tplUserProfile_,e.userProfileData_)),e.userProfileContainer_.find('[data-toggle="collapse"]').collapse(),e.userProfileContainer_.find('[role="button"]').unbind("click.title").bind("click.title",function(){var t=e.userProfileContainer_.find("span.icon");t.attr("class",t.hasClass("icon-expand-down-single")?"icon-collapse-up-single icon pull-right":"icon-expand-down-single icon pull-right")})},sensorsdata.UserEventsPage.prototype.getEventList_=function(e){var t=(new Date).valueOf(),a={success:!0,use_cache:!!e.use_cache},s=this.apiMap_[this.naviPath_[0]]+"/sequence";return sensorsdata.reportAjax({type:"post",queueEnable:!0,queueKey:"POST-seq-"+s,url:s,error:function(e){a.success=!1,a.fail_reason=e.status,a.time_consuming="",sensorsdata.track("user_sequence",a)},success:sensorsdata.bind(function(e){t=100*Math.ceil(((new Date).valueOf()-t)/100),a.time_consuming=t,sensorsdata.track("user_sequence",a),this.eventList_=e},this),data:e})},sensorsdata.UserEventsPage.prototype.getEventProps_=function(){return sensorsdata.ajax({url:"property/all",useCache:!0,success:sensorsdata.bind(function(e){this.eventProps_=e.filter(function(e){return e.is_in_use&&e.has_db_column_name&&"$user_id"!==e.name})},this)})},sensorsdata.UserEventsPage.prototype.formatData_=function(e){for(var t=this,a=function(e,t){var a=-1;return $.each(t,function(t,s){s.name===e&&(a=t)}),a},s=e.events,n=[],r=0;r<s.length;r++){e.events[r].cname=sensorsdata.findEventCname(s[r].event)||s[r].event,e.events[r].index=r;var i=e.events[r].time.split(" ");if(e.events[r].time=i[1],e.events[r].date=null,e.events[r].event_mark=s[r].event_mark||!1,e.events[r].time_orientation_mark=s[r].time_orientation_mark||!1,this.previewDict.hasOwnProperty(s[r].event)){var o=this.previewDict[s[r].event];e.events[r].previewProp=s[r].properties[o]}if(s[r].properties.hasOwnProperty("$os")){var l="$os",d=s[r].properties[l].toLowerCase();this.osDict_.hasOwnProperty(d)?(e.events[r].hasIcon=!0,e.events[r].os=this.osDict_[d]):(e.events[r].hasIcon=!1,e.events[r].os=sensorsdata.languages.get("[其他]<!--{en}[Other]-->"))}else e.events[r].hasIcon=!1,e.events[r].os=null;i[0]!==n[n.length-1]&&(e.events[r].date=i[0],n.push(i[0]));var p={propLabel:[]},c=[];for(var u in s[r].properties)if(s[r].properties.hasOwnProperty(u)){var _=a(u,this.eventProps_),h={};if(-1!==_)if(h={name:this.eventProps_[_].name,cname:this.eventProps_[_].cname,data_type:this.eventProps_[_].data_type},"datetime"===h.data_type){var m=this.eventProps_[_].is_truncated?sensorsdata.CONSTSET.dateFormat:sensorsdata.CONSTSET.timeFormat;h.value=moment(s[r].properties[u]).format(m)}else h.value=sensorsdata.formatByValue(s[r].properties[u],h.data_type);else h={name:s[r].properties[u],cname:sensorsdata.unknownByValue,data_type:"string",value:sensorsdata.languages.get("未知<!--{en}Unknown-->")};if(h.value.length>80){var f=h.value===sensorsdata.CONSTSET.unknownByValue||h.value===sensorsdata.CONSTSET.emptyStringByValue;if(!f){var v=t.longText_.length;h.realValue=h.value,h.value=h.value.substring(0,80),h.realIndex=v,t.longText_.push(h.realValue)}}c.length<2?c.push(h):(p.propLabel.push(c),c=[],c.push(h))}p.propLabel.push(c),e.events[r]=$.extend(!0,{},e.events[r],p)}return e.timeLabel=n,e},sensorsdata.UserEventsPage.prototype.initEvents_=function(){var e=this;e.options.container.find("#eventListTableContainer").unbind("click.more").bind("click.more",sensorsdata.bind(e.eventsTimeLineClick_,e)),e.optionTab.find("li a").unbind("click.overview").bind("click.overview",function(t){t.preventDefault(),$(this).tab("show"),"#sequence-overview"===$(this).attr("href")&&e.initPieChart_(e.clearPieAjaxData_(e.paramObj_))}),e.graphContainer_.find("button[data-slice-unit]").unbind("click.slice-unit").bind("click.slice-unit",function(){var t=$(this),a=t.attr("data-slice-unit");e.paramObj_.unit!==a&&(e.graphContainer_.find("button[data-slice-unit]").removeClass("active"),e.graphContainer_.find('button[data-slice-unit="'+a+'"]').addClass("active"),e.paramObj_.unit=a,e.options.container.find('button[data-method="clear-selected"]').is(":visible")&&e.options.container.find('button[data-method="clear-selected"]').trigger("click"),e.initBarChart_(e.paramObj_))}),e.options.container.find("div.content").unbind("click.content").bind("click.content",sensorsdata.bind(e.contentClick_,e)),e.sequenceContainer_.find("button[data-method]").unbind("click.toggle").bind("click.toggle",function(){var t=$(this).attr("data-method");switch(t){case"collapse-all":e.sequenceContainer_.find("div.content-detail").each(function(e,t){$(t).is(":visible")&&$(t).prev("div[data-index]").trigger("click.content")}),$(this).attr("data-method","expand-all"),$(this).text(sensorsdata.languages.get("全部展开<!--{en}Expand all-->"));break;case"expand-all":e.sequenceContainer_.find("div.content-detail").each(function(e,t){$(t).is(":visible")||$(t).prev("div[data-index]").trigger("click.content")}),$(this).attr("data-method","collapse-all"),$(this).text(sensorsdata.languages.get("全部折叠<!--{en}Collapse all-->"))}}),e.options.container.find('button[data-method="clear-selected"]').unbind("click.clear").bind("click.clear",function(){$(this).css("display","none"),e.barChart_.dispatchAction({type:"downplay"}),e.paramObj_.from_date=e.inputDate_.data("startDate").format(sensorsdata.CONSTSET.dateFormat),e.paramObj_.to_date=e.inputDate_.data("endDate").format(sensorsdata.CONSTSET.dateFormat),e.paramObj_.sequence_from_date=e.paramObj_.from_date,e.paramObj_.sequence_to_date=e.paramObj_.to_date;var t=e.clearPieAjaxData_(e.paramObj_,"pie");t.unit="day",e.initPieChart_(t);var a=e.formatParam_(e.paramObj_);e.clearPage(),e.eventJqXHR=e.getEventList_(a),e.eventJqXHR.then(function(){sensorsdata.enableReportAjaxCache(),e.longText_=[],e.sequenceData=e.formatData_(e.eventList_),e.renderTable_(e.sequenceData)
})}),sensorsdata.popover({ele:e.options.container.find("a[data-real-value]"),template:$("#tpl_template_real_value").html(),placement:"bottom",content:function(){var t=$(this),a=parseInt(t.attr("data-index"));return Mustache.render($("#tpl_real_value").html(),e.longText_[a])},container:e.timelineContainer_,onShow:function(){var e=this,t=new Clipboard('[data-method="pop-copy"]',{text:function(e){return $(e).parent().siblings(".text-real").html()}});t.on("success",function(e){console.info(e.text),$(e.trigger).attr("title","Copied").tooltip("fixTitle").tooltip("show"),e.clearSelection()}),t.on("error",function(e){console.error("Action:",e.action),console.error("Trigger:",e.trigger)}),this.container.find(".pop-is-cancel.btn-link").unbind("click.cancel").bind("click.cancel",function(){e.ele.popover("hide")})}})},sensorsdata.UserEventsPage.prototype.contentClick_=function(e){var t=$(e.target||e.srcElement),a=t.parents("div.time-item:first"),s=a.find(".content-detail");s.is(":visible")?(a.find("span[data-method]").removeClass("icon-collapse-up-single").addClass("icon-expand-down-single"),s.fadeOut()):(a.find("span[data-method]").removeClass("icon-expand-down-single").addClass("icon-collapse-up-single"),s.fadeIn())},sensorsdata.UserEventsPage.prototype.eventsTimeLineClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first")),e.preventDefault();var a=this,s=t.attr("data-method");switch(s){case"page-next":t.hasClass("disabled")||(t.next("div").css("display","block"),a.getMorePage_("page-next"));break;case"page-previous":t.hasClass("disabled")||(t.next("div").css("display","block"),a.getMorePage_("page-previous"))}},sensorsdata.UserEventsPage.prototype.dealParam_=function(e){switch(this.allEvents_=sensorsdata.cache.events.filter("ALL"===sensorsdata.authority.eventPermission.type?function(e){return!e.virtual}:function(e){return!e.virtual&&-1!==sensorsdata.authority.eventPermission.events.indexOf(e.name)}),this.naviPath_[0]){case"addiction":e.by_field=e.by_field?e.by_field:null;break;case"retention":e.chartsType&&delete e.chartsType,e.sampling_factor&&delete e.sampling_factor;break;case"segmentation":e.chartsType&&delete e.chartsType}if(e.hasOwnProperty("request_type")&&delete e.request_type,e.hasOwnProperty("slice_freq")&&!e.slice_freq&&(e.slice_freq=null),e.hasOwnProperty("slice_max_freq")&&!e.slice_max_freq&&(e.slice_max_freq=null),e.hasOwnProperty("slice_by_value"))switch(e.slice_by_value){case sensorsdata.CONSTSET.unknownByValueText:case"":e.slice_by_value=null;break;case sensorsdata.CONSTSET.emptyStringByValueText:e.slice_by_value=""}var t=null;if(e.hasOwnProperty("slice_by_values")&&e.slice_by_values.length>0)for(t=0;t<e.slice_by_values.length;t++)switch(e.slice_by_values[t]){case sensorsdata.CONSTSET.unknownByValueText:case"":e.slice_by_values[t]=null;break;case sensorsdata.CONSTSET.emptyStringByValueText:e.slice_by_values[t]=""}else delete e.slice_by_values;var a=null;if(e.hasOwnProperty("bucket_params")&&e.bucket_params)for(a in e.bucket_params)if(e.bucket_params.hasOwnProperty(a))for(var s=0;s<e.bucket_params[a].length;s++)e.bucket_params[a][s]=e.bucket_params[a][s]?parseInt(e.bucket_params[a][s],10):null;if(e.hasOwnProperty("bucket_param")&&e.bucket_param)for(a in e.bucket_param)e.bucket_param.hasOwnProperty(a)&&(e.bucket_param[a]=e.bucket_param[a]?parseInt(e.bucket_param[a],10):null);if(e.hasOwnProperty("slice_interval")&&!e.slice_interval&&(e.slice_interval=null),e.hasOwnProperty("slice_date")&&!e.slice_date&&(e.slice_date=null),e.hasOwnProperty("filter")||delete e.filter,e.hasOwnProperty("result_bucket_param"))if(e.result_bucket_param instanceof Array)for(t=0;t<e.result_bucket_param.length;t++)e.result_bucket_param[t]=+e.result_bucket_param[t];else e.result_bucket_param=[];if(e.hasOwnProperty("rollup_date")&&"true"===e.rollup_date&&(e.rollup_date=!0),$.isArray(e.measures)&&e.measures.length>0&&(e.measures=e.measures.map(function(e){return e.event_name===sensorsdata.CONSTSET.sessionGeneral.name&&(e.event_name="$Anything"),e})),!e.from_date||!e.to_date){var n=sensorsdata.buildDefaultTimeRange();e.from_date=n[0].format(sensorsdata.CONSTSET.dateFormat),e.to_date=n[1].format(sensorsdata.CONSTSET.dateFormat)}return e=$.extend(e,{page:0,num_per_page:15,use_distinct:!1})},sensorsdata.UserEventsPage.prototype.getMorePage_=function(e){var t=this,a=null;switch(e){case"page-next":return t.page.end+=1,a=t.formatParam_(t.paramObj_),a.page=t.page.end,t.page.isFirstInit&&(a.sequence_from_date=null,a.sequence_to_date=null),t.getEventList_(a).then(function(){var e=t.formatData_(t.eventList_);t.sequenceData.timeLabel[0]===e.timeLabel[e.timeLabel.length-1]?(t.sequenceData.events[0].date=null,t.sequenceData.timeLabel=e.timeLabel.concat(t.sequenceData.timeLabel.slice(0))):t.sequenceData.timeLabel=e.timeLabel.concat(t.sequenceData.timeLabel),t.sequenceData.timeLabel=e.timeLabel.concat(t.sequenceData.timeLabel.slice(1)),t.sequenceData.events=e.events.concat(t.sequenceData.events),t.sequenceData.next_page=t.eventList_.next_page,t.renderTable_(t.sequenceData),t.timelineContainer_.scrollTop(0)});case"page-previous":return t.page.start-=1,a=t.formatParam_(t.paramObj_),a.page=t.page.start,t.page.isFirstInit&&(a.sequence_from_date=null,a.sequence_to_date=null),t.getEventList_(a).then(function(){var e=t.formatData_(t.eventList_);t.sequenceData.timeLabel[t.sequenceData.timeLabel.length-1]===e.timeLabel[0]?(e.events[0].date=null,t.sequenceData.timeLabel=t.sequenceData.timeLabel.concat(e.timeLabel.slice(0))):t.sequenceData.timeLabel=t.sequenceData.timeLabel.concat(e.timeLabel),t.sequenceData.events=t.sequenceData.events.concat(e.events),t.sequenceData.prev_page=t.eventList_.prev_page,t.renderTable_(t.sequenceData),t.timelineContainer_.find(".timeline").scrollTop(t.timelineContainer_.find(".timeline")[0].scrollHeight)})}},sensorsdata.UserEventsPage.prototype.clearPage=function(){this.page={start:0,end:0,isFirstInit:!1},this.paramObj_.page=0},sensorsdata.UserEventsPage.prototype.unload=function(){this.options.container.find("span").popover("hide"),this.eventJqXHR&&$.isFunction(this.eventJqXHR.abort)&&(this.eventJqXHR.abort(),this.eventJqXHR=null),this.propsJqXHR&&$.isFunction(this.propsJqXHR.abort)&&(this.propsJqXHR.abort(),this.propsJqXHR=null),this.pieJqXHR&&$.isFunction(this.pieJqXHR.abort)&&(this.pieJqXHR.abort(),this.pieJqXHR=null),this.barJqXHR&&$.isFunction(this.barJqXHR.abort)&&(this.barJqXHR.abort(),this.barJqXHR=null),this.inputDate_.tooltip("destroy"),this.propsEditList_.find("button").tooltip("destroy"),$(window).off("resize.seq"),this.inputDate_&&this.inputDate_.data("daterangepicker")&&this.inputDate_.data("daterangepicker").remove()},sensorsdata.UserEventsPage.prototype.reload=function(){window.location.pathname===this.pageName&&this.init()};