sensorsdata.MetaManager=function(e){this.options=$.extend(!0,{},e),this.$container=e.container||$("body"),this.tplMetaTable=$("#tpl-meta-table").html(),this.$container.html($("#tpl-meta-manager").html()),this.tplVirtualCreate=$("#tpl-virtual-create").html(),this.tplSession=$("#tpl-session").html(),this.tplMetaEdit=$("#tpl-meta-edit").html(),this.$tableContainer=this.options.container.find("#meta-table-container"),this.tplNavData=[{nav:"meta",title:sensorsdata.languages.get("元事件<!--{en}Meta event-->"),subtitle:sensorsdata.languages.get("在代码中追踪的原始事件<!--{en}Original events tracked in the code-->"),className:"mega-tab-link"},{nav:"virtual",title:sensorsdata.languages.get("虚拟事件<!--{en}Virtual event-->"),subtitle:sensorsdata.languages.get("组合多个元事件和筛选条件<!--{en}Combination of meta events and filters-->"),className:"mega-tab-link"},{nav:"profile",title:sensorsdata.languages.get("用户属性<!--{en}User properties-->"),subtitle:sensorsdata.languages.get("编辑用户属性<!--{en}Edit user properties-->"),className:"mega-tab-link"},{nav:"event",title:sensorsdata.languages.get("事件属性<!--{en}Event properties-->"),subtitle:sensorsdata.languages.get("编辑事件属性<!--{en}Edit event properties-->"),className:"mega-tab-link"},{nav:"session",title:sensorsdata.languages.get("Session 管理<!--{en}Session-->"),subtitle:sensorsdata.languages.get("管理创建 Session<!--{en}Edit Session-->"),className:"mega-tab-link"}],this.tags=[],this.data=null,this.tableData_=null,this.table_=null,this.$toolboxContainer=this.$container.find("section.toolbox"),this.options.closeLoading(),this.floatLayer=new sensorsdata.createSlidePage,this.$dictModalContainer=this.$container.find("section.dict-modal"),this.init()},sensorsdata.MetaManager.prototype.init=function(){var e=this,t=this.type=sensorsdata.unparam(window.location.hash).type||this.tplNavData[0].nav;this.nav=new sensorsdata.NavManage({container:this.$container.find("header.section-header > ul"),items:this.tplNavData,clickHandle:function(t){e.handleNavEvent(t)},selected:this.type}),this.initToolBox(this.type),this.request(t),$(document).off("click.tags-drop").on("click.tags-drop",function(t){var a=$(t.srcElement||t.target);0===a.closest(".tag_dropdown").size()&&1===a.parents("body").size()&&e.$container.find('[data-toggle="tags"]').each(function(){a.closest('[data-toggle="tags"]').is($(this))||$(this).next("ul").hide()})}),e.floatLayer.$container.off("click.tags-toggle").on("click.tags-toggle",function(t){var a=$(t.srcElement||t.target),n=e.floatLayer.$container.find("span.icon-add");0!==a.closest(".tag_dropdown").size()||1!==a.parents("body").size()||n.is(a)||n.next("ul").hide()})},sensorsdata.MetaManager.prototype.updateHash=function(e){var t=$.param({type:e});window.history.pushState("#"+t,"","#"+t)},sensorsdata.MetaManager.prototype.handleNavEvent=function(e){var t=e.$target,a=t.attr("data-nav");this.initToolBox(a),this.type=a,this.updateHash(a),this.$dictModalContainer.html(""),this.request(a)},sensorsdata.MetaManager.prototype.initToolBox=function(e){var t=this;this.toolbox=new sensorsdata.ToolBox({container:this.$toolboxContainer,type:e}),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||this.$toolboxContainer.find('button[data-method="create-virtual"], button[data-method="create-session"]').prop("disabled",!0),this.toolbox.off("change").on("change",function(e){var a=[];switch(e.method){case"toggle-display":case"input-filter":case"tags-filter":case"clear-tag":t.table_.trigger("filter",e);break;case"tags-set":var n=e.newTags,s=e.common;a=e.status.selected;var o=t.data.filter(function(e){var t=$.extend(!0,[],n);return a.indexOf(e.id)>-1?(e.tag.forEach(function(e){-1===t.indexOf(e)&&-1===s.indexOf(e)&&t.push(e)}),e.tag=t,!0):!1});sensorsdata.MetaModel.update(t.type,o,function(){t.reloadTable(t.type)});break;case"show":a=e.status.selected,sensorsdata.MetaModel.show(t.type,a,function(){t.toolbox.trigger("selected",{ids:[]}),t.reloadTable(t.type,[])});break;case"hide":a=e.status.selected,sensorsdata.MetaModel.hide(t.type,a,function(){t.toolbox.trigger("selected",{ids:[]}),t.reloadTable(t.type,[])});break;case"delete":a=e.status.selected,sensorsdata.MetaModel.delete(t.type,a,function(){t.toolbox.trigger("selected",{ids:[]}),t.reloadTable(t.type,[])});break;case"cancel":t.$tableContainer.find('input[type="checkbox"]').prop("checked",!1),t.toolbox.trigger("selected",{ids:[]}),t.table_.reset(),t.table_.trigger("filter",e);break;case"create-virtual":t.createVirtual("create");break;case"create-session":t.createSession("create");break;case"deleted.tag":t.reloadTable(t.type,[])}})},sensorsdata.MetaManager.prototype.createSession=function(e,t){var a=this,n={},s={};if(n.id=t,"create"===e)n.title=sensorsdata.languages.get("创建<!--{en}Create-->"),n.isCreate=!0;else if("edit"===e){s=$.grep(this.data,function(e){return String(e.id)===String(t)})[0];var o=a.formatSessionRule(s.session_rule);n.title=sensorsdata.languages.get("编辑<!--{en}Edit-->"),n.isEdit=!0,n.session_name=s.name,n.session_cname=s.cname,n.event_list=s.event_list,n.comment=s.comment,n=$.extend(!0,n,o)}this.floatLayer.setContent(Mustache.render(this.tplSession,n));var i=this.floatLayer.$container.find(".auth-grant-table-edit"),r=this.floatLayer.$container.find(".input-group");this.refreshAllEvents().then(function(){sensorsdata.popover({ele:a.floatLayer.$container.find("span.icon-card"),template:$("#tpl-creator-info-tip").html(),html:!0,content:Mustache.render($("#tpl-creator-info-content").html(),s),placement:"right",container:a.floatLayer.$container,trigger:"hover"}),i.eventDropdown("destroy").eventDropdown({multiple:!0,events:sensorsdata.cache.events.filter(function(e){return e.visible}),eventNames:n.event_list||[],multiselectOption:{templates:{button:'<button class="btn-selector multiselect" data-toggle="dropdown" data-error-reg-exp="\\S+" data-error-text="选择事件不能为空">            <span class="icon-event"></span><span class="multiselect-selected-text">请选择事件</span>            </button>'},includeSelectAllOption:!0,selectAllText:sensorsdata.languages.get("选择全部<!--{en}Select all-->"),nSelectedText:sensorsdata.languages.get("个<!--{en} items-->"),allSelectedText:sensorsdata.languages.get("全选<!--{en}Select all-->"),nonSelectedText:sensorsdata.languages.get("请选择事件<!--{en}Please select-->"),filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->"),onChange:function(){i.find(".btn-selector[data-error-reg-exp]").val(i.data("selected-event")||[])},onDropdownShow:function(){i.find(".btn-selector[data-error-reg-exp]").val(i.data("selected-event")||[])},onDropdownHide:function(){sensorsdata.form.checkChildren(i,!0,1,{container:i.parent()})}}}),i.find(".btn-selector[data-error-reg-exp]").off("click.rmerr").on("click.rmerr",function(){var e=$(this).attr("aria-describedby");a.floatLayer.$container.children("#"+e).remove()}),i.find(".btn-selector[data-error-reg-exp]").val(n.event_list||[]),r.off("input.checkintime").on("input.checkintime",function(){sensorsdata.form.checkChildren($(this),!0,1,{container:$(this).parent()})}),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||(a.floatLayer.$container.find("button,input,textarea").prop("disabled",!0),a.floatLayer.$container.find("span[data-toggle]").attr("disabled",!0),a.floatLayer.$container.find('span[data-method="add-tag"]').remove()),a.floatLayer.$container.find('.input-group button[data-toggle="dropdown"]').saDropdown(),a.floatLayer.$container.prev("div").off("click.removetip").on("click.removetip",function(){$(this).next(".slide-page").children(".form-error-tooltip").remove()}),a.floatLayer.show()}),this.floatLayer.$container.find("[data-method]").unbind("click").bind("click",function(){var t=$(this),o=t.attr("data-method"),i=a.floatLayer.$container;switch(o){case"session-save":var r=i.find("#session_float_event_name"),d=n.session_name||r.val(),l=i.find("#session_float_event_cname"),c=l.val(),u=i.find(".auth-grant-table-edit").data("selected-event"),g=i.find("#session_float_role_create"),p=g.val(),f=i.find("#comment-area").val(),h=i.find('.input-group button[data-toggle="dropdown"]').attr("data-value");if(f.length>150)return void sensorsdata.error.show(sensorsdata.languages.get("备注信息请在150个字符内<!--{en}Please note the information in 150 characters-->"));if(null===u)return void sensorsdata.error.show(sensorsdata.languages.get("请选择事件<!--{en}Select events-->"));if(!sensorsdata.form.checkChildren(i,!0,1,{container:i}))return;"hour"===h?p=3600*p:"minute"===h&&(p=60*p);var m={name:d,cname:c,session_rule:{type:"INTERVAL",params:[p]},event_list:u,comment:f};switch(String(s.id)&&(m.id=s.id),e){case"create":sensorsdata.MetaModel.create(a.type,[m],function(){a.floatLayer.hide(),a.request(a.type)});break;case"edit":sensorsdata.MetaModel.update(a.type,[m],function(){a.floatLayer.hide(),a.reloadTable(a.type)})}break;case"session-cancel":sensorsdata.form.removeChildrenError(i),a.floatLayer.hide();break;case"session-delete":sensorsdata.popover({ele:t,footer:$("#tpl_popover_footer_state_3").html(),showNow:!0,content:'确认删除这个 Session 吗？<div class="remark">本操作无法撤销</div>',successAfter:function(){sensorsdata.MetaModel.delete(a.type,[n.id],function(){a.floatLayer.hide(),a.request(a.type)})}}),sensorsdata.form.removeChildrenError(i)}})},sensorsdata.MetaManager.prototype.createVirtual=function(e,t){var a=this,n={},s=$.extend(!0,[],this.tags),o={};if("create"===e)n.isCreate=!0,n.title=sensorsdata.languages.get("创建<!--{en}Create-->");else{if("edit"!==e)return!1;o=$.grep(this.data,function(e){return String(e.id)===String(t)})[0],n.title=sensorsdata.languages.get("编辑<!--{en}Edit-->"),n.event_name=o.name,n.event_cname=o.cname,n.id=o.id,n.isEdit=!0,n.comment=o.comment,n.tags=(o.tag||[]).map(function(e){var t=s.filter(function(t){return String(t.id)===String(e)});return t.length>0&&(t[0].checked=!0),t[0]})}this.floatLayer.setContent(Mustache.render(this.tplVirtualCreate,n)),this.floatLayer.$container.find("#events_virtual_float_filter").html(""),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||(a.floatLayer.$container.find("button,input,textarea").prop("disabled",!0),a.floatLayer.$container.find("span[data-toggle]").attr("disabled",!0),a.floatLayer.$container.find('span[data-method="add-tag"]').remove()),this.refreshAllEvents().then(function(){sensorsdata.popover({ele:a.floatLayer.$container.find("span.icon-card"),template:$("#tpl-creator-info-tip").html(),html:!0,content:Mustache.render($("#tpl-creator-info-content").html(),o),placement:"right",container:a.floatLayer.$container,trigger:"hover"}),a.filterGroupEvents=new sensorsdata.FilterGroupEventList({type:"virtualEvents",container:a.floatLayer.$container.find("#events_virtual_float_filter"),disabled:!(sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege),tpl:$("#tpl_filter_group_events_list").html(),events:sensorsdata.cache.events.filter(function(e){return e.visible&&!e.virtual})}),a.floatLayer.$container.find("#event-select").eventDropdown({events:sensorsdata.cache.events.filter(function(e){return e.visible&&!e.virtual}),multiple:!0,virtualDisplay:!1,nonSelectedText:sensorsdata.languages.get("添加事件<!--{en}Add event-->"),optConfirm:!0,multiselectOption:{includeSelectAllOption:!0,nonSelectedText:sensorsdata.languages.get("添加事件<!--{en}Add event-->")},onDropdownShown:function(){var e=a.floatLayer.$container.find(".fu-cface");e.animate({scrollTop:e[0].scrollHeight-e[0].clientHeight},500)},onConfirmed:function(e){e.forEach(function(e){a.filterGroupEvents.addFilterEvent({event_name:e})})}}),"create"===e?a.filterGroupEvents.addFilterEvent():"edit"===e&&a.filterGroupEvents.setData(o.virtual_define),a.floatLayer.show()}),this.floatLayer.$container.find("[data-method]").unbind("click.method").bind("click.method",function(){var t=$(this);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.attr("data-method"),s=a.floatLayer.$container;switch(n){case"virtual-save":a.saveVirtualData(e,o);break;case"virtual-cancel":a.floatLayer.hide();break;case"virtual-delete":sensorsdata.popover({ele:t,footer:$("#tpl_popover_footer_state_3").html(),showNow:!0,content:'确认删除这个虚拟事件吗？<div class="remark">本操作无法撤销</div>',successAfter:function(){sensorsdata.MetaModel.delete(a.type,[o.id],function(){a.floatLayer.hide(),a.request(a.type)})}});break;case"add-tag":var i=[];s.find("span[data-id]").each(function(){i.push(parseInt($(this).attr("data-id"),10))}),t.data("saTagsDropdown")||$(this).saTagsDropdown({value:i,onSelected:function(){},onApply:function(e){t.parent().prev().html(Mustache.render($("#tpl-tag-label").html(),{tags:e}))},editable:!0,autoshow:!0,type:"set"})}})},sensorsdata.MetaManager.prototype.saveVirtualData=function(e,t){var a=this,n=null,s={success:!0},o=$("#events_virtual_float_event_cname").val().slice(0,100);if(""===o)return sensorsdata.error.show(sensorsdata.languages.get("输入的虚拟事件的显示名不能为空<!--{en}Name/Display name of virtual event cannot be empty-->")),!1;var i=a.floatLayer.$container.find("#comment-area").val();if(i.length>150)return void sensorsdata.error.show(sensorsdata.languages.get("备注信息请在150个字符内<!--{en}Please note the information in 150 characters-->"));var r={virtual_define:a.filterGroupEvents.getData(),cname:o,tag:[],comment:i};a.floatLayer.$container.find("#tagLabelContainer [data-id]").map(function(e,t){r.tag.push(parseInt($(t).attr("data-id"),10))});var d=$("#events_virtual_float_event_cname").val();switch(r.cname=a.getCheckedInput(d,$("#events_virtual_float_event_cname").attr("data-default")),e){case"create":if(n=$("#events_virtual_float_event_name").val(),!/^[a-zA-Z_$][a-zA-Z\d_$]*$/.test(n))return sensorsdata.error.show(sensorsdata.languages.get("虚拟事件名只能包含大小写字母数字或_ $，且第一个字符不能是数字<!--{en}Name of virtual event can only contain uppercase and lowercase letter，number or_$, and the first character cannot be number.-->")),!1;s.operation_type=sensorsdata.languages.get("新建<!--{en}New-->"),r.name=n,sensorsdata.MetaModel.create(a.type,[r],function(){a.floatLayer.hide(),a.request(a.type)});break;case"edit":r.id=t.id,s.operation_type=sensorsdata.languages.get("编辑<!--{en}Edit-->"),sensorsdata.MetaModel.update(a.type,[r],function(){a.floatLayer.hide(),a.request(a.type)})}},sensorsdata.MetaManager.prototype.editMetaData=function(e){var t=this,a={title:sensorsdata.languages.get("编辑事件属性<!--{en}Edit event properties-->"),mode:"event",prop_notice:sensorsdata.languages.get("编辑事件和属性的显示名称，以便提供更好的报表展示。如需修改追踪的数据内容，请联系开发人员<!--{en}Edit the event and the display name of the property,  for the better presentation of reports. If you want to modify the content of the tracking data, please contact with the developer.-->")},n=$.grep(this.data,function(t){return String(t.id)===String(e)})[0];t.getProperties(e).then(function(e){var s=$.extend(!0,[],t.tags),o=sensorsdata.setCommonProperty(e);a=$.extend(!0,{},a,t.getDefaultAndCustomProperties(o.event)),a.is_meta_float=!0,a.event_name=n.name,a.event_cname=n.cname,a.event_visible=n.visible,a.comment=n.comment,a.hasNumberColumn=$.grep(a.customProp,function(e){return"number"===e.data_type}).length>0,a.unit_fix=function(){return"number"===this.data_type?this.unit?this.unit:" ":!1},n.tag.map(function(e){var t=s.filter(function(t){return String(t.id)===String(e)});t.length>0&&(t[0].checked=!0)}),a.tags=n.tag.map(function(e){var t=s.filter(function(t){return String(t.id)===String(e)});return t.length>0&&(t[0].checked=!0),t[0]}),t.floatLayer.setContent(Mustache.render(t.tplMetaEdit,a)),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||(t.floatLayer.$container.find("button,input,textarea").prop("disabled",!0),t.floatLayer.$container.find("span[data-toggle]").attr("disabled",!0),t.floatLayer.$container.find('span[data-method="add-tag"]').remove()),t.floatLayer.$container.find('[data-method="toggle-meta"]').saDropdown({value:n.visible,onSelected:function(e){console.log(e)}}),t.floatLayer.$container.find('[data-toggle="tooltip"]').tooltip(),t.floatLayer.$container.find('span[data-toggle="dropdown"]').each(function(){$(this).saDropdown()}),t.floatLayer.show(),t.floatLayer.$container.find("[data-method]").unbind("click.meta").bind("click.meta",function(){var e=$(this),a=e.attr("data-method"),s=t.floatLayer.$container;switch(a){case"meta-save":t.saveMetaFloat(s,n);break;case"meta-cancel":t.floatLayer.hide();break;case"add-tag":var o=[];s.find("span[data-id]").each(function(){o.push(parseInt($(this).attr("data-id"),10))}),e.data("saTagsDropdown")||$(this).saTagsDropdown({value:o,onSelected:function(){},onApply:function(t){e.parent().prev().html(Mustache.render($("#tpl-tag-label").html(),{tags:t}))},editable:!0,autoshow:!0,type:"set"})}})})},sensorsdata.MetaManager.prototype.getCheckedInput=function(e,t){return e=$.trim(e),""===e?t:e.slice(0,100)},sensorsdata.MetaManager.prototype.getDefaultAndCustomProperties=function(e){var t={defaultProp:[],customProp:[]};return $.isArray(e)?($.each(e,function(e,a){a.data_type_fix=sensorsdata.CONSTSET.engTypeToChs[a.data_type],"$"===a.name.slice(0,1)?t.defaultProp.push(a):t.customProp.push(a)}),t):t},sensorsdata.MetaManager.prototype.saveMetaFloat=function(e,t){var a=[],n=this;e.find("#event_meta_float_table tbody tr").each(function(e,t){var s=$(t).find(".meta-event-float-cname"),o=s.val();o=n.getCheckedInput(o,s.attr("data-default")),a.push({unit:$(t).find(".meta-event-float-unit").val(),cname:o,property_id:s.attr("data-id"),is_in_use:"true"===$(t).find('span[data-toggle="dropdown"]').attr("data-value")})});var s=[];if(e.find("#tagLabelContainer [data-id]").map(function(e,t){s.push(parseInt($(t).attr("data-id"),10))}),sensorsdata.form.checkChildren(e,!0,1,{container:e})){var o=e.find("#events_meta_float_event_cname").val();o=n.getCheckedInput(o,e.find("#events_meta_float_event_cname").attr("data-default"));var i="true"===e.find('[data-method="toggle-meta"]').attr("data-value"),r=e.find("#comment-area").val();if(r.length>150)return void sensorsdata.error.show(sensorsdata.languages.get("备注信息请在150个字符内<!--{en}Please note the information in 150 characters-->"));var d={visible:i,event_id:t.id,id:t.id,cname:o,property:a,tag:s,comment:r};sensorsdata.MetaModel.update(n.type,[d],function(){n.floatLayer.hide(),n.request(n.type)})}},sensorsdata.MetaManager.prototype.refreshAllEvents=function(){return sensorsdata.ajax({url:"events/all",data:{cache:!1,invisible:!0},success:function(e){sensorsdata.cache.events=e}})},sensorsdata.MetaManager.prototype.getProperties=function(e){return sensorsdata.ajax({url:"event/"+e+"/properties",data:{cache:!1,show_all:!0}})},sensorsdata.MetaManager.prototype.loadedHandle=function(e,t,a){this.data=t,this.tags=a,this.options.closeLoading(),this.tableData_=this.buildTplData(e),this.render(this.tableData_)},sensorsdata.MetaManager.prototype.reloadTable=function(e,t){var a=this;sensorsdata.MetaModel.request(e,function(e,n,s){a.data=n,a.tags=s,a.options.closeLoading(),a.tableData_=a.buildTplData(e),a.table_.reload(a.tableData_,t),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||a.options.container.find('input[type="checkbox"], span.icon-edit, span.icon-add').remove()})},sensorsdata.MetaManager.prototype.reload=function(){this.type=sensorsdata.unparam(window.location.hash),this.init()},sensorsdata.MetaManager.prototype.buildTplData=function(e){var t=this,a=$.extend(!0,[],this.data),n=[],s=a;switch(e){case"meta":n=[{text:sensorsdata.languages.get("事件名<!--{en}Name of event-->"),method:"sort",type:"string",key:"name"},{text:sensorsdata.languages.get("显示名<!--{en}Display name-->"),method:"sort",type:"string",key:"cname"},{text:sensorsdata.languages.get("标签<!--{en}Tag-->")},{text:sensorsdata.languages.get("显示状态<!--{en}Status-->"),method:"toggle-display"},{text:sensorsdata.languages.get("备注<!--{en}Remarks-->")}],s=s.filter(function(e){return!e.virtual}).map(function(e){return{id:e.id,name:e.name,cname:e.cname,toggleDisplay:!0,isTag:!0,tags:e.tag.map(function(e){if(t.tags.length>0){var a=t.tags.filter(function(t){return t.id===e})[0];return a}return e}),editable:!0,visible:e.visible,enabled:"string"===e.data_type||"number"===e.data_type,isShow:sensorsdata.languages.get(e.visible?"可见<!--{en}Visible-->":"隐藏<!--{en}Invisible-->"),dataValue:e.is_in_use,comment:e.comment,hasComment:!0,disabled:!sensorsdata.authority.isAdmin}});break;case"virtual":n=[{text:sensorsdata.languages.get("虚拟事件名<!--{en}Name of virtual events-->"),method:"sort",type:"string",key:"name"},{text:sensorsdata.languages.get("虚拟事件显示名<!--{en}Display name of virtual events-->"),method:"sort",type:"string",key:"cname"},{text:sensorsdata.languages.get("标签<!--{en}Tag-->")},{text:sensorsdata.languages.get("包含事件<!--{en}Contained events-->")},{text:sensorsdata.languages.get("备注<!--{en}Remarks-->")}],s=s.map(function(e){return{id:e.id,name:e.name,cname:e.cname,isTag:!0,tags:e.tag.map(function(e){if(t.tags.length>0){var a=t.tags.filter(function(t){return t.id===e})[0];return a}return e}),visible:!0,enabled:"string"===e.data_type||"number"===e.data_type,dataValue:e.is_in_use,type:sensorsdata.CONSTSET.engTypeToChs[e.data_type],unit:e.unit,isVirtual:!0,editable:!0,virtual_define:e.virtual_define.map(function(e){return sensorsdata.findEventCname(e.event_name,sensorsdata.cache.events)}).join(","),comment:e.comment,hasComment:!0,disabled:!sensorsdata.authority.isAdmin}});break;case"profile":case"event":n=[{text:sensorsdata.languages.get("属性名<!--{en}Name of property-->"),method:"sort",type:"string",key:"name"},{text:sensorsdata.languages.get("显示名<!--{en}Display name-->"),method:"sort",type:"string",key:"cname"},{text:sensorsdata.languages.get("数据类型<!--{en}Data type-->")},{text:sensorsdata.languages.get("单位/格式<!--{en}Unit / format-->")},{text:sensorsdata.languages.get("字典<!--{en}Dict-->")},{text:sensorsdata.languages.get("显示状态<!--{en}Status-->"),method:"toggle-display"},{text:sensorsdata.languages.get("预置<!--{en}Preset-->")}],s=s.map(function(e){return{id:e.id,name:e.name,cname:e.cname,toggleDisplay:!0,isDictory:sensorsdata.languages.get(e.has_dict?"有<!--{en}has-->":"无<!--{en}none-->"),has_dict:e.has_dict,enableDict:"string"===e.data_type||"number"===e.data_type,isShow:sensorsdata.languages.get(e.is_in_use?"可见<!--{en}Visible-->":"隐藏<!--{en}Invisible-->"),dataValue:e.is_in_use,visible:e.is_in_use,isTime:"datetime"===e.data_type||"date"===e.data_type,truncated:!!e.is_truncated,timeFormat:e.is_truncated?"yyyy-mm-dd":"yyyy-mm-dd HH:mm:ss.SSS",type:sensorsdata.CONSTSET.engTypeToChs[e.data_type],isUnit:!0,hasUnit:"number"===e.data_type,unit:e.unit,"delete":e.has_dict,download:e.has_dict,isPreset:sensorsdata.languages.get(0===e.name.indexOf("$")?"是<!--{en}Yes-->":"否<!--{en}No-->"),comment:e.comment,disabled:!sensorsdata.authority.isAdmin}});break;case"session":n=[{text:sensorsdata.languages.get("Session 名<!--{en}Name of session-->"),method:"sort",type:"string",key:"name"},{text:sensorsdata.languages.get("Session 显示名<!--{en}Display name of session-->"),method:"sort",type:"string",key:"cname"},{text:sensorsdata.languages.get("包含事件<!--{en}Contained events-->")},{text:sensorsdata.languages.get("切割规则<!--{en}Cutting rules-->")},{text:sensorsdata.languages.get("备注<!--{en}Remarks-->")}],s=s.map(function(e){var a=t.formatSessionRule(e.session_rule);return{id:e.id,name:e.name,cname:e.cname,toggleDisplay:!1,editable:!0,enabled:"string"===e.data_type||"number"===e.data_type,dataValue:e.is_in_use,type:sensorsdata.CONSTSET.engTypeToChs[e.data_type],sessionUnit:a.unit+a.unitText,visible:!0,event_list:e.event_list.map(function(e){return sensorsdata.findEventCname(e,sensorsdata.cache.events)}).join(","),comment:e.comment,hasComment:!0,disabled:!sensorsdata.authority.isAdmin}})}return{heads:n,rows:s}},sensorsdata.MetaManager.prototype.request=function(e){sensorsdata.MetaModel.request(e,sensorsdata.bind(this.loadedHandle,this))},sensorsdata.MetaManager.prototype.render=function(e){this.table_=new sensorsdata.MetaTable({tableData_:e,currentPage_:1,tpl:this.tplMetaTable,container:this.$tableContainer,onRendered:sensorsdata.bind(function(e){this.toolbox.trigger("total",e)},this),isAdmin:sensorsdata.authority.isAdmin}),this.initTableEvents_()},sensorsdata.MetaManager.prototype.initTableEvents_=function(){var e=this;this.table_.on("selected",function(t){e.toolbox.trigger("selected",t)}),this.table_.off("update").on("update",function(t){sensorsdata.MetaModel.update(e.type,t.newValue,function(){e.reloadTable(e.type)})}),this.table_.unbind("edit").bind("edit",function(t){switch(e.type){case"session":e.createSession("edit",t.index);break;case"virtual":e.createVirtual("edit",t.index);break;case"meta":e.editMetaData(t.index)}}),this.table_.off("toggle").on("toggle",function(t){var a=t.method,n=t.ids;switch(a){case"show":sensorsdata.MetaModel.show(e.type,n,function(){e.reloadTable(e.type)});break;case"hide":sensorsdata.MetaModel.hide(e.type,n,function(){e.reloadTable(e.type)})}}),this.table_.off("change").on("change",function(t){e.toolbox.trigger("change",t)}),this.table_.off("dict").on("dict",function(t){var a=t.$id,n=t.method,s=e.type,o=t.$name,i=t.$cname;switch(n){case"download":var r="";r="event"===e.type?sensorsdata.util.format(sensorsdata.languages.get("事件属性-#{cname}-维度字典<!--{en}Event property-#{name}-dimensional dictionary-->"),{name:o,cname:i}):sensorsdata.util.format(sensorsdata.languages.get("用户属性-#{cname}-维度字典<!--{en}User property-#{name}-dimensional dictionary-->"),{name:o,cname:i}),sensorsdata.DictModel.download(s,a,r);break;case"upload":e.$dictModalContainer.html(Mustache.render($("#tpl-dict-modal").html(),{title:o})),e.$dictModalContainer.find("div.modal").modal("show"),e.$dictModalContainer.find("button.btn-select-file").unbind("click.select").bind("click.select",function(t){t.preventDefault(),e.$dictModalContainer.find('input[type="file"]').click()}),e.$dictModalContainer.find('input[type="file"]').off("change").on("change",function(){var t=$(this),a=t.val(),n=a.split("\\");n=n[n.length-1];var s=e.$dictModalContainer.find("input.file-name"),o=e.$dictModalContainer.find("div.modal"),i=function(e){return e.length>10?e.substr(0,4)+"..."+e.substr(e.length-6,e.length):e};s.val(i(n)),a=a.substring(a.lastIndexOf(".")+1),"txt"!==a||""===a?(sensorsdata.form.addError(s,s.attr("data-error-text"),!1,{container:o}),e.$dictModalContainer.find("button.upload").attr("disabled",!0)):(sensorsdata.form.removeError(s),e.$dictModalContainer.find("button.upload").attr("disabled",!1))}),e.$dictModalContainer.find("button.upload").unbind("click.upload-dict").bind("click.upload-dict",function(){var t=o,a=e.type;"event"===a&&(a="property"),e.$dictModalContainer.find("#type").val(a),e.$dictModalContainer.find("#propertyName").val(t);var n=e.$dictModalContainer.find('input[type="file"]')[0].files||[];if(0!==n.length){var s=new FormData(e.$dictModalContainer.find('[data-method="upload-form"]')[0]);sensorsdata.DictModel.upload(a,s,function(){e.$dictModalContainer.find("div.modal").modal("hide"),e.reloadTable(e.type);var t={success:!0,property_type:"event"===e.type?sensorsdata.languages.get("事件属性<!--{en}Event properties-->"):"profile"===e.type?sensorsdata.languages.get("用户属性<!--{en}User properties-->"):""};sensorsdata.track("upload_dictionary",t)})}});break;case"delete":sensorsdata.DictModel.delete(s,o,function(){e.reloadTable(s)})}})},sensorsdata.MetaManager.prototype.formatSessionRule=function(e){var t=e.params[0],a={};return a=t%3600===0?{unit:t/3600,unitText:sensorsdata.languages.get("小时<!--{en} hours-->"),unitTextT:"hour"}:t%60===0?{unit:t/60,unitText:sensorsdata.languages.get("分钟<!--{en} minutes-->"),unitTextT:"minute"}:{unit:t,unitText:sensorsdata.languages.get("秒<!--{en} seconds-->"),unitTextT:"second"}},sensorsdata.MetaManager.prototype.unload=function(){$(document).off("click.tags-drop"),this.floatLayer.destroy()};