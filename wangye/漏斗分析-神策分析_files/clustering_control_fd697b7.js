sensorsdata.ClusteringControl=function(){},sensorsdata.ClusteringControl.prototype.getTimeRange_=function(e,t){var n={};if(0===t){var i=sensorsdata.CONSTSET,s=e.data("startDate"),a=e.data("endDate");if(moment.isMoment(s)&&moment.isMoment(a)){var r=s.format(i.timeFormat),o=a.format(i.timeFormat);n.absolute_time_range=[r,o],n.relative_time_range=""}}else n.relative_time_range=e.data("relativeValue"),n.absolute_time_range=[];return n},sensorsdata.ClusteringControl.prototype.changeProfileType=function(e,t){t=t||{};var n=t.relative_time_range,i={allowStatic:!0,allowDisplayTip:!0};if(0===e){var s=sensorsdata.CONSTSET;$.isArray(t.absolute_time_range)&&2===t.absolute_time_range.length?(i.startDate=moment(t.absolute_time_range[0],s.timeFormat).startOf("day"),i.endDate=moment(t.absolute_time_range[1],s.timeFormat).startOf("day")):i.chosenLabel=sensorsdata.languages.get("本周<!--{en}This week-->")}else i.allowRelative=!0,i.relativeValue=n,i.chosenLabel=n?sensorsdata.convertRelativeTimeLabel(n):sensorsdata.languages.get("本周<!--{en}This week-->");var a=this;sensorsdata.initDateRangeInput(this.$timeRange_,i),this.$timeRange_.unbind("apply.daterangepicker").bind("apply.daterangepicker",function(){a.options_.valueChangedFunc()}),this.changeFilterProfileType_(e),this.options_.profileType=e},sensorsdata.ClusteringControl.prototype.prepareData=function(e,t){sensorsdata.ajax({useCache:!0,url:"event/"+e+"/properties",success:sensorsdata.bind(function(e){if($.isEmptyObject(e)||!$.isArray(e.event)||!$.isArray(e.user))throw"ajax return error json.";e=$.extend(!0,{},e),delete e.user,e.event=e.event.filter(function(e){return"$user_id"!==e.name}),this.propObj_=e,t(e)},this)})},sensorsdata.ClusteringEventFilter=function(e){sensorsdata.ClusteringControl.call(this),this.defaultValue_={type:1,event_filter:{event_name:"",filter:{relation:"",conditions:[]}},min_repeated_times:0,max_repeated_times:0,relative_time_range:"",absolute_time_range:[]},this.options_={container:null,profileType:0,valueChangedFunc:function(){},removedEventFilter:function(){},value:{},label:{timesTypes:[{name:sensorsdata.languages.get("至少<!--{en}at least-->"),value:"least"},{name:sensorsdata.languages.get("至多<!--{en}at most-->"),value:"most"},{name:sensorsdata.languages.get("区间<!--{en}range-->"),value:"between"},{name:sensorsdata.languages.get("0 次<!--{en}0 item-->"),value:"never"}]}},$.extend(!0,this.options_,e),this.events_=$.extend(!0,[],sensorsdata.cache.events.filter(function(e){return e.virtual===!1})),this.tpl_=$("#tpl-clustering-index-filter-item").html(),this.$container_=this.renderTpl_(this.tpl_),this.$itemCondContainer_=this.$container_.find("#filter-item-cond"),this.$btnAdd_=this.$container_.find("#btnAdd"),this.$timeRange_=this.$container_.find("#filter-time-range"),this.$eventsContainer_=this.$container_.find("#filter-events"),this.$timesType_=this.$container_.find("#filter-repeated-times-type"),this.$inputTimes_=this.$container_.find('.input-times[type="text"]'),this.filterControl_=new sensorsdata.FilterGroupControl,this.init_()},sensorsdata.inherits(sensorsdata.ClusteringEventFilter,sensorsdata.ClusteringControl),sensorsdata.ClusteringEventFilter.prototype.init_=function(){this.initEvents_(),this.changeProfileType(this.options_.profileType,this.options_.value);var e=this.options_.value,t="";t=!$.isEmptyObject(e.event_filter)&&e.event_filter.event_name?e.event_filter.event_name:this.events_[0].name,this.renderEvents_(t),this.prepareData(t,sensorsdata.bind(this.initFilter_,this)),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||this.$container_.find("button,input").prop("disabled",!0)},sensorsdata.ClusteringEventFilter.prototype.changeFilterProfileType_=function(e){this.filterControl_.changeTimeType(0===e?"absolute":"")},sensorsdata.ClusteringEventFilter.prototype.val=function(){if(null===this.$container_)return{};var e=$.extend(!0,{},this.defaultValue_),t=this.getTimeRange_(this.$timeRange_,this.options_.profileType);$.extend(!0,e,t);var n=this.$timesType_.attr("data-value"),i=parseInt(this.$inputTimes_.eq(0).val(),10),s=parseInt(this.$inputTimes_.eq(1).val(),10);if(!$.isNumeric(i)&&"never"!==n)return{};if("least"===n)e.min_repeated_times=i,e.max_repeated_times=0,e.min_repeated_times>0?sensorsdata.form.removeError(this.$inputTimes_.eq(0)):sensorsdata.form.addError(this.$inputTimes_.eq(0),sensorsdata.languages.get("必须大于0<!--{en}Must be greater than 0-->"),!0);else if("most"===n)e.min_repeated_times=0,e.max_repeated_times=i;else if("between"===n){if(!$.isNumeric(s))return{};if(i>s)return sensorsdata.form.addError(this.$inputTimes_.eq(1),sensorsdata.languages.get("必须大于左侧数字<!--{en}Must be greater than the number on the left-->"),!0),{};sensorsdata.form.removeError(this.$inputTimes_.eq(1)),e.min_repeated_times=i,e.max_repeated_times=s}else e.min_repeated_times=0,e.max_repeated_times=0;e.event_filter.event_name=this.$eventsContainer_.data("selected-event");var a=this.filterControl_.val();return e.event_filter.filter.conditions=a.conditions||[],$.isArray(a.conditions)&&a.conditions.length>0&&(e.event_filter.filter.relation=a.relation),e},sensorsdata.ClusteringEventFilter.prototype.toggleNeverError=function(e){if(e===!1)sensorsdata.form.removeError(this.$timesType_);else{var t='<div style="text-align:left;">选择 0 次 须满足至少一个条件：</br>';t+="1. 有一个用户属性过滤条件 </br>",t+="2. 明确做过某个事件</br>",t+="3. 有个行为序列条件</div>",sensorsdata.form.addError(this.$timesType_,t,!0,{html:!0})}},sensorsdata.ClusteringEventFilter.prototype.renderTpl_=function(e){var t=this.options_,n=t.value,i="least",s=1,a=0;n.min_repeated_times>0&&0===n.max_repeated_times?(i="least",s=n.min_repeated_times):0===n.min_repeated_times&&n.max_repeated_times>0?(i="most",s=n.max_repeated_times):n.min_repeated_times>0&&n.max_repeated_times>0?(i="between",s=n.min_repeated_times,a=n.max_repeated_times):0===n.min_repeated_times&&0===n.max_repeated_times&&(i="never",s=n.min_repeated_times,a=n.max_repeated_times);var r=this.findDefault_(t.label.timesTypes,function(e){return e.value===i}),o=$(Mustache.render(e,{events:this.events_,selectedTimesType:r,timesTypes:t.label.timesTypes,isNever:"never"===r.value,isBetween:"between"===r.value,leftValue:s,rightValue:a}));return t.container.append(o),o},sensorsdata.ClusteringEventFilter.prototype.initFilter_=function(){var e=this.options_.value;this.filterControl_.init({container:this.$itemCondContainer_,propertyObj:this.propObj_,timeType:0===this.options_.profileType?"absolute":"",disabled:!(sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege)}),$.isEmptyObject(e)||this.filterControl_.val({relation:e.event_filter.filter.relation,conditions:e.event_filter.filter.conditions})},sensorsdata.ClusteringEventFilter.prototype.renderEvents_=function(e){var t=this;this.$eventsContainer_.eventDropdown("destroy").eventDropdown({events:this.events_,eventName:e,virtualDisplay:!1,onChange:function(e){t.prepareData(e,sensorsdata.bind(t.initFilter_,t)),t.options_.valueChangedFunc()}}),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||this.$eventsContainer_.find("button").prop("disabled",!0)},sensorsdata.ClusteringEventFilter.prototype.initEvents_=function(){var e=this;this.$container_.unbind("click.clustering-event-filter").bind("click.clustering-event-filter",sensorsdata.bind(this.containerClick_,this)),this.$btnAdd_.unbind("click").bind("click",function(){e.filterControl_.addFilter()}),this.$timesType_.saDropdown({onSelected:function(t){sensorsdata.form.removeChildrenError(e.$container_.find(".clustering-event-filter-item")),e.$inputTimes_.eq(0).toggle("never"!==t);var n="between"===t;e.$inputTimes_.eq(1).toggle(n),e.$container_.find('[data-type="repeated-times-split"]').toggle(n),e.options_.valueChangedFunc()}}),this.$inputTimes_.unbind("focusout.clustering-event-filter").bind("focusout.clustering-event-filter",function(){e.options_.valueChangedFunc()}),this.filterControl_.bindEvent("valueChangedEvent",function(){e.options_.valueChangedFunc()}),this.filterControl_.bindEvent("inputKeyupEvent",function(){e.options_.valueChangedFunc()})},sensorsdata.ClusteringEventFilter.prototype.containerClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.attr("data-method");switch(n){case"remove-filter":this.$container_.find("[data-original-title]").tooltip("destroy"),this.$container_.remove(),this.$container_=null,this.options_.removedEventFilter(this),this.options_.valueChangedFunc()}},sensorsdata.ClusteringEventFilter.prototype.findDefault_=function(e,t){var n=sensorsdata.findIndex(e,t);return-1===n?e[0]:e[n]},sensorsdata.ClusteringEventSeq=function(e){sensorsdata.ClusteringControl.call(this),this.options_={container:null,profileType:0,value:{relative_time_range:"",event_filter_sequence:[]},label:{}},$.extend(!0,this.options_,e),this.events_=$.extend(!0,[],sensorsdata.cache.events.filter(function(e){return e.virtual===!1}));var t=$("#tpl-clustering-index-event-seq").html();this.container_=$(t),this.options_.container.append(this.container_),this.tplItem_=$("#tpl-clustering-index-event-seq-item").html(),this.$timeRange_=this.container_.find("#filter-time-range"),this.$btnAddEvent_=this.container_.find("#btn-add-event"),this.init_(),this.initEvents_()},sensorsdata.inherits(sensorsdata.ClusteringEventSeq,sensorsdata.ClusteringControl),sensorsdata.ClusteringEventSeq.prototype.init_=function(){var e=this.options_,t=e.value;if(this.changeProfileType(e.profileType,t),t.event_filter_sequence.length>0)for(var n=0,i=t.event_filter_sequence.length;i>n;n++)this.add_(t.event_filter_sequence[n]);else this.add_();sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege?Sortable.create(this.container_.find("#seq-container")[0],{animation:200,handle:".fu-filter-pos"}):(this.options_.container.find("button,input").prop("disabled",!0),this.container_.find('[draggable="true"]').removeAttr("draggable"),this.container_.find(".fu-filter-pos").addClass("disabled"))},sensorsdata.ClusteringEventSeq.prototype.initEvents_=function(){var e=this;this.$btnAddEvent_.unbind("click.clustering-event-seq").bind("click.clustering-event-seq",function(){e.add_(),e.options_.valueChangedFunc()}),this.container_.unbind("click.clustering-event-seq").bind("click.clustering-event-seq",sensorsdata.bind(this.containerClick_,this))},sensorsdata.ClusteringEventSeq.prototype.val=function(){if(null===this.container_)return{};var e={type:2,event_filter_sequence:[]},t=this.getTimeRange_(this.$timeRange_,this.options_.profileType);return $.extend(!0,e,t),this.container_.find('div[data-method="event-seq-item"]').each(function(){var t=$(this).find("#seq-filter").data("sa-filter-control");e.event_filter_sequence.push({event_name:$(this).find("#seq-event").data("selected-event"),filter:t?t.val():{}})}),e},sensorsdata.ClusteringEventSeq.prototype.add_=function(e){e=e||{};var t=[];this.container_.find("#seq-event").each(function(){t.push($(this).data("selected-event"))});var n=$(Mustache.render(this.tplItem_,{events:this.events_}));this.container_.find("#seq-container").append(n);var i=e.event_name;if(!i)for(var s=0,a=this.events_.length;a>s;s++)if(-1===t.indexOf(this.events_[s].name)){i=this.events_[s].name;break}var r=n.find("#seq-event");this.renderEvents_(r,i),i=r.data("selected-event"),r=n.find("#seq-filter");var o=this;this.prepareData(i,function(t){var n=new sensorsdata.FilterGroupControl;o.renderFilter_(n,r,t,e.filter)}),sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege||r.find("button,input").prop("disabled",!0)},sensorsdata.ClusteringEventSeq.prototype.renderEvents_=function(e,t){var n=this;e.eventDropdown("destroy").eventDropdown({events:this.events_,eventName:t,virtualDisplay:!1,onChange:function(t){var i=e.parents('[data-method="event-seq-item"]:first').find("#seq-filter"),s=i.data("sa-filter-control");s instanceof sensorsdata.FilterGroupControl||(s=new sensorsdata.FilterGroupControl),n.prepareData(t,function(e){n.renderFilter_(s,i,e)}),n.options_.valueChangedFunc()}})},sensorsdata.ClusteringEventSeq.prototype.renderFilter_=function(e,t,n,i){var s=this;e.init({container:t,propertyObj:n,timeType:0===s.options_.profileType?"absolute":"",disabled:!(sensorsdata.authority.isAdmin||sensorsdata.authority.isAnalyst&&sensorsdata.cache.config.allow_analyst_higher_privilege)}),e.val(i),e.bindEvent("valueChangedEvent",function(){s.options_.valueChangedFunc()}),e.bindEvent("inputKeyupEvent",function(){s.options_.valueChangedFunc()}),t.data("sa-filter-control",e)},sensorsdata.ClusteringEventSeq.prototype.containerClick_=function(e){var t=$(e.target||e.srcElement);t.attr("data-method")||(t=t.parents("[data-method]:first"));var n=t.parents('[data-method="event-seq-item"]'),i=t.attr("data-method");switch(i){case"add-condition":n.find("#seq-filter").data("sa-filter-control").addFilter();break;case"remove-event":this.container_.html(""),this.container_=null,this.options_.valueChangedFunc();break;case"remove-filter":n.remove(),this.options_.valueChangedFunc(),0===this.container_.find("#seq-container").children().size()&&(this.container_.remove(),this.container_=null)}},sensorsdata.ClusteringEventSeq.prototype.changeFilterProfileType_=function(e){if(this.container_){var t=0===e?"absolute":"";this.container_.find('[id="seq-container"] [id="seq-filter"]').each(function(){var e=$(this).data("sa-filter-control");e instanceof sensorsdata.FilterGroupControl&&e.changeTimeType(t)})}};