sensorsdata.SegmentationBase=function(e){sensorsdata.BasePage.call(this),this.pageName=window.location.pathname,this.sessions=[],this.events=(e||{}).events||$.extend(!0,[],sensorsdata.cache.events),"ALL"===sensorsdata.authority.eventPermission.type&&this.events.unshift(sensorsdata.CONSTSET.everyEvent),this.paramObj={},this.propObj={},this.sessionFunction={general:sensorsdata.languages.get("Session 总次数<!--{en}Session Totals-->"),unique:sensorsdata.languages.get("触发用户数<!--{en}Unique Users-->"),average:sensorsdata.languages.get("人均 Session 次数<!--{en}Average-->")},this.timeFormat="YYYY-MM-DD HH:00:00"},sensorsdata.inherits(sensorsdata.SegmentationBase,sensorsdata.BasePage),sensorsdata.SegmentationBase.prototype.validResponse=function(e){return $.isEmptyObject(e)?!0:$.isArray(e.series)&&$.isArray(e.rows)&&e.rows.length>0?e.series.length===e.rows[0].values.length:!0},sensorsdata.SegmentationBase.prototype.buildMeasureNames=function(e,s){e=e===!0?!0:!1,s=s===!1?!1:!0;var t=this.paramObj.measures,a=this.propObj,n=!!this.paramObj.session_name,r=[];if(!$.isArray(t)||0===t.length)return r;var i=[];e===!0&&(i=this.buildMeasureUnits());for(var o="",m=0,d=t.length;d>m;m++){o="";var u=t[m];if(u.expression)r.push(u.name);else{var l="";n&&(l=this.sessionFunction[u.aggregator]),l=l||sensorsdata.CONSTSET.measureFunctions[u.aggregator].cname;var f=sensorsdata.findProperty(u.field,a.original[u.event_name]);if(s===!0){var g=sensorsdata.findEventCname(u.event_name,this.events);g&&(o+=g+sensorsdata.languages.get("的<!--{en} . -->"))}o+=($.isEmptyObject(f)?"":f.cname+sensorsdata.languages.get("的<!--{en} . -->"))+l,e===!0&&i[m]&&(o+="("+i[m]+")"),r.push(o)}}return r},sensorsdata.SegmentationBase.prototype.checkPercent=function(e){return e.expression&&"%2p"===e.format||"bounce_rate"===e.aggregator||"exit_rate"===e.aggregator},sensorsdata.SegmentationBase.prototype.buildMeasureUnits=function(){var e=this.paramObj.measures,s=this.propObj,t=[];if(!$.isArray(e)||0===e.length)return t;for(var a=sensorsdata.CONSTSET.measureFunctions,n=0,r=e.length;r>n;n++){var i=e[n];if(i.expression)t.push(this.checkPercent(i)?"%":"");else{var o="";if(i.field){var m=sensorsdata.findProperty(i.field,s.original[i.event_name]);$.isEmptyObject(m)||(o=m.unit||"")}!o&&a[i.aggregator]&&(o=a[i.aggregator].unit||""),t.push(o)}}return t},sensorsdata.SegmentationBase.prototype.clearAjaxData=function(e){var s=$.extend(!0,{},e);delete s.chartsType,delete s.rangeText,$.isArray(s.measures)&&s.measures.length>0&&s.measures.map(function(e){e.event_name===sensorsdata.CONSTSET.sessionGeneral.name&&(e.event_name=sensorsdata.CONSTSET.eventEmptyValue)});var t="hour"!==s.unit&&"minute"!==s.unit||s.compare_from_date||s.compare_to_date?sensorsdata.CONSTSET.dateFormat:this.timeFormat,a=moment(s.from_date,this.timeFormat);return s.from_date=a.format(t),a=moment(s.to_date,this.timeFormat),s.to_date=a.format(t),s.compare_from_date&&s.compare_to_date&&(a=moment(s.compare_from_date,this.timeFormat),s.compare_from_date=a.format(sensorsdata.CONSTSET.dateFormat),a=moment(s.compare_to_date,this.timeFormat),s.compare_to_date=a.format(sensorsdata.CONSTSET.dateFormat)),s},sensorsdata.SegmentationBase.prototype.removeInvalidProperties=function(e,s,t){if($.isArray(e.by_fields)&&e.by_fields.length>0){var a=[],n=[];e.by_fields.map(function(e){var t=sensorsdata.findProperty(e,s.intersection);$.isEmptyObject(t)?n.push(e.split(".").pop()):a.push(e)}),n.length>0&&(e.by_fields=a,t!==!1&&sensorsdata.info.show(sensorsdata.languages.get("属性<!--{en}Property-->")+n.join("、")+sensorsdata.languages.get("不存在或已被隐藏，已从查询中去掉<!--{en}Does not exist or has been hided.Has been removed from the query.-->")))}return e},sensorsdata.SegmentationBase.prototype.getPageStatusItem_=function(e){var s=null,t=sensorsdata.localStorage.getItem(this.pageName);if(t){var a=JSON.parse(t);if(!$.isEmptyObject(a))return a[e]}return s},sensorsdata.SegmentationBase.prototype.dealParam=function(e){var s=$.extend(!0,[],sensorsdata.cache.events);if("ALL"===sensorsdata.authority.eventPermission.type&&s.unshift(sensorsdata.CONSTSET.everyEvent),e=e||{},e.session_name&&sensorsdata.cache.sessions.length>0){var t=sensorsdata.cache.sessions.filter(function(s){return s.name===e.session_name})[0];t||(t=sensorsdata.cache.sessions[0],e.session_name=t.name,delete e.filter),s=$.extend(!0,[],sensorsdata.cache.events).filter(function(e){return t.event_list.indexOf(e.name)>=0}),"ALL"===sensorsdata.authority.eventPermission.type&&s.unshift(sensorsdata.CONSTSET.everyEvent),s.unshift(sensorsdata.CONSTSET.sessionGeneral)}if($.isEmptyObject(e)||e.session_name||($.isArray(e.measures)&&(e.measures=e.measures.filter(function(e){return!e.by_session})),!$.isEmptyObject(e.filter)&&$.isArray(e.filter.conditions)&&(e.filter.conditions=e.filter.conditions.filter(function(e){return!(3===e.field.split(".").length&&0===e.field.indexOf("session."))}),0===e.filter.conditions.length&&delete e.filter)),!$.isEmptyObject(e)&&$.isArray(e.measures)){for(var a=this.getEventNamesFromParam(e.measures),n=[],r=0,i=a.length;i>r;r++)if(!e.session_name||a[r]!==sensorsdata.CONSTSET.sessionGeneral.name){var o=s.filter(function(e){return e.name===a[r]})[0];$.isEmptyObject(o)&&n.push(a[r])}if(n.length>0){e.measures=e.measures.filter(function(e){if(e.event_name&&n.indexOf(e.event_name)>=0)return!1;if($.isArray(e.events)&&e.events.length>=0)for(var s=0,t=e.events.length;t>s;s++)if(n.indexOf(e.events[s])>=0)return!1;return!0});var m=sensorsdata.languages.get("事件<!--{en}Event-->")+n.join("、")+sensorsdata.languages.get("不存在或没此事件权限，已从查询中去掉此事件<!--{en}Does not exist or does not have the event permission.The event has been removed from the query.-->");sensorsdata.info.show(m)}}var d=sensorsdata.buildDefaultTimeRange(),u=this.getPageStatusItem_("ratioActive"),l=this.getPageStatusItem_("tableType"),f={measures:[{event_name:s[0].name,aggregator:"general",field:""}],unit:"day",from_date:d[0].format(sensorsdata.CONSTSET.dateFormat),to_date:d[1].format(sensorsdata.CONSTSET.dateFormat),axis_config:{isNormalize:!1,left:[],right:[]}};if(f.measures[0].event_name===sensorsdata.CONSTSET.sessionGeneral.name&&(f.measures[0].by_session=!0),u&&(f.ratio=u),l&&(f.tType=l),e.session_name&&(f.session_name=e.session_name),e.sampling_factor&&(f.sampling_factor=e.sampling_factor),e.rangeText){var g=sensorsdata.buildTimeRanges();if(g[e.rangeText]){var p="hour"===e.unit||"minute"===e.unit,c=p?this.timeFormat:sensorsdata.CONSTSET.dateFormat;e.from_date=g[e.rangeText][0].format(c),e.to_date=g[e.rangeText][1].hour(p?23:0).format(c)}}var h=this.clearAjaxData(e);if($.isEmptyObject(e)||$.isEmptyObject(h)||!$.isArray(e.measures)||0===e.measures.length)return f;if(delete e.count_type,e.measures.map(function(e){"string"==typeof e.by_session&&(e.by_session="true"===e.by_session)}),e.eventName||e.event_name){var v={event_name:e.event_name||e.eventName};e.type?v.aggregator="total"===e.type?"general":e.type:$.isEmptyObject(e.aggregate)||(v.aggregator=e.aggregate.aggregator,v.field=e.aggregate.field),e.measures=[v],delete e.eventName,delete e.event_name,delete e.type,delete e.aggregate}if(moment(e.from_date,this.timeFormat).isValid()===!1&&delete e.from_date,moment(e.to_date,this.timeFormat).isValid()===!1&&delete e.to_date,moment(e.compare_from_date,this.timeFormat).isValid()===!1&&delete e.compare_from_date,moment(e.compare_to_date,this.timeFormat).isValid()===!1&&delete e.compare_to_date,$.isArray(e.by_fields)||(e.by_fields=[]),e.sampling_factor&&(e.sampling_factor=sensorsdata.BookmarkSave.dealSamplingValue(e.sampling_factor)),e.filter=sensorsdata.FilterGroupControl.dealCompatible(e.filter),$.isEmptyObject(e.bucket_params))delete e.bucket_params;else for(var _ in e.bucket_params)if(e.bucket_params.hasOwnProperty(_)){var y=e.bucket_params[_],b=sensorsdata.buildBucketPopoverValue(y);b.length>0?e.bucket_params[_]=b:delete e.bucket_params[_]}e.hasOwnProperty("axis_config")?(e.axis_config.isNormalize=e.axis_config.isNormalize+""=="true",e.axis_config.left=e.axis_config.left&&$.isArray(e.axis_config.left)?e.axis_config.left.map(function(e){return $.isNumeric(e)?parseInt(e,10):void 0}):[],e.axis_config.right=e.axis_config.right&&$.isArray(e.axis_config.right)?e.axis_config.right.map(function(e){return $.isNumeric(e)?parseInt(e,10):void 0}):[]):e.axis_config={isNormalize:!1,left:[],right:[]},!e.tType&&l&&(e.tType=l),!e.ratio&&u&&(e.ratio=u);var S=this.getEventNamesFromParam(e.measures);return $.isEmptyObject(e.filter)||1!==S.length||(e.filter.conditions=e.filter.conditions.map(function(e){var s=e.field.split(".");return 3===s.length&&"event"===s[0]&&s[1]!==S[0]&&(s[1]=S[0],e.field=s.join(".")),e})),$.isArray(e.by_fields)&&1===S.length&&(e.by_fields=e.by_fields.map(function(e){var s=e.split(".");return 3===s.length&&"event"===s[0]&&s[1]!==S[0]&&(s[1]=S[0],e=s.join(".")),e})),e.approx=e.approx+""=="true",e.chartsType=e.chartsType||"line",e},sensorsdata.SegmentationBase.prototype.convertAjaxModel=function(e){if($.isEmptyObject(e)||!$.isArray(e.series)||0===e.series.length||!$.isArray(e.rows)||0===e.rows.length)return{};var s=this.buildMeasureNames(!0).join("，"),t=$.extend(!0,{},this.paramObj.bucket_params)||{};for(var a in t){var n=a.split(".");3===n.length&&(n[1]="$Anything",t[n.join(".")]=t[a])}var r=this.propObj.intersection,i={series:e.series,rows:[],num:e.num_rows},o=(e.by_fields||[]).length,m=s;return e.rows.map(sensorsdata.bind(function(s,a){if(o>0){for(var n=[],d=0,u=s.by_values.length;u>d;d++){var l=s.by_values[d],f=sensorsdata.findProperty(e.by_fields[d],r)||{};l=sensorsdata.formatByValue(l,f.data_type,"",t[e.by_fields[d]]),n.push(l)}m=n.join("，")}i.rows.push({name:m,data:s.values,rowIndex:a})},this)),i},sensorsdata.SegmentationBase.prototype.getEventNamesFromParam=function(e){var s=[];return e.map(function(e){e.event_name?-1===s.indexOf(e.event_name)&&s.push(e.event_name):$.isArray(e.events)&&e.events.map(function(e){-1===s.indexOf(e)&&s.push(e)})}),s},sensorsdata.SegmentationBase.prototype.getSessions=function(e){var s=this;sensorsdata.ajax({useCache:!0,url:"sessions/all",success:sensorsdata.bind(function(t){return $.isArray(t)?(sensorsdata.cache.sessions=s.sessions=t,void e(t)):void sensorsdata.error.show(sensorsdata.languages.get("获取 Session 数据时数据格式错误，请联系技术人员"))},this)})},sensorsdata.SegmentationBase.prototype.getProperties=function(e,s){function t(e,s,t){for(var n in e.original)e.original.hasOwnProperty(n)&&(e.original[n].event=e.intersection.session.concat(e.original[n].event));var r=a.sessions.filter(function(e){return e.name===a.paramObj.session_name})[0].properties.session.filter(function(e){return e.session_name=a.paramObj.session_name,"$session_id"!==e.name&&"$session_position"!==e.name});return t?(e.intersection.session=r,e.intersection.event=[]):s?e.intersection.session=r:(e.intersection.session=r,e.intersection.event=[]),e.original[sensorsdata.CONSTSET.sessionGeneral.name]={event:r,user:[]},e}e=e.filter(function(e,s,t){return t.indexOf(e)===s});var a=this,n=e.filter(function(e){return e!==sensorsdata.CONSTSET.sessionGeneral.name}),r=n.length===e.length,i=0===n.length;0===n.length&&n.push(sensorsdata.CONSTSET.eventEmptyValue),sensorsdata.ajax({useCache:!0,url:"event/properties?events="+n.join(",")+"&method=mixed",success:sensorsdata.bind(function(e){if($.isEmptyObject(e))return void sensorsdata.error.show(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->"));var n=$.extend(!0,{},e);if(a.paramObj.session_name)n=t(n,r,i);else{delete n.intersection.session;var o=n.intersection;for(var m in o)o.hasOwnProperty(m)&&$.isArray(o[m])&&(o[m]=o[m].filter(function(e){return e.is_dimension||(e.is_dimension=!0),e.is_dimension!==!1}))}s(n)},this)})};