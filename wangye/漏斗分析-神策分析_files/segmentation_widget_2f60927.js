sensorsdata.SegmentationWidget=function(e){if($.isEmptyObject(e))throw"Init segmentationWidget error, parameter is empty.";if(e.configContainer instanceof jQuery==!1||e.contentContainer instanceof jQuery==!1)throw console.info(e),"Init segmentationWidget error, container is not jQuery object.";if(!$.isFunction(e.saveConfig))throw console.info(e),"Init segmentationWidget error, saveConfig is not function.";if($.isEmptyObject(e.widgetObj)||$.isEmptyObject(e.widgetObj.bookmark))throw console.info(e),"Init segmentationWidget error, widgetObj is empty.";sensorsdata.SegmentationBase.call(this),this.configContainer_=e.configContainer,this.contentContainer_=e.contentContainer,this.bookmark_=e.widgetObj.bookmark,this.dashboardConfig_=e.dashboardConfig,this.rawConfig_=e.config,this.config_=$.extend(!0,{},e.config),this.saveConfig_=e.saveConfig,this.tplLoader_=$("#tpl-widget-loader").html(),this.tplConfig_=$("#tpl-segmentation-widget-config").html(),this.tplConfigType_=$("#tpl-segmentation-widget-config-type").html(),this.tplContent_=$("#tpl-segmentation-widget-content").html(),this.tplKeyInfo_=$("#tpl-segmentation-widget-content-key-info").html(),this.tplNumber_=$("#tpl-segmentation-widget-number").html(),this.tplTable_=$("#tpl-segmentation-widget-table").html(),this.segsCache_={},this.compareSegsCache_={},this.segObj_={},this.compareSegObj_={},this.chart_=null,this.isCompare_=!1,this.widgetTypes_=[{value:"number",text:sensorsdata.languages.get("数字<!--{en}Number-->"),icon:"icon-num btn-icon"},{value:"line",text:sensorsdata.languages.get("线图<!--{en}Line chart-->"),icon:"icon-line-chart btn-icon"},{value:"column",text:sensorsdata.languages.get("柱图<!--{en}Bar chart-->"),icon:"icon-bar-chart btn-icon"},{value:"pie",text:sensorsdata.languages.get("饼图<!--{en}Pie chart-->"),icon:"icon-pie-chart btn-icon"},{value:"table",text:sensorsdata.languages.get("表格<!--{en}Form-->"),icon:"icon-table btn-icon"},{value:"stack",text:sensorsdata.languages.get("累积<!--{en}Stack graph-->"),icon:"icon-stack-chart btn-icon"}],this.UNIT={rollup:sensorsdata.languages.get("合计<!--{en}Total-->"),minute:sensorsdata.languages.get("按分钟<!--{en}By minute-->"),hour:sensorsdata.languages.get("按小时<!--{en}By hour-->"),day:sensorsdata.languages.get("按天<!--{en}By day-->"),week:sensorsdata.languages.get("按周<!--{en}By week-->"),month:sensorsdata.languages.get("按月<!--{en}By month-->")},this.renderAllow_=!1,this.dataAlready_=!1,this.measureNames_=[],this.measureUnits_=[],this.seriesLen_=0,this.isOverRowsLimit_=!1,this.rowsLimit_=50,this.config_.widgetTime||(this.config_.widgetTime=this.dashboardConfig_.widgetTime),this.config_.widgetUnit||(this.config_.widgetUnit=this.dashboardConfig_.widgetUnit),this.init()},sensorsdata.inherits(sensorsdata.SegmentationWidget,sensorsdata.SegmentationBase),sensorsdata.SegmentationWidget.prototype.render=function(){this.renderAllow_=!0,this.dataAlready_===!0&&this.renderContent_(this.config_)},sensorsdata.SegmentationWidget.prototype.resize=function(){this.chart_&&$.isFunction(this.chart_.resize)&&this.chart_.resize()},sensorsdata.SegmentationWidget.prototype.refresh=function(e,t){$.isEmptyObject(e)||(e.widgetTime&&(this.config_.widgetTime=e.widgetTime),e.widgetUnit&&(this.config_.widgetUnit=e.widgetUnit)),this.init(t)},sensorsdata.SegmentationWidget.prototype.init=function(e){this.setEmpty_(this.tplLoader_);var t=this.paramObj=JSON.parse(this.bookmark_.data);this.config_.widgetUnit&&(t.unit=this.config_.widgetUnit),this.isCompare_=!(!t.compare_from_date||!t.compare_to_date),"boolean"==typeof e?t.use_cache=e:delete t.use_cache,this.config_.widgetType=this.buildWidgetType_(this.config_),"pie"===this.config_.widgetType&&(this.config_.widgetUnit="rollup");var s=this.config_.widgetUnit;s?"rollup"===s?(t.rollup_date=!0,t.unit="day"):(t.rollup_date=!1,t.unit=s):this.config_.widgetUnit=t.unit,sensorsdata.fillBookmarkTime(this.paramObj,this.config_.widgetTime,sensorsdata.CONSTSET.dateRangeLimit[t.unit]),this.renderConfig_(this.config_),this.changeRedirectUrl_(),this.segsCache_={},this.compareSegsCache_={},this.segObj_={},this.compareSegObj_={},this.config_.widgetByValues=[];var i=this;this.contentContainer_.off("click",'[data-method="time-change"]').on("click",'[data-method="time-change"]',function(){var e=$(this);if(!e.is(":disabled")){var t=parseInt(e.siblings("[data-series-index]").attr("data-series-index"),10);"left"===e.attr("data-type")?t--:t++,t>=0&&t<i.seriesLen_&&(i.config_.widgetIndex=t,i.renderContent_(i.config_))}}),this.contentContainer_.parents("article.dashboard-widget:first").find("header h4").unbind("click.segmentation-widget").bind("click.segmentation-widget",function(){var e="segmentation-widget-"+i.bookmark_.id;sensorsdata.localStorage.setItem(e,JSON.stringify(i.config_.widgetByValues||[]))}),this.contentContainer_.off("click",".dashboard-widget-chart").on("click",".dashboard-widget-chart",function(e){var t=$(e.target||e.srcElement),s=t.attr("data-m-index");if(s&&$.isNumeric(s)&&"pointer"===t.css("cursor")){var a=$.extend(!0,{},i.paramObj);s=parseInt(s,10),a.measures=[a.measures[s]],delete a.ignore_cache_expire,delete a.bookmarkid,sensorsdata.indexPage.initPage("/segmentation/#"+$.param(a))}});var a=function(){var e=i.getEventNamesFromParam(i.paramObj.measures);i.getProperties(e,function(e){i.propObj=$.extend(!0,{},e),i.paramObj=i.removeInvalidProperties(t,i.propObj,!1),i.measureNames_=i.buildMeasureNames(),i.measureUnits_=i.buildMeasureUnits(),i.getWidgetData_(i.config_)})};i.paramObj.session_name?i.getSessions(function(){var e=i.sessions.filter(function(e){return e.name===i.paramObj.session_name})[0];e?a():i.setEmpty_(sensorsdata.util.format(sensorsdata.languages.get("Session #{session_name} 已被删除，请删除此书签。<!--{en}Session #{session_name} has been deleted, please delete this bookmark.-->"),i.paramObj))}):a()},sensorsdata.SegmentationWidget.prototype.getWidgetData_=function(e){var t=this.paramObj,s=e.widgetUnit,i=sensorsdata.bind(function(){if(!$.isEmptyObject(this.segObj_)){var t=[];if($.isArray(e.widgetByValues)&&0!==e.widgetByValues.length){var s=this.segObj_.rows.map(function(e){return e.name});e.widgetByValues.map(function(e){s.indexOf(e)>=0&&t.push(e)}),0===t.length&&(t=s.slice(0,3))}else t=this.getTopByValues_();this.config_.widgetByValues=t}},this),a=sensorsdata.bind(function(){$.isEmptyObject(this.segObj_)||(this.config_.widgetIndex=this.segObj_.series.length-1)},this),n=sensorsdata.bind(function(){$.isEmptyObject(this.segObj_)?this.seriesLen_=0:(this.seriesLen_=this.segObj_.series.length,this.isCompare_&&this.seriesLen_<this.compareSegObj_.series.length&&(this.seriesLen_=this.compareSegObj_.series.length))},this),r=sensorsdata.bind(function(){i(),a(),n(),this.renderAllow_===!0&&this.renderContent_(this.config_)},this),o=s+t.from_date+t.to_date;$.isEmptyObject(this.segsCache_[o])?(this.setEmpty_(this.tplLoader_),this.getSegs_(t,s,r)):(this.segObj_=this.segsCache_[o],this.compareSegObj_=this.compareSegsCache_[o],r())},sensorsdata.SegmentationWidget.prototype.getTopByValues_=function(){for(var e=[],t=0,s=this.segObj_.rows.length;s>t;t++){var i=this.segObj_.rows[t];e.push({name:i.name,sum:i.data.reduce(function(e,t){return($.isArray(e)?e[0]:e)+t[0]})})}return e.sort(function(e,t){return t.sum-e.sum}),e.slice(0,3).map(function(e){return e.name})},sensorsdata.SegmentationWidget.prototype.buildWidgetType_=function(e){var t=e.widgetUnit,s=e.widgetType,i=this.paramObj,a=i.measures.length>1,n=(i.by_fields||[]).length>0;if(s){var r=this.getDisplayTypes_(a,t,n,i.measures);return-1===r.indexOf(s)?r[0]:s}if(a)return"number";if("rollup"===t)return"number";if("rollup"!==t){var o=sensorsdata.convertTimeRange(this.config_.widgetTime),d=Math.abs(o[0].startOf(t).diff(o[1].startOf(t)));if(1>=d)return"table"}return"line"},sensorsdata.SegmentationWidget.prototype.renderConfig_=function(e){var t=this.paramObj,s=(t.by_fields||[]).length>0,i=t.measures.length>1,a=sensorsdata.bind(function(e,a){var n=this.getDisplayTypes_(i,e,s,t.measures),r=$.extend(!0,[],this.widgetTypes_),o=-1,d=-1;return r.map(function(e,t){e.display=-1!==n.indexOf(e.value),e.display&&e.value===a&&(o=t),e.display&&-1===d&&(d=t)}),-1!==o?r[o].active=!0:-1!==d&&(r[d].active=!0),1===n.length&&(r[d].display=!1),r},this),n=sensorsdata.CONSTSET.timeFormat,r=sensorsdata.CONSTSET.dateRangeLimit.hour,o=moment(t.to_date,n).diff(moment(t.from_date,n),"day")>r;o===!1&&this.isCompare_&&(o=moment(t.compare_to_date,n).diff(moment(t.compare_from_date,n),"day")>=r),r=sensorsdata.CONSTSET.dateRangeLimit.minute;var d=moment(t.to_date,n).diff(moment(t.from_date,n),"day")>r;d===!1&&this.isCompare_&&(d=moment(t.compare_to_date,n).diff(moment(t.compare_from_date,n),"day")>=r);var h=Mustache.render(this.tplConfig_,{unit:e.widgetUnit,unitText:this.UNIT[e.widgetUnit],hourDisabled:o,minuteDisabled:d});this.configContainer_.html(h),this.configContainer_.find('a[data-value="'+e.widgetUnit+'"]').parent().addClass("active");var g=this.configContainer_.find("span#widgetUnit"),l=g.parents("div.segmentation-unit:first");l.toggleClass("widget-config",!!this.rawConfig_.widgetUnit),l.find("ul a").bind("click",sensorsdata.bind(function(t){var s=$(t.target||t.srcElement),i=s.attr("data-value");i||(s=s.parents("a:first"),i=s.attr("data-value"));var n=s.parents("li:first");if(!n.hasClass("active")&&!n.hasClass("disabled")&&(n.addClass("active").siblings(".active").removeClass("active"),g.attr("data-value")!==i)){g.attr("data-value",i),g.html(l.find('ul a[data-value="'+i+'"]').html());var r=e.widgetRememberType||{},o="";"rollup"===i&&r.rollup?o=r.rollup:r.unit&&(o=r.unit);var d=Mustache.render(this.tplConfigType_,a(i,o||this.config_.widgetType)),h=this.configContainer_.find("div#widgetType").html(d).find("span.active").attr("data-value");"rollup"===i?(this.paramObj.rollup_date=!0,this.paramObj.unit="day"):(this.paramObj.rollup_date=!1,this.paramObj.unit=i),this.config_.widgetUnit=i,this.config_.widgetType=h,r["rollup"===i?"rollup":"unit"]=h,this.config_.widgetRememberType=r,this.getWidgetData_(this.config_),this.rawConfig_.widgetUnit=i,this.rawConfig_.widgetType=h,this.rawConfig_.widgetRememberType=r,this.saveConfig_(this.rawConfig_),this.changeRedirectUrl_(),l.addClass("widget-config")}},this));var u=this;l.find("span.icon-remove").unbind("click").bind("click",function(){return u.config_.widgetUnit=u.dashboardConfig_.widgetUnit,delete u.rawConfig_.widgetUnit,u.saveConfig_(u.rawConfig_),u.config_.widgetType=u.buildWidgetType_(u.config_),u.configContainer_.find('a[data-value="'+u.config_.widgetUnit+'"]').parent().addClass("active").siblings().removeClass("active"),g.attr("data-value",u.config_.widgetUnit).text(u.UNIT[u.config_.widgetUnit]),l.removeClass("widget-config"),"rollup"===u.config_.widgetUnit?(u.paramObj.rollup_date=!0,u.paramObj.unit="day"):(u.paramObj.rollup_date=!1,u.paramObj.unit=u.config_.widgetUnit),u.getWidgetData_(u.config_),u.changeRedirectUrl_(),!1});var m=Mustache.render(this.tplConfigType_,a(e.widgetUnit,e.widgetType));this.configContainer_.find("div#widgetType").html(m).bind("click",sensorsdata.bind(function(e){var t=$(e.target||e.srcElement);if("widgetType"===t.attr("data-method")){var s=t.attr("data-value");t.siblings().removeClass("active"),t.addClass("active");var i=this.config_.widgetRememberType||{};i["rollup"===this.config_.widgetUnit?"rollup":"unit"]=s,this.config_.widgetRememberType=i,this.config_.widgetType=s,this.renderContent_(this.config_),this.rawConfig_.widgetRememberType=i,this.rawConfig_.widgetType=s,this.saveConfig_(this.rawConfig_),this.changeRedirectUrl_()}},this))},sensorsdata.SegmentationWidget.prototype.getDisplayTypes_=function(e,t,s,i){var a=[];return e||"rollup"===t&&!s?a.push("number"):"rollup"===t&&s?(a.push("number"),a.push("pie")):(a.push("line"),a.push("column"),a.push("table"),("general"===i[0].aggregator||"SUM"===i[0].aggregator)&&a.push("stack")),a},sensorsdata.SegmentationWidget.prototype.getSegs_=function(e,t,s){var i=function(e){var t=sensorsdata.CONSTSET.dateFormat;return e.from_date=moment(e.from_date,t).format(t),e.to_date=moment(e.to_date,t).format(t),e.compare_from_date&&e.compare_to_date&&(e.compare_from_date=moment(e.compare_from_date,t).format(t),e.compare_to_date=moment(e.compare_to_date,t).format(t)),e},a=t+e.from_date+e.to_date,n="events/report?bookmarkId="+this.bookmark_.id;e.limit=this.rowsLimit_+1,e.ignore_cache_expire=!0,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST-"+n+"-"+t+"-"+this.bookmark_.id,url:n,method:"POST",data:i(this.clearAjaxData(e)),customErrorStatusCode:422,error:sensorsdata.bind(function(e){var t=sensorsdata.buildAjaxError(e.status,e.responseJSON);this.setEmpty_(t),this.segsCache_[a]=this.segObj_={},this.compareSegsCache_[a]=this.compareSegObj_={}},this),success:sensorsdata.bind(function(e){this.dataAlready_=!0,this.paramObj.compare_from_date&&this.paramObj.compare_to_date?$.isArray(e)&&2===e.length&&this.validResponse(e[0])&&this.validResponse(e[1])?(this.isOverRowsLimit_=e[0].rows.length>this.rowsLimit_,e[0].rows.splice(this.rowsLimit_),e[1].rows.splice(this.rowsLimit_),this.segsCache_[a]=this.segObj_=this.convertAjaxModel(e[0]),this.compareSegsCache_[a]=this.compareSegObj_=this.convertAjaxModel(e[1])):(this.setEmpty_(sensorsdata.languages.get("数据格式错误，请联系技术人员<!--{en}Data in wrong format, please contact with technicians-->")),this.segsCache_[a]=this.segObj_={},this.compareSegsCache_[a]=this.compareSegObj_={}):(this.compareSegsCache_[a]=this.compareSegObj_={},$.isEmptyObject(e)||!this.validResponse(e)?this.segsCache_[a]=this.segObj_={}:(this.isOverRowsLimit_=e.rows.length>this.rowsLimit_,e.rows.splice(this.rowsLimit_),this.segsCache_[a]=this.segObj_=this.convertAjaxModel(e))),$.isEmptyObject(this.segObj_)?this.setEmpty_():s()},this)})},sensorsdata.SegmentationWidget.prototype.renderContent_=function(e){this.clearChart_(),this.contentContainer_.removeClass("no-display").html(this.tplContent_),this.renderToolbar_(e),this.renderKeyInfo_(e),this.renderChart_(e)},sensorsdata.SegmentationWidget.prototype.renderChart_=function(e){if(!$.isEmptyObject(e)&&!$.isEmptyObject(this.segObj_)){this.clearChart_();var t=[0];switch(e.widgetType){case"number":this.renderNumber_(e);break;case"line":this.chart_=new sensorsdata.SegmentationLineChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues,t);break;case"column":this.chart_=new sensorsdata.SegmentationColumnChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues,t);break;case"pie":this.chart_=new sensorsdata.SegmentationPieChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues,t);break;case"table":this.renderTable_(e.widgetIndex);break;case"stack":this.chart_=new sensorsdata.SegmentationStackChart(this.buildChartOption_()),this.chart_.show(e.widgetByValues,t);break;default:sensorsdata.error.show(sensorsdata.languages.get("不支持展示此类型的图<!--{en}This type of graph is not supported for display-->"))}}},sensorsdata.SegmentationWidget.prototype.buildChartOption_=function(){var e=this.paramObj;return{container:this.contentContainer_.find("div#widget-chart-container"),limit:3,queryData:e,segObj:$.extend(!0,{},this.segObj_),compareSegObj:$.extend(!0,{},this.compareSegObj_),measureNames:this.measureNames_,measureUnits:this.measureUnits_,widgetModel:!0,onPointChanged:sensorsdata.bind(this.changeDate,this)}},sensorsdata.SegmentationWidget.prototype.changeDate=function(e){e>=0&&e!==this.config_.widgetIndex&&(this.config_.widgetIndex=e,this.renderToolbar_(this.config_),this.renderKeyInfo_(this.config_))},sensorsdata.SegmentationWidget.prototype.renderToolbar_=function(e){if(!$.isEmptyObject(e)&&!$.isEmptyObject(this.segObj_)){var t=e.widgetUnit,s=e.widgetType,i=e.widgetIndex,a=e.widgetByValues,n=this.contentContainer_.find("div#toolbar-container"),r=this.paramObj,o=r.measures.length>1,d=(r.by_fields||[]).length>0,h=this.isCompare_,g="",l=sensorsdata.CONSTSET;if(d){for(var u=[],m=0,c=r.by_fields.length;c>m;m++){var p=sensorsdata.findProperty(r.by_fields[m],this.propObj.intersection);p&&p.cname&&u.push(p.cname)}g=sensorsdata.languages.get(this.isOverRowsLimit_?"前<!--{en}before-->":"共<!--{en}in total-->")+this.segObj_.rows.length+sensorsdata.languages.get("组<!--{en}group-->")}var _="",f=this.segObj_,b=this.compareSegObj_,v="-";f.series.length>i&&(v=sensorsdata.formatTime(f.series[i],r.unit));var w="-";this.isCompare_&&b.series.length>i&&(w=sensorsdata.formatTime(b.series[i],r.unit));var y=v;if(h&&(y+=sensorsdata.languages.get("对比<!--{en}Contrast-->")+w),"rollup"!==t&&"table"===s&&!o&&!d)return void n.html("").addClass("display-none");if(n.removeClass("display-none"),"stack"===s){var C=[];return C.push(sensorsdata.formatTime(r.from_date,r.unit)+l.dateRangeSplit+sensorsdata.formatTime(f.series[i],r.unit)+sensorsdata.languages.get(" 累积<!--{en} Stack graph-->")),_=$("#tpl-segmentation-widget-toolbar-text").html(),void n.html(Mustache.render(_,C)).show()}if("rollup"===t||!o&&!d&&!h||!o&&!d&&h){var O=[];if("rollup"===t){var T=sensorsdata.checkCrossTime(r.from_date,r.to_date,r.compare_from_date,r.compare_to_date).yearCross,j=T?sensorsdata.CONSTSET.dateFormat:sensorsdata.CONSTSET.shortDateFormat,S=sensorsdata.buildTimeRangeText(r.from_date,r.to_date,j)+this.UNIT[t];O.push(S),h&&(S=sensorsdata.buildTimeRangeText(r.compare_from_date,r.compare_to_date,j)+this.UNIT[t],O.push(S))}else O.push(v),h&&O.push(w);return _=$("#tpl-segmentation-widget-toolbar-text").html(),void n.html(Mustache.render(_,O)).show()}var x=this.segObj_.rows;if(o||"table"===s){var k=i+1>=f.series.length;return this.isCompare_&&(k=k&&i+1>=b.series.length),_=$("#tpl-segmentation-widget-toolbar-date-select").html(),void n.html(Mustache.render(_,{timeText:y,leftDisabled:0===i,rightDisabled:k,byText:g,seriesIndex:i})).show()}if(1===n.find("div#by-select").size())return void n.find("span#by-select-text").text(y);var N=function(e){e?n.find("li.filter").addClass("disabled").find('input[type="text"].multiselect-search').attr("disabled","disabled").attr("placeholder",sensorsdata.languages.get("最多显示3组数据<!--{en}Displays up to 3 sets of data-->")):n.find("li.filter").removeClass("disabled").find('input[type="text"].multiselect-search').removeAttr("disabled").attr("placeholder",sensorsdata.languages.get("搜索<!--{en}Search-->"))},U=function(e){n.find(":checkbox").each(function(t,s){s=$(s);var i=parseInt(s.val(),10);e.length<3?(s.removeAttr("disabled"),s.parents("li:first").removeClass("disabled")):-1===e.indexOf(i)&&(s.attr("disabled","disabled"),s.parents("li:first").addClass("disabled"))})},I=x.map(function(e){return e.name});$.isArray(a)&&0!==a.length||(a=I.slice(0,3)),_=$("#tpl-segmentation-widget-toolbar-by-select").html();var E=$("#tpl-segmentation-widget-toolbar-by-select-ul").html();n.html(Mustache.render(_,{timeText:y,byValues:I.map(function(e,t){return{index:t,value:e,disabled:-1===a.indexOf(e)}})})).show();var W=n.find("select");W.multiselect("destroy"),W.multiselect({nonSelectedText:g,buttonText:function(){return g},templates:{ul:E},onChange:sensorsdata.bind(function(){var e=[],t=[];n.find(":checkbox:checked").each(function(s,i){var a=parseInt($(i).val(),10);t.push(I[a]),e.push(a)}),this.config_.widgetByValues=0===t.length?this.getTopByValues_():t,this.renderKeyInfo_(this.config_),this.renderChart_(this.config_),N(t.length>=3),U(e)},this)});var B=a.map(function(e){return I.indexOf(e)});W.multiselect("select",B),N(a.length>=3),U(B)}},sensorsdata.SegmentationWidget.prototype.renderKeyInfo_=function(e){if(!$.isEmptyObject(e)&&!$.isEmptyObject(this.segObj_)){var t=e.widgetUnit,s=e.widgetType,i=e.widgetIndex,a=e.widgetByValues,n=this.contentContainer_.find("div#keyinfo-container"),r=this.paramObj,o=this.formatNumber_(this.segObj_,r.measures),d=this.formatNumber_(this.compareSegObj_,r.measures),h=(r.by_fields||[]).length>0,g=r.measures.length>1;if(g||"rollup"===t||"table"===s||"pie"===s)return void n.addClass("display-none").html("");n.removeClass("display-none");var l=function(e){return e.data[i]&&null!==e.data[i][0]?e.data[i][0]:"--"},u=this.measureUnits_[0],m={isMulti:g,isCompare:this.isCompare_,isChart:"number"!==e.widgetType&&"table"!==e.widgetType},c=[],p=0,_=null,f=null;if(!h)return"stack"!==s?(c.push({values:[{value:l(o.rows[0]),unit:u}]}),this.isCompare_&&c.push({values:[{value:l(d.rows[0]),unit:u}],className:"dashboard-widget-key-wrap-compare"})):(_=this.segObj_.rows[0],p=0,f=$.extend(!0,{},_),f.data=_.data.map(function(e){return e.map(function(e){var t=p+e;return sensorsdata.isFloat(t)&&(t=sensorsdata.addNumber(p+"",e+"")),sensorsdata.formatNumber(t)})}),c.push({values:[{value:l(f),unit:u}]})),void n.html(Mustache.render(this.tplKeyInfo_,{tips:c,style:m}));for(var b=0,v=a.length;v>b;b++){var w=a[b],y=o.rows.filter(function(e){return e.name===w})[0];if(_=this.segObj_.rows.filter(function(e){return e.name===w})[0],y){var C=[];"stack"!==e.widgetType?(C.push({value:l(y),unit:u}),this.isCompare_&&(y=d.rows.filter(function(e){return e.name===w})[0],C.push({value:l(y),unit:u}))):(p=0,f=$.extend(!0,{},_),f.data=_.data.map(function(e){return e.map(function(e){var t=p+e;return sensorsdata.isFloat(t)&&(t=sensorsdata.addNumber(p+"",e+"")),sensorsdata.formatNumber(t)})}),C.push({value:l(f),unit:u})),c.push({values:C,tip:y.name,color:sensorsdata.CONSTSET.chartsColors[b]})}}n.html(Mustache.render(this.tplKeyInfo_,{tips:c,style:m}))}},sensorsdata.SegmentationWidget.prototype.renderNumber_=function(e){var t=this.paramObj,s=e.widgetUnit,i=e.widgetIndex,a=(t.by_fields||[]).length>0,n=t.measures.length>1,r=this.isCompare_,o=this.formatNumber_(this.segObj_,t.measures),d=this.formatNumber_(this.compareSegObj_,t.measures),h=this.measureNames_,g=this.measureUnits_,l=[];if("rollup"!==s||n||a||r||l.push({values:[{value:o.rows[0].data[0][0],unit:g[0],caption:o.rows[0].name}]}),"rollup"===s&&!n&&a&&!r){var u=[];o.rows.map(function(e){e.data[0][0]&&u.push({value:e.data[0][0],unit:g[0],caption:e.name})}),l.push({values:u})}"rollup"===s&&!n&&a&&r&&o.rows.map(function(e,t){e.data[0][0]&&d.rows[t].data[0][0]&&l.push({name:e.name,values:[{value:e.data[0][0],unit:g[0]},{value:d.rows[t].data[0][0],unit:g[0]}]})}),"rollup"!==s||n||a||!r||l.push({values:[{value:o.rows[0].data[0][0],unit:g[0],caption:o.rows[0].name},{value:d.rows[0].data[0][0],unit:g[0],caption:d.rows[0].name}]});var m=-1;i<o.series.length&&(m=i);var c=-1;this.isCompare_&&c<d.series.length&&(c=i),!n||a||r||(l.push({values:[]}),o.rows[0].data[m].map(function(e,t){l[0].values.push({mIndex:t,value:e,unit:g[t],caption:h[t]})})),n&&a&&!r&&o.rows.map(function(e){var t=[],s=!0;e.data[m].map(function(e,i){s=s&&!e,t.push({mIndex:i,value:e,unit:g[i],caption:h[i]})}),s||l.push({values:t,name:e.name})}),n&&a&&r&&o.rows.map(function(e,t){h.map(function(s,i){var a=[];a.push(-1===m||m>=o.series.length?{mIndex:i,value:"--",unit:g[i],caption:s}:{mIndex:i,value:e.data[m][i],unit:g[i],caption:s}),a.push(-1===c||m>=d.series.length?{mIndex:i,value:"--",unit:g[i],caption:s}:{mIndex:i,value:d.rows[t].data[c][i],unit:g[i],caption:s}),l.push({values:a}),0===i&&(l[l.length-1].name=e.name)})}),n&&!a&&r&&h.map(function(e,t){var s=[];s.push(-1===m||m>=o.series.length?{mIndex:t,value:"--",unit:g[t],caption:e}:{mIndex:t,value:o.rows[0].data[c][t],unit:g[t],caption:e}),s.push(-1===c||m>=d.series.length?{mIndex:t,value:"--",unit:g[t],caption:e}:{mIndex:t,value:d.rows[0].data[c][t],unit:g[t],caption:e}),l.push({values:s})});var p={isMulti:n,isCompare:r,isChart:"number"!==e.widgetType&&"table"!==e.widgetType};this.contentContainer_.find("div#widget-chart-container").html(Mustache.render(this.tplNumber_,{rows:l,style:p}))},sensorsdata.SegmentationWidget.prototype.formatNumber_=function(e,t,s){if($.isEmptyObject(e)||!$.isArray(e.rows)||0===e.rows.length)return e;var i=$.extend(!0,{},e),a=this;return i.rows.map(function(e){e.data=e.data.map(function(e){return e.map(function(e,i){return sensorsdata.formatNumber(e)+(s===!0&&a.checkPercent(t[i])?"%":"")})})}),i},sensorsdata.SegmentationWidget.prototype.renderTable_=function(e){var t=this.paramObj,s=this.formatNumber_(this.segObj_,t.measures,!0),i=this.formatNumber_(this.compareSegObj_,t.measures,!0),a=this.buildMeasureNames(!0,!1),n=a[0],r=this.buildByText_(t.by_fields),o=[];$.isArray(t.by_fields)&&t.by_fields.length>0?(o.push({value:r,title:""}),o.push({value:n,title:n}),this.isCompare_&&(o.push({value:r,title:""}),o.push({value:n,title:n}))):(o.push({value:sensorsdata.languages.get("日期<!--{en}Date-->"),title:""}),o.push({value:n,title:n}),this.isCompare_&&(o.push({value:sensorsdata.languages.get("日期<!--{en}Date-->"),title:""}),o.push({value:n,title:n})));var d=!1,h=[],g=[];if($.isArray(t.by_fields)&&t.by_fields.length>0){var l=-1;e<s.series.length&&(l=e);var u=-1;this.isCompare_&&e<i.series.length&&(u=e);for(var m=0,c=s.rows.length;c>m;m++){if(g=[],g.push(s.rows[m].name),g.push(-1===l?"--":s.rows[m].data[l][0]),this.isCompare_&&(g.push(i.rows[m].name),g.push(-1===u?"--":i.rows[m].data[u][0])),"--"===g[1]||"0"===g[1]){if(!this.isCompare_){d=!0;continue}if("--"===g[3]||"0"===g[3]){d=!0;continue}}h.push(g)}var p=function(e,t){var s=sensorsdata.toNumber(e),i=sensorsdata.toNumber(t);return $.isNumeric(s)?$.isNumeric(i)?i-s:-1:1};h.sort(sensorsdata.bind(function(e,t){var s=p(e[1],t[1]);return this.isCompare_&&0===s&&(s=p(e[3],t[3])),s},this))}else{for(var _=this.seriesLen_,f=0;_>f;f++)g=[],f<s.series.length?(g.push(sensorsdata.formatTime(s.series[f],t.unit)),g.push(s.rows[0].data[f][0])):(g.push("--"),g.push("--")),this.isCompare_&&(f<i.series.length?(g.push(sensorsdata.formatTime(i.series[f],t.unit)),g.push(i.rows[0].data[f][0])):(g.push("--"),g.push("--"))),h.push(g);h.reverse()}var b="";if(s.series.length>1&&(t.by_fields||[]).length>0){var v=sensorsdata.CONSTSET.datetimeNames[t.unit];b=sensorsdata.languages.get("按最近一<!--{en}Closest-->")+v+sensorsdata.languages.get("的数据排序<!--{en}data sorting-->")}d===!0?b+=(b?"，":"")+sensorsdata.languages.get("忽略了指标为0的行。<!--{en}Ignore line with metrics 0-->"):b&&(b+="。");var w=null;b&&(w={colspan:this.isCompare_?4:2,tip:b});var y=Mustache.render(this.tplTable_,{table:{heads:o,rows:h},tableClass:this.isCompare_?"compare-table":"no-compare-table",tipRow:w});this.contentContainer_.find("div#widget-chart-container").html(y)},sensorsdata.SegmentationWidget.prototype.buildByText_=function(){var e=this.propObj,t=function(t){var s=sensorsdata.findProperty(t,e.intersection);return s.cname};if($.isArray(this.paramObj.by_fields)&&this.paramObj.by_fields.length>0){var s=[];return this.paramObj.by_fields.map(function(e){s.push(t(e))}),s.join("，")}return""},sensorsdata.SegmentationWidget.prototype.clearChart_=function(){this.chart_&&$.isFunction(this.chart_.destroyAll)&&this.chart_.destroyAll()},sensorsdata.SegmentationWidget.prototype.setEmpty_=function(e){this.clearChart_(),this.contentContainer_.addClass("no-display").html(e||sensorsdata.languages.get("没有查询到数据<!--{en}No data-->"))},sensorsdata.SegmentationWidget.prototype.changeRedirectUrl_=function(){var e="line";("column"===this.config_.widgetType||"pie"===this.config_.widgetType)&&(e=this.config_.widgetType);var t=$.extend(!0,{},this.paramObj);t.chartsType=e,t[sensorsdata.CONSTSET.bookmarkId]=this.bookmark_.id,delete t.rangeText;var s=this.bookmark_.type+"#"+$.param(t);this.contentContainer_.parents("article.dashboard-widget:first").find("header h4[data-href]").attr("data-href",s)};