sensorsdata.FunnelWidget=function(e){if($.isEmptyObject(e))throw"Init Retention Widget error, parameter is empty.";if(e.configContainer instanceof jQuery==!1||e.contentContainer instanceof jQuery==!1)throw"Init Retention Widget error, container is not jQuery object.";if($.isEmptyObject(e.widgetObj)||$.isEmptyObject(e.widgetObj.bookmark))throw"Init Retention Widget error, widgetObj is empty.";this.contentContainer_=e.contentContainer,this.configContainer_=e.configContainer,this.bookmark_=e.widgetObj.bookmark,this.widgetTime_=e.widgetTime,this.config_=e.config||{},this.saveConfig_=e.saveConfig,this.tplLoader_=$("#tpl-widget-loader").html(),this.tpl_=$("#tpl_dashboard_indicator_funnel").html(),this.renderAllow_=!1,this.dataAlready_=!1,this.dataFunnelReport={},this.dataFunnelProperties={},this.dataFunnelResult={},this.paramObj_={},this.init()},sensorsdata.FunnelWidget.prototype.refresh=function(e,t){!$.isEmptyObject(e)&&e.widgetTime&&(this.widgetTime_=e.widgetTime),this.init(t)},sensorsdata.FunnelWidget.prototype.resize=function(){},sensorsdata.FunnelWidget.prototype.init=function(e){this.setEmpty_(this.tplLoader_),this.paramObj_=JSON.parse(this.bookmark_.data),"boolean"==typeof e?this.paramObj_.use_cache=e:delete this.paramObj_.use_cache,this.paramObj_.sampling_factor=$.isNumeric(this.paramObj_.sampling_factor)?parseInt(this.paramObj_.sampling_factor,10):64,sensorsdata.fillBookmarkTime(this.paramObj_,this.widgetTime_),this.lazyloadView()},sensorsdata.FunnelWidget.prototype.lazyloadView=function(){var e=this,t=this.paramObj_;$.isArray(t.bucket_param)&&t.bucket_param.length>0&&(t.bucket_param=$.map(t.bucket_param,function(e){return parseInt(e)}));var n=null;t.ignore_cache_expire=!0,sensorsdata.reportAjax({url:"funnels/funnel/"+t.funnel_id+"/report?bookmarkId="+e.bookmark_.id,data:t,type:"post",contentType:"application/json",showCommonError:!1,error:function(t){var n=parseInt(t.status,10),a=sensorsdata.buildAjaxError(n,t.responseJSON);410===n&&(a=sensorsdata.languages.get("漏斗不存在，请删除此书签<!--{en}The funnel does not exist, please delete this bookmark-->")),e.setEmpty_(a)},success:function(e){n=$.extend(!0,{},e,e.funnel_detail[0])}}).then(function(){return!n||$.isEmptyObject(n)||!n.steps||!$.isArray(n.steps)||n.steps.length<2||0===n.steps[0].converted_user?(e.setEmpty_(),!1):void sensorsdata.ajax({showCommonError:!1,url:"funnels/funnel/"+t.funnel_id+"/properties",success:function(t){e.dataFunnelReport=n,e.dataFunnelProperties=t||{},e.dataAlready_=!0,e.renderAllow_&&e.render()}})})},sensorsdata.FunnelWidget.prototype.render=function(){if(this.renderAllow_=!0,!this.dataAlready_)return!1;this.getFunnelData(),this.dataFunnelResult.glist=this.dataFunnelResult.overview[0];var e=!1;e="boolean"!=typeof this.paramObj_.extend_over_end_date?"false"===this.paramObj_.extend_over_end_date:this.paramObj_.extend_over_end_date===!1,this.configContainer_.find("span.date-limit").tooltip("destroy"),this.configContainer_.html($("#tpl-funnel-widget-config").html()),this.configContainer_.find("span.date-limit").toggleClass("active",e).tooltip({title:sensorsdata.languages.get(e?"窗口期被限制在查询时间区间内<!--{en}The window period is limited to the the query time range-->":"窗口期被延展到查询时间区间外<!--{en}The window period is extended out of the query time range-->"),placement:"left",container:"body"}),this.paramObj_.by_field?this.renderFunnelGroup():this.contentContainer_.removeClass("no-display").html(Mustache.render(this.tpl_,this.dataFunnelResult))},sensorsdata.FunnelWidget.prototype.getFunnelData=function(){function e(e){var t=Number(e)/10,n=0;return n=0===t||-1===t?1:Math.ceil(t),"convert-color-"+n}var t=this.dataFunnelReport,n=sensorsdata.findProperty(t.by_field,this.dataFunnelProperties),a=this.paramObj_.bucket_param;t.by_values=$.map(t.by_values,function(e){return"$ALL"===e?sensorsdata.languages.get("全部<!--{en}All-->"):sensorsdata.formatByValue(e,n.data_type,"",a)}),t.eventNames=this.dataFunnelProperties.step_name,t.completion_rate_fix=-1===t.completion_rate?"-":t.completion_rate+"%",$.each(t.overview,function(n,a){$.each(a,function(n,a){a.converted_user=sensorsdata.formatNumber(-1===a.converted_user?0:a.converted_user),a.cname=t.eventNames[n],a.conversion_rate_fix=0===n||-1===n?"":e(a.conversion_rate)})}),this.dataFunnelResult=t},sensorsdata.FunnelWidget.prototype.renderFunnelGroup=function(){function e(){var e=$(this).find("span.selected").attr("data-value");t.dataFunnelResult.glist=t.dataFunnelResult.overview[e];var n=t.dataFunnelResult.by_field.split("."),a=$.grep(t.dataFunnelProperties[n[0]],function(e){return 2===n.length?e.name===n[1]:e.name===n[2]&&e.event_name===n[1]});a[0]&&a[0].name&&(t.dataFunnelResult.group=a[0].cname||a[0].name,t.dataFunnelResult.groupValue=t.dataFunnelResult.by_values[e]),t.dataFunnelResult.completion_rate_fix=t.dataFunnelResult.overview[e].slice(-1)[0].completion_rate,t.dataFunnelResult.completion_rate_fix=-1===t.dataFunnelResult.completion_rate_fix?"-":t.dataFunnelResult.completion_rate_fix+"%",t.contentContainer_.removeClass("no-display").html(Mustache.render(t.tpl_,t.dataFunnelResult))}var t=this,n="",a=-1;!$.isEmptyObject(this.config_)&&this.config_.groupName&&(a=$.inArray(this.config_.groupName,this.dataFunnelReport.by_values)),-1===a?(n=this.dataFunnelReport.by_values[0],a=0):n=this.config_.groupName;var i=$.map(this.dataFunnelReport.by_values,function(e,t){return{index:t,value:e,active:e===n}}),s=$("#tpl_dashboard_funnel_select").html(),r=$(Mustache.render(s,{glist:i,groupName:n,groupIndex:a}));r.find("ul li a").on("click",function(){$(this).parent().addClass("active").siblings(".active").removeClass("active");var n=$.trim($(this).html());r.find("span.selected").html(n).attr("data-value",$(this).attr("data-value")),t.config_.groupName=n,t.saveConfig_(t.config_),e.call(r)}),this.configContainer_.find(".widget-config-bottom").html(r),e.call(r)},sensorsdata.FunnelWidget.prototype.setEmpty_=function(e){this.contentContainer_.addClass("no-display").html(e||sensorsdata.languages.get("没有查询到数据<!--{en}No data-->"))};