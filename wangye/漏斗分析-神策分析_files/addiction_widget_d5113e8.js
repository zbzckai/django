sensorsdata.AddictionWidget=function(t){if($.isEmptyObject(t))throw"Init Addiction Widget error, parameter is empty.";if(t.configContainer instanceof jQuery==!1||t.contentContainer instanceof jQuery==!1)throw console.info(t),"Init Addiction Widget error, container is not jQuery object.";if(!$.isFunction(t.saveConfig))throw console.info(t),"Init Addiction Widget error, saveConfig is not function.";if($.isEmptyObject(t.widgetObj)||$.isEmptyObject(t.widgetObj.bookmark))throw console.info(t),"Init Addiction Widget error, widgetObj is empty.";sensorsdata.AddictionBase.call(this),this.configContainer_=t.configContainer.html($("#tpl-addiction-widget-config").html()),this.byContainer_=this.configContainer_.find(".widget-config-top"),this.subtitleContainer_=this.configContainer_.find(".widget-config-bottom"),this.contentContainer_=t.contentContainer,this.bookmark_=t.widgetObj.bookmark,this.dashboardConfig_=t.dashboardConfig,this.rawConfig_=t.config,this.config_=JSON.parse(t.widgetObj.config||"{}"),this.saveConfig_=t.saveConfig,this.tplLoader_=$("#tpl-widget-loader").html(),this.tplByfieldSelect_=$("#tpl-addiction-widget-byfield-select").html(),this.tplContent_=$("#tpl-addiction-widget-content").html(),this.tplKeyinfo_=$("#tpl-addiction-widget-keyinfo").html(),this.retentions_={},this.byRetentions_={},this.chart_=null,this.widgetByFields_=[],this.renderAllow_=!1,this.dataAlready_=!1,this.config_.widgetTime||(this.config_.widgetTime=this.dashboardConfig_.widgetTime),this.config_.widgetUnit||(this.config_.widgetUnit=this.dashboardConfig_.widgetUnit),this.init()},sensorsdata.inherits(sensorsdata.AddictionWidget,sensorsdata.AddictionBase),sensorsdata.AddictionWidget.prototype.refresh=function(t,e){$.isEmptyObject(t)||(this.config_.widgetTime=t.widgetTime),this.init(e)},sensorsdata.AddictionWidget.prototype.resize=function(){this.chart_&&$.isFunction(this.chart_.resize)&&this.chart_.resize()},sensorsdata.AddictionWidget.prototype.init=function(t){this.setEmpty_(this.tplLoader_),this.allText_=sensorsdata.languages.get("全部<!--{en}All-->"),this.allValue_="sensorsdata.AddictionWidget.allvalue",this.paramObj=JSON.parse(this.bookmark_.data),sensorsdata.fillBookmarkTime(this.paramObj,this.config_.widgetTime,sensorsdata.CONSTSET.dateRangeLimit.date,"day"),"boolean"==typeof t?this.paramObj.use_cache=t:delete this.paramObj.use_cache;var e=this;this.getProperties(this.paramObj.event_name,function(){e.getRetentions_(e.paramObj)})},sensorsdata.AddictionWidget.prototype.render=function(){this.renderAllow_=!0,this.dataAlready_===!0&&this.renderContent_(this.config_.widgetByField)},sensorsdata.AddictionWidget.prototype.clearChart_=function(){this.chart_&&$.isFunction(this.chart_.dispose)&&this.chart_.dispose()},sensorsdata.AddictionWidget.prototype.setEmpty_=function(t){this.clearChart_(),this.contentContainer_.addClass("no-display").html(t||sensorsdata.languages.get("没有查询到数据。<!--{en}No data.-->"))},sensorsdata.AddictionWidget.prototype.renderKeyInfo_=function(t){t=t||0;var e=this.contentContainer_.find("div#keyinfo-container");if(e.html(""),!$.isEmptyObject(this.retentions_)){var i=this.paramObj,s=i.measure_type,n=this.config_.widgetByField,a=-1,o=sensorsdata.findEventCname(i.event_name),r=i.measure&&i.measure.field?this.buildMeasureName(i):"",d=null;if(i.by_field&&n&&n!==this.allValue_&&$.isArray(this.byRetentions_.rows)){var h=this.byRetentions_.rows.filter(function(t){return t.by_value+""===n});1===h.length&&(d=h[0])}null===d&&(d=this.retentions_.rows[0]),a=d.total_people;var l=d.cells[t]||{percent:0,people:0,label:""},c=this.buildLabel(l),g=!0,_="",p="";"times"===s?0===d.cells.length?(g=!1,_=sensorsdata.languages.get("合计有 <!--{en}Total is -->")+a+sensorsdata.languages.get(" 人进行过<!--{en} People did-->")+o):p=sensorsdata.languages.get("合计有 <!--{en}Total is -->")+a+sensorsdata.languages.get(" 人进行过<!--{en} People did-->")+o+sensorsdata.languages.get("，有 <!--{en}，have -->")+l.people+sensorsdata.languages.get(" 人进行了<!--{en} People did-->")+r+c:p=sensorsdata.languages.get("合计有 <!--{en}Total is -->")+a+sensorsdata.languages.get(" 人进行<!--{en} People did-->")+o+sensorsdata.languages.get("，有 <!--{en}，have -->")+l.people+sensorsdata.languages.get(" 人平均进行<!--{en} People average did-->")+c,e.html(Mustache.render(this.tplKeyinfo_,{keyTip:_,percentDisplay:g,percent:l.percent,text:p}))}},sensorsdata.AddictionWidget.prototype.setTitle_=function(t,e){if(e){var i=sensorsdata.findProperty(e,this.propObj);i&&i.cname&&this.subtitleContainer_.html(sensorsdata.languages.get("按<!--{en}By-->")+i.cname+sensorsdata.languages.get("分组<!--{en}Clustering-->"))}},sensorsdata.AddictionWidget.prototype.initWidgetSelect_=function(t){if(this.paramObj.by_field){var e=0;this.widgetByFields_.map(function(i,s){i.active=!1,i.index=s,i.value===t&&(e=s)}),this.widgetByFields_[e].active=!0;var i=Mustache.render(this.tplByfieldSelect_,{display:this.widgetByFields_.length>0,type:this.widgetByFields_[e],types:this.widgetByFields_});this.byContainer_.html(i).find("button").saDropdown(sensorsdata.bind(function(t){var e=parseInt(t,10),i=this.widgetByFields_[e];this.config_.widgetByField=i.value,this.renderContent_(i.value),this.saveConfig_(this.config_)},this))}},sensorsdata.AddictionWidget.prototype.getRetentions_=function(t){var e=sensorsdata.findProperty(t.by_field,this.propObj),i="addictions/report?bookmarkId="+this.bookmark_.id,s=$.extend(!0,{},t);delete s.by_field,s.rollup_date=!0,s.ignore_cache_expire=!0,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST"+i+"-"+this.bookmark_.id+"-rollup",url:i,method:"POST",data:s,contentType:"application/json",customErrorStatusCode:422,error:sensorsdata.bind(function(t){var e=sensorsdata.buildAjaxError(t.status,t.responseJSON);this.setEmpty_(e),this.retentions_={}},this),success:sensorsdata.bind(function(t){$.isArray(t.rows)&&t.rows.length>0?(this.retentions_=this.padRetentions(t,this.paramObj,e),this.setTitle_(this.paramObj.unit,this.paramObj.by_field)):this.retentions_={}},this)}).then(sensorsdata.bind(function(){return this.paramObj.by_field?(t.ignore_cache_expire=!0,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST"+i+"-"+this.bookmark_.id,url:i,method:"POST",data:t,contentType:"application/json",customErrorStatusCode:422,error:sensorsdata.bind(function(t){var e=sensorsdata.buildAjaxError(t.status,t.responseJSON);this.setEmpty_(e),this.byRetentions_={}},this),success:sensorsdata.bind(function(t){this.dataAlready_=!0,$.isArray(t.rows)&&t.rows.length>0?(this.byRetentions_=this.padRetentions(t,this.paramObj,e),this.widgetByFields_=this.getWidgetByFields_(this.byRetentions_.rows,this.paramObj.by_field),this.initWidgetSelect_(this.config_.widgetByField)):this.byRetentions_={}},this)})):$.Deferred().resolve()},this)).then(sensorsdata.bind(function(){this.renderAllow_&&this.renderContent_(this.config_.widgetByField)},this))},sensorsdata.AddictionWidget.prototype.getWidgetByFields_=function(t,e){if(!e)return[];for(var i=[{value:this.allValue_,text:this.allText_}],s=0,n=t.length;n>s;s++){var a=t[s].by_value;i.push({value:a,text:a})}return i},sensorsdata.AddictionWidget.prototype.renderContent_=function(t){return $.isEmptyObject(this.retentions_)?void this.setEmpty_():(this.clearChart_(),this.contentContainer_.removeClass("no-display").html(this.tplContent_),this.renderKeyInfo_(),void this.renderChart_(t))},sensorsdata.AddictionWidget.prototype.renderChart_=function(t){var e=this,i=null;if(this.paramObj.by_field&&t&&t!==this.allValue_&&!$.isEmptyObject(this.byRetentions_)){var s=this.byRetentions_.rows.filter(function(e){return e.by_value+""===t});1===s.length&&(i=s[0])}null===i&&(i=this.retentions_.rows[0]);var n=$.extend(!0,[],i.cells),a=[];a.push({name:i.by_value,type:"bar",data:i.cells.map(function(t){return t.percent})});var o=n.map(function(t){return e.buildLabel(t)}),r={dataZoom:{show:!1},tooltip:{trigger:"axis",axisPointer:{lineStyle:{width:1,color:"#aaa"}},backgroundColor:"rgba(50,50,50,0)",borderWidth:0,formatter:function(){return""}},grid:{bottom:0},legend:{show:!1},xAxis:{data:o},yAxis:{splitNumber:3,axisLabel:{formatter:function(t){return sensorsdata.formatNumber(t,!0)+"%"}}},series:a};this.chart_&&$.isFunction(this.chart_.dispose)&&(this.chart_.dispose(),this.chart_=null),this.chart_=echarts.init(this.contentContainer_.find("div.dashboard-widget-chart")[0]),e.chart_.on("showtip",function(t){e.renderKeyInfo_(t.dataIndex)}),r=$.extend(!0,{},sensorsdata.echarts.option,r),e.chart_.setOption(r)};