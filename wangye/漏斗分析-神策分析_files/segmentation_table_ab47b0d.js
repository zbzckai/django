sensorsdata.SegmentationTable=function(e){this.option_=$.extend(!0,{},e),this.queryData_=e.queryData,this.measureNames_=e.measureNames,this.propObj_=e.propObj,this.segObj_=e.segObj,this.compareSegObj_=e.compareSegObj,this.rollupSegObj_=e.rollupSegObj,this.rollupCompareSegObj_=e.rollupCompareSegObj,this.option_.container.find("#table-tab").hide(),this.$tableConfig_=this.option_.tableConfig,this.$tableContainer_=this.option_.container.find(".table-wrap"),this.$paginationContainer_=this.option_.container.find("#table-pagination"),this.$tableConfig_.find(".sa-checkbox").hide(),this.tableData_={},this.tplTable_=$("#tpl-segmentation-index-table").html(),this.dateColExpanded_=!!this.getStatusItem_("dateColExpanded"),this.sortStatus_=this.getStatusItem_("sortStatus")||{key:"",index:-1,value:sensorsdata.languages.get("合计<!--{en}Total-->"),type:"descend"},this.initEvents_(),this.sortRows_(),this.renderHtml_()},sensorsdata.SegmentationTable.prototype.unload=function(){this.saveStatus_()},sensorsdata.SegmentationTable.prototype.toggleRatio=function(e){"boolean"==typeof e?this.$tableContainer_.find("td span.ratio").toggleClass("hide",e):this.$tableContainer_.find("td span.ratio").toggleClass("hide")},sensorsdata.SegmentationTable.prototype.initEvents_=function(){this.$tableContainer_.unbind("click.table").bind("click.table",sensorsdata.bind(this.tableContainerClick_,this));var e=this.$tableConfig_.find('input[type="text"]');e.val("").attr("data-last",""),e.unbind("keyup").bind("keyup",sensorsdata.bind(function(){var a=e.attr("data-timeout");a&&window.clearTimeout(a);var t=$.trim(e.val()),s=e.attr("data-last");return t===s?this.tableData_:(a=window.setTimeout(sensorsdata.bind(function(){this.searchTable_(t),this.renderTable_(),e.attr("data-last",t)},this),500),void e.attr("data-timeout",a))},this))},sensorsdata.SegmentationTable.prototype.tableContainerClick_=function(e){var a=$(e.target||e.srcElement);a.attr("data-method")||(a=a.parents("[data-method]:first"));var t=a.attr("data-method");switch(t){case"showDateCol":this.$tableContainer_.find("th.date-col,td.date-col").removeClass("hide"),a.attr("data-method","hideDateCol").removeClass("icon-chart-expand").addClass("icon-chart-collapse"),this.dateColExpanded_=!0;break;case"hideDateCol":this.$tableContainer_.find("th.date-col,td.date-col").addClass("hide"),a.attr("data-method","showDateCol").removeClass("icon-chart-collapse").addClass("icon-chart-expand"),this.dateColExpanded_=!1;break;case"sort":this.sortStatus_.index=a.closest("th").prevAll().size(),this.sortStatus_.type="descend"===a.closest("th").attr("data-sort")?"ascend":"descend",this.sortTable_(this.sortStatus_),this.renderTable_();break;case"user-list":var s=parseInt(a.attr("data-row-index"),10),r=parseInt(a.attr("data-measure-index"),10),o=a.parents("td:first").prevAll("td").length,i=this.$tableContainer_.find("thead th:not(.text-col)").eq(o).attr("data-series-index");i=parseInt(i,10);var n=$.extend(!0,{},this.queryData_);if(n.rollup_date=!a.parents("td:first").is(".date-col"),n.slice_by_values=this.rollupSegObj_.rows[s].by_values,n.slice_by_values=n.slice_by_values.map(function(e){return null===e?sensorsdata.CONSTSET.unknownByValueText:""===e?sensorsdata.CONSTSET.emptyStringByValueText:e}),n.compare_from_date&&n.compare_to_date){var l=1===a.parents("tr:first").find("th[data-compare]").length;l?(n.from_date=n.compare_from_date,n.to_date=n.compare_to_date,n.slice_date=n.rollup_date?null:this.compareSegObj_.series[i]):n.slice_date=n.rollup_date?null:this.segObj_.series[i]}else n.slice_date=n.rollup_date?null:this.segObj_.series[i];n.detail=!0,n.measures=[n.measures[r]],a.createUserListPanel({queryData:n})}},sensorsdata.SegmentationTable.prototype.buildRatio_=function(e,a){if(!$.isNumeric(e)||!$.isNumeric(a))return null;if(e-=0,a-=0,0===e)return null;var t=Math.round((a-e)/e*1e3)/10;return{value:Math.abs(t)+"%",className:t>=0?"ratio-pos":"ratio-neg"}},sensorsdata.SegmentationTable.prototype.renderHtml_=function(){var e=this,a=this.queryData_,t=this.queryData_.bucket_params||{},s=a.measures.length>1,r=(a.by_fields||[]).length>0,o=a.compare_from_date&&a.compare_to_date,i=r&&this.rollupSegObj_.rows.length>2,n="unique"===a.measures[0].aggregator,l=this.checkPercent(a.measures[0]),u=[],d=[],p=[],_=[],h=0,m=this.segObj_.series.length;o&&this.compareSegObj_.series.length>m&&(m=this.compareSegObj_.series.length);var b=[];if(r&&a.by_fields.map(function(a){var t=sensorsdata.findProperty(a,e.propObj_.intersection)||{};b.push(t),u.push({value:t.cname,sortDisplay:i,isHead:!0})}),(!r||s)&&u.push({value:sensorsdata.languages.get("指标<!--{en}Metrics-->"),isHead:!0}),o&&u.push({value:sensorsdata.languages.get("时间段<!--{en}Period of time-->"),isHead:!0}),u.push({value:sensorsdata.languages.get("合计<!--{en}Total-->"),isRollup:!0,sortDisplay:i,sortType:"descend"}),o)for(h=m-1;h>=0;h--){var c=[this.segObj_.series[h],this.compareSegObj_.series[h]];u.push({isDate:!0,value:sensorsdata.formatTime(c,a.unit,!0,!0,"</br>"),originalTime:c.join("-"),sortDisplay:i,seriesIndex:h})}else for(h=m-1;h>=0;h--)u.push({isDate:!0,value:sensorsdata.formatTime(this.segObj_.series[h],a.unit),originalTime:this.segObj_.series[h],sortDisplay:i,seriesIndex:h});if(!s&&!r&&!o){for(p=[],p.push({value:e.measureNames_[0],isHead:!0}),p.push({isRollup:!0,value:sensorsdata.formatNumber(this.rollupSegObj_.rows[0].values[0][0],!1,l),download:n,rowIndex:0,measureIndex:0}),_=this.segObj_.rows[0]?this.segObj_.rows[0].values:"",h=m-1;h>=0;h--)p.push({isDate:!0,value:sensorsdata.formatNumber(_[h][0],!1,l),ratio:e.buildRatio_((_[h-1]||[])[0],_[h][0]),download:n,rowIndex:0,measureIndex:0});d.push(p)}if(s||!r||o||this.rollupSegObj_.rows.map(function(s,r){for(p=[],s.by_values.map(function(e,s){var r=sensorsdata.formatByValue(e,b[s].data_type,"",t[a.by_fields[s]]);p.push({value:r,isHead:!0})}),p.push({isRollup:!0,value:sensorsdata.formatNumber(s.values[0][0],!1,l),download:n,rowIndex:r,measureIndex:0}),_=e.segObj_.rows[r]?e.segObj_.rows[r].values:"",h=m-1;h>=0;h--)p.push({isDate:!0,value:sensorsdata.formatNumber(_[h][0],!1,l),ratio:e.buildRatio_((_[h-1]||[])[0],_[h][0]),download:n,rowIndex:r,measureIndex:0});d.push(p)}),!s||r||o||a.measures.map(function(t,s){for(l=e.checkPercent_(a.measures[s]),n="unique"===t.aggregator,p=[],p.push({value:e.measureNames_[s],isHead:!0}),p.push({isRollup:!0,value:sensorsdata.formatNumber(e.rollupSegObj_.rows[0].values[0][s],!1,l),download:n,rowIndex:0,measureIndex:s}),_=e.segObj_.rows[0]?e.segObj_.rows[0].values:"",h=m-1;h>=0;h--)p.push({isDate:!0,value:sensorsdata.formatNumber(_[h][s],!1,l),ratio:e.buildRatio_((_[h-1]||[])[s],_[h][s]),download:n,rowIndex:0,measureIndex:s});d.push(p)}),s&&r&&!o&&this.rollupSegObj_.rows.map(function(s,r){var o=[];s.by_values.map(function(e,s){var r=sensorsdata.formatByValue(e,b[s].data_type,"",t[a.by_fields[s]]);o.push({value:r,isHead:!0,rowSpan:a.measures.length})}),_=e.segObj_.rows[r]?e.segObj_.rows[r].values:"",a.measures.map(function(t,s){for(n="unique"===t.aggregator,l=e.checkPercent_(a.measures[s]),p=0===s?$.extend(!0,[],o):[],p.push({value:e.measureNames_[s],isHead:!0}),p.push({isRollup:!0,value:sensorsdata.formatNumber(e.rollupSegObj_.rows[r].values[0][s],!1,l),download:n,rowIndex:r,measureIndex:s}),h=m-1;h>=0;h--)p.push({isDate:!0,value:sensorsdata.formatNumber(_[h][s],!1,l),ratio:e.buildRatio_((_[h-1]||[])[s],_[h][s]),download:n,rowIndex:r,measureIndex:s});d.push(p)})}),!s&&!r&&o){var g=this.rollupSegObj_.rows[0]?this.rollupSegObj_.rows[0].values:"",f=this.rollupCompareSegObj_.rows[0]?this.rollupCompareSegObj_.rows[0].values:"",v=this.segObj_.rows[0]?this.segObj_.rows[0].values:"",S=this.compareSegObj_.rows[0]?this.compareSegObj_.rows[0].values:"",w=this.buildCompareRows_(g,f,v,S);p=[],p.push({value:e.measureNames_[0],rowSpan:3,isHead:!0}),d.push(p.concat(w[0])),d.push(w[1]),d.push(w[2])}if(!s&&r&&o&&this.rollupSegObj_.rows.map(function(s,r){var o=s.values,i=e.rollupCompareSegObj_.rows[r]?e.rollupCompareSegObj_.rows[r].values:"",n=e.segObj_.rows[r]?e.segObj_.rows[r].values:"",l=e.compareSegObj_.rows[r]?e.compareSegObj_.rows[r].values:"",u=e.buildCompareRows_(o,i,n,l,r);p=[],s.by_values.map(function(e,s){var r=sensorsdata.formatByValue(e,b[s].data_type,"",t[a.by_fields[s]]);p.push({value:r,rowSpan:3,isHead:!0})}),d.push(p.concat(u[0])),d.push(u[1]),d.push(u[2])}),s&&!r&&o&&a.measures.map(function(a,t){var s=e.rollupSegObj_.rows[0]?e.rollupSegObj_.rows[0].values:"",r=e.rollupCompareSegObj_.rows[0]?e.rollupCompareSegObj_.rows[0].values:"",o=e.segObj_.rows[0]?e.segObj_.rows[0].values:"",i=e.compareSegObj_.rows[0]?e.compareSegObj_.rows[0].values:"",n=e.buildCompareRows_(s,r,o,i,0,t);p=[],p.push({value:e.measureNames_[t],rowSpan:3,isHead:!0}),d.push(p.concat(n[0])),d.push(n[1]),d.push(n[2])}),s&&r&&o&&this.rollupSegObj_.rows.map(function(s,r){var o=[];s.by_values.map(function(e,s){var r=sensorsdata.formatByValue(e,b[s].data_type,"",t[a.by_fields[s]]);o.push({value:r,isHead:!0,rowSpan:3*a.measures.length})}),a.measures.map(function(a,t){var i=s.values,n=e.rollupCompareSegObj_.rows[r]?e.rollupCompareSegObj_.rows[r].values:"",l=e.segObj_.rows[r]?e.segObj_.rows[r].values:"",u=e.compareSegObj_.rows[r]?e.compareSegObj_.rows[r].values:"",_=e.buildCompareRows_(i,n,l,u,r,t);p=0===t?$.extend(!0,[],o):[],p.push({value:e.measureNames_[t],rowSpan:3,isHead:!0}),d.push(p.concat(_[0])),d.push(_[1]),d.push(_[2])})}),this.tableData_={heads:u,rows:d},(a.by_fields||[]).length>0){var y=a.measures.length+(a.by_fields||[]).length+a.from_date+a.to_date+a.compare_from_date+a.compare_to_date;if(this.sortStatus_.key!==y){this.sortStatus_.key=y,this.sortStatus_.index=1;for(var O=0,j=u.length;j>O;O++)if(u[O].value===sensorsdata.languages.get("合计<!--{en}Total-->")){this.sortStatus_.index=O,this.sortStatus_.value=sensorsdata.languages.get("合计<!--{en}Total-->"),this.sortStatus_.type="descend";break}}this.sortTable_(this.sortStatus_)}var C=this.segObj_.rows.length>10,x=this.$tableConfig_.find('[data-method="search"]').toggle(C).filter("input");C&&x.val()&&this.searchTable_(x.val()),this.renderTable_()},sensorsdata.SegmentationTable.prototype.buildCompareRows_=function(e,a,t,s,r,o){r=r||0,o=o||0;var i=this,n=[],l=[],u=this.queryData_,d=sensorsdata.CONSTSET,p=i.checkPercent_(u.measures[o]),_="unique"===u.measures[o].aggregator,h=0,m=t.length>s.length?t.length:s.length,b=sensorsdata.CONSTSET.dateFormat,c=moment(u.from_date,b),g=moment(u.to_date,b);for(l=[],l.push({value:c.format(b)+d.dateRangeSplit+g.format(b),isHead:!0}),l.push({isRollup:!0,value:sensorsdata.formatNumber(e[0][o],!1,p),download:_,rowIndex:r,measureIndex:o}),h=m-1;h>=0;h--)l.push(h<t.length?{isDate:!0,value:t[h]?sensorsdata.formatNumber(t[h][o],!1,p):"-",ratio:i.buildRatio_((t[h-1]||[])[o],t[h][o]),download:_,rowIndex:r,measureIndex:o}:{isDate:!0,value:"-"});for(n.push(l),l=[],l.push({value:u.compare_from_date+d.dateRangeSplit+u.compare_to_date,isHead:!0,isCompare:!0}),l.push({isRollup:!0,value:sensorsdata.formatNumber(a[0][o],!1,p),download:_,rowIndex:r,measureIndex:o}),h=m-1;h>=0;h--)l.push(h<s.length?{isDate:!0,value:s[h]?sensorsdata.formatNumber(s[h][o]):"-",ratio:i.buildRatio_((s[h-1]||[])[o],s[h][o]),download:_,rowIndex:r,measureIndex:o}:{isDate:!0,value:"-"});n.push(l);var f=moment(u.compare_from_date,b).format(b),v=c.isAfter(f);l=[],l.push({value:sensorsdata.languages.get("对比<!--{en}Contrast-->"),isHead:!0});var S=e[0][o],w=a[0][o],y=i.buildRatio_(v?w:S,v?S:w)||{value:"-"};for(l.push({isRollup:!0,value:y.value,valueClassName:"ratio "+y.className}),h=m-1;h>=0;h--){var O=t[h]?t[h][o]:"-",j=s[h]?s[h][o]:"-";y=i.buildRatio_(v?j:O,v?O:j)||{value:"-"},l.push({isDate:!0,value:y.value,valueClassName:"ratio "+y.className})}return n.push(l),n},sensorsdata.SegmentationTable.prototype.renderTable_=function(){var e=this,a=this.tableData_.rows.filter(function(e){return!e.hide}),t=function(t,s){var r={dateColExpanded:e.dateColExpanded_,ratioDisplay:e.$tableConfig_.find('button[data-method="percent"]').is(".active"),heads:e.tableData_.heads,rows:a.slice(t,s)};e.$tableContainer_.find('[data-toggle="tooltip"]').tooltip("destroy"),e.$tableContainer_.html(Mustache.render(e.tplTable_,r)),e.$tableContainer_.find('[data-toggle="tooltip"]').tooltip()},s=this.queryData_,r=a.length,o=s.measures.length;s.compare_from_date&&s.compare_to_date&&(o*=3);var i=sensorsdata.CONSTSET.paginationSize*o;this.$paginationContainer_.html(""),i>=r?t(0,r):sensorsdata.pagination({tableElement:this.$paginationContainer_.show(),totalItems:r,pageItems:i,clickHandle:sensorsdata.bind(function(e){t(e.range[0]-1,e.range[1])},this)})},sensorsdata.SegmentationTable.prototype.searchTable_=function(e){var a=(e||"").split(/[,\/ ，]+/);a=a.filter(function(e,t){return a.indexOf(e)===t});var t=0===a.length||1===a.length&&!a[0],s=RegExp(a.join("|")),r=this.queryData_,o=r.measures.length;r.compare_from_date&&r.compare_to_date&&(o*=3);for(var i=0,n=this.tableData_.rows.length;n>i;i+=o){var l=this.tableData_.rows[i],u=t;u||r.by_fields.map(function(e,a){u=u||s.test(l[a].value)});for(var d=0;o>d;d++)this.tableData_.rows[i+d].hide=!u}},sensorsdata.SegmentationTable.prototype.sortTable_=function(e){if(!(e.index<0||"descend"!==e.type&&"ascend"!==e.type)){var a=this.queryData_,t=e.index,s="number",r=[];if((a.by_fields||[]).length>0&&t<a.by_fields.length){var o=sensorsdata.findProperty(a.by_fields[t],this.propObj_.intersection)||{};s=o.has_dict?"string":o.data_type||s,a.bucket_params&&(r=a.bucket_params[a.by_fields[t]])}var i=a.measures.length;a.compare_from_date&&a.compare_to_date&&(i*=3);var n=function(a,t,r){switch(s){case"number":return a=(a+"").split(sensorsdata.CONSTSET.bucketSplit)[0],t=(t+"").split(sensorsdata.CONSTSET.bucketSplit)[0],a=sensorsdata.toNumber(a),t=sensorsdata.toNumber(t),sensorsdata.isNumeric(a)||sensorsdata.isNumeric(t)?"descend"===e.type?sensorsdata.isNumeric(a)?sensorsdata.isNumeric(t)?t-a:-1:1:sensorsdata.isNumeric(a)?sensorsdata.isNumeric(t)?a-t:1:-1:0;case"string":case"date":case"datetime":return $.isArray(r)&&2===r.length?(a=a.split(" ")[1],t=t.split(" ")[1],a=sensorsdata.toNumber(a),t=sensorsdata.toNumber(t),sensorsdata.isNumeric(a)||sensorsdata.isNumeric(t)?"descend"===e.type?sensorsdata.isNumeric(a)?sensorsdata.isNumeric(t)?t-a:-1:1:sensorsdata.isNumeric(a)?sensorsdata.isNumeric(t)?a-t:1:-1:0):"descend"===e.type?(a+"").localeCompare(t):(t+"").localeCompare(a);case"bool":return"descend"===e.type?(a+"").localeCompare(t):(t+"").localeCompare(a)}return 1};if(1===i)this.tableData_.rows.sort(function(e,a){return n(e[t].value,a[t].value,r)});else{for(var l=[],u=0,d=this.tableData_.rows.length;d>u;u+=i)this.tableData_.rows[u][0]._rowIndex_=u,l.push(this.tableData_.rows[u]);l.sort(function(e,a){return n(e[t].value,a[t].value,r)});for(var p=[],_=0,h=l.length;h>_;_++){var m=l[_][0]._rowIndex_;p=p.concat(this.tableData_.rows.slice(m,m+i))}this.tableData_.rows=p}this.tableData_.heads.map(function(e){e.sortType=""}),this.tableData_.heads[t].sortType=e.type}},sensorsdata.SegmentationTable.prototype.empty_=function(){this.$tableContainer_.html(""),this.$tableConfig_.find('input[type="text"]').val("")},sensorsdata.SegmentationTable.prototype.checkPercent=function(e){return e.expression&&"%2p"===e.format||"bounce_rate"===e.aggregator||"exit_rate"===e.aggregator},sensorsdata.SegmentationTable.prototype.sortRows_=function(){var e=this.queryData_,a=e.compare_from_date&&e.compare_to_date;if(0!==(e.by_fields||[]).length){var t=this.rollupSegObj_.rows.map(function(e){return JSON.stringify(e.by_values)}),s=[];if(this.segObj_.rows.map(function(e){s[t.indexOf(JSON.stringify(e.by_values))]=e}),this.segObj_.rows=s,a){var r=[];this.compareSegObj_.rows.map(function(e){r[t.indexOf(JSON.stringify(e.by_values))]=e}),this.compareSegObj_.rows=r}}},sensorsdata.SegmentationTable.prototype.saveStatus_=function(){if(!$.isEmptyObject(this.tableData_)&&!$.isEmptyObject(this.sortStatus_)&&this.sortStatus_.index>0&&this.sortStatus_.index<this.tableData_.heads.length){var e=this.queryData_;this.sortStatus_.value=this.tableData_.heads[this.sortStatus_.index].value,this.sortStatus_.key=e.measures.length+(e.by_fields||[]).length+e.from_date+e.to_date+e.compare_from_date+e.compare_to_date}sensorsdata.localStorage.setItem("segmentation-table",JSON.stringify({dateColExpanded:this.dateColExpanded_,sortStatus:this.sortStatus_}))},sensorsdata.SegmentationTable.prototype.getStatusItem_=function(e){var a=sensorsdata.localStorage.getItem("segmentation-table"),t=a?JSON.parse(a)||{}:{};return t[e]},sensorsdata.SegmentationTable.prototype.checkPercent_=function(e){return e.expression&&"%2p"===e.format||"bounce_rate"===e.aggregator||"exit_rate"===e.aggregator};