var guid=require("components/util/util").guid;sensorsdata.DataStreamPage=function(t){sensorsdata.BasePage.call(this),this.options=t,this.options.container=t.container||$("body"),this.pageName=window.location.pathname,this.tplDataStreamPage_=$("#tpl_data_stream_page").html(),this.recvInterval=null,this.streamInterval=null,this.dataQueue=[],this.totalCount=0,this.__id__=null,this.hasData=!1,this.options.container.html(this.tplDataStreamPage_),sensorsdata.cache.config.disable_vtrack===!0&&this.options.container.find('[data-method="vtrack-manager"]').hide(),this.dataStreamContainer_=this.options.container.find("#data-stream-page-container"),this.tplContentItem_=$("#tpl_content_item").html(),this.importedContainer_=this.options.container.find("#imported-container"),this.importedContentContainer_=this.options.container.find("#imported-content-container"),this.debugContainer_=this.options.container.find("#debug-container"),this.debugContentContainer_=this.options.container.find("#debug-content-container"),this.importedSocket=null,this.options.container.find("#link-import-tool").attr("href","/accessories/data_checker?project="+(sensorsdata.cache.project.name||"default")),this.paramObj_=null,this.debugSocket=null,this.trackManager_=this.options.container.find('[data-method="track-manager"]'),this.vtrackManager_=this.options.container.find('[data-method="vtrack-manager"]'),this.tplNoData_=$("#tpl_no_content_item").html(),this.socketBaseUrl=window.location.host+"/api/ws/consume?rate=1",this.currentTab="debug",this.importedHasData=!1,this.debugHasData=!1,this.errorText='获取数据失败，请参考<a href="https://www.sensorsdata.cn/manual/data_import_nginx.html" target="_blank">文档</a>检查转发配置 或 联系值班同学<!--{todo}-->',this.PROTOCAL={HTTP:"http:",HTTPS:"https:"},this.init()},sensorsdata.inherits(sensorsdata.DataStreamPage,sensorsdata.BasePage),sensorsdata.DataStreamPage.prototype.init=function(){sensorsdata.DataStreamPage.superClass_.init.call(this),sensorsdata.setModuleByTheme(this.options.container),this.paramObj_=sensorsdata.unparam(window.location.hash),this.paramObj_=this.dealParam_(this.paramObj_),window.history.pushState("stream","","#"+$.param(this.paramObj_)),this.resizeContentContainer_(),this.renderConditionsSelector(),this.importedContentContainer_.html(this.tplNoData_),this.debugContentContainer_.html(this.tplNoData_),this.initEvents(),this.paramObj_.imported.state&&$("#option-tab").find('li a[href="#imported-container"]').trigger("click"),this.options.closeLoading()},sensorsdata.DataStreamPage.prototype.initStreamStart=function(t){this.__id__=guid()+moment().unix()+""+moment().milliseconds(),t.unique_id=this.__id__;var a=sensorsdata.api.get("streamStart");return sensorsdata.ajax({url:a,method:"POST",data:JSON.stringify(t),success:function(){sensorsdata.log("初始化成功")}})},sensorsdata.DataStreamPage.prototype.recvData=function(t){var a=sensorsdata.api.get("streamGet"),e={unique_id:this.__id__},n=this;this.recvInterval=setInterval(function(){sensorsdata.ajax({url:a,data:e,success:function(a){$.isFunction(t)&&t(a)},error:function(){clearInterval(n.recvInterval)}})},2e3)},sensorsdata.DataStreamPage.prototype.stopStream=function(){clearInterval(this.recvInterval),clearInterval(this.streamInterval),this.dataQueue=[],this.totalCount=0;var t=this,a=sensorsdata.api.get("streamStop")+"?unique_id="+this.__id__;return sensorsdata.ajax({url:a,method:"DELETE",success:function(){t.__id__=null}})},sensorsdata.DataStreamPage.prototype.start=function(t){var a=this,e={debug:this.paramObj_.debug.state};e.user=e.debug?this.paramObj_.debug.users.join():this.paramObj_.imported.users.join(),e.event=e.debug?this.paramObj_.debug.events.join():this.paramObj_.imported.events.join();var n=t.find(".data-stream-panel-content:visible");this.initStreamStart(e).then(function(){a.recvData(function(t){$.isEmptyObject(t)||0===t.length||(a.hasData||n.html(""),a.hasData=!0,a.dataQueue=a.dataQueue.concat(t))})}),a.streamInterval=setInterval(function(){if(a.dataQueue.length){n.find("div:last-child").hasClass("report-no-data")&&n.html(""),a.totalCount++;var e=a.dataQueue.shift(),i=JSON.parse(e),s=i.record?JSON.parse(i.record)[0]:i,r={index:a.totalCount,origin:i.record||e,parse:s,imported:a.paramObj_.imported.state,event:s.event||s.type,distinct_id:s.distinct_id,debug:a.paramObj_.debug.state};i.reason&&(r.reason=i.reason),r.time=moment(r.parse.recv_time).format("HH:mm:ss.SSS");var o=Mustache.render(a.tplContentItem_,r);if(n.append(o),t.find("span.switch").hasClass("on")){var d=n.find("div.content-item:last-child");d.find('button[data-method="parse-json"]').trigger("click")}n.scrollTop()+n.innerHeight()===n[0].scrollHeight?(n.find("div:last-child").slideDown({duration:"400",queue:!1},function(){}),n.animate({scrollTop:n[0].scrollHeight},"400")):n.find("div:last-child").slideDown({duration:"400",queue:!1},function(){})}},1e3)},sensorsdata.DataStreamPage.prototype.stop=function(){this.stopStream()},sensorsdata.DataStreamPage.prototype.renderConditionsSelector=function(){this.importedContainer_.find("input#imported-events").val(this.paramObj_.imported.events.join(",")),this.importedContainer_.find("input#imported-users").val(this.paramObj_.imported.users.join(",")),this.debugContainer_.find("input#debug-events").val(this.paramObj_.debug.events.join(",")),this.debugContainer_.find("input#debug-users").val(this.paramObj_.debug.users.join(",")),this.dataStreamContainer_.find('[data-toggle="tooltip"]').tooltip("destroy").tooltip()},sensorsdata.DataStreamPage.prototype.dealParam_=function(t){return t.hasOwnProperty("imported")?(t.imported.hasOwnProperty("events")&&t.imported.events instanceof Array||(t.imported.events=[]),t.imported.hasOwnProperty("users")&&t.imported.users instanceof Array||(t.imported.users=[]),t.imported.state=t.imported.hasOwnProperty("state")?"true"===t.imported.state:!1):t.imported={events:[],users:[],state:"imported"===this.currentTab},t.hasOwnProperty("debug")?(t.debug.hasOwnProperty("users")&&t.debug.users instanceof Array||(t.debug.users=[]),t.debug.hasOwnProperty("events")&&t.debug.events instanceof Array||(t.debug.events=[]),t.debug.state=t.debug.hasOwnProperty("state")?"true"===t.debug.state:!1):t.debug={events:[],users:[],state:"debug"===this.currentTab},t.debug.state&&t.imported.state&&(t.imported.state=!1),t},sensorsdata.DataStreamPage.prototype.resizeContentContainer_=function(){var t=document.body.clientHeight-$("#sa_head_nav").height();this.importedContentContainer_.css("max-height",t-150),this.debugContainer_.css("max-height",t-this.debugContainer_.find("div.data-stream-panel").height()-this.debugContainer_.find("div.data-stream-panel-header").height())},sensorsdata.DataStreamPage.prototype.initEvents=function(){var t=this;$(window).unbind("resize.data-stream").bind("resize.data-stream",function(){t.resizeContentContainer_()}),this.dataStreamContainer_.find("ul li a").unbind("click.current").bind("click.current",function(){var a=$(this).attr("data-method");if(!$(this).parent().hasClass("active")){t.paramObj_.debug.state="debug"===a,t.paramObj_.imported.state="imported"===a;var e=$(this).attr("href"),n=t.dataStreamContainer_.find(e).siblings(),i=n.find('button[data-method="resume"]').is(":visible");i||n.find('button[data-method="pause"]').trigger("click"),window.history.replaceState("stream","","#"+$.param(t.paramObj_)),t.hasData=!1}}),this.dataStreamContainer_.unbind("click").bind("click",function(a){var e=$(a.target||a.srcElement),n=e.attr("data-method");n||(e=e.parents("[data-method]:first"),n=e.attr("data-method"));var i=e.parents('[role="tabpanel"]:first');switch(n){case"parse-json":var s=e.parent().prev("div.data-json");t.beautifyJSON(s),e.toggle(),e.next("button[data-origin]").toggle();break;case"reverse-json":var r=e.attr("data-origin");e.toggle(),e.prev('button[data-method="parse-json"]').toggle(),e.parent().prev("div.data-json").html(r);break;case"init-format":e.hasClass("disabled")||e.toggleClass("on");break;case"resume":var o=t.checkInputs_(i);o&&(t.paramObj_=t.buildParamObj_(),window.history.replaceState("stream","","#"+$.param(t.paramObj_)),e.toggle(!1),e.siblings("button[data-method]").toggle(!0),i.find("div.conditions-selector input").attr("disabled","disabled"),i.find("span.iconc-running").show(),i.find("span.switch").addClass("disabled"),t.start(i));break;case"pause":e.toggle(!1),e.siblings("button[data-method]").toggle(!0),i.find("div.conditions-selector input").removeAttr("disabled"),i.find("span.iconc-running").hide(),i.find("span.switch").removeClass("disabled"),t.stopStream();break;case"clear":i.find(".data-stream-panel-content").html(t.tplNoData_)}}),this.vtrackManager_.unbind("click").bind("click",sensorsdata.bind(function(){this.options.initPage("/vtrack/")},this)),this.trackManager_.unbind("click").bind("click",sensorsdata.bind(function(){this.options.initPage("/track-manager/")},this))},sensorsdata.DataStreamPage.prototype.beautifyJSON=function(t){var a={dom:t,imgCollapsed:"/res/img/Collapsed.gif",imgExpanded:"/res/img/Expanded.gif",isCollapsible:!1},e=new JsonFormater(a),n=t.next("div").find('[data-method="reverse-json"]').attr("data-origin");e.doFormat(n)},sensorsdata.DataStreamPage.prototype.buildParamObj_=function(){var t={imported:{users:[],events:[],state:!1},debug:{users:[],events:[],state:!1}},a=this.dataStreamContainer_.find("input#imported-events").val(),e=this.dataStreamContainer_.find("#imported-users").val();t.imported.events=a?a.split(","):[],t.imported.users=e?e.split(","):[],t.imported.state=this.dataStreamContainer_.find('ul li a[data-method="imported"]').parent().hasClass("active");var n=this.dataStreamContainer_.find("input#debug-events").val(),i=this.dataStreamContainer_.find("#debug-users").val();return t.debug.events=n?n.split(","):[],t.debug.users=i?i.split(","):[],t.debug.state=!t.imported.state,t},sensorsdata.DataStreamPage.prototype.checkInputs_=function(t){var a=!0;return t.find("div.conditions-selector input").each(function(t,e){sensorsdata.log(e,t),-1!==$(e).val().indexOf("，")&&(a=!1)}),a},sensorsdata.DataStreamPage.prototype.reload=function(){this.init()},sensorsdata.DataStreamPage.prototype.unload=function(){this.__id__&&this.stopStream(),clearInterval(this.recvInterval),clearInterval(this.recvInterval),$(window).unbind("resize.data-stream")};