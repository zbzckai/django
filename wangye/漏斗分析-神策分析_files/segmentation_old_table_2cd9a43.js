sensorsdata.SegmentationOldTable=function(t){this.option_=$.extend(!0,{},t),this.$tableContainer_=this.option_.container.find(".table-wrap"),this.$tableToolbar_=this.option_.tableConfig,this.$tableTab_=this.option_.container.find("#table-tab"),this.queryData_=this.option_.queryData,this.propObj_=this.option_.propObj,this.rawSegObj_=this.option_.rawSegObj,this.segObj_=this.option_.segObj,this.compareSegObj_=this.option_.compareSegObj,this.rollupSegObj_=this.option_.rollupSegObj,this.rollupCompareSegObj_=this.option_.rollupCompareSegObj,this.ratioSegObj_={},this.ratioRollupSegObj_={},this.tableData_=null,this.tableRollupRowDis_=!1,this.firstTableColumnText_=sensorsdata.languages.get("日期<!--{en}Date-->"),this.tplTable_=$("#tpl-segmentation-index-old-table").html(),this.initEvents_(),this.sortRows_(),this.renderHtml_()},sensorsdata.SegmentationOldTable.prototype.toggleRatio=function(t){"boolean"==typeof t?this.$tableContainer_.find("td span.ratio").toggleClass("hide",t):this.$tableContainer_.find("td span.ratio").toggleClass("hide")},sensorsdata.SegmentationOldTable.prototype.initEvents_=function(){this.$tableContainer_.unbind("click.table").bind("click.table",sensorsdata.bind(this.tableContainerClick_,this)),this.$tableTab_.unbind("click.table").bind("click.table",sensorsdata.bind(this.tableTabClick_,this));var t=this.$tableToolbar_.find('input[type="text"]');t.val("").attr("data-last",""),t.unbind("keyup").bind("keyup",sensorsdata.bind(function(){var e=t.attr("data-timeout");e&&window.clearTimeout(e);var a=$.trim(t.val()),s=t.attr("data-last");return a===s?this.tableData_:(e=window.setTimeout(sensorsdata.bind(function(){var e=this.searchTable_(a,this.tableData_);this.renderTable_(e),t.attr("data-last",a)},this),500),void t.attr("data-timeout",e))},this));var e=this;this.$tableToolbar_.find("input:checkbox").off("change").change(function(){e.tableRollupRowDis_=$(this).is(":checked"),e.renderHtml_()})},sensorsdata.SegmentationOldTable.prototype.renderHtml_=function(){var t=this.queryData_,e=!(!t.compare_from_date||!t.compare_to_date);if(this.$tableTab_.toggle(e),e){var a=sensorsdata.CONSTSET;this.$tableTab_.find('a[data-method="switch-left"]').text(t.from_date+a.dateRangeSplit+t.to_date),this.$tableTab_.find('a[data-method="switch-right"]').text(t.compare_from_date+a.dateRangeSplit+t.compare_to_date)}this.tableData_=this.getDisplayTableData_(),this.tableData_=this.sortTableData_(this.tableData_,this.firstTableColumnText_,"descend"),this.renderTable_(this.tableData_)},sensorsdata.SegmentationOldTable.prototype.renderTable_=function(t){this.renderToolbar_();var e=this.tableRollupRowDis_,a=0;t=$.extend(!0,{},t),t.rows=t.rows.filter(function(t){return t[0].rollup===!0?t.rowHide!==!0&&e===!0?(a++,!0):!1:t.rowHide!==!0});var s=this.dealRowSpan_(t.rows.splice(0,a)),r="switch-ratio"===this.$tableTab_.find("a.active").attr("data-method"),o=this.$tableToolbar_.find('button[data-method="percent"]').is(".active"),i=sensorsdata.CONSTSET.paginationSize,n=sensorsdata.bind(function(e,a){e-=1;var i=t.rows.slice(e,a);i=this.dealRowSpan_(i),this.$tableContainer_.find('[data-toggle="tooltip"]').tooltip("destroy"),this.$tableContainer_.html(Mustache.render(this.tplTable_,{heads:t.heads,rows:s.concat(i),percentDisplay:o||r})),this.$tableContainer_.find('[data-toggle="tooltip"]').tooltip()},this);0===t.rows.length&&0===t.heads.length?(this.$tableContainer_.html(""),this.option_.container.find("#table-pagination").hide().html("")):t.rows.length<=i?(this.option_.container.find("#table-pagination").hide().html(""),n(1,t.rows.length)):sensorsdata.pagination({tableElement:this.option_.container.find("#table-pagination").show(),totalItems:t.rows.length,clickHandle:sensorsdata.bind(function(t){n(t.range[0],t.range[1])},this)})},sensorsdata.SegmentationOldTable.prototype.renderToolbar_=function(){this.$tableToolbar_.find('[data-method="search"]').toggle(this.rawSegObj_.rows.length>10),!$.isEmptyObject(this.rawSegObj_)&&this.rawSegObj_.series.length>1?(this.$tableToolbar_.find("input#chk-rollup-display").prop("checked",this.tableRollupRowDis_),this.$tableToolbar_.find('[data-method="rollup"]').show()):this.$tableToolbar_.find('[data-method="rollup"]').hide(),this.$tableToolbar_.find('[data-toggle="tooltip"]').tooltip()},sensorsdata.SegmentationOldTable.prototype.sortRows_=function(){var t=this.queryData_,e=t.compare_from_date&&t.compare_to_date,a=this.rollupSegObj_.rows.map(function(t){return t.name}),s=[];if(this.segObj_.rows.map(function(t){s[a.indexOf(t.name)]=t}),this.segObj_.rows=s,e){var r=[];this.compareSegObj_.rows.map(function(t){r[a.indexOf(t.name)]=t}),this.compareSegObj_.rows=r}},sensorsdata.SegmentationOldTable.prototype.sortMultiMeasureTableData_=function(t,e,a){var s=-1===this.option_.measureNames.indexOf(e),r=-1,o=-1;if(t.heads.map(function(t,s){s>0&&t.sortType&&(o=s),t.value===e&&(r=s,t.sortType=a)}),-1===r)return t;-1!==o&&o!==r&&(t.heads[o].sortType="");var i=!1;if(s){if(s&&1===this.queryData_.by_fields.length){var n=sensorsdata.findProperty(this.queryData_.by_fields[0],this.propObj_.intersection);i="number"===n.data_type&&!n.has_dict}}else i=!0;var l=sensorsdata.CONSTSET.bucketSplit,d=null;d=!0===i?function(t,e){var s=t[r].value,o=e[r].value;sensorsdata.isNumeric(s)||(s=-1===s.indexOf(l)?s:s.split(l)[0]),sensorsdata.isNumeric(o)||(o=-1===o.indexOf(l)?o:o.split("-")[0]);var i=0;return i=sensorsdata.isNumeric(s)?sensorsdata.isNumeric(o)?sensorsdata.toNumber(s)-sensorsdata.toNumber(o):1:-1,"ascend"===a?i:-i}:function(t,e){var s=t[r].value.localeCompare(e[r].value);return"ascend"===a?s:-s};for(var h=[],u=[],b=0,p=t.rows.length;p>b;){var _=t.rows[b][0].rowSpan||1;u=t.rows.splice(b,_),_>1&&(u[0][0].isRowSpanHide=!0,delete u[0][0].rowSpan,u.sort(d),u[0][0].isRowSpanHide=!1,u[0][0].rowSpan=_),h=h.concat(u),p-=_}return t.rows=h,t},sensorsdata.SegmentationOldTable.prototype.sortMultiMeasureTableDataByDate_=function(t,e){var a=this.getDisplayTableData_();if(a.heads.map(function(t){t.sortType=""}),a.heads[0].sortType=t,"ascend"!==t){var s=[];a.rows[0][0].rollup===!0&&(s=a.rows.splice(0,a.rows[0][0].rowSpan||1));for(var r=[];a.rows.length>0;){var o=a.rows[0][0].rowSpan||1;r=a.rows.splice(0,o).concat(r)}a.rows=s.concat(r),a.rows=this.dealRowSpan_(a.rows)}return e!==!0?this.sortMultiMeasureTableData_(a,this.option_.measureNames[0],"descend"):a},sensorsdata.SegmentationOldTable.prototype.getDisplayTableData_=function(){if($.isEmptyObject(this.compareSegObj_))return this.buildTableData_(this.segObj_,this.rollupSegObj_);var t=sensorsdata.CONSTSET.bucketSplit,e=sensorsdata.bind(function(e,a){var s={series:[],rows:[]},r=e.series.length,o=a.series.length,i=r>o?r:o,n=0;for(n=0;i>n;n++){var l=o>n?a.series[n]:"-";l+=t,l+=r>n?e.series[n]:"-",s.series.push(l)}for(var d=0,h=a.rows.length;h>d;d++){var u=[];for(n=0;i>n;n++){var b=r>n?e.rows[d].data[n]:null,p=o>n?a.rows[d].data[n]:null,_=[];_=b?b.map(function(t,e){var a=p?p[e]:"-";if(0!==t&&$.isNumeric(a)){var s=(a-t)/t;return Math.round(1e4*s)/100}return"-"}):p.map(function(t,e){var a=b?b[e]:"-";if(0!==a&&$.isNumeric(a)){var s=(t-a)/a;return Math.round(1e4*s)/100}return"-"}),u.push(_)}s.rows.push({name:a.rows[d].name,data:u})}return s},this),a=this.$tableTab_.find("a.active").attr("data-method");switch(this.tableData_=null,a){case"switch-left":return this.buildTableData_(this.segObj_,this.rollupSegObj_);case"switch-right":return this.buildTableData_(this.compareSegObj_,this.rollupCompareSegObj_);case"switch-ratio":return $.isEmptyObject(this.ratioSegObj_)&&(this.ratioSegObj_=e(this.segObj_,this.compareSegObj_)),!$.isEmptyObject(this.ratioRollupSegObj_)||$.isEmptyObject(this.rollupSegObj_)||$.isEmptyObject(this.rollupCompareSegObj_)||(this.ratioRollupSegObj_=e(this.rollupSegObj_,this.rollupCompareSegObj_)),this.buildTableData_(this.ratioSegObj_,this.ratioRollupSegObj_,!0)}},sensorsdata.SegmentationOldTable.prototype.buildTableData_=function(t,e,a){return 1===this.queryData_.measures.length?this.buildSingleMeasureTableData_(t,e,a):this.buildMultiMeasuresTableData_(t,e,a)},sensorsdata.SegmentationOldTable.prototype.checkUserDownload_=function(t){var e=this.$tableTab_.find("a.active").attr("data-method");return!sensorsdata.authority.isNormal&&"switch-ratio"!==e&&!t.field&&"unique"===t.aggregator},sensorsdata.SegmentationOldTable.prototype.buildSingleMeasureTableData_=function(t,e,a){if($.isEmptyObject(t))return{};t=$.extend(!0,{},t);var s={heads:[{value:this.firstTableColumnText_,showSort:!0,sortType:"ascend",index:-1}],rows:[]},r=this.checkPercent(this.queryData_.measures[0]),o=this.checkUserDownload_(this.queryData_.measures[0]),i=this.buildTableCell_,n=this.queryData_.unit;if(t.series.map(function(e,a){var r=[{value:sensorsdata.formatTime(e,n),tooltip:"week"===n?sensorsdata.buildWeekRangeTip(e):"",showSort:!1,sortType:a===t.series.length-1?"descend":"",isHead:!0}];s.rows.push(r)}),t.rows.map(function(t){var e={value:t.name,isMeasureValue:!0};e.title=sensorsdata.trimConstHtml(t.name),s.heads.push(e),s.rows.map(function(e,s){var n=0===s?"":t.data[s-1][0],l=i(a,t.data[s][0],n,s,r);l.download=o,l.rowIndex=t.rowIndex,l.seriesIndex=s,l.measureIndex=0,e.push(l)})}),!$.isEmptyObject(e)&&this.needRollupRow_()){var l=[{value:sensorsdata.languages.get("合计<!--{en}Total-->"),showSort:!1,isHead:!0,rollup:!0}];e.rows.map(function(t){var e=i(a,t.data[0][0],"",0,r);e.download=o,e.rowIndex=t.rowIndex,e.measureIndex=0,l.push(e)}),s.rows.unshift(l)}return s},sensorsdata.SegmentationOldTable.prototype.buildMultiMeasuresTableData_=function(t,e,a){if($.isEmptyObject(t))return{};t=$.extend(!0,{},t);var s={heads:[{value:this.firstTableColumnText_,showSort:!0,sortType:"ascend"}],rows:[]},r=this.queryData_,o=this.propObj_.intersection,i=(this.queryData_.by_fields||[]).length>0;if(i){var n=this.buildByFieldText_(r.by_fields,o);s.heads.push({value:n,showSort:!0})}this.option_.measureNames.map(function(t){s.heads.push({value:t,showSort:!0,isMeasureValue:!0})});var l=this.buildTableCell_,d=sensorsdata.bind(this.checkUserDownload_,this),h=r.unit,u=r.measures.length,b=t.rows.length,p=this;if(t.series.map(function(e,o){var n=[];t.rows.map(function(t,s){var _=[{value:sensorsdata.formatTime(e,h),isRowSpanHide:b>1&&0!==s,isHead:!0}];i&&_.push({value:t.name,className:"by-overflow",title:sensorsdata.trimConstHtml(t.name)});for(var c=0;u>c;c++){var m=p.checkPercent(r.measures[c]),f=0===o?"":t.data[o-1][c],g=l(a,t.data[o][c],f,o,m);g.download=d(r.measures[c]),g.rowIndex=t.rowIndex,g.seriesIndex=o,g.measureIndex=c,_.push(g)}n.push(_)}),b>1&&(n[0][0].rowSpan=n.length),s.rows=s.rows.concat(n)}),!$.isEmptyObject(e)&&this.needRollupRow_()){var _=[];e.rows.map(function(t,e){var s=[{value:sensorsdata.languages.get("合计<!--{en}Total-->"),isRowSpanHide:b>1&&0!==e,isHead:!0,rollup:!0}];i&&s.push({value:t.name,className:"by-overflow"});for(var o=0;u>o;o++){var n=p.checkPercent(r.measures[o]),h=l(a,t.data[0][o],"",0,n);h.download=d(r.measures[o]),h.rowIndex=e,h.measureIndex=o,s.push(h)}_.push(s)}),b>1&&(_[0][0].rowSpan=_.length),s.rows=_.concat(s.rows)}return s},sensorsdata.SegmentationOldTable.prototype.buildTableCell_=function(t,e,a,s,r){if(t===!0)return{hideValue:$.isNumeric(e),value:e,showPercent:$.isNumeric(e),percent:Math.abs(e),style:e>=0?"pos":"neg",isMeasureValue:!0};var o="",i=0;return $.isNumeric(e)&&0!==s&&0!==a&&$.isNumeric(a)&&(i=e-a,o=Math.round(Math.abs(i)/a*1e3)/10),{value:sensorsdata.formatNumber(e,!1,r),showPercent:$.isNumeric(o),percent:o,style:i>=0?"pos":"neg",isMeasureValue:!0}},sensorsdata.SegmentationOldTable.prototype.tableTabClick_=function(t){var e=$(t.target||t.srcElement),a=e.attr("data-method");if(a){this.$tableTab_.find("a.active").removeClass("active"),this.$tableTab_.find('a[data-method="'+a+'"]').addClass("active"),this.tableData_=this.getDisplayTableData_();var s=this.$tableContainer_.find("table thead th:first").attr("data-sort")||"descend";"ascend"!==s&&(this.tableData_=this.sortTableData_(this.tableData_,this.firstTableColumnText_,s));var r=this.$tableContainer_.find('table thead th[data-sort$="end"]:eq(1)');1===r.size()&&(this.tableData_=this.sortTableData_(this.tableData_,r.attr("data-value"),r.attr("data-sort"))),this.renderTable_(this.tableData_)}},sensorsdata.SegmentationOldTable.prototype.tableContainerClick_=function(t){var e=$(t.target||t.srcElement);e.attr("data-method")||(e=e.parents("[data-method]:first"));var a=e.attr("data-method");switch(a){case"sort":var s=e.attr("data-value"),r=e.attr("data-sort");r=r&&"descend"===r?"ascend":"descend",sensorsdata.loader.show(),this.tableData_=this.sortTableData_(this.tableData_,s,r),this.renderTable_(this.tableData_),sensorsdata.loader.close();break;case"user-list":var o=parseInt(e.attr("data-row-index"),10),i=parseInt(e.attr("data-series-index"),10),n=parseInt(e.attr("data-measure-index"),10),l=$.extend(!0,{},this.option_.queryData);l.rollup_date=!!e.attr("data-rollup"),l.slice_by_values=l.rollup_date?this.rawSegObj_.rows[this.segObj_.rows[o].rowIndex].by_values:this.rawSegObj_.rows[o].by_values;for(var d in l.slice_by_values)if(l.slice_by_values.hasOwnProperty(d))switch(l.slice_by_values[d]){case null:l.slice_by_values[d]=sensorsdata.CONSTSET.unknownByValueText;break;case"":l.slice_by_values[d]=sensorsdata.CONSTSET.emptyStringByValueText}l.compare_from_date&&l.compare_to_date&&"switch-right"===this.$tableTab_.find(".active").attr("data-method")?(l.from_date=l.compare_from_date,l.to_date=l.compare_to_date,l.slice_date=l.rollup_date?null:this.compareSegObj_.series[i]):l.slice_date=l.rollup_date?null:this.rawSegObj_.series[i],l.detail=!0,l.measures=[l.measures[n]],e.createUserListPanel({queryData:l})}},sensorsdata.SegmentationOldTable.prototype.sortTableData_=function(t,e,a){var s=this.queryData_.measures.length>1;if(s){var r=(this.queryData_.by_fields||[]).length>0;if(this.rawSegObj_.rows.length>1)e===this.firstTableColumnText_?t=this.sortMultiMeasureTableDataByDate_(a):r&&(t=this.sortMultiMeasureTableData_(t,e,a));else if(e===this.firstTableColumnText_)t=this.sortMultiMeasureTableDataByDate_(a,!0);else{var o=-1;if(t.heads.map(function(t,s){t.sortType="",t.value===e&&(o=s,t.sortType=a)}),-1!==o&&(1!==o||!r)){var i=null;!0===t.rows[0][0].rollup&&(i=t.rows.shift()),t.rows.sort(function(t,e){var s=t[o].value,r=e[o].value,i=0;return i=sensorsdata.isNumeric(s)?sensorsdata.isNumeric(r)?sensorsdata.toNumber(s)-sensorsdata.toNumber(r):1:-1,"ascend"===a?i:-i}),null!==i&&t.rows.unshift(i)}}}else t.heads[0].sortType=a,t.rows.reverse(),!0===t.rows[t.rows.length-1][0].rollup&&t.rows.unshift(t.rows.pop());return t},sensorsdata.SegmentationOldTable.prototype.dealRowSpan_=function(t){for(var e="",a=-1,s=0,r=0,o=t.length;o>r;r++)t[r].rowClass=r%2===1?"row-odd":"row-even",e=t[r][0].value,t[r][0].isRowSpanHide=!0,t[r].rowHide!==!0&&(s++,-1===a&&(a=r)),o>r+1&&e===t[r+1][0].value||(1!==s?(-1!==a&&(t[a][0].rowSpan=s,t[a][0].isRowSpanHide=!1),e="",a=-1,s=0):(-1!==a&&(delete t[a][0].rowSpan,delete t[a][0].isRowSpanHide),e="",a=-1,s=0));return t},sensorsdata.SegmentationOldTable.prototype.searchTable_=function(t,e){if($.isEmptyObject(e)||!$.isArray(e.rows))return e;sensorsdata.loader.show();var a=(t||"").split(/[,\/ ，]+/);a=a.filter(function(t,e){return a.indexOf(t)===e});var s=0===a.length||1===a.length&&!a[0],r=RegExp(a.join("|")),o=this.queryData_.measures.length>1;if(o)e.rows.map(function(t){if(s)t.rowHide=!1;else{var e=t[1].value;t.rowHide=!r.test(e)}}),e.rows=this.dealRowSpan_(e.rows);else{var i=[];e.heads.map(function(t,e){e>0&&(t.cellHide=s?!1:!r.test(t.value),t.cellHide&&i.push(e))});var n=i.length===e.heads.length-1;e.rows.map(function(t){n?(t.rowHide=!0,t.map(function(t){t.cellHide=!0})):(t.rowHide=!1,t.map(function(t,e){t.cellHide=-1!==i.indexOf(e)}))})}return sensorsdata.loader.close(),e},sensorsdata.SegmentationOldTable.prototype.buildByFieldMap_=function(t,e){var a={};return $.isArray(t)&&t.length>0&&t.map(function(t){var s=sensorsdata.findProperty(t,e);a[t]=s.cname}),a},sensorsdata.SegmentationOldTable.prototype.buildByFieldText_=function(t,e){if(!$.isArray(t)||0===t.length)return"";var a=this.buildByFieldMap_(t,e),s=$.map(a,function(t){return t});return s.join("，")},sensorsdata.SegmentationOldTable.prototype.checkPercent=function(t){return t.expression&&"%2p"===t.format||"bounce_rate"===t.aggregator||"exit_rate"===t.aggregator},sensorsdata.SegmentationOldTable.prototype.needRollupRow_=function(){var t=this.queryData_;return t.from_date!==t.to_date||t.compare_from_date!==t.compare_to_date||!$.isEmptyObject(this.rawSegObj_)&&this.rawSegObj_.series.length>1};