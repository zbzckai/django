sensorsdata.RetentionWidget=function(t){if($.isEmptyObject(t))throw"Init Retention Widget error, parameter is empty.";if(t.configContainer instanceof jQuery==!1||t.contentContainer instanceof jQuery==!1)throw"Init Retention Widget error, container is not jQuery object.";if($.isEmptyObject(t.widgetObj)||$.isEmptyObject(t.widgetObj.bookmark))throw"Init Retention Widget error, widgetObj is empty.";sensorsdata.RetentionBase.call(this),this.contentContainer_=t.contentContainer,this.configContainer_=t.configContainer,this.bookmark_=t.widgetObj.bookmark,this.widgetTime_=t.widgetTime,this.config_=t.config||{},this.saveConfig_=t.saveConfig,this.tplLoader_=$("#tpl-widget-loader").html(),this.tplContent_=$("#tpl-retention-widget-content").html(),this.tplToolbar_=$("#tpl-retention-widget-toolbar").html(),this.tplKeyinfo_=$("#tpl-retention-widget-keyinfo").html(),this.retentions_={},this.propObj_={},this.chart_=null,this.paramObj_={},this.renderAllow_=!1,this.dataAlready_=!1,this.defaultIndex_=1,this.init()},sensorsdata.inherits(sensorsdata.RetentionWidget,sensorsdata.RetentionBase),sensorsdata.RetentionWidget.prototype.refresh=function(t,e){!$.isEmptyObject(t)&&t.widgetTime&&(this.widgetTime_=t.widgetTime),this.init(e)},sensorsdata.RetentionWidget.prototype.resize=function(){this.chart_&&$.isFunction(this.chart_.resize)&&this.chart_.resize()},sensorsdata.RetentionWidget.prototype.init=function(t){this.setEmpty_(this.tplLoader_,!0);var e=this.paramObj_=JSON.parse(this.bookmark_.data);"boolean"==typeof t?e.use_cache=t:delete e.use_cache;var n=this.getDuration(e.duration,e.unit);sensorsdata.fillBookmarkTime(e,this.widgetTime_,n.limit,e.unit),this.getRetentions_(this.paramObj_);var s=this;this.contentContainer_.off("click",'[data-method="by-value-change"]').on("click",'[data-method="by-value-change"]',function(){var t=$(this);if(!t.is(":disabled")){var e=parseInt(t.siblings("[data-by-value-index]").attr("data-by-value-index"),10);"left"===t.attr("data-type")?e--:e++,s.renderToolbar_(e),s.renderKeyInfo_(e,0),s.renderChart_(e)}})},sensorsdata.RetentionWidget.prototype.render=function(){this.renderAllow_=!0,this.dataAlready_===!0&&this.renderContent_()},sensorsdata.RetentionWidget.prototype.clearChart_=function(){this.chart_&&$.isFunction(this.chart_.dispose)&&this.chart_.dispose()},sensorsdata.RetentionWidget.prototype.setEmpty_=function(t){this.clearChart_(),this.contentContainer_.addClass("no-display").html(t||sensorsdata.languages.get("没有查询到数据<!--{en}No data-->"))},sensorsdata.RetentionWidget.prototype.setTitle_=function(t){var e="";if(t.by_field){var n=sensorsdata.findProperty(t.by_field,this.propObj_);n&&n.cname&&(e+=sensorsdata.util.format(sensorsdata.languages.get("按 #{cname} 分组<!--{en}Group by #{name}-->"),n))}var s=t.extend_over_end_date===!1;this.configContainer_.find("span.date-limit").tooltip("destroy"),this.configContainer_.html(Mustache.render($("#tpl-retention-widget-config").html(),e)),this.configContainer_.find("span.date-limit").toggleClass("active",s).tooltip({title:sensorsdata.languages.get(t.extend_over_end_date===!1?"后续事件被限制在查询时间区间内<!--{en}Subsequent events are limited to the query time range-->":"后续事件被延展到查询时间区间外<!--{en}Subsequent events are extended out of the query time range-->"),placement:"left",container:"body"})},sensorsdata.RetentionWidget.prototype.getRetentions_=function(t){var e=$.Deferred().resolve();if(!$.isEmptyObject(t.by_field)){var n=t.by_field.split("."),s=2===n.length?t.first_event.event_name:n[1];e=sensorsdata.ajax({useCache:!0,url:"event/"+s+"/properties",success:sensorsdata.bind(function(t){!$.isEmptyObject(t)&&$.isArray(t.event)&&$.isArray(t.user)?this.propObj_=t:this.setEmpty_(sensorsdata.languages.get("查询数据异常，请稍后刷新重试。<!--{en}Query data is abnormal, please try again later.-->"))},this)})}var a="retentions/report?bookmarkId="+this.bookmark_.id;e.then(sensorsdata.bind(function(){t.ignore_cache_expire=!0,sensorsdata.reportAjax({queueEnable:!0,queueKey:"POST"+a+"-"+this.bookmark_.id,url:a,method:"POST",data:t,contentType:"application/json",customErrorStatusCode:422,error:sensorsdata.bind(function(t){var e=sensorsdata.buildAjaxError(t.status,t.responseJSON);this.setEmpty_(e),this.retentions_={}},this),success:sensorsdata.bind(function(e){if(this.dataAlready_=!0,this.setTitle_(t),$.isArray(e.rows)&&e.rows.length>0){var n=sensorsdata.findProperty(t.by_field,this.propObj_);this.retentions_=this.padRetentions(e,this.paramObj_,n)}else this.retentions_={};this.renderAllow_&&this.renderContent_()},this)})},this))},sensorsdata.RetentionWidget.prototype.renderContent_=function(){return $.isEmptyObject(this.retentions_)?void this.setEmpty_():(this.clearChart_(),this.contentContainer_.removeClass("no-display").html(this.tplContent_),this.renderToolbar_(),this.renderKeyInfo_(),void this.renderChart_())},sensorsdata.RetentionWidget.prototype.renderToolbar_=function(t){var e=this.retentions_.rows[0].cells.length;(!$.isNumeric(t)||0>t||t>=e)&&(t=this.defaultIndex_);var n=this.paramObj_,s=this.getDuration(n.duration,n.unit),a="";a=0===t?sensorsdata.languages.get("当<!--{en}When-->")+s.unitCname:sensorsdata.languages.get("第<!--{en}No.-->")+t+s.unitCname,this.contentContainer_.find("div#toolbar-container").html(Mustache.render(this.tplToolbar_,{text:a,leftDisabled:1===t,rightDisabled:t===e-1,rowIndex:t})).show()},sensorsdata.RetentionWidget.prototype.renderKeyInfo_=function(t,e){var n=this.contentContainer_.find("div#keyinfo-container");if($.isEmptyObject(this.retentions_))return void n.html("");var s=this.retentions_.rows[0].cells.length;(!$.isNumeric(t)||0>t)&&(t=this.defaultIndex_),t>=s&&(t=s-1),e=e||0,(0>e||e>=this.retentions_.rows.length)&&(e=0);var a=this.paramObj_,i=this.getDuration(a.duration,a.unit),o=this.retentions_.rows[e],r=sensorsdata.findEventCname(a.first_event.event_name),d=sensorsdata.findEventCname(a.second_event.event_name),h=o.total_people,l=o.cells[t].people,g=o.cells[t].percent,u=0===t?sensorsdata.languages.get("当<!--{en}When-->")+i.unitCname:sensorsdata.languages.get("第<!--{en}No.-->")+t+i.unitCname,c="";if(a.by_field)c=a.is_wastage?h+sensorsdata.languages.get(" 人进行了<!--{en} People did-->")+r+"，"+l+sensorsdata.languages.get(" 人在随后持续<!--{en}people and then continue-->")+t+i.unitCname+sensorsdata.languages.get("没有进行<!--{en}didn't do-->")+d:h+sensorsdata.languages.get("人进行了<!--{en}People did-->")+r+"，"+l+sensorsdata.languages.get("人在随后<!--{en}people then-->")+u+sensorsdata.languages.get("进行了<!--{en}did-->")+d;else{var _=sensorsdata.formatTime(sensorsdata.trimConstHtml(o.by_value),a.unit),p=moment(sensorsdata.trimConstHtml(o.by_value),sensorsdata.CONSTSET.dateFormat).add(t,a.unit),m=sensorsdata.formatTime(p,a.unit);c=a.is_wastage?h+sensorsdata.languages.get("人在<!--{en}People in-->")+_+sensorsdata.languages.get("进行了<!--{en}did-->")+r+"，"+l+sensorsdata.languages.get("人截至<!--{en}people by-->")+u+"("+m+")"+sensorsdata.languages.get("没有进行<!--{en}didn't do-->")+d:h+sensorsdata.languages.get("人在<!--{en}People in-->")+_+sensorsdata.languages.get("进行了<!--{en}did-->")+r+"，"+l+sensorsdata.languages.get("人在<!--{en}People in-->")+u+"("+m+")"+sensorsdata.languages.get("进行了<!--{en}did-->")+d}n.html(Mustache.render(this.tplKeyinfo_,{percent:g,tip:c}))},sensorsdata.RetentionWidget.prototype.renderChart_=function(t){this.clearChart_();var e=this,n=this.paramObj_;(!$.isNumeric(t)||0>t||t>=this.retentions_.rows[0].cells.length)&&(t=this.defaultIndex_);for(var s=this.getDuration(n.duration,n.unit),a=[],i=[],o=0,r=this.retentions_.rows.length;r>o;o++){var d=this.retentions_.rows[o];d.cells.length>t&&a.push(d.cells[t].percent),i.push(n.by_field?sensorsdata.trimConstHtml(d.by_value):sensorsdata.formatTime(d.by_value,n.unit))}var h=[];h.push({name:0===t?sensorsdata.languages.get("当<!--{en}When-->")+s.unitCname:sensorsdata.languages.get("第<!--{en}No.-->")+t+s.unitCname,type:"line",symbol:"circle",symbolSize:6,showAllSymbol:!0,data:a,lineStyle:{normal:{width:1.4}}});var l={dataZoom:{show:!1},tooltip:{trigger:"axis",axisPointer:{lineStyle:{width:1,color:"#aaa"}},backgroundColor:"rgba(50,50,50,0)",borderWidth:0,formatter:function(){return""}},grid:{bottom:0},legend:{show:!1},xAxis:{data:i},yAxis:{splitNumber:3,axisLabel:{formatter:function(t){return sensorsdata.formatNumber(t,!0)+"%"}}},series:h};this.chart_&&$.isFunction(this.chart_.dispose)&&(this.chart_.dispose(),this.chart_=null),this.chart_=echarts.init(this.contentContainer_.find("div.dashboard-widget-chart")[0]),this.chart_.on("mouseover",function(t){e.chart_.dispatchAction({type:"highlight",seriesIndex:t.seriesIndex})}),e.chart_.on("mouseout",function(t){e.chart_.dispatchAction({type:"downplay",seriesIndex:t.seriesIndex})}),e.chart_.on("showtip",function(n){e.renderKeyInfo_(t,n.dataIndex)}),l=$.extend(!0,{},sensorsdata.echarts.option,l),e.chart_.setOption(l)};