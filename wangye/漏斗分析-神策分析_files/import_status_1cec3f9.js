var trackManagerModel=require("components/model/trackManager");sensorsdata.ImportStatus=function(t){sensorsdata.BasePage.call(this),this.options=t,this.options.container=t.container||$("body"),this.pageName=window.location.pathname,this.tplImportStatus_=$("#status-container").html(),this.options.container.html(this.tplImportStatus_),this.overViewContainer_=this.options.container.find("#status-overview"),this.trackInfoContainer_=this.options.container.find("#track-info"),this.tplOverView_=$("#tpl_over_view").html(),this.errDetailContainer_=this.options.container.find("#err-detail"),this.titleBar=this.options.container.find("#event-title"),this.tplErrDetail_=$("#tpl_err_detail").html(),this.tplTrackInfo_=$("#tpl_track_info").html(),this.tplNoErrMsg_=$("#tpl_no_err_msg").html(),this.tplStatusTitle_=$("#tpl_status_title").html(),this.errData_=null,this.paramObj_={},this.init()},sensorsdata.inherits(sensorsdata.ImportStatus,sensorsdata.BasePage),sensorsdata.ImportStatus.prototype.init=function(){sensorsdata.ImportStatus.superClass_.init.call(this),this.paramObj_=sensorsdata.unparam(window.location.hash);var t=function(t,a){var e=-1;return"{PROFILE}"===t?sensorsdata.languages.get("用户属性<!--{en}User properties-->"):($.each(a,function(a,r){r.name===t&&(e=a)}),-1!==e?a[e].cname:"")},a=this;this.overViewContainer_.html(Mustache.render(this.tplOverView_,this.formatTotalData_(this.paramObj_))),this.trackInfoContainer_.html(Mustache.render(this.tplTrackInfo_,this.formatTrackInfoData_(this.paramObj_))),sensorsdata.disableReportAjaxCache(),this.getAllEvents_().then(function(){var e=t(a.paramObj_.event,a.allEvents_)||a.paramObj_.event;a.options.container.find("#event-title").html(Mustache.render(a.tplStatusTitle_,e)),trackManagerModel.queryErrorInfo(a.dealParam_(a.paramObj_),function(t){a.errData_=t,a.renderErrDetail_(a.formatData_(a.errData_)),a.initEvents_()})}),sensorsdata.enableReportAjaxCache(),this.options.closeLoading()},sensorsdata.ImportStatus.prototype.renderErrDetail_=function(t){t.length?(this.errDetailContainer_.html(Mustache.render(this.tplErrDetail_,t)),this.errDetailContainer_.find(".err-json").each(function(){var t={dom:$(this),imgCollapsed:"/res/img/Collapsed.gif",imgExpanded:"/res/img/Expanded.gif",isCollapsible:!1},a=new JsonFormater(t);a.doFormat($(this).html())})):this.errDetailContainer_.html(this.tplNoErrMsg_)},sensorsdata.ImportStatus.prototype.getAllEvents_=function(){return sensorsdata.reportAjax({url:"events/all?cache=false&invisible=true",success:sensorsdata.bind(function(t){this.allEvents_=t},this)})},sensorsdata.ImportStatus.prototype.initEvents_=function(){var t=this;this.options.container.find('[data-toggle="tooltip"]').tooltip(),this.options.container.find('[data-method="return-back"]').unbind("click.return").bind("click.return",function(){var a=sensorsdata.unparam(window.location.hash),e={from:a.from,to:a.to,page:a.page||0,platform:a.platform||"all",app_version:a.app_version||"all"};t.options.initPage("/track-manager/"+$.param(e))}),this.options.container.find("div.err-description > a").unbind("click.mannual").bind("click.mannual",function(t){t.preventDefault();var a=$(this).attr("href");window.open(a,"_blank")})},sensorsdata.ImportStatus.prototype.dealParam_=function(t){var a=$.extend(!0,{},t);return a.hasOwnProperty("total")&&delete a.total,a.hasOwnProperty("app_version")&&"all"===a.app_version&&delete a.app_version,a.hasOwnProperty("platform")&&"all"===a.platform&&delete a.platform,a.hasOwnProperty("page")&&delete a.page,delete a.lib_version,delete a.lib,a},sensorsdata.ImportStatus.prototype.formatData_=function(t){var a,e=[];for(a in t)if(t.hasOwnProperty(a)){var r={name:a,detail:t[a]};if(r.detail.example=[],r.detail.hasOwnProperty("sample")&&r.detail.sample.length)for(a=0;a<r.detail.sample.length;a++)r.detail.example.push({index:a+1,value:r.detail.sample[a],reason:r.detail.reason[a]});e.push(r)}return e},sensorsdata.ImportStatus.prototype.formatTotalData_=function(t){var a=moment(parseInt(t.from,10)).format(sensorsdata.CONSTSET.normalTimeFormat),e=moment(parseInt(t.to,10)).format(sensorsdata.CONSTSET.normalTimeFormat);return{from:a,to:e,total:t.total}},sensorsdata.ImportStatus.prototype.formatTrackInfoData_=function(t){var a=$.extend(!0,{},t),e=sensorsdata.CONSTSET.emptyStringByValue,r=t.lib_detail,n={};if(t.hasOwnProperty("lib_method"))switch(t.lib_method){case"code":r=r.split("##"),n={className:r[0]||e,funcName:r[1]||e,fileName:r[2]||e,lineNo:r[3]||e,isCode:!0,category:"code",categoryCName:sensorsdata.languages.get("代码埋点<!--{en}Code tracking-->")};break;case"tools":r=r.split("##"),n={type:r[0],path:r[1],isTools:!0,category:"tools",categoryCName:sensorsdata.languages.get("辅助工具<!--{en}Auxiliary tools-->")};break;case"vtrack":n={ID:r,isVtrack:!0,category:"vtrack",categoryCName:sensorsdata.languages.get("可视化埋点<!--{en}Visualized tracking-->")};break;case"Other":n={value:r,isOther:!0,category:"Other",categoryCName:sensorsdata.languages.get("其它方式<!--{en}Other way-->")};break;case"unknown":n={value:r,isUnknown:!0,category:"unknown",categoryCName:sensorsdata.languages.get("未知埋点方式<!--{en}Unknown tracking method-->")}}return a=$.extend(!0,{},a,n)},sensorsdata.ImportStatus.prototype.reload=function(){this.pageName===window.location.pathname&&this.init()},sensorsdata.ImportStatus.prototype.unload=function(){this.options.container.find('[data-toggle="tooltip"]').tooltip("destroy")};