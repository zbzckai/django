var trackManagerModel=require("components/model/trackManager"),reportLoading=require("components/reportLoading/reportLoading");sensorsdata.TrackManager=function(t){sensorsdata.BasePage.call(this),this.options=t,this.options.container=t.container||$("body"),this.pageName=window.location.pathname,this.tplTrackManager_=$("#data-manager-container").html(),this.tplDataSource_=$("#tpl_data_source").html(),this.tplVersionList_=$("#tpl_version_list").html(),this.options.container.html(this.tplTrackManager_),sensorsdata.cache.config.disable_vtrack===!0&&this.options.container.find('[data-method="vtrack-manager"]').hide(),this.options.container.find("#link-import-tool").attr("href","/accessories/data_checker?project="+(sensorsdata.cache.project.name||"default")),this.libMethods_={vtrack:"vtrack",code:"code",tools:"tools",Other:"Other"},this.sourceDict_={all:sensorsdata.languages.get("全部<!--{en}All-->"),Java:"Java",python:"Python",php:"PHP",Node:"Node",Ruby:"Ruby",Javascript:"Javascript",js:"Javascript",Android:"Android",iOS:"iOS",BatchImporter:"BatchImporter",FormatImporter:"FormatImporter",LogAgent:"LogAgent",HDFSImporter:"HDFSImporter",MiniProgram:sensorsdata.languages.get("小程序<!--{en}MiniProgram-->"),Other:"Other",unknown:sensorsdata.languages.get("未知<!--{en}Unknown-->")},this.defaultFilterConditions_={from:this.formatTime_(moment().add(5,"m").subtract(1,"hours"),!1),to:this.formatTime_(moment().add(5,"m"),!1),lib:"all",app_version:"all"},this.defaultPageItems=15,this.timePickerDefaultOptions={autoclose:!0,todayBtn:!0,minuteStep:5,language:sensorsdata.languages.get("zh-CN<!--{en}en-->"),todayHighlight:!0,startDate:this.formatTime_(moment().add(5,"m").subtract(7,"days"),!0),initialDate:this.formatTime_(moment().subtract(3,"days"),!0),endDate:this.formatTime_(moment().add(5,"m"),!0)},this.currentConditions_={},this.paramObj_={},this.tplTrackList_=$("#tpl_track_list").html(),this.tplImportStatus_=$("#tpl_import_status").html(),this.trackManagerContainer_=this.options.container.find("#data-manager"),this.importStatusContainer_=this.options.container.find("#manager-title"),this.conditionContainer=this.options.container.find("#conditions-selector-container"),this.dataSourceContainer_=this.options.container.find("#data-soure-container"),this.statusContainer=this.options.container.find("#track-status-container"),this.appVersionContainer_=this.options.container.find("#data-app-version-container"),this.dateTimeContainer_=this.options.container.find("#data-time-container"),this.trackListContainer_=this.options.container.find("#track-list-container"),this.vtrackManagerContainer_=this.options.container.find('[data-method="vtrack-manager"]'),this.dataStreamPage_=this.options.container.find('[data-method="data-stream"]'),this.reportLoading=new reportLoading({container:this.trackListContainer_,quickType:"",approx:""}),this.isInit=!0,this.trackListContainer_.html($("#tpl_init_msg").html()),this.tplNoResultMsg_=$("#tpl_no_result_msg").html(),this.disabledList=[],this.currentPage_=1,this.dataSet={detail:{}},this.init()},sensorsdata.inherits(sensorsdata.TrackManager,sensorsdata.BasePage),sensorsdata.TrackManager.prototype.init=function(){sensorsdata.TrackManager.superClass_.init.call(this),sensorsdata.setModuleByTheme(this.options.container);var t=this;this.vtrackManagerContainer_.unbind("click").bind("click",sensorsdata.bind(function(){this.options.initPage("/vtrack/")},this)),this.dataStreamPage_.unbind("click").bind("click",sensorsdata.bind(function(){this.options.initPage("/data-stream/")},this)),this.paramObj_=sensorsdata.unparam(window.location.hash),this.paramObj_.hasOwnProperty("page")&&this.paramObj_.page||(this.paramObj_.page=1),this.currentConditions_={lib:this.paramObj_.lib||this.defaultFilterConditions_.lib,app_version:this.paramObj_.app_version||this.defaultFilterConditions_.app_version,from:this.paramObj_.from||this.defaultFilterConditions_.from,to:this.paramObj_.to||this.defaultFilterConditions_.to},trackManagerModel.getDisabled(function(a){t.disabledList=a,trackManagerModel.getSourceCategory(function(a){t.renderConditionSelector_(a),t.initEvents_()})}),this.options.closeLoading()},sensorsdata.TrackManager.prototype.getDisabled_=function(){var t=this;return sensorsdata.ajax({url:"data_source/disabled",success:sensorsdata.bind(function(a){t.disabledList=a},this)})},sensorsdata.TrackManager.prototype.getAllEvents_=function(){return sensorsdata.reportAjax({url:"events/all?cache=false&invisible=true",success:sensorsdata.bind(function(t){this.allEvents_=t},this)})},sensorsdata.TrackManager.prototype.addDisabled_=function(t){return sensorsdata.ajax({url:"data_source/disabled",type:"post",data:JSON.stringify(t),success:sensorsdata.bind(function(){},this)})},sensorsdata.TrackManager.prototype.removeDisabled_=function(t){return sensorsdata.ajax({url:"data_source/disabled/"+t,type:"delete",success:sensorsdata.bind(function(){},this)})},sensorsdata.TrackManager.prototype.renderDatetimePicker_=function(){this.dateTimeContainer_.find("#from_time").val(this.formatTime_(moment(Math.floor(parseInt(this.currentConditions_.from,10))),!0)),this.dateTimeContainer_.find("#to_time").val(this.formatTime_(moment(parseInt(this.currentConditions_.to,10)),!0));var t=$.extend(!0,{},this.timePickerDefaultOptions,this.currentConditions_);this.options.container.find(".form-control").datetimepicker(t),this.options.container.find(".form-control").on("change",function(){$(this).datetimepicker("update"),$(this).trigger("changeDate")}),this.options.container.find(".form-control").on("mousedown",function(){var t=$(this).data("datetimepicker").picker.is(":visible");$(this).datetimepicker(t?"hide":"show")})},sensorsdata.TrackManager.prototype.initEvents_=function(){var t=this;this.conditionContainer.delegate("ul li","click.condition",function(){$(this).siblings().removeClass("active"),$(this).addClass("active")}),this.trackListContainer_.find('[data-toggle="collapse"]').unbind("click.title").bind("click.title",this.toggleCollapse_),t.trackListContainer_.find('[data-toggle="toggle-able"]').unbind("click.toggle").bind("click.toggle",function(){var a=this,e=$(a).attr("data-method");switch(e){case"enable":sensorsdata.popover({ele:$(a),placement:"left",container:t.trackListContainer_,showNow:!0,template:$("#pop_enable_tpl").html(),content:$("#pop_enable_content_tpl").html(),success:function(){var e=$(a).parents("tr:first"),i=e.attr("disable-id");t.removeDisabled_(i).then(function(){e.data("enable","false"),$(a).attr("data-method","disable"),$(a).html(sensorsdata.languages.get("已启用<!--{en}Activated-->")),$(a).popover("destroy"),sensorsdata.info.show(sensorsdata.languages.get("启用将在 1 分钟之后生效<!--{en}The activation will take effect in 1 minutes-->"))})}});break;case"disable":sensorsdata.popover({ele:$(a),placement:"left",container:t.trackListContainer_,showNow:!0,template:$("#pop_disable_tpl").html(),content:$("#pop_disable_content_tpl").html(),success:function(){var e=$(a).parents("tr:first"),i={event:e.data("event"),lib:e.data("lib"),lib_detail:e.attr("data-detail"),lib_version:e.attr("data-version"),app_version:e.attr("data-app-version"),lib_method:e.attr("data-lib-method")};t.addDisabled_(i).then(function(t){e.data("enable","true"),t&&t.id&&e.attr("disable-id",t.id),$(a).attr("data-method","enable"),$(a).html(sensorsdata.languages.get("已禁用<!--{en}Disabled-->")),$(a).popover("destroy"),sensorsdata.info.show(sensorsdata.languages.get("禁用将在 1 分钟之后生效<!--{en}The disable will take effect in 1 minutes-->"))})}})}}),this.options.container.find('[data-toggle="tooltip"]').tooltip({container:t.trackManagerContainer_,placement:"auto",html:!0}),this.options.container.find('[data-method="input-filter"]').unbind("input propertychange").bind("input propertychange",function(){var a=$(this).val().trim();if(a){if(t.dataSet&&!$.isEmptyObject(t.dataSet.detail)){var e=$.extend(!0,{},t.dataSet),i=(e.detail.payload||[]).filter(function(e){return-1!==e.event.toLowerCase().indexOf(a)||-1!==(sensorsdata.findEventCname(e.event,t.allEvents_)||"").indexOf(a)});e.detail.payload=i,t.renderTrackList_(e)}}else t.renderTrackList_(t.dataSet)}),this.trackListContainer_.find('[data-method="data-status"]').unbind("click.navi").bind("click.navi",function(){var a=$(this).parents("tr:first"),e=$.extend(!0,{},t.getFilterConditions_(),{lib_detail:a.attr("data-detail"),lib_version:a.attr("data-version"),event:a.attr("data-event"),lib:a.attr("data-lib"),app_version:a.attr("data-app-version"),lib_method:a.attr("data-lib-method"),total:{read:a.attr("data-read"),write:a.attr("data-write"),err:a.attr("data-err"),send:a.attr("data-send")}}),i=$.extend(!0,{},t.paramObj_,t.getFilterConditions_()),n=$.param(i);window.history.pushState(n,"","#"+n),t.options.initPage(window.location.pathname+"import-status/#"+$.param(e))}),this.trackListContainer_.find('[data-method="event-status"]').unbind("click.navi").bind("click.navi",function(){var a=$(this),e=t.getFilterConditions_();e=$.extend(!0,{},e,{event:a.attr("data-event"),total:{read:a.attr("data-read"),write:a.attr("data-write"),err:a.attr("data-err"),send:a.attr("data-send")}});var i=$.extend(!0,{},t.paramObj_,t.getFilterConditions_()),n=$.param(i);window.history.pushState(n,"","#"+n),t.options.initPage(window.location.pathname+"import-status/#"+$.param(e))}),this.dateTimeContainer_.find('[data-method="reset-current-time"]').unbind("click.reset").bind("click.reset",function(){var a=t.formatTime_(moment().add(5,"m").subtract(1,"hours"),!1),e=t.formatTime_(moment().add(5,"m"),!1);t.defaultFilterConditions_=$.extend(!0,{},t.defaultFilterConditions_,{from:a,to:e}),t.timePickerDefaultOptions=$.extend(!0,{},t.timePickerDefaultOptions,{startDate:t.formatTime_(moment().add(5,"m").subtract(7,"days"),!0),initialDate:t.formatTime_(moment().subtract(3,"days"),!0),endDate:t.formatTime_(moment().add(5,"m"),!0)}),t.currentConditions_=$.extend(!0,{},t.currentConditions_,{from:a,to:e}),t.paramObj_=$.extend(!0,{},t.paramObj_,t.currentConditions_),t.dateTimeContainer_.find("#from_time").val(t.formatTime_(a,!0)).datetimepicker("update"),t.dateTimeContainer_.find("#to_time").val(t.formatTime_(e,!0)).datetimepicker("update")}),this.conditionContainer.find("button#query-submit").off("click.query").on("click.query",function(){var a=t.getFilterConditions_();t.options.container.find('[data-method="input-filter"]').val(""),t.reportLoading.showLoading(),t.currentConditions_=a,t.paramObj_=$.extend(!0,{},t.paramObj_,t.currentConditions_);var e=$.extend(!0,{},t.paramObj_);delete e.from,delete e.to;var i=$.param(e);window.history.pushState("hash","","#"+i),trackManagerModel.queryReport(t.currentConditions_,function(a){t.dataSet=a,t.options.container.find('[data-method="input-filter"]').toggle(!$.isEmptyObject(a.detail)),t.renderTrackList_(a),t.reportLoading.closeLoading("success")}),sensorsdata.track("track_manager")})},sensorsdata.TrackManager.prototype.renderTrackList_=function(t,a){var e=this.formatListData_($.extend(!0,{},t)),i=a||1,n=sensorsdata.bind(function(t,a){t-=1;var i=t/this.defaultPageItems+1,n={from:e.from,to:e.to,payload:e.payload.slice(t,a),total:e.total};this.paramObj_=$.extend(!0,{},this.paramObj_,{page:i});var o=$.extend(!0,{},this.paramObj_);delete o.from,delete o.to;var r=$.param(o);window.history.pushState(r,"","#"+r),this.trackListContainer_.html(Mustache.render(this.tplTrackList_,n)),this.initEvents_()},this),o=null,r=null;e.hasOwnProperty("payload")&&e.payload.length<=this.defaultPageItems&&e.payload.length>0?(this.trackListContainer_.html(Mustache.render(this.tplTrackList_,e)),o=$.extend(!0,{},this.paramObj_),delete o.from,delete o.to,r=$.param(o),window.history.pushState(r,"","#"+r),this.options.container.find("#result-pagination").hide(),this.initEvents_()):e.hasOwnProperty("payload")&&e.payload.length>this.defaultPageItems?sensorsdata.pagination({paginationElement:this.options.container.find("#result-pagination").show(),tableElement:this.options.container.find("#result-pagination").show(),totalItems:e.payload.length,pageItems:this.defaultPageItems,pageIndex:i,clickHandle:sensorsdata.bind(function(t){n(t.range[0],t.range[1])},this)}):(o=$.extend(!0,{},this.paramObj_),delete o.from,delete o.to,r=$.param(o),window.history.pushState(r,"","#"+r),this.trackListContainer_.html(this.tplNoResultMsg_),this.options.container.find("#result-pagination").hide()),this.importStatusContainer_.html(Mustache.render(this.tplImportStatus_,t))},sensorsdata.TrackManager.prototype.renderConditionSelector_=function(t){var a=function(t,a){for(var e=0;e<a.length;e++)if(a[e].name===t)return!0;return!1};this.dataSourceContainer_.html(Mustache.render(this.tplDataSource_,t.lib)),this.appVersionContainer_.html(Mustache.render(this.tplVersionList_,t.app_version)),a(this.currentConditions_.lib,t.lib)||(this.currentConditions_.lib="all"),this.dataSourceContainer_.find('[data-source="'+this.currentConditions_.lib+'"]').addClass("active"),a(this.currentConditions_.app_version,t.app_version)||(this.currentConditions_.app_version="all"),this.appVersionContainer_.find('[data-version="'+this.currentConditions_.app_version+'"]').addClass("active"),this.renderDatetimePicker_()},sensorsdata.TrackManager.prototype.toggleCollapse_=function(t){var a=t.target||t.srcElement||t,e=$(a);e.attr("data-toggle")||(e=e.parents("[data-toggle]:first"));var i=e.find("span.panel-title span.icon"),n=e.find('span[role="button"]'),o=e.next();"false"===n.attr("aria-expanded")&&n.hasClass("collapsed")?(n.attr("aria-expanded","true"),n.removeClass("collapsed"),o.css("height","auto"),o.fadeIn(),e.parent().addClass("collapsed")):(n.attr("aria-expanded","false"),n.addClass("collapsed"),o.fadeOut(),e.parent().removeClass("collapsed")),i.attr("class","icon-expand-down-single icon"===i.attr("class")?"icon-collapse-up-single icon":"icon-expand-down-single icon")},sensorsdata.TrackManager.prototype.getFilterConditions_=function(){var t=this.dataSourceContainer_.find("li.active").data("source"),a=this.formatTime_(moment(this.dateTimeContainer_.find("#from_time").val()),!1),e=this.formatTime_(moment(this.dateTimeContainer_.find("#to_time").val()),!1),i=this.appVersionContainer_.find("li.active").data("version")+"",n=this.statusContainer.find("li.active").data("status");return{lib:t,from:a,to:e,app_version:i,status:n}},sensorsdata.TrackManager.prototype.formatListData_=function(t){var a=t.detail||{},e={payload:this.formatByType_(a)||[],from:this.formatTime_(this.currentConditions_.from,!0),to:this.formatTime_(this.currentConditions_.to,!0),total:{read:a.read,send:a.send,write:a.write,err:a.err}};return e},sensorsdata.TrackManager.prototype.formatByType_=function(t){var a=this,e=function(t,e){for(var i=0;i<a.disabledList.length;i++){var n=a.disabledList[i];if(t===n.event&&e.lib===n.lib&&e.lib_detail===n.lib_detail){if(!(n.hasOwnProperty("lib_method")&&n.hasOwnProperty("lib_version")&&n.hasOwnProperty("app_version")))return n;if(n.lib_method===e.lib_method&&n.lib_version===e.lib_version&&n.app_version===e.app_version)return n}}return null},i=t.payload||[];i=$.map(i,function(t){for(var i={},n=0;n<t.payload.length;n++){t.payload[n].libDisplayName=a.sourceDict_[t.payload[n].lib];var o=t.payload[n].lib_detail,r={},s=sensorsdata.CONSTSET.emptyStringByValue;switch(t.payload[n].lib_method){case"code":o=o.split("##"),r={className:o[0]||s,funcName:o[1]||s,fileName:o[2]||s,lineNo:o[3]||s,isCode:!0,category:"code",categoryCName:sensorsdata.languages.get("代码埋点<!--{en}Code tracking-->")};break;case"tools":o=o.split("##"),r={type:o[0],path:o[1],isTools:!0,category:"tools",categoryCName:sensorsdata.languages.get("辅助工具<!--{en}Assistant tool-->")};break;case"vtrack":r={ID:o,isVtrack:!0,category:"vtrack",categoryCName:sensorsdata.languages.get("可视化埋点<!--{en}Visualized tracking-->")};break;case"Other":r={value:o,isOther:!0,category:"Other",categoryCName:sensorsdata.languages.get("其它方式<!--{en}Other methods-->")};break;case"unknown":r={value:o,isUnknown:!0,category:"unknown",categoryCName:sensorsdata.languages.get("未知埋点方式<!--{en}Unknown tracking method-->")}}var d=e(t.event,t.payload[n]);r=d?$.extend(!0,{},r,{id:d.id,isDisable:!0}):$.extend(!0,{},r,{isDisable:!1}),t.payload[n]=$.extend(!0,{},t.payload[n],r),i.hasOwnProperty(r.category)?i[r.category].payload.push(t.payload[n]):(i[r.category]={desc:r.categoryCName,isCode:r.isCode||!1,isOther:r.isOther||!1,isVtrack:r.isVtrack||!1,isUnknown:r.isUnknown,isTools:r.isTools||!1,hasErrors:!1,payload:[]},i[r.category].payload.push(t.payload[n])),i[r.category].hasErrors=i[r.category].hasErrors||!!t.payload[n].err}t.payload=[];for(n in i)i.hasOwnProperty(n)&&t.payload.push(i[n]);var l=null;return l="{PROFILE}"===t.event?sensorsdata.languages.get("用户属性<!--{en}User properties-->"):sensorsdata.findEventCname(t.event,a.allEvents_)||t.event,t=$.extend(!0,{},t,{cname:l,isProfile:"{PROFILE}"===t.event})});for(var n=0;n<i.length;n++)if("{PROFILE}"===i[n].event){var o=$.extend(!0,{},i[n]);i[n]=i[0],i[0]=o}return i},sensorsdata.TrackManager.prototype.formatTime_=function(t,a){var e=3e5*Math.floor(t.valueOf()/3e5);return a?moment(e).format(sensorsdata.CONSTSET.normalTimeFormat):e},sensorsdata.TrackManager.prototype.dealParam_=function(t){var a=this.defaultFilterConditions_.from,e=this.defaultFilterConditions_.to;return t={from:t.from||a,to:t.to||e,app_version:t.app_version||this.defaultFilterConditions_.app_version,lib:t.lib||this.defaultFilterConditions_.lib},t.from>t.to&&(t.to=t.from),t},sensorsdata.TrackManager.prototype.unload=function(){this.trackListJqXHR&&$.isFunction(this.trackListJqXHR.abort)&&(this.trackListJqXHR.abort(),this.trackListJqXHR=null),this.options.container.find('[data-toggle="tooltip"]').tooltip("destroy")},sensorsdata.TrackManager.prototype.reload=function(){window.location.pathname===this.pageName&&this.init()};