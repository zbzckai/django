sensorsdata.EventsManage=function(e){this.para=e,this.para.container.html($("#tpl_events_manage").html()),this.eleContainerMeta=$("#events_manage_meta"),this.eleContainerVirtual=$("#events_manage_virtual"),this.eleContainerUserPro=$("#user_profile"),this.eleContainerEventPro=$("#event_profile"),this.eleContainerSession=$("#session_create"),this.eleMetaFloat=$("#events-meta-floatlayer"),this.eleVirtualFloat=$("#events-virtual-floatlayer"),this.eleSessionFloat=$("#session_floatlayer"),this.eleTabs=$("#events_manage_tabs"),this.dataSelectedIndex=null,this.dataSelectedTr=null,this.dataAjaxEvents=null,this.dataMetaEvents=null,this.dataVirtualEvents=null,this.dataUserProfiles=null,this.dataEventProfiles=null,this.dataSessions=null,this.dataFilterMetaEvents=null,this.dataFilterVirtualEvents=null,this.dataFilterUserProfiles=null,this.dataFilterEventProfiles=null,this.dataFilterSessions=null,this.eleEventsMetaBtn=$("#events_meta_head_checkbox"),this.initData(this.para.events),this.eleMetaTableContainer=this.eleContainerMeta.find(".events-meta-table"),this.eleVirtualTableContainer=this.eleContainerVirtual.find(".events-virtual-table"),this.tplMetaTable=$("#tpl_events_manage_meta_table").html(),this.tplVirtualTable=$("#tpl_events_manage_virtual_table").html(),this.tplVirtualFloat=$("#tpl_events_virtual_edit").html(),this.tplMetaFloat=$("#tpl_events_meta_edit").html(),this.tplUserShowTable_=$("#tpl_user_profile_table").html(),this.tplEventShowTable_=$("#tpl_event_profile_table").html(),this.userShowTable_=this.eleContainerUserPro.find("#user_profile_table"),this.userEditBtn_=this.eleContainerUserPro.find("#editBtn"),this.userEditOk_=this.eleContainerUserPro.find("#user_profile_save"),this.userEditCancel_=this.eleContainerUserPro.find("#user_profile_cancel"),this.userShowAll_=this.eleContainerUserPro.find("#user_profile_head_checkbox"),this.userModal_=$("#user_profile_uploadDictory"),this.eventShowTable_=this.eleContainerEventPro.find("#event_profile_table"),this.eventEditBtn_=this.eleContainerEventPro.find("#event_profile_edit_btn"),this.eventCheckBtn_=this.eleContainerEventPro.find("#event_profile_head_checkbox"),this.eventEditCancel_=this.eleContainerEventPro.find("#event_profile_cancel"),this.eventEditOk_=this.eleContainerEventPro.find("#event_profile_save"),this.eventModal_=$("#event_profile_uploadDictory"),this.eleSessionTable_=this.eleContainerSession.find("#session_table"),this.tplSession_=$("#tpl_session").html(),this.tplSessionTable_=$("#tpl_session_table").html(),this.visualTrackingManager=null,this.allEvents_=[],this.sessions_=null,this.tpl_meta_tag_create=$("#tpl_meta_tag_create").html(),this.tpl_meta_tag_select=$("#tpl_meta_tag_select").html(),this.init(),sensorsdata.languages.update()},sensorsdata.EventsManage.prototype={constructor:sensorsdata.EventsManage,initData:function(e){this.dataAjaxEvents=e;var t=this.dataAjaxEvents.slice(0);this.dataMetaEvents=$.grep(t,function(e){return!e.virtual})},refreshAllEvents:function(){return sensorsdata.ajax({url:"events/all",data:{cache:!1,invisible:!0}})},showSuggestView:function(e){function t(t){return-1!==t.cname.indexOf(e)||-1!==t.name.indexOf(e)}"meta"===this.dataHash.type&&(this.dataFilterMetaEvents=$.grep(this.dataMetaEvents,function(e){return t(e)}),this.showMetaEvents({glist:this.dataFilterMetaEvents})),"virtual"===this.dataHash.type&&(this.dataFilterVirtualEvents=$.grep(this.dataVirtualEvents,function(e){return t(e)}),this.showVirtualEvents({glist:this.dataFilterVirtualEvents})),"user_profile"===this.dataHash.type&&(this.dataFilterUserProfiles=$.grep(this.dataUserProfiles,function(e){return t(e)}),this.showUserProfiles(!0,{glist:this.dataFilterUserProfiles})),"event_profile"===this.dataHash.type&&(this.dataFilterEventProfiles=$.grep(this.dataEventProfiles,function(e){return t(e)}),this.showEventProfiles(!0,{glist:this.dataFilterEventProfiles})),"session_create"===this.dataHash.type&&(this.dataFilterSessions=$.grep(this.dataSessions,function(e){return t(e)}),this.showAllSession({slist:this.dataFilterSessions}))},metaTableSort:function(e){var t=e.attr("data-sort"),a=e.attr("data-flag").split("-"),s="data_sort_"+a[1],n=a[0],i=null,o={};""===t||"ascend"===t?(i=sensorsdata.seniorSort(this.dataFilterMetaEvents?this.dataFilterMetaEvents:this.dataMetaEvents,n),o[s]="descend"):"descend"===t&&(i=sensorsdata.seniorSort(this.dataFilterMetaEvents?this.dataFilterMetaEvents:this.dataMetaEvents,n).reverse(),o[s]="ascend"),o.glist=i,this.showMetaEvents(o)},showMetaEvents:function(e){var t=this;e?t.showMetaEventsContent(e):this.refreshAllEvents().then(function(e){t.para.events=e.filter(function(e){return e.visible===!0}),t.initData(e),sensorsdata.ajax({url:"tag",success:function(e){t.dataMetaEvents.map(function(t){t.tag=(t.tag||[]).map(function(t){return e.filter(function(e){return e.id===t})[0]})}),t.showMetaEventsContent({glist:t.dataMetaEvents})}})})},showMetaEventsContent:function(e){var t=$("#events_meta_table_none_state");this.eleMetaTableContainer.html(""),$.isArray(e.glist)&&0===e.glist.length?t.show():t.hide(),e.visible_fix=function(){return sensorsdata.languages.get(this.visible?"可见<!--{en}Visible-->":"隐藏<!--{en}Invisible-->")},$("#events_meta_head_checkbox").is(":checked")||(e.glist=$.grep(e.glist,function(e){return e.visible}));var a=Mustache.render(this.tplMetaTable,e);this.eleMetaTableContainer.html(a),$("#events_meta_total_events").html(e.glist.length),sensorsdata.languages.update()},metaFloatLayer:null,showMetaFloat:function(){this.floatMode="event";var e=this,t={title:sensorsdata.languages.get("编辑事件属性<!--{en}Edit event properties-->"),mode:"event",prop_notice:sensorsdata.languages.get("编辑事件和属性的显示名称，以便提供更好的报表展示。如需修改追踪的数据内容，请联系开发人员<!--{en}Edit the event and the display name of the property,  for the better presentation of reports. If you want to modify the content of the tracking data, please contact with the developer.-->")},a=$.grep(this.dataMetaEvents,function(t){return String(t.id)===e.dataSelectedIndex})[0];e.metaFloatLayer=new sensorsdata.floatLayerRight({ele:e.eleMetaFloat,width:800}),e.metaFloatLayer.showView(),sensorsdata.ajax({url:"tag",success:function(s){e.getPropertiesByEvent(a.id).then(function(n){var i=sensorsdata.setCommonProperty(n),o=e.getDefaultAndCustomProperties(i.event);o.is_meta_float=!0,o.event_name=a.name,o.event_cname=a.cname,o.event_visible=a.visible,o.hasNumberColumn=$.grep(o.customProp,function(e){return"number"===e.data_type}).length>0,o.unit_fix=function(){return"number"===this.data_type?this.unit?this.unit:" ":!1},$.extend(o,t),s=$.extend(!0,[],s),a.tag.map(function(e){s.filter(function(t){return t.id===e.id})[0].checked=!0}),o.tags=s,e.eleMetaFloat.html(Mustache.render(e.tplMetaFloat,o)),sensorsdata.authority.isAdmin||e.eleMetaFloat.find("button,input").prop("disabled",!0),sensorsdata.languages.update()})}})},getCheckedInput:function(e,t){return e=$.trim(e),""===e?t:e.slice(0,100)},saveMetaFloat:function(){var e=[],t=this,a=$.grep(this.dataMetaEvents,function(e){return String(e.id)===t.dataSelectedIndex})[0];$("#event_meta_float_table tbody tr").each(function(a,s){var n=$(s).find(".meta-event-float-cname"),i=n.val();i=t.getCheckedInput(i,n.attr("data-default")),e.push({unit:$(s).find(".meta-event-float-unit").val(),cname:i,property_id:n.attr("data-id"),is_in_use:!$(s).find(".checkbox").is(":checked")})});var s=[];t.eleMetaFloat.find("#tag-list :checked").map(function(e,t){s.push(parseInt($(t).attr("data-id"),10))});var n=$("#events_meta_float_event_cname").val();n=this.getCheckedInput(n,$("#events_meta_float_event_cname").attr("data-default"));var i=!$("#events_meta_float_event_visible").is(":checked"),o=$("#events_meta_float_event_cname").attr("data-default")===n,r=$("#events_meta_float_event_visible").attr("data-default")===String(i),l=$("#tag-list").children().size()>1,d={visible:i,event_id:a.id,cname:n,property:e,tag:s},u={success:!0};sensorsdata.ajax({url:"event/"+d.event_id+"/meta",data:JSON.stringify(d),type:"post",error:function(e){u.success=!1,u.fail_reason=e.status,sensorsdata.track("edit_event_meta",u)},success:function(){sensorsdata.track("edit_event_meta",u),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},t.metaFloatLayer.hideView(),o&&r&&!l||(t.eleContainerMeta.find("#events_meta_filter_input").val(""),t.showMetaEvents())}})},virtualTableSort:function(e){var t=e.attr("data-sort"),a=e.attr("data-flag").split("-"),s="data_sort_"+a[1],n=a[0],i=null,o={};""===t||"ascend"===t?(i=sensorsdata.seniorSort(this.dataFilterVirtualEvents?this.dataFilterVirtualEvents:this.dataVirtualEvents,n),o[s]="descend"):"descend"===t&&(i=sensorsdata.seniorSort(this.dataFilterVirtualEvents?this.dataFilterVirtualEvents:this.dataVirtualEvents,n).reverse(),o[s]="ascend"),o.glist=i,this.showVirtualEvents(o)},getVirtualProps:function(){return sensorsdata.ajax({url:"events/virtual"})},getVirtualDesc:function(e){var t=[],a=this;return $.isArray(e)&&e.length>0?($.each(e,function(e,s){var n=a.dataAjaxEvents.filter(function(e){return e.name===s.event_name})[0];n&&t.push(n.cname)}),t.join(",")):""},getUserProfiles:function(){return sensorsdata.ajax({url:"property/user/properties",data:{show_all:!0,cache:!1}})},showUserProfiles:function(e,t){var a=this;t?a.showUserProfilesContent(e,t):this.getUserProfiles().then(function(t){a.dataUserProfiles=t,a.showUserProfilesContent(e,a.dataUserProfiles)})},showUserProfilesContent:function(e,t){var a=this,s=$("#user_profile_table_none_state"),n=$("#user_profile_head_checkbox").is(":checked");"object"!=typeof t||t.glist||(t.glist=t);var i={},o="",r="";if(t.glist?(i=t.glist,o=t.data_sort_0,r=t.data_sort_1):i=t,n||(i=i.filter(function(e){return e.is_in_use})),$.isArray(i)&&0===i.length)return s.show(),this.userShowTable_.hide(),void $("#user_profile_total").html(0);s.hide(),this.userShowTable_.show();var l=e;$("#user_profile_save").is(":visible")&&(o||r)&&(l=!1),i=i.map(function(t){return{id:t.id,name:t.name,cname:t.cname,display:l,edit:e,isDictory:sensorsdata.languages.get(t.has_dict?"有<!--{en}has-->":"无<!--{en}none-->"),enabled:"string"===t.data_type||"number"===t.data_type,isShow:sensorsdata.languages.get(t.is_in_use?"显示<!--{en}Visible-->":"隐藏<!--{en}Invisible-->"),dataValue:t.is_in_use,isPreset:sensorsdata.languages.get(0===t.name.indexOf("$")?"是<!--{en}Yes-->":"否<!--{en}No-->"),type:sensorsdata.CONSTSET.engTypeToChs[t.data_type],"delete":t.has_dict,download:t.has_dict}});var d={glist:i,data_sort_0:o,data_sort_1:r};a.renderUserPage(e,d),$("#user_profile_total").html(i.length)},renderUserPage:function(e,t){var a=10,s=this,n=t,i=t.glist,o=sensorsdata.bind(function(e,t){e-=1;var a=i.slice(e,t),o=Mustache.render(s.tplUserShowTable_,{glist:a,data_sort_0:n.data_sort_0,data_sort_1:n.data_sort_1});s.userShowTable_.html(o).find("button").prop("disabled",!sensorsdata.authority.isAdmin),sensorsdata.languages.update()},this);0===i.length?(s.eleContainerUserPro.html(""),s.eleContainerUserPro.find("#table-pagination").html("").hide()):i.length<=a?(s.eleContainerUserPro.find("#table-pagination").html("").hide(),o(1,i.length)):sensorsdata.pagination({tableElement:s.eleContainerUserPro.find("#table-pagination").show(),totalItems:i.length,pageItems:10,clickHandle:sensorsdata.bind(function(e){o(e.range[0],e.range[1])},this)}),sensorsdata.languages.update()},userTableSort:function(e){var t=e.attr("data-sort"),a=e.attr("data-flag").split("-"),s="data_sort_"+a[1],n=a[0],i=null,o={};""===t||"ascend"===t?(i=sensorsdata.seniorSort(this.dataFilterUserProfiles?this.dataFilterUserProfiles:this.dataUserProfiles,n),o[s]="descend"):"descend"===t&&(i=sensorsdata.seniorSort(this.dataFilterUserProfiles?this.dataFilterUserProfiles:this.dataUserProfiles,n).reverse(),o[s]="ascend"),o.glist=i,this.showUserProfiles(!0,o)},saveUserProfile:function(){var e=[],t=this;$("#user_profile_table tbody tr").each(function(a,s){var n=$(s).find(".cname").val();n=t.getCheckedInput(n,$(s).find(".cname").attr("data-default")),e.push({cname:n,property_id:$(s).attr("data-index"),is_in_use:"true"===$(s).find("td.visible-edit span[data-value]").attr("data-value")})});var a={property:e},s={success:!0};sensorsdata.ajax({url:"property/user/properties",data:JSON.stringify(a),type:"post",error:function(e){s.success=!1,s.fail_reason=e.status,sensorsdata.track("edit_user_profile",s)},success:function(){sensorsdata.track("edit_user_profile",s),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},sensorsdata.info.show(sensorsdata.languages.get("保存成功<!--{en}Saved successfully-->")),t.showUserProfiles(!0)}})},getEventProfiles:function(){return sensorsdata.ajax({url:"property/all"})},showEventProfiles:function(e,t){var a=this;t?a.showEventProfileContent(e,t):this.getEventProfiles().then(function(t){a.dataEventProfiles=t,a.showEventProfileContent(e,a.dataEventProfiles)})},showEventProfileContent:function(e,t){var a=this,s=$("#event_profile_table_none_state"),n=$("#event_profile_head_checkbox").is(":checked");"object"!=typeof t||t.glist||(t.glist=t);var i={},o="",r="";if(t.glist?(i=t.glist,o=t.data_sort_0,r=t.data_sort_1):i=t,n||(i=i.filter(function(e){return e.is_in_use})),$.isArray(i)&&0===i.length)return s.show(),a.eventShowTable_.hide(),void $("#event_profile_total").html(0);s.hide(),a.eventShowTable_.show();var l=e;$("#event_profile_save").is(":visible")&&(o||r)&&(l=!1),i=i.map(function(t){return{id:t.id,name:t.name,cname:t.cname,display:l,edit:e,isDictory:sensorsdata.languages.get(t.has_dict?"有<!--{en}has-->":"无<!--{en}none-->"),enabled:"string"===t.data_type||"number"===t.data_type,isShow:sensorsdata.languages.get(t.is_in_use?"显示<!--{en}Visible-->":"隐藏<!--{en}Invisible-->"),dataValue:t.is_in_use,isPreset:sensorsdata.languages.get(0===t.name.indexOf("$")?"是<!--{en}Yes-->":"否<!--{en}No-->"),type:sensorsdata.CONSTSET.engTypeToChs[t.data_type],unit:t.unit,"delete":t.has_dict,download:t.has_dict,isUnit:"number"===t.data_type}});var d={glist:i,data_sort_0:o,data_sort_1:r};a.renderEventPage(e,d),$("#event_profile_total").html(i.length)},renderEventPage:function(e,t){var a=10,s=this,n=t,i=t.glist,o=sensorsdata.bind(function(e,t){e-=1;var a=i.slice(e,t),o=Mustache.render(s.tplEventShowTable_,{glist:a,data_sort_0:n.data_sort_0,data_sort_1:n.data_sort_1});s.eventShowTable_.html(o).find("button").prop("disabled",!sensorsdata.authority.isAdmin),sensorsdata.languages.update()},this);0===i.length?(s.eleContainerEventPro.html(""),s.eleContainerEventPro.find("#event-table-pagination").html("").hide()):i.length<=a?(s.eleContainerEventPro.find("#event-table-pagination").html("").hide(),o(1,i.length)):sensorsdata.pagination({tableElement:s.eleContainerEventPro.find("#event-table-pagination").show(),totalItems:i.length,pageItems:10,clickHandle:sensorsdata.bind(function(e){o(e.range[0],e.range[1])},this)}),sensorsdata.languages.update()},eventTableSort:function(e){var t=e.attr("data-sort"),a=e.attr("data-flag").split("-"),s="data_sort_"+a[1],n=a[0],i=null,o={};""===t||"ascend"===t?(i=sensorsdata.seniorSort(this.dataFilterEventProfiles||this.dataEventProfiles,n),o[s]="descend"):"descend"===t&&(i=sensorsdata.seniorSort(this.dataFilterEventProfiles||this.dataEventProfiles,n).reverse(),o[s]="ascend"),o.glist=i,this.showEventProfiles(!0,o)},saveEventProfile:function(){var e=[],t=this;$("#event_profile_table tbody tr").each(function(a,s){var n=$(s).find(".cname").val();n=t.getCheckedInput(n,$(s).find(".cname").attr("data-default")),e.push({cname:n,property_id:$(s).attr("data-index"),is_in_use:"true"===$(s).find("td.visible-edit [data-value]").attr("data-value"),unit:$(s).find(".unit").val()})});var a={property:e},s={success:!0};sensorsdata.ajax({url:"property/meta",data:JSON.stringify(a),type:"post",error:function(e){s.success=!1,s.fail_reason=e.status,sensorsdata.track("edit_event_meta",s)},success:function(){sensorsdata.track("edit_event_meta",s),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},sensorsdata.info.show(sensorsdata.languages.get("保存成功<!--{en}Saved successfully-->")),t.showEventProfiles(!0)}})},showVirtualEvents:function(e){var t=this;e?t.showVirtualEventsContent(e):sensorsdata.ajax({url:"tag",success:function(e){t.getVirtualProps().then(function(a){a.map(function(t){t.tag=(t.tag||[]).map(function(t){return e.filter(function(e){return e.id===t})[0]})});var s=$("#events_virtual_table_none_state");t.eleVirtualTableContainer.html(""),t.dataVirtualEvents=a,a&&$.isArray(a)&&a.length>0?($.each(a,function(e,a){a.desc_fix=t.getVirtualDesc(a.virtual_define)}),t.showVirtualEventsContent({glist:a}),s.hide()):s.show()})}})},showVirtualEventsContent:function(e){var t=0;e.getIndex=function(){return t++};var a=Mustache.render(this.tplVirtualTable,e);this.eleVirtualTableContainer.html(a),$("#events_virtual_total_events").html(e.glist.length),sensorsdata.languages.update()},filterGroupEvents:null,addBookMarkIdToUrl:function(e){var t=e.data.indexOf("#"),a="",s={};return-1===t||t===e.data.length-1?a=e.data:(s=sensorsdata.unparam(e.data.substr(t+1)),a=e.data.substr(0,t+1)),s[sensorsdata.CONSTSET.bookmarkId]=e.id,s[sensorsdata.CONSTSET.bookmarkTime]=e.time,a+$.param(s)},showUndeleteDialog:function(e){if("object"!=typeof e)return!1;var t=this;sensorsdata.showFloatLayer({unCloseClass:["g-floatlayer"],onLoad:function(){var a=this,s={};s.rows=[],s.isUsed=!1,$.isArray(e.bookmark)&&e.bookmark.length>0&&$.each(e.bookmark,function(e,a){s.rows.push({name:a.name,link:t.addBookMarkIdToUrl(a),type:sensorsdata.languages.get("书签<!--{en}Bookmarks-->")})}),$.isArray(e.funnel)&&e.funnel.length>0&&$.each(e.funnel,function(e,t){s.rows.push({name:t.name,link:"/funnel/#funnel_id="+t.id,type:sensorsdata.languages.get("漏斗<!--{en}Funnel-->")})}),e.other_user_bookmark===!0&&(s.isUsed=!0),s.rowsHasValue=!0,0===s.rows.length&&(s.rowsHasValue=!1),$.isArray(e.session)&&e.session.length>0&&(s.hasSession=!0),s.session=e.session;var n=$("#tpl_popover_float_virtual_delete_confirm").html();n=$(Mustache.render(n,{glist:s})),n.css({left:$("#events_virtual_edit_remove").offset().left-110,top:$("#events_virtual_edit_remove").offset().top-250}),n.on("click",".pop-is-success",function(){a.hideView()}),$("body").append(n),this.floatLayer=n},onClose:function(){this.floatLayer.remove()}})},showVirtualFloat:function(e){var t={},a=this,s={};if("createVirtual"===this.floatMode)t.title=sensorsdata.languages.get("创建<!--{en}Create-->"),t.isCreate=!0,t.tags=e;else{if("editVirtual"!==this.floatMode)return!1;s=$.grep(this.dataVirtualEvents,function(e){return String(e.id)===a.dataSelectedIndex})[0],t.title=sensorsdata.languages.get("编辑<!--{en}Edit-->"),t.event_name=s.name,t.event_cname=s.cname,t.isEdit=!0,(s.tag||[]).map(function(t){e.filter(function(e){return e.id===t.id})[0].checked=!0}),t.tags=e}this.virtualFloatLayer=new sensorsdata.floatLayerRight({ele:a.eleVirtualFloat,width:800}),this.virtualFloatLayer.showView(),a.eleVirtualFloat.html(Mustache.render(a.tplVirtualFloat,t)),sensorsdata.authority.isAdmin||a.eleVirtualFloat.find("button,input").prop("disabled",!0),"createVirtual"===this.floatMode?(this.filterGroupEvents=new sensorsdata.FilterGroupEventList({type:"virtualEvents",container:$("#events_virtual_float_filter"),tpl:$("#tpl_filter_group_events_list").html(),events:this.dataMetaEvents.filter(function(e){return e.visible})}),this.filterGroupEvents.addFilterEvent()):"editVirtual"===this.floatMode&&(this.filterGroupEvents=new sensorsdata.FilterGroupEventList({type:"virtualEvents",container:$("#events_virtual_float_filter"),tpl:$("#tpl_filter_group_events_list").html(),disabled:!sensorsdata.authority.isAdmin,events:this.dataMetaEvents.filter(function(e){return e.visible})}),this.filterGroupEvents.setData(s.virtual_define),sensorsdata.popover({ele:$("#events_virtual_edit_remove"),footer:$("#tpl_popover_footer_state_3").html(),content:'确认删除这个虚拟事件吗？<div class="remark">本操作无法撤销</div>',successAfter:function(){var e={success:!0,operation_type:sensorsdata.languages.get("删除<!--{en}Delete-->")};sensorsdata.ajax({type:"delete",url:"event/virtual/"+s.id,async:!1,error:function(t){e.success=!1,e.fail_reason=t.status,sensorsdata.track("virtual_event_operation",e)},success:function(t){sensorsdata.track("virtual_event_operation",e),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},$.isEmptyObject(t)?(a.virtualFloatLayer.hideView(),a.showVirtualEvents()):a.showUndeleteDialog(t)}})}})),sensorsdata.languages.update()},saveVirtualFloat:function(){var e=this,t={},a=null,s={success:!0},n=$("#events_virtual_float_event_cname").val().slice(0,100);if(""===n)return sensorsdata.error.show(sensorsdata.languages.get("输入的虚拟事件的显示名不能为空<!--{en}Name/Display name of virtual event cannot be empty-->")),!1;var i={};i.virtual_define=this.filterGroupEvents.getData(),i.cname=n,i.tag=[],e.eleVirtualFloat.find("#tag-list :checked").map(function(e,t){i.tag.push(parseInt($(t).attr("data-id"),10))});var o=$("#events_virtual_float_event_cname").val();if(o=this.getCheckedInput(o,$("#events_virtual_float_event_cname").attr("data-default")),"createVirtual"===this.floatMode){if(a=$("#events_virtual_float_event_name").val(),!/^[a-zA-Z_$][a-zA-Z\d_$]*$/.test(a))return sensorsdata.error.show(sensorsdata.languages.get("虚拟事件名只能包含大小写字母数字或_ $，且第一个字符不能是数字<!--{en}Name of virtual event can only contain uppercase and lowercase letter，number or_$, and the first character cannot be number.-->")),!1;s.operation_type=sensorsdata.languages.get("新建<!--{en}New-->"),i.name=a,sensorsdata.ajax({url:"event/virtual",data:JSON.stringify(i),type:"post",error:function(e){s.success=!1,s.fail_reason=e.status,sensorsdata.track("virtual_event_operation",s)},success:function(){sensorsdata.track("virtual_event_operation",s),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},e.virtualFloatLayer.hideView(),e.showVirtualEvents()}})}"editVirtual"===this.floatMode&&(t=$.grep(this.dataVirtualEvents,function(t){return String(t.id)===e.dataSelectedIndex})[0],s.operation_type=sensorsdata.languages.get("编辑<!--{en}Edit-->"),sensorsdata.ajax({url:"event/virtual/"+t.id,data:JSON.stringify(i),type:"post",error:function(e){s.success=!1,s.fail_reason=e.status,sensorsdata.track("virtual_event_operation",s)},success:function(){sensorsdata.track("virtual_event_operation",s),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},e.virtualFloatLayer.hideView(),e.eleContainerVirtual.find("#events_virtual_filter_input").val(""),e.showVirtualEvents()}}))},getDefaultAndCustomProperties:function(e){var t={defaultProp:[],customProp:[]};return $.isArray(e)?($.each(e,function(e,a){a.data_type_fix=sensorsdata.CONSTSET.engTypeToChs[a.data_type],"$"===a.name.slice(0,1)?t.defaultProp.push(a):t.customProp.push(a)}),t):t},getPropertiesByEvent:function(e){return sensorsdata.ajax({url:"event/"+e+"/properties",data:{cache:!1,show_all:!0}})},saveProfileFloat:function(){var e=[],t=this;$("#event_meta_float_table .meta-event-float-cname").each(function(a,s){var n=$(s).val();n=t.getCheckedInput(n,$(s).attr("data-default")),e.push({cname:n,property_id:$(s).attr("data-id"),is_in_use:!$(s).parent().parent().find(".checkbox").is(":checked")})});var a={property:e};sensorsdata.ajax({url:"property/user/properties",data:JSON.stringify(a),contentType:"application/json",type:"post",success:function(){sensorsdata.cache.events=[],sensorsdata.cache.ajax={},t.sessionFloatLayer.hideView()}})},saveSessionFloat:function(){var e=this,t=this.eleSessionFloat,a=t.find("#session_float_event_name"),s=a.val(),n=t.find("#session_float_event_cname"),i=n.val(),o=t.find(".auth-grant-table-edit").data("selected-event"),r=t.find("#session_float_role"),l=r.val(),d=t.find("#role_span").attr("data-value");if(null===o)return void sensorsdata.error.show(sensorsdata.languages.get("请选择事件<!--{en}Select events-->"));if(sensorsdata.form.checkChildren(t,!0,1,{container:t})){"hour"===d?l=3600*l:"minute"===d&&(l=60*l);var u={name:s,cname:i,session_rule:{type:"INTERVAL",params:[l]},event_list:o},c={success:!0,session_interval:u.session_rule.params[0],is_all_events:u.event_list.length===sensorsdata.cache.events.length,operation_type:sensorsdata.languages.get("新建<!--New-->")};sensorsdata.ajax({url:"sessions/session",type:"post",error:function(e){c.success=!1,c.fail_reason=e.status,sensorsdata.track("session_operation",c)},data:JSON.stringify(u),success:function(){sensorsdata.track("session_operation",c),sensorsdata.info.show(sensorsdata.languages.get("Session 创建成功<!--{en}Session create successfully-->")),e.showAllSession(),e.sessionFloatLayer.hideView()}})}},saveEditSessionFloat:function(){var e=this,t=this.eleSessionFloat,a=t.find("#session_float_event_name").text(),s=t.find("#session_float_event_cname"),n=s.val(),i=t.find(".auth-grant-table-edit").data("selected-event"),o=t.find("#session_float_role_create"),r=o.val(),l=t.find("#role_span").attr("data-value"),d=t.find("#session_edit_remove").attr("data-value"),u=r;if(null===i)return void sensorsdata.error.show(sensorsdata.languages.get("请选择事件<!--{en}Please select events-->"));if(sensorsdata.form.checkChildren(t,!0,1,{container:t})){"hour"===l?r=3600*r:"minute"===l&&(r=60*r);var c={name:a,cname:n,session_rule:{type:"INTERVAL",params:[r]},event_list:i},h=[];this.eleSessionTable_.find('tr[data-index="'+d+'"] td').each(function(e,t){h.push($(t).text())}),l=sensorsdata.languages.get("hour"===l?"小时<!--{en}hour-->":"minute"===l?"分钟<!--{en}minutes-->":"秒<!--{en}seconds-->"),i=i.map(function(t){return sensorsdata.findProperty(t,[{event:e.para.events}]).cname});var f=-1!==h.indexOf(a)&&-1!==h.indexOf(n)&&-1!==h.indexOf(i.join(","))&&-1!==h.indexOf(u+l);if(f)e.sessionFloatLayer.hideView(),e.eleContainerSession.find("#session_filter_input").val("");else{var v={success:!0,session_interval:c.session_rule.params[0],is_all_events:c.event_list.length===sensorsdata.cache.events.length,operation_type:sensorsdata.languages.get("修改<!--{en}Edit-->")};sensorsdata.ajax({url:"sessions/session/"+d,type:"post",data:JSON.stringify(c),error:function(e){v.success=!1,v.fail_reason=e.status,sensorsdata.track("session_operation",v)},success:function(){sensorsdata.track("session_operation",v),e.sessionFloatLayer.hideView(),sensorsdata.info.show(sensorsdata.languages.get("Session 修改成功<!--{en}Session edit successfully-->")),e.eleContainerSession.find("#session_filter_input").val(""),e.showAllSession()}})}}},renderSessionEvents:function(e,t){e.eventDropdown("destroy").eventDropdown({multiple:!0,events:this.para.events,eventNames:t,multiselectOption:{includeSelectAllOption:!0,selectAllText:sensorsdata.languages.get("选择全部<!--{en}Select all-->"),nSelectedText:sensorsdata.languages.get("个<!--{en} items-->"),allSelectedText:sensorsdata.languages.get("选择全部<!--{en}Select all-->"),nonSelectedText:sensorsdata.languages.get("请选择<!--{en}Please select-->"),filterPlaceholder:sensorsdata.languages.get("搜索<!--{en}Search-->")}})},getRoleUnit:function(e){var t=e[0],a={};return a=t%3600===0?{unit:t/3600,unitText:sensorsdata.languages.get("小时<!--{en} hours-->"),unitTextT:"hour"}:t%60===0?{unit:t/60,unitText:sensorsdata.languages.get("分钟<!--{en} minutes-->"),unitTextT:"minute"}:{unit:e,unitText:sensorsdata.languages.get("秒<!--{en} seconds-->"),unitTextT:"second"}},renderSession:function(e,t,a){var s=this;t?this.getSession(a.id).then(function(t){var n=s.getRoleUnit(t.session_rule.params),i={id:a.id,title:a.title,isEdit:a.isEdit,session_name:t.name,session_cname:t.cname,unit:n.unit,unitText:n.unitText,unitTextT:n.unitTextT};s.eleSessionFloat.html(Mustache.render(s.tplSession_,i)),s.renderSessionEvents(e.find(".auth-grant-table-edit"),t.event_list),sensorsdata.authority.isAdmin||s.eleSessionFloat.find("button,input").prop("disabled",!0),sensorsdata.languages.update()}):(s.eleSessionFloat.html(Mustache.render(s.tplSession_,a)),s.renderSessionEvents(e.find(".auth-grant-table-edit"),[]),sensorsdata.languages.update())},getSession:function(e){return sensorsdata.ajax({url:"sessions/session/"+e,data:{cache:!1,invisible:!0}})},getAllSession:function(e){return sensorsdata.ajax({url:"sessions/all",success:function(t){e(t)}})},renderSessionPage:function(e){var t=sensorsdata.CONSTSET.paginationSize,a=this,s=e,n=e.slist,i=sensorsdata.bind(function(e,t){e-=1;var i=n.slice(e,t),o=Mustache.render(a.tplSessionTable_,{slist:i,data_sort_0:s.data_sort_0,data_sort_1:s.data_sort_1});a.eleSessionTable_.html(o),sensorsdata.languages.update()},this);0===n.length?a.eleContainerSession.find("#table-pagination-session").html("").hide():n.length<=t?(a.eleContainerSession.find("#table-pagination-session").html("").hide(),i(1,n.length)):sensorsdata.pagination({tableElement:a.eleContainerSession.find("#table-pagination-session").show(),totalItems:n.length,pageItems:10,clickHandle:sensorsdata.bind(function(e){i(e.range[0],e.range[1])},this)}),sensorsdata.languages.update()},showFloatSession:function(){var e={},t=this;if(this.sessionFloatLayer=new sensorsdata.floatLayerRight({ele:t.eleSessionFloat,width:800}),this.sessionFloatLayer.showView(),"createSession"===this.floatMode)e.title=sensorsdata.languages.get("创建<!--{en}Create-->"),e.isCreate=!0,t.renderSession(t.eleSessionFloat,!1,e);else{if("editSession"!==this.floatMode)return!1;e.title=sensorsdata.languages.get("编辑<!--{en}Edit-->"),e.id=t.dataSelectedIndex,e.isEdit=!0,t.renderSession(t.eleSessionFloat,!0,e)}},sessionSort:function(e){var t=e.attr("data-sort"),a=e.attr("data-flag").split("-"),s="data_sort_"+a[1],n=a[0],i=null,o={};""===t||"ascend"===t?(i=sensorsdata.seniorSort(this.dataFilterSessions?this.dataFilterSessions:this.dataSessions,n),o[s]="descend"):"descend"===t&&(i=sensorsdata.seniorSort(this.dataFilterSessions?this.dataFilterSessions:this.dataSessions,n).reverse(),o[s]="ascend"),o.slist=i,this.showAllSession(o)},showAllSession:function(e){var t=this;e?t.showAllSessionContent(e):this.getAllSession(function(e){t.dataSessions=e,t.showAllSessionContent(t.dataSessions)})},showAllSessionContent:function(e){var t=this,a=[],s={},n="",i="",o=this.eleContainerSession.find("#session_table_none_state");if($.isArray(e.slist)&&0===e.slist.length)return o.show(),this.eleSessionTable_.hide(),void $("#session_total").html(0);o.hide(),this.eleSessionTable_.show(),e.slist?(s=e.slist,n=e.data_sort_0,i=e.data_sort_1):s=e,s.forEach(function(e){var s=e,n={id:s.id,sname:s.name,scname:s.cname,sevents:[],unit:t.getRoleUnit(e.session_rule.params).unit,unitText:t.getRoleUnit(e.session_rule.params).unitText};e.event_list.forEach(function(e){n.sevents.push(sensorsdata.findEventCname(e,t.para.events))}),a.push(n)});var r={slist:a,data_sort_0:n,data_sort_1:i};t.renderSessionPage(r),t.eleContainerSession.find("#session_total").html(a.length),sensorsdata.languages.update()},checkToShow:function(e){this.dataHash=sensorsdata.unparam(location.hash);var t=e||this.dataHash.type;this.eleTabs.find("li.on").removeClass("on"),"meta"===t?(this.eleTabs.find('li[data-type="meta"]').addClass("on"),$(".events-manage-content").hide(0),$("#user_profile").hide(0),$("#event_profile").hide(0),$("#session_create").hide(0),$("#events_manage_meta").show(),this.showMetaEvents(),$("#events_meta_filter_input").val(""),this.dataFilterMetaEvents&&(this.dataFilterMetaEvents=null),this.initTagEvents_(this.eleContainerMeta.find(".meta-tag"),this.eleMetaTableContainer)):"virtual"===t?(this.eleTabs.find('li[data-type="virtual"]').addClass("on"),$(".events-manage-content").hide(0),$("#user_profile").hide(0),$("#event_profile").hide(0),$("#session_create").hide(0),$("#events_manage_virtual").show().find("button:first").prop("disabled",!sensorsdata.authority.isAdmin),this.showVirtualEvents(),$("#events_virtual_filter_input").val(""),this.dataFilterVirtualEvents&&(this.dataFilterVirtualEvents=null),this.initTagEvents_(this.eleContainerVirtual.find(".meta-tag"),this.eleVirtualTableContainer)):"user_profile"===t?(this.eleTabs.find('li[data-type="user_profile"]').addClass("on"),$(".events-manage-content").hide(0),$("#events_manage_virtual").hide(0),$("#event_profile").hide(0),$("#session_create").hide(0),$("#user_profile").show().find("button").prop("disabled",!sensorsdata.authority.isAdmin),this.showUserProfiles(!0),this.dataFilterUserProfiles&&(this.dataFilterUserProfiles=null),$("#user_profile_filter_input").val("")):"event_profile"===t?(this.eleTabs.find('li[data-type="event_profile"]').addClass("on"),$(".events-manage-content").hide(0),$("#events_manage_virtual").hide(0),$("#user_profile").hide(0),$("#session_create").hide(0),$("#event_profile").show().find("button").prop("disabled",!sensorsdata.authority.isAdmin),this.showEventProfiles(!0),this.dataFilterEventProfiles&&(this.dataFilterEventProfiles=null),$("#event_profile_filter_input").val("")):"session_create"===t&&(this.eleTabs.find('li[data-type="session_create"]').addClass("on"),$(".events-manage-content").hide(),$("#events_manage_virtual").hide(),$("#user_profile").hide(),$("#event_profile").hide(),$("#session_create").show().find("button").prop("disabled",!sensorsdata.authority.isAdmin),this.showAllSession(),this.dataFilterSessions&&(this.dataFilterSessions=null),$("#session_filter_input").val(""))
},initTagEvents_:function(e,t){var a=this,s=e.find('button[data-method="tagDropdown"]'),n=[],i=function(){var t=function(t){var n=s.find(".selected").text();if(n)for(var i=0,o=t.length;o>i;i++)t[i].checked=t[i].name===n;t=0===t.length?null:t,e.find("ul").html(Mustache.render(a.tpl_meta_tag_select,t)).show()};n.length>0?t(n):sensorsdata.ajax({url:"tag"}).done(function(e){n=e,t(n)})};a.para.container.find(".report-no-data.tag-no-data").hide(),e.find('[data-method="tagDropdown"] .selected').text(sensorsdata.languages.get("标签<!--{en}Tag-->")),e.find("li.tag-checked").removeClass("tag-checked"),e.off("click.event-tag").on("click.event-tag",function(s){var o=$(s.target||s.srcElement),r=e.find('[data-method="tagDropdown"]');o.attr("data-method")||(o=o.parents("[data-method]:first"));var l=o.attr("data-method"),d=e.find("ul").attr("data-id")||"";switch(d&&(d=parseInt(d,10)),l){case"tagDropdown":e.find("ul").is(":visible")||i();break;case"selectTag":d="",o.hasClass("tag-checked")?(o.removeClass("tag-checked"),r.find(".selected").text(sensorsdata.languages.get("标签<!--{en}Tag-->"))):(r.find(".selected").text(o.find(".detail").text()),o.addClass("tag-checked").siblings().removeClass("tag-checked"),d=o.find("span[data-color][data-id]").attr("data-id")||""),e.find("ul").hide(),t.find("tbody tr").each(function(e,t){$(t).toggle(!d||1===$(t).find('span[data-id="'+d+'"]').size())}),a.para.container.find(".report-no-data.tag-no-data").toggle(0===t.find("tbody tr:visible").size());break;case"addTag":var u=e.find("ul li").size();u>20?sensorsdata.info.show(sensorsdata.languages.get("最多允许创建 20 个标签<!--{en}Allowed to create up to 20 tags-->")):(e.find("ul").removeAttr("data-id").html(Mustache.render(a.tpl_meta_tag_create)).find(".delete").hide(),sensorsdata.authority.isAdmin||e.find("ul button,ul input").prop("disabled",!0));break;case"editTag":e.find("ul").empty().html(Mustache.render(a.tpl_meta_tag_create));var c=o.prev();e.find("ul").attr("data-id",c.attr("data-id")).find(".delete").show(),e.find("input[type=text]").val(c.text()),e.find(".body .icon-selected").removeClass("icon-selected"),e.find(".body ."+c.attr("data-color")).addClass("icon-selected"),sensorsdata.authority.isAdmin||e.find("ul button,ul input").prop("disabled",!0);break;case"selectColor":o.addClass("icon-selected").siblings().removeClass("icon-selected");break;case"addTagOk":var h={name:e.find('input[name="tag_name"]').val(),color:e.find(".icon-selected").attr("data-color")},f="tag";d&&(f+="/"+d),sensorsdata.ajax({url:f,type:"post",data:JSON.stringify(h),success:function(a){if(e.find("input[name=tag_name]").val(""),d){sensorsdata.info.show(sensorsdata.languages.get("签修改成功<!--{en}Modify successfully-->"));var s=n.filter(function(e){return e.id===d})[0];t.find('tbody tr td span[data-id="'+d+'"]').each(function(){$(this).removeClass(s.color).addClass(h.color).text(h.name)}),$.extend(!0,s,h)}else h.id=a.id,n.push(h);i()}});break;case"cancel":i();break;case"turnLeft":i();break;case"delete":sensorsdata.popover({ele:o,footer:$("#tpl_popover_footer_state_3").html(),showNow:!0,content:'确认删除这个标签吗？<div class="remark">本操作无法撤销</div>',successAfter:function(){sensorsdata.ajax({type:"delete",url:"tag/"+d,async:!1,success:function(e){for(var t=0,s=n.length;s>t;t++)if(n[t].id===d){n.splice(t,1);break}sensorsdata.cache.events=[],sensorsdata.cache.ajax={},$.isEmptyObject(e)&&(sensorsdata.info.show(sensorsdata.languages.get("标签删除成功<!--{en}Delete the tag successfully-->")),i(),a.showMetaEvents())}})}})}sensorsdata.languages.update()}),$(document).off("click.event-tag").on("click.event-tag",function(t){var a=$(t.target||t.srcElement);0!==a.closest(".tag_dropdown").size()||a.closest("button").is(s)||1!==a.parents("body").size()||e.find("ul").hide()})},events_:function(){function e(e){return e.length>10?e.substr(0,4)+"..."+e.substr(e.length-6,e.length):e}var t=this;this.eleMetaTableContainer.on("click",".events-manage-edit-btn",function(){t.dataSelectedIndex=$(this).closest("tr").attr("data-index"),t.showMetaFloat()}),this.eleVirtualTableContainer.on("click",".events-manage-edit-btn",function(){t.dataSelectedIndex=$(this).closest("tr").attr("data-index"),t.floatMode="editVirtual",sensorsdata.ajax({url:"tag",success:function(e){t.showVirtualFloat($.extend(!0,[],e))}})}),this.eleMetaTableContainer.tooltip({selector:'[data-toggle="tooltip"]'}),this.eleMetaFloat.tooltip({selector:'[data-toggle="tooltip"]'}),this.eleMetaFloat.on("click","#btn_events_meta_float_save",function(){"event"===t.floatMode?t.saveMetaFloat():"profile"===t.floatMode&&(t.saveProfileFloat(),t.eleContainerMeta.find("#events_meta_filter_input").val(""))}),this.eleVirtualFloat.on("click","#btn_events_meta_float_save",function(){t.saveVirtualFloat()}),this.eleMetaFloat.on("click","#btn-cancel",function(){t.metaFloatLayer.hideView()}),this.eleVirtualFloat.on("click","#btn-cancel",function(){t.virtualFloatLayer.hideView()});var a=null;this.eleContainerMeta.on("keyup","#events_meta_filter_input",function(){var e=$(this),s=$.trim(e.val());e.data("inputVal")&&e.data("inputVal")===s||(e.data("inputVal",s),a&&clearTimeout(a),a=setTimeout(function(){t.showSuggestView(s)},500))}),this.eleContainerVirtual.on("keyup","#events_virtual_filter_input",function(){var e=$(this),s=$.trim(e.val());e.data("inputVal")&&e.data("inputVal")===s||(e.data("inputVal",s),a&&clearTimeout(a),a=setTimeout(function(){t.showSuggestView(s)},500))}),this.eleMetaTableContainer.on("click","thead th[data-sort]",function(){t.metaTableSort($(this))}),this.eleVirtualTableContainer.on("click","thead th[data-sort]",function(){t.virtualTableSort($(this))}),this.eleTabs.on("click","li",function(){return $(this).hasClass("on")?!1:(window.history.pushState("events-type","","#type="+$(this).attr("data-type")),void t.reload())}),$("#events_virtual_create_btn").on("click",function(){t.floatMode="createVirtual",sensorsdata.ajax({url:"tag",success:function(e){t.showVirtualFloat($.extend(!0,[],e))}})}),this.eleVirtualFloat.on("click","#events_virtual_filter_add",function(){t.filterGroupEvents.addFilterEvent()}),this.eleEventsMetaBtn.on("click",function(){t.showMetaEvents({glist:t.dataFilterMetaEvents?t.dataFilterMetaEvents:t.dataMetaEvents})}),this.eleContainerUserPro.on("click","#user_profile_edit",function(){t.showUserProfiles(!1,t.dataFilterUserProfiles),t.userEditBtn_.show(),t.eleContainerUserPro.tooltip({selector:'[data-toggle="tooltip"]',container:"body"}),t.eleContainerUserPro.tooltip("show"),$(this).hide()}),this.eleContainerUserPro.on("click","tr td.visible-edit",function(){var e=t.eleContainerUserPro.find("#editBtn").is(":visible"),a=$(this).find("span[data-value]");e&&void 0!==a.attr("data-value")&&("false"===a.attr("data-value")?(a.text(sensorsdata.languages.get("显示<!--{en}Visible-->")),a.attr("data-value",!0)):(a.text(sensorsdata.languages.get("隐藏<!--{en}Invisible-->")),a.attr("data-value",!1)))}),this.userEditCancel_.on("click",function(){t.showUserProfiles(!0,t.dataFilterUserProfiles),t.eleContainerUserPro.find("#user_profile_edit").show(),t.eleContainerUserPro.tooltip("destroy"),t.userEditBtn_.hide()}),this.userEditOk_.on("click",function(){t.saveUserProfile(),t.eleContainerUserPro.find("#user_profile_edit").show(),t.eleContainerUserPro.tooltip("destroy"),t.userEditBtn_.hide()}),this.eleContainerUserPro.on("click","thead th[data-sort]",function(){t.userTableSort($(this))}),this.userShowAll_.on("click",function(){var e=t.userEditBtn_.is(":visible"),a=!1;e||(a=!0),t.showUserProfiles(a,{glist:t.dataFilterUserProfiles?t.dataFilterUserProfiles:t.dataUserProfiles})}),this.eleContainerUserPro.on("keyup","#user_profile_filter_input",function(){var e=$(this),s=$.trim(e.val());e.data("inputVal")&&e.data("inputVal")===s||(e.data("inputVal",s),a&&clearTimeout(a),a=setTimeout(function(){t.showSuggestView(s)},500))}),this.eleContainerUserPro.on("click","td .uploadT",function(){var e=$(this),a=e.attr("name"),s=e.attr("cname"),n=e.attr("id");t.userModal_.modal("show"),t.userModal_.find(".modal-title").text(sensorsdata.util.format(sensorsdata.languages.get("#{cname} 上传维度字典<!--{en}Upload Dimension dict of #{name}-->"),{cname:s,name:a})),t.userModal_.find("button.upload").attr("id",n);var i=t.userModal_.find("#user-profile-upload"),o=t.userModal_.find(".close");i.unbind("click.select").bind("click.select",function(e){e.preventDefault(),t.userModal_.find("#user-profile").click()}),o.click(function(){document.getElementById("form").reset(),sensorsdata.form.removeError(t.userModal_.find("input.file-name"))});var r=t.userModal_.find("button.upload");r.unbind("click.upload-user-pro").on("click.upload-user-pro",function(){if($(this).attr("id")===e.attr("id")){var s=$(this).parent().prev(),n=a,i="profile";s.find("#type").val(i),s.find("#propertyName").val(n);var o=sensorsdata.AJAX_CONST.BASE_URL+"property/dict/upload";sensorsdata.cache.project.name&&-1===o.indexOf("project=")&&(o=o+"?project="+sensorsdata.cache.project.name);var r=new FormData($("#form")[0]),l={success:!0,property_type:sensorsdata.languages.get("用户属性<!--{en}User properties-->")};$.ajax({url:o,type:"POST",data:r,async:!1,cache:!1,contentType:!1,processData:!1,success:function(){sensorsdata.track("upload_dictionary",l),sensorsdata.info.show(sensorsdata.languages.get("上传成功<!--{en}Upload successfully-->")),t.userModal_.modal("hide"),t.showUserProfiles(!0)},error:function(e){l.success=!1,l.fail_reason=e.status,sensorsdata.track("upload_dictionary",l);var t=sensorsdata.languages.get("上传失败<!--{en}Upload failed-->");if(e&&410===e.status){var a=e.responseJSON||{};a.error&&(t+="："+(a.error||""))}sensorsdata.error.show(t)}})}})}),this.eleContainerUserPro.on("click","td .delete",function(){var e=$(this),a=$(this).attr("name"),s=sensorsdata.AJAX_CONST.BASE_URL+"property/dict/empty?";sensorsdata.cache.project.name&&-1===s.indexOf("project=")&&(s+="project="+sensorsdata.cache.project.name),e.data("bs.popover")||sensorsdata.popover({className:"popover-edit-dashboard-delete",ele:e,showNow:!0,footer:$("#tpl_popover_footer_state_3").html(),content:sensorsdata.languages.get("确认删除吗？<!--{en}Are you sure to delete it?-->"),success:function(){sensorsdata.ajax({url:s+"&propertyName="+a+"&type=profile",type:"post",error:function(){sensorsdata.error.show(sensorsdata.languages.get("删除失败<!--{en}Delete failed-->"))},success:function(){sensorsdata.info.show(sensorsdata.languages.get("删除成功<!--{en}Delete successfully-->")),t.userModal_.modal("hide"),t.showUserProfiles(!0)}})}})}),this.eleContainerEventPro.on("click","td .delete",function(){var e=$(this),a=$(this).attr("name"),s=sensorsdata.AJAX_CONST.BASE_URL+"property/dict/empty?";sensorsdata.cache.project.name&&-1===s.indexOf("project=")&&(s=s+"project="+sensorsdata.cache.project.name),e.data("bs.popover")||sensorsdata.popover({className:"popover-edit-dashboard-delete",ele:e,showNow:!0,footer:$("#tpl_popover_footer_state_3").html(),content:sensorsdata.languages.get("确认删除吗？<!--{en}Are you sure to delete it?-->"),success:function(){sensorsdata.ajax({url:s+"&propertyName="+a+"&type=property",type:"post",error:function(){sensorsdata.error.show(sensorsdata.languages.get("删除失败<!--{en}Delete failed-->"))},success:function(){sensorsdata.info.show(sensorsdata.languages.get("删除成功<!--{en}Delete successfully-->")),t.eventModal_.modal("hide"),t.showEventProfiles(!0)}})}})}),this.eleContainerEventPro.on("click",'td button[data-method="download-dict"]',function(){var e=$(this).parents("tr:first"),t=e.attr("data-index"),a="property/dict/txt/"+t,s=sensorsdata.util.format(sensorsdata.languages.get("事件属性-#{name}-维度字典<!--{en}Event property-#{name}-dimensional dictionary-->"),{name:e.find("td:nth-child(2)").text()});sensorsdata.download(a,null,s)}),this.eleContainerUserPro.on("click",'td button[data-method="download-dict"]',function(){var e=$(this).parents("tr:first"),t=e.attr("data-index"),a="property/dict/txt/"+t,s=sensorsdata.util.format(sensorsdata.languages.get("用户属性-#{name}-维度字典<!--{en}User property-#{name}-dimensional dictionary-->"),{name:e.find("td:nth-child(2)").text()});sensorsdata.download(a,null,s)}),this.eventEditBtn_.on("click",function(){$(this).hide(),t.eleContainerEventPro.find("#eventEidtBtn").show(),t.eleContainerEventPro.tooltip({selector:"[data-toggle=tooltip]",container:"body"}),t.eleContainerEventPro.tooltip("show"),t.showEventProfiles(!1,t.dataFilterEventProfiles)}),this.eventEditCancel_.on("click",function(){t.showEventProfiles(!0,t.dataFilterEventProfiles),t.eleContainerEventPro.find("#eventEidtBtn").hide(),t.eleContainerEventPro.tooltip("destroy"),t.eventEditBtn_.show()}),this.eleContainerEventPro.on("click","thead th[data-sort]",function(){t.eventTableSort($(this))}),this.eventCheckBtn_.on("click",function(){var e=t.eleContainerEventPro.find("#eventEidtBtn").is(":visible"),a=!1;e||(a=!0),t.showEventProfiles(a,{glist:t.dataFilterEventProfiles||t.dataEventProfiles})}),this.eventEditOk_.on("click",function(){t.saveEventProfile(),t.eventEditBtn_.show(),t.eleContainerEventPro.tooltip("destroy"),t.eleContainerEventPro.find("#eventEidtBtn").hide()}),this.eleContainerEventPro.on("keyup","#event_profile_filter_input",function(){var e=$(this),s=$.trim(e.val());e.data("inputVal")&&e.data("inputVal")===s||(e.data("inputVal",s),a&&clearTimeout(a),a=setTimeout(function(){t.showSuggestView(s)},500))}),this.eleContainerEventPro.on("click","td .uploadT",function(){var e=$(this),a=e.attr("name"),s=e.attr("cname"),n=e.attr("id");t.eventModal_.modal("show"),t.eventModal_.find(".modal-title").text(sensorsdata.util.format(sensorsdata.languages.get("#{cname} 上传维度字典<!--{en}Upload Dimension dict of #{name}-->"),{cname:s,name:a})),t.eventModal_.find("button.upload").attr("id",n);var i=t.eventModal_.find(".close"),o=t.eventModal_.find("#event-profile-upload");o.unbind("click.select").bind("click.select",function(e){e.preventDefault(),t.eventModal_.find("#event-profile").click()}),i.click(function(){document.getElementById("event-form").reset(),sensorsdata.form.removeError(t.eventModal_.find("input.file-name"))});var r=t.eventModal_.find("button.upload");r.unbind("click.upload-event-pro").on("click.upload-event-pro",function(){if($(this).attr("id")===e.attr("id")){var s=$(this).parent().prev(),n=a,i="property";s.find("#type").val(i),s.find("#propertyName").val(n);var o=sensorsdata.AJAX_CONST.BASE_URL+"property/dict/upload";sensorsdata.cache.project.name&&-1===o.indexOf("project=")&&(o=o+"?project="+sensorsdata.cache.project.name);var r=new FormData($("#event-form")[0]),l={success:!0,property_type:sensorsdata.languages.get("事件属性<!--{en}Event properties-->")};$.ajax({url:o,type:"POST",data:r,async:!1,cache:!1,contentType:!1,processData:!1,success:function(){sensorsdata.track("upload_dictionary",l),sensorsdata.info.show(sensorsdata.languages.get("上传成功<!--{en}Upload successfully-->")),t.eventModal_.modal("hide"),t.showEventProfiles(!0)},error:function(e){l.success=!1,l.fail_reason=e.status,sensorsdata.track("upload_dictionary",l);var t=sensorsdata.languages.get("上传失败<!--{en}Upload failed-->");if(e&&410===e.status){var a=e.responseJSON||{};a.error&&(t+="："+(a.error||""))}sensorsdata.error.show(t)}})}})}),this.eleContainerEventPro.on("click","tr td.visible-edit",function(){var e=t.eleContainerEventPro.find("#eventEidtBtn").is(":visible"),a=$(this).find("span[data-value]");e&&void 0!==a.attr("data-value")&&("false"===a.attr("data-value")?(a.text(sensorsdata.languages.get("显示<!--{en}Visible-->")),a.attr("data-value",!0)):(a.text(sensorsdata.languages.get("隐藏<!--{en}Invisible-->")),a.attr("data-value",!1)))}),this.eventModal_.find("input#event-profile").on("change",function(){var a=$(this),s=a.val(),n=s.split("\\");n=n[n.length-1];var i=t.eventModal_.find("input.file-name");i.val(e(n)),s=s.substring(s.lastIndexOf(".")+1),"txt"!==s||""===s?(sensorsdata.form.addError(i,i.attr("data-error-text"),!1,{container:t.eventModal_}),t.eventModal_.find("button.upload").attr("disabled",!0)):(sensorsdata.form.removeError(i),t.eventModal_.find("button.upload").attr("disabled",!1))}),this.userModal_.find("input#user-profile").on("change",function(){var a=$(this),s=a.val(),n=s.split("\\");n=n[n.length-1];var i=t.userModal_.find("input.file-name");i.val(e(n)),s=s.substring(s.lastIndexOf(".")+1),"txt"!==s||""===s?(sensorsdata.form.addError(i,i.attr("data-error-text"),!1,{container:t.userModal_}),t.userModal_.find("button.upload").attr("disabled",!0)):(sensorsdata.form.removeError(i),t.userModal_.find("button.upload").attr("disabled",!1))}),this.eleContainerSession.find("#session_create_btn").on("click",function(){t.floatMode="createSession",t.showFloatSession()}),this.eleContainerSession.on("click",".events-manage-edit-btn",function(){t.dataSelectedIndex=$(this).closest("tr").attr("data-index"),t.floatMode="editSession",t.showFloatSession()}),this.eleSessionFloat.on("click","ul a",function(e){var a=$(e.target||e.srcElement),s=a.attr("data-value"),n=t.eleSessionFloat.find("#role_span"),i=n.attr("data-value");i!==s&&(n.attr("data-value",s),n.removeClass(),n.html(n.parent().parent().find('ul a[data-value="'+s+'"]').html()),sensorsdata.languages.update())}),this.eleSessionFloat.on("click","#btn_session_meta_float_save",function(){"createSession"===t.floatMode?t.saveSessionFloat():"editSession"===t.floatMode&&t.saveEditSessionFloat()}),this.eleSessionFloat.on("click","#session_edit_remove",function(){var e=$(this);e.data("bs.popover")||sensorsdata.popover({ele:$("#session_edit_remove"),footer:$("#tpl_popover_footer_state_3").html(),showNow:!0,content:'确认删除这个session吗？<div class="remark">本操作无法撤销</div>',successAfter:function(){var a=parseInt(e.attr("data-value"),10),s=t.dataSessions.filter(function(e){return e.id===a})[0],n={success:!0,session_interval:s.session_rule.params[0],is_all_events:s.event_list.length===sensorsdata.cache.events.length,operation_type:sensorsdata.languages.get("删除<!--{en}Delete-->")};sensorsdata.ajax({type:"delete",url:"sessions/session/"+a,async:!1,error:function(e){n.success=!1,n.fail_reason=e.status,sensorsdata.track("session_operation",n)},success:function(e){sensorsdata.track("session_operation",n),sensorsdata.cache.events=[],sensorsdata.cache.ajax={},$.isEmptyObject(e)&&(t.sessionFloatLayer.hideView(),sensorsdata.info.show(sensorsdata.languages.get("Session删除成功<!--{en}Delete the Session successfully-->")),t.showAllSession())}})}})}),this.eleSessionFloat.on("click","#btn_session_meta_float_cancel",function(){t.sessionFloatLayer.hideView()}),this.eleSessionTable_.on("click","thead th[data-sort]",function(){t.sessionSort($(this))}),this.eleContainerSession.on("keyup","#session_filter_input",function(){var e=$(this),s=$.trim(e.val());e.data("inputVal")&&e.data("inputVal")===s||(e.data("inputVal",s),a&&clearTimeout(a),a=setTimeout(function(){t.showSuggestView(s)},500))}),this.eleMetaFloat.on("click",".popover .cancel",function(){t.eleMetaFloat.find(".popover").hide()}),this.eleMetaFloat.on("click",".tag_class .icon-remove",function(){$(this).parents("li:first").remove()})}},sensorsdata.EventsManage.prototype.init=function(){var e="/accessories/progress_viewer";sensorsdata.cache.project.name&&(e+="?project="+sensorsdata.cache.project.name),this.para.container.find("#link-import-tool").attr("href",e),this.para.closeLoading(),this.checkToShow(),this.events_()},sensorsdata.EventsManage.prototype.unload=function(){this.visualTrackingManager&&$.isFunction(this.visualTrackingManager.unload)&&this.visualTrackingManager.unload()},sensorsdata.EventsManage.prototype.reload=function(){this.checkToShow()};